import * as tslib_1 from "tslib";
import { Input, EventEmitter, Output } from '@angular/core';
import { isTypeof } from '../../../../utils/util';
import { getGridColumnsClasses, isVisibleField } from '../../po-dynamic.util';
import { PoDynamicFieldType } from '../../po-dynamic-field-type.enum';
export class PoDynamicFormFieldsBaseComponent {
    constructor(titleCasePipe) {
        this.titleCasePipe = titleCasePipe;
        this._value = {};
        this.visibleFields = [];
        this.fieldsChange = new EventEmitter();
        this.formValidate = new EventEmitter();
    }
    // array de objetos que implementam a interface PoDynamicFormField, que serão exibidos no componente.
    set fields(value) {
        this._fields = Array.isArray(value) ? [...value] : [];
    }
    get fields() {
        return this._fields;
    }
    // valor que será utilizado para iniciar valor no componente.
    set value(value) {
        this._value = value && isTypeof(value, 'object') ? value : {};
    }
    get value() {
        return this._value;
    }
    compareTo(value, compareTo) {
        return value === compareTo;
    }
    // retorna um array com os objetos configurados e visiveis.
    getVisibleFields() {
        const visibleFields = [];
        this.fields.forEach(field => {
            if (this.existsProperty(visibleFields, field.property)) {
                this.printError(`"po-dynamic-form" property "${field.property}" está duplicado. Interface: PoDynamicFormField.`);
                return;
            }
            if (!field['property']) {
                this.printError('"po-dynamic-form" É obrigatório ser especificado um property.');
                return;
            }
            if (isVisibleField(field)) {
                visibleFields.push(this.createField(field));
            }
        });
        return visibleFields;
    }
    // converte um array em string para um array de objetos que contem label e value.
    convertOptions(options) {
        const everyOptionString = options.every(option => typeof option === 'string');
        if (everyOptionString) {
            return options.map(value => ({ label: value, value }));
        }
        return options;
    }
    // cria um novo objeto com as classes de grid system, com control (tipo do componente) e label default.
    createField(field) {
        const control = this.getComponentControl(field);
        const options = !!field.options ? this.convertOptions(field.options) : undefined;
        const focus = this.hasFocus(field);
        const componentClass = getGridColumnsClasses(field.gridSmColumns, field.gridMdColumns, field.gridLgColumns, field.gridXlColumns, field.gridColumns);
        return Object.assign({ label: this.titleCasePipe.transform(field.property) }, field, { componentClass,
            control,
            focus,
            options });
    }
    existsProperty(fields, property) {
        return fields.some(field => {
            return field.property === property;
        });
    }
    // recupera o componente de acordo com algumas regras do field.
    getComponentControl(field = {}) {
        const type = field && field.type ? field.type.toLocaleLowerCase() : 'string';
        if (this.isNumberType(field, type)) {
            return 'number';
        }
        else if (this.isCurrencyType(field, type)) {
            return 'decimal';
        }
        else if (this.isSelect(field)) {
            return 'select';
        }
        else if (this.isRadioGroup(field)) {
            return 'radioGroup';
        }
        else if (this.isCheckboxGroup(field)) {
            return 'checkboxGroup';
        }
        else if (this.isMultiselect(field)) {
            return 'multiselect';
        }
        else if (this.compareTo(type, PoDynamicFieldType.Boolean)) {
            return 'switch';
        }
        else if (this.compareTo(type, PoDynamicFieldType.Date) || this.compareTo(type, PoDynamicFieldType.DateTime)) {
            return 'datepicker';
        }
        else if (this.compareTo(type, PoDynamicFieldType.Time)) {
            field.mask = field.mask || '99:99';
            return 'input';
        }
        else if (this.isCombo(field)) {
            return 'combo';
        }
        else if (this.isLookup(field)) {
            return 'lookup';
        }
        else if (this.isTextarea(field)) {
            return 'textarea';
        }
        else if (this.isPassword(field)) {
            return 'password';
        }
        return 'input';
    }
    hasFocus(field) {
        return !!this.autoFocus && this.autoFocus === field.property;
    }
    isCheckboxGroup(field) {
        const { optionsService, optionsMulti, options } = field;
        return !optionsService && optionsMulti && !!options && options.length <= 3;
    }
    isCombo(field) {
        const { optionsService } = field;
        return !!optionsService && isTypeof(optionsService, 'string');
    }
    isCurrencyType(field, type) {
        const { mask, pattern } = field;
        return this.compareTo(type, PoDynamicFieldType.Currency) && (!mask && !pattern);
    }
    isLookup(field) {
        const { searchService } = field;
        return !!searchService && isTypeof(searchService, 'string');
    }
    isMultiselect(field) {
        const { optionsService, optionsMulti, options } = field;
        return !optionsService && optionsMulti && !!options && options.length > 3;
    }
    isNumberType(field, type) {
        const { mask, pattern } = field;
        return this.compareTo(type, PoDynamicFieldType.Number) && (!mask && !pattern);
    }
    isPassword(field) {
        const { secret } = field;
        return secret;
    }
    isRadioGroup(field) {
        const { optionsMulti, options } = field;
        return !optionsMulti && !!options && options.length <= 3;
    }
    isSelect(field) {
        const { optionsMulti, options } = field;
        return !optionsMulti && !!options && options.length > 3;
    }
    isTextarea(field) {
        const { rows } = field;
        return rows && rows >= 3;
    }
    printError(error) {
        console.error(error);
    }
}
tslib_1.__decorate([
    Input('p-auto-focus'),
    tslib_1.__metadata("design:type", String)
], PoDynamicFormFieldsBaseComponent.prototype, "autoFocus", void 0);
tslib_1.__decorate([
    Input('p-fields'),
    tslib_1.__metadata("design:type", Array),
    tslib_1.__metadata("design:paramtypes", [Array])
], PoDynamicFormFieldsBaseComponent.prototype, "fields", null);
tslib_1.__decorate([
    Output('p-fieldsChange'),
    tslib_1.__metadata("design:type", Object)
], PoDynamicFormFieldsBaseComponent.prototype, "fieldsChange", void 0);
tslib_1.__decorate([
    Input('p-value'),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], PoDynamicFormFieldsBaseComponent.prototype, "value", null);
tslib_1.__decorate([
    Input('p-disabled-form'),
    tslib_1.__metadata("design:type", Boolean)
], PoDynamicFormFieldsBaseComponent.prototype, "disabledForm", void 0);
tslib_1.__decorate([
    Input('p-validate'),
    tslib_1.__metadata("design:type", Object)
], PoDynamicFormFieldsBaseComponent.prototype, "validate", void 0);
tslib_1.__decorate([
    Output('p-form-validate'),
    tslib_1.__metadata("design:type", Object)
], PoDynamicFormFieldsBaseComponent.prototype, "formValidate", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLWZpZWxkcy1iYXNlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb3J0aW5hcmkvcG9ydGluYXJpLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZHluYW1pYy9wby1keW5hbWljLWZvcm0vcG8tZHluYW1pYy1mb3JtLWZpZWxkcy9wby1keW5hbWljLWZvcm0tZmllbGRzLWJhc2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHNUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRWxELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5RSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUl0RSxNQUFNLE9BQU8sZ0NBQWdDO0lBbUMzQyxZQUFvQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQWhDeEMsV0FBTSxHQUFTLEVBQUUsQ0FBQztRQUUxQixrQkFBYSxHQUFzQyxFQUFFLENBQUM7UUFhNUIsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBZXRDLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUVmLENBQUM7SUExQnBELHFHQUFxRztJQUNsRixJQUFJLE1BQU0sQ0FBQyxLQUFnQztRQUM1RCxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3hELENBQUM7SUFFRCxJQUFJLE1BQU07UUFDUixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUlELDZEQUE2RDtJ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QyxDQUFDO0lBQzNELENBQUM7SUFFTyxRQUFRLENBQUMsS0FBeUI7UUFDeEMsTUFBTSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFFeEMsT0FBTyxDQUFDLFlBQVksSUFBSSxDQUFDLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFTyxVQUFVLENBQUMsS0FBeUI7UUFDMUMsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQztRQUV2QixPQUFPLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFTyxVQUFVLENBQUMsS0FBYTtRQUM5QixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7Q0FFRjtBQXpNd0I7SUFBdEIsS0FBSyxDQUFDLGNBQWMsQ0FBQzs7bUVBQW9CO0FBR3ZCO0lBQWxCLEtBQUssQ0FBQyxVQUFVLENBQUM7c0NBQW1CLEtBQUs7NkNBQUwsS0FBSzs4REFFekM7QUFNeUI7SUFBekIsTUFBTSxDQUFDLGdCQUFnQixDQUFDOztzRUFBd0M7QUFHL0M7SUFBakIsS0FBSyxDQUFDLFNBQVMsQ0FBQzs7OzZEQUVoQjtBQU15QjtJQUF6QixLQUFLLENBQUMsaUJBQWlCLENBQUM7O3NFQUF1QjtBQUUzQjtJQUFwQixLQUFLLENBQUMsWUFBWSxDQUFDOztrRUFBOEI7QUFFdkI7SUFBMUIsTUFBTSxDQUFDLGlCQUFpQixDQUFDOztzRUFBd0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnB1dCwgRXZlbnRFbWl0dGVyLCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVGl0bGVDYXNlUGlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcblxyXG5pbXBvcnQgeyBpc1R5cGVvZiB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xyXG5cclxuaW1wb3J0IHsgZ2V0R3JpZENvbHVtbnNDbGFzc2VzLCBpc1Zpc2libGVGaWVsZCB9IGZyb20gJy4uLy4uL3BvLWR5bmFtaWMudXRpbCc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0ZpZWxkVHlwZSB9IGZyb20gJy4uLy4uL3BvLWR5bmFtaWMtZmllbGQtdHlwZS5lbnVtJztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnLi4vcG8tZHluYW1pYy1mb3JtLWZpZWxkLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1GaWVsZEludGVybmFsIH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tZmllbGQtaW50ZXJuYWwuaW50ZXJmYWNlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBQb0R5bmFtaWNGb3JtRmllbGRzQmFzZUNvbXBvbmVudCB7XHJcblxyXG4gIHByaXZhdGUgX2ZpZWxkczogQXJyYXk8UG9EeW5hbWljRm9ybUZpZWxkPjtcclxuICBwcml2YXRlIF92YWx1ZT86IGFueSA9IHt9O1xyXG5cclxuICB2aXNpYmxlRmllbGRzOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGRJbnRlcm5hbD4gPSBbXTtcclxuXHJcbiAgQElucHV0KCdwLWF1dG8tZm9jdXMnKSBhdXRvRm9jdXM/OiBzdHJpbmc7XHJcblxyXG4gIC8vIGFycmF5IGRlIG9iamV0b3MgcXVlIGltcGxlbWVudGFtIGEgaW50ZXJmYWNlIFBvRHluYW1pY0Zvcm1GaWVsZCwgcXVlIHNlcsOjbyBleGliaWRvcyBubyBjb21wb25lbnRlLlxyXG4gIEBJbnB1dCgncC1maWVsZHMnKSBzZXQgZmllbGRzKHZhbHVlOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+KSB7XHJcbiAgICB0aGlzLl9maWVsZHMgPSBBcnJheS5pc0FycmF5KHZhbHVlKSA/IFsuLi52YWx1ZV0gOiBbXTtcclxuICB9XHJcblxyXG4gIGdldCBmaWVsZHMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fZmllbGRzO1xyXG4gIH1cclxuXHJcbiAgQE91dHB1dCgncC1maWVsZHNDaGFuZ2UnKSBmaWVsZHNDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgLy8gdmFsb3IgcXVlIHNlcsOhIHV0aWxpemFkbyBwYXJhIGluaWNpYXIgdmFsb3Igbm8gY29tcG9uZW50ZS5cclxuICBASW5wdXQoJ3AtdmFsdWUnKSBzZXQgdmFsdWUodmFsdWU6IGFueSkge1xyXG4gICAgdGhpcy5fdmFsdWUgPSB2YWx1ZSAmJiBpc1R5cGVvZih2YWx1ZSwgJ29iamVjdCcpID8gdmFsdWUgOiB7fTtcclxuICB9XHJcblxyXG4gIGdldCB2YWx1ZSgpIHtcclxuICAgIHJldHVybiB0aGlzLl92YWx1ZTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCgncC1kaXNhYmxlZC1mb3JtJykgZGlzYWJsZWRGb3JtOiBib29sZWFuO1xyXG5cclxuICBASW5wdXQoJ3AtdmFsaWRhdGUnKSB2YWxpZGF0ZT86IHN0cmluZyB8IEZ1bmN0aW9uO1xyXG5cclxuICBAT3V0cHV0KCdwLWZvcm0tdmFsaWRhdGUnKSBmb3JtVmFsaWRhdGUgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB0aXRsZUNhc2VQaXBlOiBUaXRsZUNhc2VQaXBlKSB7fVxyXG5cclxuICBjb21wYXJlVG8odmFsdWUsIGNvbXBhcmVUbykge1xyXG4gICAgcmV0dXJuIHZhbHVlID09PSBjb21wYXJlVG87XHJcbiAgfVxyXG5cclxuICAvLyByZXRvcm5hIHVtIGFycmF5IGNvbSBvcyBvYmpldG9zIGNvbmZpZ3VyYWRvcyBlIHZpc2l2ZWlzLlxyXG4gIHByb3RlY3RlZCBnZXRWaXNpYmxlRmllbGRzKCkge1xyXG4gICAgY29uc3QgdmlzaWJsZUZpZWxkcyA9IFtdO1xyXG5cclxuICAgIHRoaXMuZmllbGRzLmZvckVhY2goZmllbGQgPT4ge1xyXG4gICAgICBpZiAodGhpcy5leGlzdHNQcm9wZXJ0eSh2aXNpYmxlRmllbGRzLCBmaWVsZC5wcm9wZXJ0eSkpIHtcclxuICAgICAgICB0aGlzLnByaW50RXJyb3IoYFwicG8tZHluYW1pYy1mb3JtXCIgcHJvcGVydHkgXCIke2ZpZWxkLnByb3BlcnR5fVwiIGVzdMOhIGR1cGxpY2Fkby4gSW50ZXJmYWNlOiBQb0R5bmFtaWNGb3JtRmllbGQuYCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoIWZpZWxkWydwcm9wZXJ0eSddKSB7XHJcbiAgICAgICAgdGhpcy5wcmludEVycm9yKCdcInBvLWR5bmFtaWMtZm9ybVwiIMOJIG9icmlnYXTDs3JpbyBzZXIgZXNwZWNpZmljYWRvIHVtIHByb3BlcnR5LicpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGlzVmlzaWJsZUZpZWxkKGZpZWxkKSkge1xyXG4gICAgICAgIHZpc2libGVGaWVsZHMucHVzaCh0aGlzLmNyZWF0ZUZpZWxkKGZpZWxkKSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB2aXNpYmxlRmllbGRzO1xyXG4gIH1cclxuXHJcbiAgLy8gY29udmVydGUgdW0gYXJyYXkgZW0gc3RyaW5nIHBhcmEgdW0gYXJyYXkgZGUgb2JqZXRvcyBxdWUgY29udGVtIGxhYmVsIGUgdmFsdWUuXHJcbiAgcHJpdmF0ZSBjb252ZXJ0T3B0aW9ucyhvcHRpb25zOiBBcnJheTxhbnk+KTogQXJyYXk8eyBsYWJlbDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIH0+IHtcclxuICAgIGNvbnN0IGV2ZXJ5T3B0aW9uU3RyaW5nID0gb3B0aW9ucy5ldmVyeShvcHRpb24gPT4gdHlwZW9mIG9wdGlvbiA9PT0gJ3N0cmluZycpO1xyXG5cclxuICAgIGlmIChldmVyeU9wdGlvblN0cmluZykge1xyXG4gICAgICByZXR1cm4gb3B0aW9ucy5tYXAodmFsdWUgPT4gKHtsYWJlbDogdmFsdWUsIHZhbHVlfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBvcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgLy8gY3JpYSB1bSBub3ZvIG9iamV0byBjb20gYXMgY2xhc3NlcyBkZSBncmlkIHN5c3RlbSwgY29tIGNvbnRyb2wgKHRpcG8gZG8gY29tcG9uZW50ZSkgZSBsYWJlbCBkZWZhdWx0LlxyXG4gIHByaXZhdGUgY3JlYXRlRmllbGQoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCk6IFBvRHluYW1pY0Zvcm1GaWVsZEludGVybmFsIHtcclxuICAgIGNvbnN0IGNvbnRyb2wgPSB0aGlzLmdldENvbXBvbmVudENvbnRyb2woZmllbGQpO1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9ICEhZmllbGQub3B0aW9ucyA/IHRoaXMuY29udmVydE9wdGlvbnMoZmllbGQub3B0aW9ucykgOiB1bmRlZmluZWQ7XHJcbiAgICBjb25zdCBmb2N1cyA9IHRoaXMuaGFzRm9jdXMoZmllbGQpO1xyXG5cclxuICAgIGNvbnN0IGNvbXBvbmVudENsYXNzID0gZ2V0R3JpZENvbHVtbnNDbGFzc2VzKGZpZWxkLmdyaWRTbUNvbHVtbnMsXHJcbiAgICAgIGZpZWxkLmdyaWRNZENvbHVtbnMsXHJcbiAgICAgIGZpZWxkLmdyaWRMZ0NvbHVtbnMsXHJcbiAgICAgIGZpZWxkLmdyaWRYbENvbHVtbnMsXHJcbiAgICAgIGZpZWxkLmdyaWRDb2x1bW5zKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBsYWJlbDogdGhpcy50aXRsZUNhc2VQaXBlLnRyYW5zZm9ybShmaWVsZC5wcm9wZXJ0eSksXHJcbiAgICAgIC4uLmZpZWxkLFxyXG4gICAgICBjb21wb25lbnRDbGFzcyxcclxuICAgICAgY29udHJvbCxcclxuICAgICAgZm9jdXMsXHJcbiAgICAgIG9wdGlvbnNcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGV4aXN0c1Byb3BlcnR5KGZpZWxkczogQXJyYXk8UG9EeW5hbWljRm9ybUZpZWxkPiwgcHJvcGVydHk6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGZpZWxkcy5zb21lKGZpZWxkID0+IHtcclxuICAgICAgcmV0dXJuIGZpZWxkLnByb3BlcnR5ID09PSBwcm9wZXJ0eTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gcmVjdXBlcmEgbyBjb21wb25lbnRlIGRlIGFjb3JkbyBjb20gYWxndW1hcyByZWdyYXMgZG8gZmllbGQuXHJcbiAgcHJpdmF0ZSBnZXRDb21wb25lbnRDb250cm9sKGZpZWxkOiBQb0R5bmFtaWNGb3JtRmllbGQgPSA8YW55PiB7fSkge1xyXG4gICAgY29uc3QgdHlwZSA9IGZpZWxkICYmIGZpZWxkLnR5cGUgPyBmaWVsZC50eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCkgOiAnc3RyaW5nJztcclxuXHJcbiAgICBpZiAodGhpcy5pc051bWJlclR5cGUoZmllbGQsIHR5cGUpKSB7XHJcbiAgICAgIHJldHVybiAnbnVtYmVyJztcclxuICAgIH0gZWxzZSBpZiAodGhpcy5pc0N1cnJlbmN5VHlwZShmaWVsZCwgdHlwZSkpIHtcclxuICAgICAgcmV0dXJuICdkZWNpbWFsJztcclxuICAgIH0gZWxzZSBpZiAodGhpcy5pc1NlbGVjdChmaWVsZCkpIHtcclxuICAgICAgcmV0dXJuICdzZWxlY3QnO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmlzUmFkaW9Hcm91cChmaWVsZCkpIHtcclxuICAgICAgcmV0dXJuICdyYWRpb0dyb3VwJztcclxuICAgIH0gZWxzZSBpZiAodGhpcy5pc0NoZWNrYm94R3JvdXAoZmllbGQpKSB7XHJcbiAgICAgIHJldHVybiAnY2hlY2tib3hHcm91cCc7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNNdWx0aXNlbGVjdChmaWVsZCkpIHtcclxuICAgICAgcmV0dXJuICdtdWx0aXNlbGVjdCc7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuY29tcGFyZVRvKHR5cGUsIFBvRHluYW1pY0ZpZWxkVHlwZS5Cb29sZWFuKSkge1xyXG4gICAgICByZXR1cm4gJ3N3aXRjaCc7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuY29tcGFyZVRvKHR5cGUsIFBvRHluYW1pY0ZpZWxkVHlwZS5EYXRlKSB8fCB0aGlzLmNvbXBhcmVUbyh0eXBlLCBQb0R5bmFtaWNGaWVsZFR5cGUuRGF0ZVRpbWUpKSB7XHJcbiAgICAgIHJldHVybiAnZGF0ZXBpY2tlcic7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuY29tcGFyZVRvKHR5cGUsIFBvRHluYW1pY0ZpZWxkVHlwZS5UaW1lKSkge1xyXG4gICAgICBmaWVsZC5tYXNrID0gZmllbGQubWFzayB8fCAnOTk6OTknO1xyXG5cclxuICAgICAgcmV0dXJuICdpbnB1dCc7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNDb21ibyhmaWVsZCkpIHtcclxuICAgICAgcmV0dXJuICdjb21ibyc7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuaXNMb29rdXAoZmllbGQpKSB7XHJcbiAgICAgIHJldHVybiAnbG9va3VwJztcclxuICAgIH0gZWxzZSBpZiAodGhpcy5pc1RleHRhcmVhKGZpZWxkKSkge1xyXG4gICAgICByZXR1cm4gJ3RleHRhcmVhJztcclxuICAgIH0gZWxzZSBpZiAodGhpcy5pc1Bhc3N3b3JkKGZpZWxkKSkge1xyXG4gICAgICByZXR1cm4gJ3Bhc3N3b3JkJztcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gJ2lucHV0JztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFzRm9jdXMoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCkge1xyXG4gICAgcmV0dXJuICEhdGhpcy5hdXRvRm9jdXMgJiYgdGhpcy5hdXRvRm9jdXMgPT09IGZpZWxkLnByb3BlcnR5O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0NoZWNrYm94R3JvdXAoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCkge1xyXG4gICAgY29uc3QgeyBvcHRpb25zU2VydmljZSwgb3B0aW9uc011bHRpLCBvcHRpb25zIH0gPSBmaWVsZDtcclxuXHJcbiAgICByZXR1cm4gIW9wdGlvbnNTZXJ2aWNlICYmIG9wdGlvbnNNdWx0aSAmJiAhIW9wdGlvbnMgJiYgb3B0aW9ucy5sZW5ndGggPD0gMztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNDb21ibyhmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkKSB7XHJcbiAgICBjb25zdCB7IG9wdGlvbnNTZXJ2aWNlIH0gPSBmaWVsZDtcclxuXHJcbiAgICByZXR1cm4gISFvcHRpb25zU2VydmljZSAmJiBpc1R5cGVvZihvcHRpb25zU2VydmljZSwgJ3N0cmluZycpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0N1cnJlbmN5VHlwZShmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkLCB0eXBlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHsgbWFzaywgcGF0dGVybiB9ID0gZmllbGQ7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuY29tcGFyZVRvKHR5cGUsIFBvRHluYW1pY0ZpZWxkVHlwZS5DdXJyZW5jeSkgJiYgKCFtYXNrICYmICFwYXR0ZXJuKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNMb29rdXAoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCkge1xyXG4gICAgY29uc3QgeyBzZWFyY2hTZXJ2aWNlIH0gPSBmaWVsZDtcclxuXHJcbiAgICByZXR1cm4gISFzZWFyY2hTZXJ2aWNlICYmIGlzVHlwZW9mKHNlYXJjaFNlcnZpY2UsICdzdHJpbmcnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNNdWx0aXNlbGVjdChmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkKSB7XHJcbiAgICBjb25zdCB7IG9wdGlvbnNTZXJ2aWNlLCBvcHRpb25zTXVsdGksIG9wdGlvbnMgfSA9IGZpZWxkO1xyXG5cclxuICAgIHJldHVybiAhb3B0aW9uc1NlcnZpY2UgJiYgb3B0aW9uc011bHRpICYmICEhb3B0aW9ucyAmJiBvcHRpb25zLmxlbmd0aCA+IDM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzTnVtYmVyVHlwZShmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkLCB0eXBlOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHsgbWFzaywgcGF0dGVybiB9ID0gZmllbGQ7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuY29tcGFyZVRvKHR5cGUsIFBvRHluYW1pY0ZpZWxkVHlwZS5OdW1iZXIpICYmICghbWFzayAmJiAhcGF0dGVybik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzUGFzc3dvcmQoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCkge1xyXG4gICAgY29uc3QgeyBzZWNyZXQgfSA9IGZpZWxkO1xyXG5cclxuICAgIHJldHVybiBzZWNyZXQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzUmFkaW9Hcm91cChmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkKSB7XHJcbiAgICBjb25zdCB7IG9wdGlvbnNNdWx0aSwgb3B0aW9ucyB9ID0gZmllbGQ7XHJcblxyXG4gICAgcmV0dXJuICFvcHRpb25zTXVsdGkgJiYgISFvcHRpb25zICYmIG9wdGlvbnMubGVuZ3RoIDw9IDM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzU2VsZWN0KGZpZWxkOiBQb0R5bmFtaWNGb3JtRmllbGQpIHtcclxuICAgIGNvbnN0IHsgb3B0aW9uc011bHRpLCBvcHRpb25zIH0gPSBmaWVsZDtcclxuXHJcbiAgICByZXR1cm4gIW9wdGlvbnNNdWx0aSAmJiAhIW9wdGlvbnMgJiYgb3B0aW9ucy5sZW5ndGggPiAzO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc1RleHRhcmVhKGZpZWxkOiBQb0R5bmFtaWNGb3JtRmllbGQpIHtcclxuICAgIGNvbnN0IHsgcm93cyB9ID0gZmllbGQ7XHJcblxyXG4gICAgcmV0dXJuIHJvd3MgJiYgcm93cyA+PSAzO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwcmludEVycm9yKGVycm9yOiBzdHJpbmcpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19