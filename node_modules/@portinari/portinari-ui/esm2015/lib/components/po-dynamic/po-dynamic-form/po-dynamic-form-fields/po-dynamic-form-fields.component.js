import * as tslib_1 from "tslib";
import { Component, ChangeDetectorRef, OnChanges, QueryList, SimpleChanges, ViewChildren } from '@angular/core';
import { ControlContainer, NgForm } from '@angular/forms';
import { TitleCasePipe } from '@angular/common';
import { PoDynamicFormFieldsBaseComponent } from './po-dynamic-form-fields-base.component';
import { PoDynamicFormValidationService } from '../po-dynamic-form-validation/po-dynamic-form-validation.service';
/**
 * @docsPrivate
 *
 * @description
 *
 * Componente de criação dos campos dinâmicos.
 */
let PoDynamicFormFieldsComponent = class PoDynamicFormFieldsComponent extends PoDynamicFormFieldsBaseComponent {
    constructor(titleCasePipe, validationService, changes) {
        super(titleCasePipe);
        this.validationService = validationService;
        this.changes = changes;
        this.previousValue = {};
    }
    ngOnChanges(changes) {
        if (changes.fields) {
            this.visibleFields = this.getVisibleFields();
        }
    }
    focus(property) {
        const foundComponent = this.components.find(component => component.name === property);
        if (foundComponent) {
            foundComponent.focus();
        }
    }
    isDisabled(field) {
        return field.disabled || this.disabledForm;
    }
    onChangeField(visibleField) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { property } = visibleField;
            const isChangedValueField = this.previousValue[property] !== this.value[property];
            if (isChangedValueField) {
                const { changedField, changedFieldIndex } = this.getField(property);
                if (changedField.validate) {
                    yield this.validateField(changedField, changedFieldIndex, visibleField);
                }
                this.triggerValidationOnForm(changedFieldIndex);
            }
            this.previousValue[property] = this.value[property];
        });
    }
    trackBy(index) {
        return index;
    }
    applyFieldValidation(index, validatedField) {
        const field = this.fields[index];
        this.fields[index] = Object.assign({}, field, validatedField.field);
        this.updateFields();
        if (validatedField.hasOwnProperty('value')) {
            this.value[field.property] = validatedField.value;
        }
        this.changes.detectChanges();
        if (validatedField.focus) {
            this.focus(field.property);
        }
    }
    getField(property) {
        const changedFieldIndex = this.fields.findIndex(field => field.property === property);
        const changedField = this.fields[changedFieldIndex];
        return { changedField, changedFieldIndex };
    }
    triggerValidationOnForm(changedFieldIndex) {
        const hasValidationForm = this.validate && this.formValidate.observers.length;
        if (hasValidationForm) {
            const updatedField = this.fields[changedFieldIndex];
            this.formValidate.emit(updatedField);
        }
    }
    updateFields() {
        this.fieldsChange.emit(this.fields);
        this.visibleFields = this.getVisibleFields();
    }
    validateField(field, fieldIndex, visibleField) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const value = this.value[field.property];
            const previousDisabled = visibleField.disabled;
            visibleField.disabled = true;
            this.changes.detectChanges();
            try {
                const validatedField = yield this.validationService.sendFieldChange(field, value).toPromise();
                this.applyFieldValidation(fieldIndex, validatedField);
            }
            catch (_a) {
                visibleField.disabled = previousDisabled;
            }
        });
    }
};
PoDynamicFormFieldsComponent.ctorParameters = () => [
    { type: TitleCasePipe },
    { type: PoDynamicFormValidationService },
    { type: ChangeDetectorRef }
];
tslib_1.__decorate([
    ViewChildren('component'),
    tslib_1.__metadata("design:type", QueryList)
], PoDynamicFormFieldsComponent.prototype, "components", void 0);
PoDynamicFormFieldsComponent = tslib_1.__decorate([
    Component({
        selector: 'po-dynamic-form-fields',
        template: "<div class=\"po-row\" *ngIf=\"visibleFields && visibleFields.length > 0\">\r\n  <ng-container *ngFor=\"let field of visibleFields; trackBy: trackBy\">\r\n\r\n    <po-divider *ngIf=\"field?.divider?.trim()\" class=\"po-sm-12\" [p-label]=\"field.divider\">\r\n    </po-divider>\r\n\r\n    <po-datepicker #component *ngIf=\"compareTo(field.control, 'datepicker')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-max-date]=\"field.maxValue\"\r\n      [p-min-date]=\"field.minValue\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-datepicker>\r\n\r\n    <po-input #component *ngIf=\"compareTo(field.control, 'input')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-mask]=\"field.mask\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-pattern]=\"field.pattern\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n      </po-input>\r\n\r\n    <po-number #component *ngIf=\"compareTo(field.control, 'number')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-min]=\"field.minValue\"\r\n      [p-max]=\"field.maxValue\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-number>\r\n\r\n    <po-decimal #component *ngIf=\"compareTo(field.control, 'decimal')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-decimal>\r\n\r\n    <po-select #component *ngIf=\"compareTo(field.control, 'select')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-select>\r\n\r\n    <po-radio-group #component *ngIf=\"compareTo(field.control, 'radioGroup')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-columns=\"3\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-radio-group>\r\n\r\n    <po-switch #component *ngIf=\"compareTo(field.control, 'switch')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-label-off]=\"field.booleanFalse\"\r\n      [p-label-on]=\"field.booleanTrue\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-switch>\r\n\r\n    <po-combo #component *ngIf=\"compareTo(field.control, 'combo')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-filter-params]=\"field.params\"\r\n      [p-filter-service]=\"field.optionsService\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-combo>\r\n\r\n    <po-lookup #component *ngIf=\"compareTo(field.control, 'lookup')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      p-field-label=\"label\"\r\n      p-field-value=\"value\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-columns]=\"field.columns\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-filter-params]=\"field.params\"\r\n      [p-filter-service]=\"field.searchService\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-lookup>\r\n\r\n    <po-checkbox-group #component *ngIf=\"compareTo(field.control, 'checkboxGroup')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-columns=\"3\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-checkbox-group>\r\n\r\n    <po-multiselect #component *ngIf=\"compareTo(field.control, 'multiselect')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-multiselect>\r\n\r\n    <po-textarea #component *ngIf=\"compareTo(field.control, 'textarea')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      [p-rows]=\"field.rows\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-textarea>\r\n\r\n    <po-password #component *ngIf=\"compareTo(field.control, 'password')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-pattern]=\"field.pattern\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\">\r\n    </po-password>\r\n\r\n  </ng-container>\r\n</div>\r\n",
        viewProviders: [{ provide: ControlContainer, useExisting: NgForm }],
        providers: [PoDynamicFormValidationService]
    }),
    tslib_1.__metadata("design:paramtypes", [TitleCasePipe, PoDynamicFormValidationService, ChangeDetectorRef])
], PoDynamicFormFieldsComponent);
export { PoDynamicFormFieldsComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLWZpZWxkcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3BvLWR5bmFtaWMvcG8tZHluYW1pYy1mb3JtL3BvLWR5bmFtaWMtZm9ybS1maWVsZHMvcG8tZHluYW1pYy1mb3JtLWZpZWxkcy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFHaEQsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFFM0YsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sa0VBQWtFLENBQUM7QUFFbEg7Ozs7OztHQU1HO0FBT0gsSUFBYSw0QkFBNEIsR0FBekMsTUFBYSw0QkFBNkIsU0FBUSxnQ0FBZ0M7SUFNaEYsWUFBWSxhQUE0QixFQUFVLGlCQUFpRCxFQUFVLE9BQTBCO1FBQ3JJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUQyQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQWdDO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFGL0gsa0JBQWEsR0FBRyxFQUFFLENBQUM7SUFJM0IsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFzQjtRQUNoQyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7WUFDbEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUM5QztJQUNILENBQUM7SUFFRCxLQUFLLENBQUMsUUFBZ0I7UUFDcEIs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QXdHeEM7U0F4R1ksNEJBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBDaGFuZ2VEZXRlY3RvclJlZiwgT25DaGFuZ2VzLCBRdWVyeUxpc3QsIFNpbXBsZUNoYW5nZXMsIFZpZXdDaGlsZHJlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb250cm9sQ29udGFpbmVyLCBOZ0Zvcm0gfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IFRpdGxlQ2FzZVBpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5cclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnLi4vcG8tZHluYW1pYy1mb3JtLWZpZWxkLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1GaWVsZHNCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tZmllbGRzLWJhc2UuY29tcG9uZW50JztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUZpZWxkVmFsaWRhdGlvbiB9IGZyb20gJy4uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS1maWVsZC12YWxpZGF0aW9uLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uU2VydmljZSB9IGZyb20gJy4uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uLnNlcnZpY2UnO1xyXG5cclxuLyoqXHJcbiAqIEBkb2NzUHJpdmF0ZVxyXG4gKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICpcclxuICogQ29tcG9uZW50ZSBkZSBjcmlhw6fDo28gZG9zIGNhbXBvcyBkaW7Dom1pY29zLlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdwby1keW5hbWljLWZvcm0tZmllbGRzJyxcclxuICB0ZW1wbGF0ZVVybDogJ3BvLWR5bmFtaWMtZm9ybS1maWVsZHMuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHZpZXdQcm92aWRlcnM6IFsgeyBwcm92aWRlOiBDb250cm9sQ29udGFpbmVyLCB1c2VFeGlzdGluZzogTmdGb3JtIH0gXSxcclxuICBwcm92aWRlcnM6IFsgUG9EeW5hbWljRm9ybVZhbGlkYXRpb25TZXJ2aWNlIF1cclxufSlcclxuZXhwb3J0IGNsYXNzIFBvRHluYW1pY0Zvcm1GaWVsZHNDb21wb25lbnQgZXh0ZW5kcyBQb0R5bmFtaWNGb3JtRmllbGRzQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XHJcblxyXG4gIEBWaWV3Q2hpbGRyZW4oJ2NvbXBvbmVudCcpIGNvbXBvbmVudHM6IFF1ZXJ5TGlzdDx7IG5hbWU6IHN0cmluZywgZm9jdXM6ICgpID0+IHZvaWQgfT47XHJcblxyXG4gIHByaXZhdGUgcHJldmlvdXNWYWx1ZSA9IHt9O1xyXG5cclxuICBjb25zdHJ1Y3Rvcih0aXRsZUNhc2VQaXBlOiBUaXRsZUNhc2VQaXBlLCBwcml2YXRlIHZhbGlkYXRpb25TZXJ2aWNlOiBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvblNlcnZpY2UsIHByaXZhdGUgY2hhbmdlczogQ2hhbmdlRGV0ZWN0b3JSZWYpIHtcclxuICAgIHN1cGVyKHRpdGxlQ2FzZVBpcGUpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgaWYgKGNoYW5nZXMuZmllbGRzKSB7XHJcbiAgICAgIHRoaXMudmlzaWJsZUZpZWxkcyA9IHRoaXMuZ2V0VmlzaWJsZUZpZWxkcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZm9jdXMocHJvcGVydHk6IHN0cmluZykge1xyXG4gICAgY29uc3QgZm91bmRDb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudHMuZmluZChjb21wb25lbnQgPT4gY29tcG9uZW50Lm5hbWUgPT09IHByb3BlcnR5KTtcclxuICAgIGlmIChmb3VuZENvbXBvbmVudCkge1xyXG4gICAgICBmb3VuZENvbXBvbmVudC5mb2N1cygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaXNEaXNhYmxlZChmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gZmllbGQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZEZvcm07XHJcbiAgfVxyXG5cclxuICBhc3luYyBvbkNoYW5nZUZpZWxkKHZpc2libGVGaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkKSB7XHJcbiAgICBjb25zdCB7IHByb3BlcnR5IH0gPSB2aXNpYmxlRmllbGQ7XHJcbiAgICBjb25zdCBpc0NoYW5nZWRWYWx1ZUZpZWxkID0gdGhpcy5wcmV2aW91c1ZhbHVlW3Byb3BlcnR5XSAhPT0gdGhpcy52YWx1ZVtwcm9wZXJ0eV07XHJcblxyXG4gICAgaWYgKGlzQ2hhbmdlZFZhbHVlRmllbGQpIHtcclxuXHJcbiAgICAgIGNvbnN0IHsgY2hhbmdlZEZpZWxkLCBjaGFuZ2VkRmllbGRJbmRleCB9ID0gdGhpcy5nZXRGaWVsZChwcm9wZXJ0eSk7XHJcblxyXG4gICAgICBpZiAoY2hhbmdlZEZpZWxkLnZhbGlkYXRlKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy52YWxpZGF0ZUZpZWxkKGNoYW5nZWRGaWVsZCwgY2hhbmdlZEZpZWxkSW5kZXgsIHZpc2libGVGaWVsZCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMudHJpZ2dlclZhbGlkYXRpb25PbkZvcm0oY2hhbmdlZEZpZWxkSW5kZXgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucHJldmlvdXNWYWx1ZVtwcm9wZXJ0eV0gPSB0aGlzLnZhbHVlW3Byb3BlcnR5XTtcclxuICB9XHJcblxyXG4gIHRyYWNrQnkoaW5kZXgpIHtcclxuICAgIHJldHVybiBpbmRleDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXBwbHlGaWVsZFZhbGlkYXRpb24oaW5kZXg6IG51bWJlciwgdmFsaWRhdGVkRmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZFZhbGlkYXRpb24pIHtcclxuICAgIGNvbnN0IGZpZWxkID0gdGhpcy5maWVsZHNbaW5kZXhdO1xyXG5cclxuICAgIHRoaXMuZmllbGRzW2luZGV4XSA9IHsgLi4uZmllbGQsIC4uLnZhbGlkYXRlZEZpZWxkLmZpZWxkIH07XHJcbiAgICB0aGlzLnVwZGF0ZUZpZWxkcygpO1xyXG5cclxuICAgIGlmICh2YWxpZGF0ZWRGaWVsZC5oYXNPd25Qcm9wZXJ0eSgndmFsdWUnKSkge1xyXG4gICAgICB0aGlzLnZhbHVlW2ZpZWxkLnByb3BlcnR5XSA9IHZhbGlkYXRlZEZpZWxkLnZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY2hhbmdlcy5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgaWYgKHZhbGlkYXRlZEZpZWxkLmZvY3VzKSB7XHJcbiAgICAgIHRoaXMuZm9jdXMoZmllbGQucHJvcGVydHkpO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RmllbGQocHJvcGVydHk6IHN0cmluZykge1xyXG4gICAgY29uc3QgY2hhbmdlZEZpZWxkSW5kZXggPSB0aGlzLmZpZWxkcy5maW5kSW5kZXgoZmllbGQgPT4gZmllbGQucHJvcGVydHkgPT09IHByb3BlcnR5KTtcclxuICAgIGNvbnN0IGNoYW5nZWRGaWVsZCA9IHRoaXMuZmllbGRzW2NoYW5nZWRGaWVsZEluZGV4XTtcclxuXHJcbiAgICByZXR1cm4geyBjaGFuZ2VkRmllbGQsIGNoYW5nZWRGaWVsZEluZGV4IH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRyaWdnZXJWYWxpZGF0aW9uT25Gb3JtKGNoYW5nZWRGaWVsZEluZGV4OiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGhhc1ZhbGlkYXRpb25Gb3JtID0gdGhpcy52YWxpZGF0ZSAmJiB0aGlzLmZvcm1WYWxpZGF0ZS5vYnNlcnZlcnMubGVuZ3RoO1xyXG5cclxuICAgIGlmIChoYXNWYWxpZGF0aW9uRm9ybSkge1xyXG4gICAgICBjb25zdCB1cGRhdGVkRmllbGQgPSB0aGlzLmZpZWxkc1tjaGFuZ2VkRmllbGRJbmRleF07XHJcbiAgICAgIHRoaXMuZm9ybVZhbGlkYXRlLmVtaXQodXBkYXRlZEZpZWxkKTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZUZpZWxkcygpIHtcclxuICAgIHRoaXMuZmllbGRzQ2hhbmdlLmVtaXQodGhpcy5maWVsZHMpO1xyXG4gICAgdGhpcy52aXNpYmxlRmllbGRzID0gdGhpcy5nZXRWaXNpYmxlRmllbGRzKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHZhbGlkYXRlRmllbGQoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCwgZmllbGRJbmRleDogbnVtYmVyLCB2aXNpYmxlRmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCkge1xyXG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLnZhbHVlW2ZpZWxkLnByb3BlcnR5XTtcclxuXHJcbiAgICBjb25zdCBwcmV2aW91c0Rpc2FibGVkID0gdmlzaWJsZUZpZWxkLmRpc2FibGVkO1xyXG4gICAgdmlzaWJsZUZpZWxkLmRpc2FibGVkID0gdHJ1ZTtcclxuICAgIHRoaXMuY2hhbmdlcy5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdmFsaWRhdGVkRmllbGQgPSBhd2FpdCB0aGlzLnZhbGlkYXRpb25TZXJ2aWNlLnNlbmRGaWVsZENoYW5nZShmaWVsZCwgdmFsdWUpLnRvUHJvbWlzZSgpO1xyXG4gICAgICB0aGlzLmFwcGx5RmllbGRWYWxpZGF0aW9uKGZpZWxkSW5kZXgsIHZhbGlkYXRlZEZpZWxkKTtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICB2aXNpYmxlRmllbGQuZGlzYWJsZWQgPSBwcmV2aW91c0Rpc2FibGVkO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbn1cclxuIl19