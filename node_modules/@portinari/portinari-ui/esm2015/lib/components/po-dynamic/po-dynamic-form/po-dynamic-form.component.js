import * as tslib_1 from "tslib";
import { Component, ChangeDetectorRef, OnDestroy, OnInit, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { PoDynamicFormBaseComponent } from './po-dynamic-form-base.component';
import { PoDynamicFormLoadService } from './po-dynamic-form-load/po-dynamic-form-load.service';
import { PoDynamicFormValidationService } from './po-dynamic-form-validation/po-dynamic-form-validation.service';
/**
 * @docsExtends PoDynamicFormBaseComponent
 *
 * @example
 *
 * <example name="po-dynamic-form-basic" title="Portinari Dynamic Form Basic">
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.html"> </file>
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-dynamic-form-register" title="Portinari Dynamic Form - Register">
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.html"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.ts"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.service.ts"> </file>
 * </example>
 */
let PoDynamicFormComponent = class PoDynamicFormComponent extends PoDynamicFormBaseComponent {
    constructor(changes, loadService, validationService) {
        super();
        this.changes = changes;
        this.loadService = loadService;
        this.validationService = validationService;
    }
    set form(value) {
        // necessario para nao ocorrer o ExpressionChangedAfterItHasBeenCheckedError
        setTimeout(() => {
            this._form = value;
            this.emitForm();
        });
    }
    get form() {
        return this._form || {};
    }
    ngOnDestroy() {
        this.removeListeners();
    }
    ngOnInit() {
        if (this.load) {
            this.loadDataOnInitialize();
        }
    }
    /**
     * Função que atribui foco ao campo desejado.
     *
     * Para utilizá-la é necessário capturar a instância do `dynamic form`, como por exemplo:
     *
     * ``` html
     * <po-dynamic-form #dynamicForm [p-fields]="fields"></po-dynamic-form>
     * ```
     *
     * ``` javascript
     * import { PoDynamicFormComponent, PoDynamicFormField } from '@portinari/portinari-ui';
     *
     * ...
     *
     * @ViewChild('dynamicForm', { static: true }) dynamicForm: PoDynamicFormComponent;
     *
     * fields: Array<PoDynamicFormField> = [
     *   { property: 'fieldOne' },
     *   { property: 'fieldTwo' }
     * ];
     *
     * fieldFocus() {
     *   this.dynamicForm.focus('fieldTwo');
     * }
     * ```
     *
     * @param {string} property Nome da propriedade atribuída ao `PoDynamicFormField.property`.
     */
    focus(property) {
        this.fieldsComponent.focus(property);
    }
    validateForm(field) {
        const previousFocusElement = document.activeElement;
        this.disableForm(true);
        const errorOnValidation = () => this.disableForm(false);
        this.sendFormSubscription = this.validationService
            .sendFormChange(this.validate, field, this.value)
            .subscribe(this.applyFormValidation(previousFocusElement), errorOnValidation);
    }
    applyFormUpdatesOnLoad(previousFocusElement) {
        return dynamicFormData => {
            this.updateModelOnLoad(dynamicFormData);
            this.disableForm(false);
            this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    }
    applyFormValidation(previousFocusElement) {
        return dynamicFormData => {
            this.updateModelWithValidation(dynamicFormData);
            this.disableForm(false);
            this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    }
    disableForm(value) {
        this.disabledForm = value;
        this.changes.detectChanges();
    }
    emitForm() {
        if (!this.groupForm && this.formOutput.observers.length) {
            this.formOutput.emit(this.form);
        }
    }
    loadDataOnInitialize() {
        const previousFocusElement = document.activeElement;
        this.disabledForm = true;
        const errorOnLoad = () => this.disabledForm = false;
        this.onLoadSubscription = this.loadService
            .executeLoad(this.load, this.value)
            .subscribe(this.applyFormUpdatesOnLoad(previousFocusElement), errorOnLoad);
    }
    removeListeners() {
        if (this.onLoadSubscription) {
            this.onLoadSubscription.unsubscribe();
        }
        if (this.sendFormSubscription) {
            this.sendFormSubscription.unsubscribe();
        }
    }
    setFocusOnFieldByProperty(property, previousFocusElement) {
        if (property) {
            // precisa do timeout para que o valor seja atribuido no campo antes de setar o focus,
            // para nao disparar a mudança posteriormente. Situação ocorre quando retornar campo com valor e focus atribuido a ele.
            setTimeout(() => this.focus(property));
        }
        else {
            previousFocusElement['focus']();
        }
    }
    updateModelOnLoad(loadedFormData) {
        Object.assign(this.value, loadedFormData.value);
        this.fields = this.loadService.createAndUpdateFieldsForm(loadedFormData.fields, this.fields);
    }
    updateModelWithValidation(formData) {
        Object.assign(this.value, formData.value);
        this.fields = this.validationService.updateFieldsForm(formData.fields, this.fields);
    }
};
PoDynamicFormComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: PoDynamicFormLoadService },
    { type: PoDynamicFormValidationService }
];
tslib_1.__decorate([
    ViewChild('dynamicForm', { static: false }),
    tslib_1.__metadata("design:type", NgForm),
    tslib_1.__metadata("design:paramtypes", [NgForm])
], PoDynamicFormComponent.prototype, "form", null);
tslib_1.__decorate([
    ViewChild('fieldsComponent', { static: false }),
    tslib_1.__metadata("design:type", Object)
], PoDynamicFormComponent.prototype, "fieldsComponent", void 0);
PoDynamicFormComponent = tslib_1.__decorate([
    Component({
        selector: 'po-dynamic-form',
        template: "\r\n<ng-container *ngIf=\"groupForm; then reuseFormTemplate; else uniqueFormTemplate\"></ng-container>\r\n\r\n<ng-template #reuseFormTemplate>\r\n\r\n  <po-dynamic-form-fields #fieldsComponent\r\n    [p-auto-focus]=\"autoFocus\"\r\n    [p-fields]=\"fields\"\r\n    [p-value]=\"value\">\r\n  </po-dynamic-form-fields>\r\n\r\n</ng-template>\r\n\r\n<ng-template #uniqueFormTemplate>\r\n\r\n  <form #dynamicForm=\"ngForm\">\r\n\r\n    <po-dynamic-form-fields #fieldsComponent\r\n      [(p-fields)]=\"fields\"\r\n      [p-auto-focus]=\"autoFocus\"\r\n      [p-disabled-form]=\"disabledForm\"\r\n      [p-validate]=\"validate\"\r\n      [p-value]=\"value\"\r\n      (p-form-validate)=\"validateForm($event)\">\r\n    </po-dynamic-form-fields>\r\n\r\n  </form>\r\n\r\n</ng-template>\r\n"
    }),
    tslib_1.__metadata("design:paramtypes", [ChangeDetectorRef,
        PoDynamicFormLoadService,
        PoDynamicFormValidationService])
], PoDynamicFormComponent);
export { PoDynamicFormComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb3J0aW5hcmkvcG9ydGluYXJpLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZHluYW1pYy9wby1keW5hbWljLWZvcm0vcG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJeEMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHOUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0scURBQXFELENBQUM7QUFFL0YsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUVBQWlFLENBQUM7QUFFakg7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBTUgsSUFBYSxzQkFBc0IsR0FBbkMsTUFBYSxzQkFBdUIsU0FBUSwwQkFBMEI7SUF3QnBFLFlBQ1UsT0FBMEIsRUFDMUIsV0FBcUMsRUFDckMsaUJBQWlEO1FBQ3pELEtBQUssRUFBRSxDQUFDO1FBSEEsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDMUIsZ0JBQVcsR0FBWCxXQUFXLENBQTBCO1FBQ3JDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBZ0M7SUFFM0QsQ0FBQztJQXBCNEMsSUFBSSxJQUFJLENBQUMsS0FBYTtRQUNqRSw0RUFBNEU7UUFDNUUsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1lBRW5CLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLElBQUk7UUFDTixPQUFPLElBQUksQ0FBQyxLQUFL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QWlCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7OytEQUF3RDtBQXRCN0Ysc0JBQXNCO0lBSmxDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxpQkFBaUI7UUFDM0IsdXhCQUErQztLQUNoRCxDQUFDOzZDQTBCbUIsaUJBQWlCO1FBQ2Isd0JBQXdCO1FBQ2xCLDhCQUE4QjtHQTNCaEQsc0JBQXNCLENBd0psQztTQXhKWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENoYW5nZURldGVjdG9yUmVmLCBPbkRlc3Ryb3ksIE9uSW5pdCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuXHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUJhc2VDb21wb25lbnQgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1iYXNlLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1GaWVsZCB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLWZpZWxkLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1Mb2FkIH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tbG9hZC9wby1keW5hbWljLWZvcm0tbG9hZC5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtTG9hZFNlcnZpY2UgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1sb2FkL3BvLWR5bmFtaWMtZm9ybS1sb2FkLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvbiB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24uaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybVZhbGlkYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tdmFsaWRhdGlvbi9wby1keW5hbWljLWZvcm0tdmFsaWRhdGlvbi5zZXJ2aWNlJztcclxuXHJcbi8qKlxyXG4gKiBAZG9jc0V4dGVuZHMgUG9EeW5hbWljRm9ybUJhc2VDb21wb25lbnRcclxuICpcclxuICogQGV4YW1wbGVcclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLWR5bmFtaWMtZm9ybS1iYXNpY1wiIHRpdGxlPVwiUG9ydGluYXJpIER5bmFtaWMgRm9ybSBCYXNpY1wiPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tYmFzaWMvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLWR5bmFtaWMtZm9ybS1yZWdpc3RlclwiIHRpdGxlPVwiUG9ydGluYXJpIER5bmFtaWMgRm9ybSAtIFJlZ2lzdGVyXCI+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cclxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyL3NhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cclxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyL3NhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIuc2VydmljZS50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICovXHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3BvLWR5bmFtaWMtZm9ybScsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLWR5bmFtaWMtZm9ybS5jb21wb25lbnQuaHRtbCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFBvRHluYW1pY0Zvcm1Db21wb25lbnQgZXh0ZW5kcyBQb0R5bmFtaWNGb3JtQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuXHJcbiAgcHJpdmF0ZSBfZm9ybTogTmdGb3JtO1xyXG5cclxuICBkaXNhYmxlZEZvcm06IGJvb2xlYW47XHJcblxyXG4gIHByaXZhdGUgb25Mb2FkU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBzZW5kRm9ybVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICBAVmlld0NoaWxkKCdkeW5hbWljRm9ybScsIHsgc3RhdGljOiBmYWxzZSB9KSBzZXQgZm9ybSh2YWx1ZTogTmdGb3JtKSB7XHJcbiAgICAvLyBuZWNlc3NhcmlvIHBhcmEgbmFvIG9jb3JyZXIgbyBFeHByZXNzaW9uQ2hhbmdlZEFmdGVySXRIYXNCZWVuQ2hlY2tlZEVycm9yXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy5fZm9ybSA9IHZhbHVlO1xyXG5cclxuICAgICAgdGhpcy5lbWl0Rm9ybSgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXQgZm9ybSgpIHtcclxuICAgIHJldHVybiB0aGlzLl9mb3JtIHx8IDxhbnk+IHt9O1xyXG4gIH1cclxuXHJcbiAgQFZpZXdDaGlsZCgnZmllbGRzQ29tcG9uZW50JywgeyBzdGF0aWM6IGZhbHNlIH0pIGZpZWxkc0NvbXBvbmVudDogeyBmb2N1czogKHByb3BlcnR5OiBzdHJpbmcpID0+IHZvaWQgfTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNoYW5nZXM6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgcHJpdmF0ZSBsb2FkU2VydmljZTogUG9EeW5hbWljRm9ybUxvYWRTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0aW9uU2VydmljZTogUG9EeW5hbWljRm9ybVZhbGlkYXRpb25TZXJ2aWNlKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLnJlbW92ZUxpc3RlbmVycygpO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICBpZiAodGhpcy5sb2FkKSB7XHJcbiAgICAgIHRoaXMubG9hZERhdGFPbkluaXRpYWxpemUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZ1bsOnw6NvIHF1ZSBhdHJpYnVpIGZvY28gYW8gY2FtcG8gZGVzZWphZG8uXHJcbiAgICpcclxuICAgKiBQYXJhIHV0aWxpesOhLWxhIMOpIG5lY2Vzc8OhcmlvIGNhcHR1cmFyIGEgaW5zdMOibmNpYSBkbyBgZHluYW1pYyBmb3JtYCwgY29tbyBwb3IgZXhlbXBsbzpcclxuICAgKlxyXG4gICAqIGBgYCBodG1sXHJcbiAgICogPHBvLWR5bmFtaWMtZm9ybSAjZHluYW1pY0Zvcm0gW3AtZmllbGRzXT1cImZpZWxkc1wiPjwvcG8tZHluYW1pYy1mb3JtPlxyXG4gICAqIGBgYFxyXG4gICAqXHJcbiAgICogYGBgIGphdmFzY3JpcHRcclxuICAgKiBpbXBvcnQgeyBQb0R5bmFtaWNGb3JtQ29tcG9uZW50LCBQb0R5bmFtaWNGb3JtRmllbGQgfSBmcm9tICdAcG9ydGluYXJpL3BvcnRpbmFyaS11aSc7XHJcbiAgICpcclxuICAgKiAuLi5cclxuICAgKlxyXG4gICAqIEBWaWV3Q2hpbGQoJ2R5bmFtaWNGb3JtJywgeyBzdGF0aWM6IHRydWUgfSkgZHluYW1pY0Zvcm06IFBvRHluYW1pY0Zvcm1Db21wb25lbnQ7XHJcbiAgICpcclxuICAgKiBmaWVsZHM6IEFycmF5PFBvRHluYW1pY0Zvcm1GaWVsZD4gPSBbXHJcbiAgICogICB7IHByb3BlcnR5OiAnZmllbGRPbmUnIH0sXHJcbiAgICogICB7IHByb3BlcnR5OiAnZmllbGRUd28nIH1cclxuICAgKiBdO1xyXG4gICAqXHJcbiAgICogZmllbGRGb2N1cygpIHtcclxuICAgKiAgIHRoaXMuZHluYW1pY0Zvcm0uZm9jdXMoJ2ZpZWxkVHdvJyk7XHJcbiAgICogfVxyXG4gICAqIGBgYFxyXG4gICAqXHJcbiAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IE5vbWUgZGEgcHJvcHJpZWRhZGUgYXRyaWJ1w61kYSBhbyBgUG9EeW5hbWljRm9ybUZpZWxkLnByb3BlcnR5YC5cclxuICAgKi9cclxuICBmb2N1cyhwcm9wZXJ0eTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLmZpZWxkc0NvbXBvbmVudC5mb2N1cyhwcm9wZXJ0eSk7XHJcbiAgfVxyXG5cclxuICB2YWxpZGF0ZUZvcm0oZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCkge1xyXG4gICAgY29uc3QgcHJldmlvdXNGb2N1c0VsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50O1xyXG5cclxuICAgIHRoaXMuZGlzYWJsZUZvcm0odHJ1ZSk7XHJcbiAgICBjb25zdCBlcnJvck9uVmFsaWRhdGlvbiA9ICgpID0+IHRoaXMuZGlzYWJsZUZvcm0oZmFsc2UpO1xyXG5cclxuICAgIHRoaXMuc2VuZEZvcm1TdWJzY3JpcHRpb24gPSB0aGlzLnZhbGlkYXRpb25TZXJ2aWNlXHJcbiAgICAgIC5zZW5kRm9ybUNoYW5nZSh0aGlzLnZhbGlkYXRlLCBmaWVsZCwgdGhpcy52YWx1ZSlcclxuICAgICAgLnN1YnNjcmliZSh0aGlzLmFwcGx5Rm9ybVZhbGlkYXRpb24ocHJldmlvdXNGb2N1c0VsZW1lbnQpLCBlcnJvck9uVmFsaWRhdGlvbik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFwcGx5Rm9ybVVwZGF0ZXNPbkxvYWQocHJldmlvdXNGb2N1c0VsZW1lbnQ6IEVsZW1lbnQpOiAoZHluYW1pY0Zvcm1EYXRhOiBQb0R5bmFtaWNGb3JtTG9hZCkgPT4gdm9pZCB7XHJcbiAgICByZXR1cm4gZHluYW1pY0Zvcm1EYXRhID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVNb2RlbE9uTG9hZChkeW5hbWljRm9ybURhdGEpO1xyXG4gICAgICB0aGlzLmRpc2FibGVGb3JtKGZhbHNlKTtcclxuICAgICAgdGhpcy5zZXRGb2N1c09uRmllbGRCeVByb3BlcnR5KGR5bmFtaWNGb3JtRGF0YS5mb2N1cywgcHJldmlvdXNGb2N1c0VsZW1lbnQpO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXBwbHlGb3JtVmFsaWRhdGlvbihwcmV2aW91c0ZvY3VzRWxlbWVudDogRWxlbWVudCk6IChkeW5hbWljRm9ybURhdGE6IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uKSA9PiB2b2lkIHtcclxuICAgIHJldHVybiBkeW5hbWljRm9ybURhdGEgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZU1vZGVsV2l0aFZhbGlkYXRpb24oZHluYW1pY0Zvcm1EYXRhKTtcclxuICAgICAgdGhpcy5kaXNhYmxlRm9ybShmYWxzZSk7XHJcbiAgICAgIHRoaXMuc2V0Rm9jdXNPbkZpZWxkQnlQcm9wZXJ0eShkeW5hbWljRm9ybURhdGEuZm9jdXMsIHByZXZpb3VzRm9jdXNFbGVtZW50KTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRpc2FibGVGb3JtKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLmRpc2FibGVkRm9ybSA9IHZhbHVlO1xyXG4gICAgdGhpcy5jaGFuZ2VzLmRldGVjdENoYW5nZXMoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW1pdEZvcm0oKSB7XHJcbiAgICBpZiAoIXRoaXMuZ3JvdXBGb3JtICYmIHRoaXMuZm9ybU91dHB1dC5vYnNlcnZlcnMubGVuZ3RoKSB7XHJcbiAgICAgIHRoaXMuZm9ybU91dHB1dC5lbWl0KHRoaXMuZm9ybSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxvYWREYXRhT25Jbml0aWFsaXplKCkge1xyXG4gICAgY29uc3QgcHJldmlvdXNGb2N1c0VsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50O1xyXG5cclxuICAgIHRoaXMuZGlzYWJsZWRGb3JtID0gdHJ1ZTtcclxuICAgIGNvbnN0IGVycm9yT25Mb2FkID0gKCkgPT4gdGhpcy5kaXNhYmxlZEZvcm0gPSBmYWxzZTtcclxuXHJcbiAgICB0aGlzLm9uTG9hZFN1YnNjcmlwdGlvbiA9IHRoaXMubG9hZFNlcnZpY2VcclxuICAgICAgLmV4ZWN1dGVMb2FkKHRoaXMubG9hZCwgdGhpcy52YWx1ZSlcclxuICAgICAgLnN1YnNjcmliZSh0aGlzLmFwcGx5Rm9ybVVwZGF0ZXNPbkxvYWQocHJldmlvdXNGb2N1c0VsZW1lbnQpLCBlcnJvck9uTG9hZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlbW92ZUxpc3RlbmVycygpIHtcclxuICAgIGlmICh0aGlzLm9uTG9hZFN1YnNjcmlwdGlvbikge1xyXG4gICAgICB0aGlzLm9uTG9hZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnNlbmRGb3JtU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgIHRoaXMuc2VuZEZvcm1TdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0Rm9jdXNPbkZpZWxkQnlQcm9wZXJ0eShwcm9wZXJ0eTogc3RyaW5nLCBwcmV2aW91c0ZvY3VzRWxlbWVudDogRWxlbWVudCkge1xyXG4gICAgaWYgKHByb3BlcnR5KSB7XHJcbiAgICAgIC8vIHByZWNpc2EgZG8gdGltZW91dCBwYXJhIHF1ZSBvIHZhbG9yIHNlamEgYXRyaWJ1aWRvIG5vIGNhbXBvIGFudGVzIGRlIHNldGFyIG8gZm9jdXMsXHJcbiAgICAgIC8vIHBhcmEgbmFvIGRpc3BhcmFyIGEgbXVkYW7Dp2EgcG9zdGVyaW9ybWVudGUuIFNpdHVhw6fDo28gb2NvcnJlIHF1YW5kbyByZXRvcm5hciBjYW1wbyBjb20gdmFsb3IgZSBmb2N1cyBhdHJpYnVpZG8gYSBlbGUuXHJcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5mb2N1cyhwcm9wZXJ0eSkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcHJldmlvdXNGb2N1c0VsZW1lbnRbJ2ZvY3VzJ10oKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlTW9kZWxPbkxvYWQobG9hZGVkRm9ybURhdGE6IFBvRHluYW1pY0Zvcm1Mb2FkKSB7XHJcbiAgICBPYmplY3QuYXNzaWduKHRoaXMudmFsdWUsIGxvYWRlZEZvcm1EYXRhLnZhbHVlKTtcclxuICAgIHRoaXMuZmllbGRzID0gdGhpcy5sb2FkU2VydmljZS5jcmVhdGVBbmRVcGRhdGVGaWVsZHNGb3JtKGxvYWRlZEZvcm1EYXRhLmZpZWxkcywgdGhpcy5maWVsZHMpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVNb2RlbFdpdGhWYWxpZGF0aW9uKGZvcm1EYXRhOiBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvbikge1xyXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnZhbHVlLCBmb3JtRGF0YS52YWx1ZSk7XHJcbiAgICB0aGlzLmZpZWxkcyA9IHRoaXMudmFsaWRhdGlvblNlcnZpY2UudXBkYXRlRmllbGRzRm9ybShmb3JtRGF0YS5maWVsZHMsIHRoaXMuZmllbGRzKTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==