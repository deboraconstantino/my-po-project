import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Output, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { convertImageToBase64, isExternalLink, isIE } from '../../../../utils/util';
import { PoLanguageService } from './../../../../services/po-language/po-language.service';
import { PoModalComponent } from '../../../po-modal';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
import { PoRichTextModalType } from '../enums/po-rich-text-modal-type.enum';
import { PoUploadComponent } from '../../po-upload/po-upload.component';
const uploadRestrictions = ['.apng', '.bmp', '.gif', '.ico', '.jpeg', '.jpg', '.png', '.svg'];
let PoRichTextModalComponent = class PoRichTextModalComponent {
    constructor(languageService) {
        this.languageService = languageService;
        this.selection = document.getSelection();
        this.uploadRestrictions = {
            allowedExtensions: uploadRestrictions
        };
        this.literals = Object.assign({}, poRichTextLiteralsDefault[this.languageService.getShortLanguage()]);
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: () => {
                this.modal.close();
                this.command.emit();
                this.retrieveCursorPosition();
                this.cleanUpFields();
            }
        };
        this.modalConfirmAction = {
            label: this.literals.insert,
            disabled: false,
            action: () => this.insertElementRef()
        };
        this.modalLinkConfirmAction = {
            label: this.linkConfirmAction(),
            disabled: true,
            action: () => this.isLinkEditing ? this.toEditLink() : this.toInsertLink(this.urlLink, this.urlLinkText)
        };
        this.command = new EventEmitter();
        this.linkEditing = new EventEmitter();
    }
    get modalTitle() {
        if (this.modalType === 'image') {
            return this.literals.insertImage;
        }
        return this.linkConfirmAction();
    }
    get isUploadValid() {
        return !!(this.uploadModel && this.uploadModel.length);
    }
    get isUrlValid() {
        return !!this.urlImage && this.modalImageForm && this.modalImageForm.valid;
    }
    get modalPrimaryAction() {
        return this.modalType === 'image' ? this.modalConfirmAction : this.modalLinkConfirmAction;
    }
    convertToBase64() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (this.isUploadValid) {
                const uploadImage = this.uploadModel[0].rawFile;
                return yield convertImageToBase64(uploadImage);
            }
        });
    }
    linkConfirmAction() {
        return this.isLinkEditing ? this.literals.editLink : this.literals.insertLink;
    }
    emitCommand(value) {
        let command;
        if (value && this.modalType === PoRichTextModalType.Image) {
            command = 'insertImage';
            this.command.emit(({ command, value }));
        }
    }
    formModelValidate() {
        return this.modalLinkConfirmAction.disabled = this.modalLinkForm && this.modalLinkForm.invalid;
    }
    insertElementRef() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let uploadImage;
            if (this.modalType === PoRichTextModalType.Image && !this.urlImage) {
                uploadImage = yield this.convertToBase64();
            }
            this.retrieveCursorPosition();
            this.modal.close();
            if (this.isUrlValid || this.isUploadValid) {
                this.emitCommand(this.urlImage || uploadImage);
            }
            this.cleanUpFields();
        });
    }
    openModal(type) {
        this.modalType = type;
        this.saveCursorPosition();
        if (this.modalType === PoRichTextModalType.Link) {
            this.prepareModalForLink();
            this.modalLinkConfirmAction.label = this.linkConfirmAction();
        }
        this.modal.open();
    }
    selectedLink(event) {
        this.isSelectedLink = !!event;
        this.linkElement = event;
    }
    checkIfIsEmpty(urlLink, urlLinkText) {
        return urlLinkText === undefined || urlLinkText.trim() === '' ? urlLink : urlLinkText;
    }
    cleanUpFields() {
        this.urlImage = undefined;
        this.urlLink = undefined;
        this.urlLinkText = undefined;
        this.uploadModel = undefined;
        this.isLinkEditing = false;
        this.isSelectedLink = false;
        this.linkElement = undefined;
    }
    formReset(control) {
        control.markAsPristine();
        control.markAsUntouched();
        control.updateValueAndValidity();
    }
    prepareModalForLink() {
        this.saveSelectionText();
        if (this.modalLinkForm) {
            this.formReset(this.modalLinkForm.control);
        }
        setTimeout(() => { this.formModelValidate(); });
        if (this.isSelectedLink) {
            this.isLinkEditing = true;
            this.setLinkEditableForModal();
        }
        this.linkEditing.emit(this.isLinkEditing);
    }
    restoreSelection() {
        if (this.savedSelection) {
            if (this.selection) {
                this.selection.removeAllRanges();
                this.selection.addRange(this.savedSelection);
            }
            return true;
        }
        else {
            return false;
        }
    }
    retrieveCursorPosition() {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    }
    saveCursorPosition() {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    }
    saveSelectionText() {
        if (this.selection.anchorNode !== null) {
            this.savedSelection = this.selection.getRangeAt(0);
            this.urlLinkText = this.selection.toString();
        }
        else {
            return null;
        }
    }
    setLinkEditableForModal() {
        this.urlLinkText = this.linkElement.innerText;
        this.urlLink = this.linkElement.getAttribute('href');
    }
    toEditLink() {
        if (isIE()) {
            this.linkElement.parentNode.removeChild(this.linkElement);
        }
        else {
            this.linkElement.remove();
        }
        this.toInsertLink(this.urlLink, this.urlLinkText);
    }
    toInsertLink(urlLink, urlLinkText) {
        this.modal.close();
        this.restoreSelection();
        const urlLinkTextValue = this.checkIfIsEmpty(urlLink, urlLinkText);
        const urlAsExternalLink = isExternalLink(urlLink) ? urlLink : `http://${urlLink}`;
        const command = 'InsertHTML';
        const value = { urlLink: urlAsExternalLink, urlLinkText: urlLinkTextValue };
        this.command.emit({ command, value });
        this.cleanUpFields();
    }
};
PoRichTextModalComponent.ctorParameters = () => [
    { type: PoLanguageService }
];
tslib_1.__decorate([
    ViewChild('modal', { static: true }),
    tslib_1.__metadata("design:type", PoModalComponent)
], PoRichTextModalComponent.prototype, "modal", void 0);
tslib_1.__decorate([
    ViewChild('modalImageForm', { static: false }),
    tslib_1.__metadata("design:type", NgForm)
], PoRichTextModalComponent.prototype, "modalImageForm", void 0);
tslib_1.__decorate([
    ViewChild('upload', { static: true }),
    tslib_1.__metadata("design:type", PoUploadComponent)
], PoRichTextModalComponent.prototype, "upload", void 0);
tslib_1.__decorate([
    ViewChild('modalImage', { static: true }),
    tslib_1.__metadata("design:type", ElementRef)
], PoRichTextModalComponent.prototype, "modalImage", void 0);
tslib_1.__decorate([
    ViewChild('modalLink', { static: true }),
    tslib_1.__metadata("design:type", PoModalComponent)
], PoRichTextModalComponent.prototype, "modalLink", void 0);
tslib_1.__decorate([
    ViewChild('modalLinkForm', { static: false }),
    tslib_1.__metadata("design:type", NgForm)
], PoRichTextModalComponent.prototype, "modalLinkForm", void 0);
tslib_1.__decorate([
    Output('p-command'),
    tslib_1.__metadata("design:type", Object)
], PoRichTextModalComponent.prototype, "command", void 0);
tslib_1.__decorate([
    Output('p-link-editing'),
    tslib_1.__metadata("design:type", Object)
], PoRichTextModalComponent.prototype, "linkEditing", void 0);
PoRichTextModalComponent = tslib_1.__decorate([
    Component({
        selector: 'po-rich-text-modal',
        template: "<po-modal #modal\r\n  p-hide-close\r\n  [p-primary-action]=\"modalPrimaryAction\"\r\n  [p-secondary-action]=\"modalCancelAction\"\r\n  [p-title]=\"modalTitle\">\r\n\r\n  <ng-container *ngTemplateOutlet=\"modalType === 'image' ? modalImage : modalLink\"></ng-container>\r\n</po-modal>\r\n\r\n<ng-template #modalImage>\r\n  <form #modalImageForm=\"ngForm\">\r\n    <div class=\"po-row\">\r\n      <!-- po-upload desabilita o drag drop caso n\u00E3o tenha valor atribuido para a propriedade p-url -->\r\n      <po-upload #upload\r\n        class=\"po-md-12\"\r\n        name=\"upload\"\r\n        [(ngModel)]=\"uploadModel\"\r\n        p-drag-drop-height=\"160\"\r\n        p-hide-restrictions-info\r\n        p-hide-send-button\r\n        p-url=\"x\"\r\n        [p-drag-drop]=\"!modal.isHidden\"\r\n        [p-disabled]=\"isUrlValid\"\r\n        [p-restrictions]=\"uploadRestrictions\">\r\n      </po-upload>\r\n    </div>\r\n\r\n    <div class=\"po-row\">\r\n      <po-url\r\n        class=\"po-md-12 po-mt-3\"\r\n        name=\"url\"\r\n        [(ngModel)]=\"urlImage\"\r\n        [p-label]=\"literals.urlImage\"\r\n        [p-disabled]=\"isUploadValid\">\r\n      </po-url>\r\n    </div>\r\n  </form>\r\n</ng-template>\r\n\r\n<ng-template #modalLink>\r\n  <form #modalLinkForm=\"ngForm\">\r\n    <div class=\"po-row\">\r\n      <po-input class=\"po-md-12 po-mb-2\"\r\n        name=\"urlLinkText\"\r\n        [(ngModel)]=\"urlLinkText\"\r\n        p-optional\r\n        [p-label]=\"literals.linkTextLabel\"\r\n        [p-placeholder]=\"literals.linkTextLabel\">\r\n      </po-input>\r\n\r\n      <po-url class=\"po-md-12\"\r\n        name=\"urlLink\"\r\n        [(ngModel)]=\"urlLink\"\r\n        p-label=\"Link\"\r\n        p-required\r\n        [p-help]=\"literals.linkUrlTextHelper\"\r\n        [p-placeholder]=\"literals.linkUrlTextPlaceholder\"\r\n        (p-change-model)=\"formModelValidate()\">\r\n      </po-url>\r\n    </div>\r\n  </form>\r\n</ng-template>\r\n"
    }),
    tslib_1.__metadata("design:paramtypes", [PoLanguageService])
], PoRichTextModalComponent);
export { PoRichTextModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb3J0aW5hcmkvcG9ydGluYXJpLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tcmljaC10ZXh0L3BvLXJpY2gtdGV4dC1tb2RhbC9wby1yaWNoLXRleHQtbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RixPQUFPLEVBQW1CLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXpELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDcEYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0RBQXdELENBQUM7QUFFM0YsT0FBTyxFQUFpQixnQkFBZ0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQzVFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBR3hFLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFNOUYsSUFBYSx3QkFBd0IsR0FBckMsTUFBYSx3QkFBd0I7SUFnRm5DLFlBQW9CLGVBQWtDO1FBQWxDLG9CQUFlLEdBQWYsZUFBZSxDQUFtQjtRQTVFdEQsY0FBUyxHQUFHLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUVwQyx1QkFBa0IsR0FBNkI7WUFD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Qjs7QUFoQmhCO0lBQXJDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7c0NBQVEsZ0JBQWdCO3VEQUFDO0FBRWQ7SUFBL0MsU0FBUyxDQUFDLGdCQUFnQixFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO3NDQUFpQixNQUFNO2dFQUFDO0FBRWhDO0lBQXRDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7c0NBQVMsaUJBQWlCO3dEQUFDO0FBRXRCO0lBQTFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7c0NBQWEsVUFBVTs0REFBQztBQUV4QjtJQUF6QyxTQUFTLENBQUMsV0FBVyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO3NDQUFZLGdCQUFnQjsyREFBQztBQUV2QjtJQUE5QyxTQUFTLENBQUMsZUFBZSxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO3NDQUFnQixNQUFNOytEQUFDO0FBRWhEO0lBQXBCLE1BQU0sQ0FBQyxXQUFXLENBQUM7O3lEQUFpRjtBQUUzRTtJQUF6QixNQUFNLENBQUMsZ0JBQWdCLENBQUM7OzZEQUF1QztBQTlFckQsd0JBQXdCO0lBSnBDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxvQkFBb0I7UUFDOUIsODdEQUFrRDtLQUNuRCxDQUFDOzZDQWlGcUMsaUJBQWlCO0dBaEYzQyx3QkFBd0IsQ0E0T3BDO1NBNU9ZLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuXHJcbmltcG9ydCB7IGNvbnZlcnRJbWFnZVRvQmFzZTY0LCBpc0V4dGVybmFsTGluaywgaXNJRSB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xyXG5pbXBvcnQgeyBQb0xhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vLi4vLi4vLi4vLi4vc2VydmljZXMvcG8tbGFuZ3VhZ2UvcG8tbGFuZ3VhZ2Uuc2VydmljZSc7XHJcblxyXG5pbXBvcnQgeyBQb01vZGFsQWN0aW9uLCBQb01vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vLi4vcG8tbW9kYWwnO1xyXG5pbXBvcnQgeyBwb1JpY2hUZXh0TGl0ZXJhbHNEZWZhdWx0IH0gZnJvbSAnLi4vcG8tcmljaC10ZXh0LWxpdGVyYWxzJztcclxuaW1wb3J0IHsgUG9SaWNoVGV4dE1vZGFsVHlwZSB9IGZyb20gJy4uL2VudW1zL3BvLXJpY2gtdGV4dC1tb2RhbC10eXBlLmVudW0nO1xyXG5pbXBvcnQgeyBQb1VwbG9hZENvbXBvbmVudCB9IGZyb20gJy4uLy4uL3BvLXVwbG9hZC9wby11cGxvYWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgUG9VcGxvYWRGaWxlUmVzdHJpY3Rpb25zIH0gZnJvbSAnLi4vLi4vcG8tdXBsb2FkL2ludGVyZmFjZXMvcG8tdXBsb2FkLWZpbGUtcmVzdHJpY3Rpb24uaW50ZXJmYWNlJztcclxuXHJcbmNvbnN0IHVwbG9hZFJlc3RyaWN0aW9ucyA9IFsnLmFwbmcnLCAnLmJtcCcsICcuZ2lmJywgJy5pY28nLCAnLmpwZWcnLCAnLmpwZycsICcucG5nJywgJy5zdmcnXTtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncG8tcmljaC10ZXh0LW1vZGFsJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vcG8tcmljaC10ZXh0LW1vZGFsLmNvbXBvbmVudC5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUG9SaWNoVGV4dE1vZGFsQ29tcG9uZW50IHtcclxuXHJcbiAgbW9kYWxUeXBlOiBQb1JpY2hUZXh0TW9kYWxUeXBlO1xyXG4gIHNhdmVkQ3Vyc29yUG9zaXRpb247XHJcbiAgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgdXBsb2FkTW9kZWw6IEFycmF5PGFueT47XHJcbiAgdXBsb2FkUmVzdHJpY3Rpb25zOiBQb1VwbG9hZEZpbGVSZXN0cmljdGlvbnMgPSB7XHJcbiAgICBhbGxvd2VkRXh0ZW5zaW9uczogdXBsb2FkUmVzdHJpY3Rpb25zXHJcbiAgfTtcclxuICB1cmxJbWFnZTogc3RyaW5nO1xyXG4gIHVybExpbms6IHN0cmluZztcclxuICB1cmxMaW5rVGV4dDogc3RyaW5nO1xyXG5cclxuICBwcml2YXRlIGlzTGlua0VkaXRpbmc6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBpc1NlbGVjdGVkTGluazogYm9vbGVhbjtcclxuICBwcml2YXRlIGxpbmtFbGVtZW50OiBhbnk7XHJcbiAgcHJpdmF0ZSBzYXZlZFNlbGVjdGlvbjogUmFuZ2UgfCBudWxsO1xyXG5cclxuICByZWFkb25seSBsaXRlcmFscyA9IHtcclxuICAgIC4uLnBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHRbdGhpcy5sYW5ndWFnZVNlcnZpY2UuZ2V0U2hvcnRMYW5ndWFnZSgpXVxyXG4gIH07XHJcblxyXG4gIG1vZGFsQ2FuY2VsQWN0aW9uOiBQb01vZGFsQWN0aW9uID0ge1xyXG4gICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuY2FuY2VsLFxyXG4gICAgYWN0aW9uOiAoKSA9PiB7XHJcbiAgICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcclxuICAgICAgdGhpcy5jb21tYW5kLmVtaXQoKTtcclxuICAgICAgdGhpcy5yZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCk7XHJcbiAgICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIG1vZGFsQ29uZmlybUFjdGlvbjogUG9Nb2RhbEFjdGlvbiA9IHtcclxuICAgIGxhYmVsOiB0aGlzLmxpdGVyYWxzLmluc2VydCxcclxuICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgIGFjdGlvbjogKCkgPT4gdGhpcy5pbnNlcnRFbGVtZW50UmVmKClcclxuICB9O1xyXG5cclxuICBtb2RhbExpbmtDb25maXJtQWN0aW9uID0ge1xyXG4gICAgbGFiZWw6IHRoaXMubGlua0NvbmZpcm1BY3Rpb24oKSxcclxuICAgIGRpc2FibGVkOiB0cnVlLFxyXG4gICAgYWN0aW9uOiAoKSA9PiB0aGlzLmlzTGlua0VkaXRpbmcgPyB0aGlzLnRvRWRpdExpbmsoKSA6IHRoaXMudG9JbnNlcnRMaW5rKHRoaXMudXJsTGluaywgdGhpcy51cmxMaW5rVGV4dClcclxuICB9O1xyXG5cclxuICBnZXQgbW9kYWxUaXRsZSgpOiBzdHJpbmcge1xyXG4gICAgaWYgKHRoaXMubW9kYWxUeXBlID09PSAnaW1hZ2UnKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmxpdGVyYWxzLmluc2VydEltYWdlO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmxpbmtDb25maXJtQWN0aW9uKCk7XHJcbiAgfVxyXG5cclxuICBnZXQgaXNVcGxvYWRWYWxpZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAhISh0aGlzLnVwbG9hZE1vZGVsICYmIHRoaXMudXBsb2FkTW9kZWwubGVuZ3RoKTtcclxuICB9XHJcblxyXG4gIGdldCBpc1VybFZhbGlkKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICEhdGhpcy51cmxJbWFnZSAmJiB0aGlzLm1vZGFsSW1hZ2VGb3JtICYmIHRoaXMubW9kYWxJbWFnZUZvcm0udmFsaWQ7XHJcbiAgfVxyXG5cclxuICBnZXQgbW9kYWxQcmltYXJ5QWN0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubW9kYWxUeXBlID09PSAnaW1hZ2UnID8gdGhpcy5tb2RhbENvbmZpcm1BY3Rpb24gOiB0aGlzLm1vZGFsTGlua0NvbmZpcm1BY3Rpb247XHJcbiAgfVxyXG5cclxuICBAVmlld0NoaWxkKCdtb2RhbCcsIHsgc3RhdGljOiB0cnVlIH0pIG1vZGFsOiBQb01vZGFsQ29tcG9uZW50O1xyXG5cclxuICBAVmlld0NoaWxkKCdtb2RhbEltYWdlRm9ybScsIHsgc3RhdGljOiBmYWxzZSB9KSBtb2RhbEltYWdlRm9ybTogTmdGb3JtO1xyXG5cclxuICBAVmlld0NoaWxkKCd1cGxvYWQnLCB7IHN0YXRpYzogdHJ1ZSB9KSB1cGxvYWQ6IFBvVXBsb2FkQ29tcG9uZW50O1xyXG5cclxuICBAVmlld0NoaWxkKCdtb2RhbEltYWdlJywgeyBzdGF0aWM6IHRydWUgfSkgbW9kYWxJbWFnZTogRWxlbWVudFJlZjtcclxuXHJcbiAgQFZpZXdDaGlsZCgnbW9kYWxMaW5rJywgeyBzdGF0aWM6IHRydWUgfSkgbW9kYWxMaW5rOiBQb01vZGFsQ29tcG9uZW50O1xyXG5cclxuICBAVmlld0NoaWxkKCdtb2RhbExpbmtGb3JtJywgeyBzdGF0aWM6IGZhbHNlIH0pIG1vZGFsTGlua0Zvcm06IE5nRm9ybTtcclxuXHJcbiAgQE91dHB1dCgncC1jb21tYW5kJykgY29tbWFuZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nIHwgeyBjb21tYW5kOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBhbnkgfT4oKTtcclxuXHJcbiAgQE91dHB1dCgncC1saW5rLWVkaXRpbmcnKSBsaW5rRWRpdGluZyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2UpIHt9XHJcblxyXG4gIGFzeW5jIGNvbnZlcnRUb0Jhc2U2NCgpIHtcclxuICAgIGlmICh0aGlzLmlzVXBsb2FkVmFsaWQpIHtcclxuICAgICAgY29uc3QgdXBsb2FkSW1hZ2UgPSB0aGlzLnVwbG9hZE1vZGVsWzBdLnJhd0ZpbGU7XHJcbiAgICAgIHJldHVybiBhd2FpdCBjb252ZXJ0SW1hZ2VUb0Jhc2U2NCh1cGxvYWRJbWFnZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBsaW5rQ29uZmlybUFjdGlvbigpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuaXNMaW5rRWRpdGluZyA/IHRoaXMubGl0ZXJhbHMuZWRpdExpbmsgOiB0aGlzLmxpdGVyYWxzLmluc2VydExpbms7XHJcbiAgfVxyXG5cclxuICBlbWl0Q29tbWFuZCh2YWx1ZSkge1xyXG4gICAgbGV0IGNvbW1hbmQ6IHN0cmluZztcclxuICAgIGlmICh2YWx1ZSAmJiB0aGlzLm1vZGFsVHlwZSA9PT0gUG9SaWNoVGV4dE1vZGFsVHlwZS5JbWFnZSkge1xyXG4gICAgICBjb21tYW5kID0gJ2luc2VydEltYWdlJztcclxuICAgICAgdGhpcy5jb21tYW5kLmVtaXQoKHsgY29tbWFuZCwgdmFsdWUgfSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZm9ybU1vZGVsVmFsaWRhdGUoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5tb2RhbExpbmtDb25maXJtQWN0aW9uLmRpc2FibGVkID0gdGhpcy5tb2RhbExpbmtGb3JtICYmIHRoaXMubW9kYWxMaW5rRm9ybS5pbnZhbGlkO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgaW5zZXJ0RWxlbWVudFJlZigpIHtcclxuXHJcbiAgICBsZXQgdXBsb2FkSW1hZ2U6IHN0cmluZztcclxuXHJcbiAgICBpZiAodGhpcy5tb2RhbFR5cGUgPT09IFBvUmljaFRleHRNb2RhbFR5cGUuSW1hZ2UgJiYgIXRoaXMudXJsSW1hZ2UpIHtcclxuICAgICAgdXBsb2FkSW1hZ2UgPSBhd2FpdCB0aGlzLmNvbnZlcnRUb0Jhc2U2NCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmV0cmlldmVDdXJzb3JQb3NpdGlvbigpO1xyXG4gICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xyXG5cclxuICAgIGlmICh0aGlzLmlzVXJsVmFsaWQgfHwgdGhpcy5pc1VwbG9hZFZhbGlkKSB7XHJcbiAgICAgIHRoaXMuZW1pdENvbW1hbmQodGhpcy51cmxJbWFnZSB8fCB1cGxvYWRJbWFnZSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmNsZWFuVXBGaWVsZHMoKTtcclxuICB9XHJcblxyXG4gIG9wZW5Nb2RhbCh0eXBlOiBQb1JpY2hUZXh0TW9kYWxUeXBlKSB7XHJcbiAgICB0aGlzLm1vZGFsVHlwZSA9IHR5cGU7XHJcblxyXG4gICAgdGhpcy5zYXZlQ3Vyc29yUG9zaXRpb24oKTtcclxuXHJcbiAgICBpZiAodGhpcy5tb2RhbFR5cGUgPT09IFBvUmljaFRleHRNb2RhbFR5cGUuTGluaykge1xyXG4gICAgICB0aGlzLnByZXBhcmVNb2RhbEZvckxpbmsoKTtcclxuICAgICAgdGhpcy5tb2RhbExpbmtDb25maXJtQWN0aW9uLmxhYmVsID0gdGhpcy5saW5rQ29uZmlybUFjdGlvbigpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMubW9kYWwub3BlbigpO1xyXG4gIH1cclxuXHJcbiAgc2VsZWN0ZWRMaW5rKGV2ZW50KSB7XHJcbiAgICB0aGlzLmlzU2VsZWN0ZWRMaW5rID0gISFldmVudDtcclxuICAgIHRoaXMubGlua0VsZW1lbnQgPSBldmVudDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2hlY2tJZklzRW1wdHkodXJsTGluazogc3RyaW5nLCB1cmxMaW5rVGV4dDogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdXJsTGlua1RleHQgPT09IHVuZGVmaW5lZCB8fCB1cmxMaW5rVGV4dC50cmltKCkgPT09ICcnID8gdXJsTGluayA6IHVybExpbmtUZXh0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbGVhblVwRmllbGRzKCkge1xyXG4gICAgdGhpcy51cmxJbWFnZSA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMudXJsTGluayA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMudXJsTGlua1RleHQgPSB1bmRlZmluZWQ7XHJcbiAgICB0aGlzLnVwbG9hZE1vZGVsID0gdW5kZWZpbmVkO1xyXG4gICAgdGhpcy5pc0xpbmtFZGl0aW5nID0gZmFsc2U7XHJcbiAgICB0aGlzLmlzU2VsZWN0ZWRMaW5rID0gZmFsc2U7XHJcbiAgICB0aGlzLmxpbmtFbGVtZW50ID0gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBmb3JtUmVzZXQoY29udHJvbDogQWJzdHJhY3RDb250cm9sKSB7XHJcbiAgICBjb250cm9sLm1hcmtBc1ByaXN0aW5lKCk7XHJcbiAgICBjb250cm9sLm1hcmtBc1VudG91Y2hlZCgpO1xyXG4gICAgY29udHJvbC51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHByZXBhcmVNb2RhbEZvckxpbmsoKSB7XHJcbiAgICB0aGlzLnNhdmVTZWxlY3Rpb25UZXh0KCk7XHJcbiAgICBpZiAodGhpcy5tb2RhbExpbmtGb3JtKSB7XHJcbiAgICAgIHRoaXMuZm9ybVJlc2V0KHRoaXMubW9kYWxMaW5rRm9ybS5jb250cm9sKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5mb3JtTW9kZWxWYWxpZGF0ZSgpOyB9KTtcclxuXHJcbiAgICBpZiAodGhpcy5pc1NlbGVjdGVkTGluaykge1xyXG4gICAgICB0aGlzLmlzTGlua0VkaXRpbmcgPSB0cnVlO1xyXG4gICAgICB0aGlzLnNldExpbmtFZGl0YWJsZUZvck1vZGFsKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5saW5rRWRpdGluZy5lbWl0KHRoaXMuaXNMaW5rRWRpdGluZyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlc3RvcmVTZWxlY3Rpb24oKSB7XHJcbiAgICBpZiAodGhpcy5zYXZlZFNlbGVjdGlvbikge1xyXG4gICAgICBpZiAodGhpcy5zZWxlY3Rpb24pIHtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbi5hZGRSYW5nZSh0aGlzLnNhdmVkU2VsZWN0aW9uKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gIGVsc2Uge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJldHJpZXZlQ3Vyc29yUG9zaXRpb24oKSB7XHJcbiAgICB0aGlzLnNlbGVjdGlvbi5jb2xsYXBzZSh0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb25bMF0sIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvblsxXSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNhdmVDdXJzb3JQb3NpdGlvbigpIHtcclxuICAgIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvbiA9IFsgdGhpcy5zZWxlY3Rpb24uZm9jdXNOb2RlLCB0aGlzLnNlbGVjdGlvbi5mb2N1c09mZnNldCBdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzYXZlU2VsZWN0aW9uVGV4dCgpIHtcclxuICAgIGlmICh0aGlzLnNlbGVjdGlvbi5hbmNob3JOb2RlICE9PSBudWxsKSB7XHJcbiAgICAgIHRoaXMuc2F2ZWRTZWxlY3Rpb24gPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZUF0KDApO1xyXG4gICAgICB0aGlzLnVybExpbmtUZXh0ID0gdGhpcy5zZWxlY3Rpb24udG9TdHJpbmcoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRMaW5rRWRpdGFibGVGb3JNb2RhbCgpIHtcclxuICAgIHRoaXMudXJsTGlua1RleHQgPSB0aGlzLmxpbmtFbGVtZW50LmlubmVyVGV4dDtcclxuICAgIHRoaXMudXJsTGluayA9IHRoaXMubGlua0VsZW1lbnQuZ2V0QXR0cmlidXRlKCdocmVmJyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRvRWRpdExpbmsoKSB7XHJcbiAgICBpZiAoaXNJRSgpKSB7XHJcbiAgICAgIHRoaXMubGlua0VsZW1lbnQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLmxpbmtFbGVtZW50KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICB0aGlzLmxpbmtFbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMudG9JbnNlcnRMaW5rKHRoaXMudXJsTGluaywgdGhpcy51cmxMaW5rVGV4dCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRvSW5zZXJ0TGluayh1cmxMaW5rLCB1cmxMaW5rVGV4dCkge1xyXG4gICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xyXG4gICAgdGhpcy5yZXN0b3JlU2VsZWN0aW9uKCk7XHJcblxyXG4gICAgY29uc3QgdXJsTGlua1RleHRWYWx1ZSA9IHRoaXMuY2hlY2tJZklzRW1wdHkodXJsTGluaywgdXJsTGlua1RleHQpO1xyXG4gICAgY29uc3QgdXJsQXNFeHRlcm5hbExpbmsgPSBpc0V4dGVybmFsTGluayh1cmxMaW5rKSA/IHVybExpbmsgOiBgaHR0cDovLyR7dXJsTGlua31gO1xyXG5cclxuICAgIGNvbnN0IGNvbW1hbmQ6IHN0cmluZyA9ICdJbnNlcnRIVE1MJztcclxuXHJcbiAgICBjb25zdCB2YWx1ZSA9IHsgdXJsTGluazogdXJsQXNFeHRlcm5hbExpbmssIHVybExpbmtUZXh0OiB1cmxMaW5rVGV4dFZhbHVlIH07XHJcblxyXG4gICAgdGhpcy5jb21tYW5kLmVtaXQoeyBjb21tYW5kLCB2YWx1ZSB9KTtcclxuXHJcbiAgICB0aGlzLmNsZWFuVXBGaWVsZHMoKTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==