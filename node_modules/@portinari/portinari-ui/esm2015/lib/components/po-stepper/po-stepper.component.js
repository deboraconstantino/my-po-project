import * as tslib_1 from "tslib";
import { AfterContentInit, ChangeDetectorRef, Component, ContentChildren, QueryList } from '@angular/core';
import { Observable, of } from 'rxjs';
import { map, switchMap, take } from 'rxjs/operators';
import { PoStepperStatus } from './enums/po-stepper-status.enum';
import { PoStepComponent } from './po-step/po-step.component';
import { PoStepperBaseComponent } from './po-stepper-base.component';
/**
 * @docsExtends PoStepperBaseComponent
 *
 * @example
 *
 * <example name="po-stepper-basic" title="Portinari Stepper Basic">
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.html"> </file>
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-labs" title="Portinari Stepper Labs">
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.html"> </file>
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-sales" title="Portinari Stepper - Sales">
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.html"> </file>
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.ts"> </file>
 * </example>
 */
let PoStepperComponent = class PoStepperComponent extends PoStepperBaseComponent {
    constructor(changeDetector) {
        super();
        this.changeDetector = changeDetector;
    }
    get currentStepIndex() {
        return this.step - 1;
    }
    get stepList() {
        return this.usePoSteps && this.poSteps || this.steps;
    }
    get usePoSteps() {
        return !!this.poSteps.length;
    }
    ngAfterContentInit() {
        this.activeFirstStep();
        this.poSteps.changes.subscribe(() => {
            this.controlStepsStatus(0, this.poSteps.first);
        });
    }
    /**
     * Altera o status do *step* para ativo.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     *
     * @param {number} index Índice do `po-step` que se deseja ativar.
     */
    active(index) {
        if (!this.usePoSteps) {
            return;
        }
        const stepsArray = this.getPoSteps();
        const step = stepsArray[index];
        const isDisabledStep = step.status === PoStepperStatus.Disabled;
        const isErrorStep = step.status === PoStepperStatus.Error;
        if (!isDisabledStep || isErrorStep) {
            this.changeStep(index, step);
        }
    }
    /**
     * Ativa o primeiro *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    first() {
        if (!this.usePoSteps) {
            return;
        }
        const firstStep = this.poSteps.first;
        const firstStepIndex = 0;
        this.changeStep(firstStepIndex, firstStep);
    }
    /**
     * Ativa o próximo *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    next() {
        if (!this.usePoSteps) {
            return;
        }
        const { steps, stepIndex } = this.getStepsAndIndex(this.currentActiveStep);
        const nextIndex = stepIndex + 1;
        const nextStep = steps[nextIndex];
        this.changeStep(nextIndex, nextStep);
    }
    /**
     * Ativa o *step* anterior.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    previous() {
        if (!this.usePoSteps) {
            return;
        }
        const { steps, stepIndex } = this.getStepsAndIndex(this.currentActiveStep);
        const previousIndex = stepIndex - 1;
        const previousStep = steps[previousIndex];
        this.changeStep(previousIndex, previousStep);
    }
    changeStep(stepIndex, step) {
        const isDifferentStep = (!this.currentActiveStep || step.id !== this.currentActiveStep.id);
        this.allowNextStep(stepIndex).pipe(take(1)).subscribe(nextStepAllowed => {
            if (nextStepAllowed) {
                if (this.usePoSteps && isDifferentStep) {
                    this.controlStepsStatus(stepIndex, step);
                    this.onChangeStep.emit(step);
                }
                else if (!this.usePoSteps && stepIndex !== this.currentStepIndex) {
                    // if para tratamento do modelo antigo do po-stepper
                    this.onChangeStep.emit(stepIndex + 1);
                }
            }
        });
    }
    onStepActive(step) {
        this.currentActiveStep = step;
        this.previousActiveStep = this.poSteps.find(stepChild => stepChild.status === PoStepperStatus.Active && stepChild.id !== step.id);
        this.setPreviousStepAsDone();
    }
    trackByFn(step) {
        return step.id;
    }
    activeFirstStep() {
        const hasStepActive = this.poSteps.some(poStep => poStep.status === PoStepperStatus.Active);
        if (this.usePoSteps && !hasStepActive) {
            this.changeStep(0, this.poSteps.first);
        }
    }
    allowNextStep(nextStepIndex) {
        if (!this.sequential) {
            return of(true);
        }
        if (this.usePoSteps) {
            return of(this.isBeforeStep(nextStepIndex))
                .pipe(switchMap(result => {
                if (result) {
                    return of(result);
                }
                else {
                    return this.canActiveNextStep(this.currentActiveStep);
                }
            }));
        }
        return of(this.steps.slice(this.step, nextStepIndex).every(step => step.status === PoStepperStatus.Done));
    }
    canActiveNextStep(currentActiveStep = {}) {
        if (!currentActiveStep.canActiveNextStep) {
            return of(true);
        }
        const canActiveNextStep = currentActiveStep.canActiveNextStep(currentActiveStep);
        if (typeof canActiveNextStep === 'boolean') {
            currentActiveStep.status = this.getStepperStatusByCanActive(canActiveNextStep);
            return of(canActiveNextStep);
        }
        else if (canActiveNextStep instanceof Observable) {
            return canActiveNextStep.pipe(map(result => {
                currentActiveStep.status = this.getStepperStatusByCanActive(result);
                return result;
            }));
        }
        else {
            throw new Error(`Expected step ${currentActiveStep.label} canActiveNextStep function to return either a boolean or Observable`);
        }
    }
    controlStepsStatus(stepIndex, step) {
        if (this.usePoSteps) {
            this.setStepAsActive(step);
            this.setNextStepAsDefault(step);
            if (this.isBeforeStep(stepIndex)) {
                this.setFinalSteppersAsDisabled(stepIndex);
            }
            this.changeDetector.detectChanges();
        }
    }
    getStepperStatusByCanActive(canActiveNextStep) {
        return canActiveNextStep ? PoStepperStatus.Done : PoStepperStatus.Error;
    }
    getStepsAndIndex(step = {}) {
        const steps = this.getPoSteps();
        const stepIndex = steps.findIndex(poStep => poStep.id === step.id);
        return { steps, stepIndex };
    }
    getPoSteps() {
        return this.poSteps.toArray();
    }
    isBeforeStep(stepIndex) {
        const currentActiveStepIndex = () => this.getPoSteps().findIndex(step => step.id === this.currentActiveStep.id);
        return !!this.currentActiveStep && currentActiveStepIndex() >= stepIndex;
    }
    setFinalSteppersAsDisabled(stepIndex) {
        this.getPoSteps()
            .filter((step, index) => step && index >= stepIndex + 2)
            .forEach(step => step.status = PoStepperStatus.Disabled);
    }
    setStepAsActive(step) {
        step.status = PoStepperStatus.Active;
    }
    setNextStepAsDefault(currentStep) {
        const { steps, stepIndex } = this.getStepsAndIndex(currentStep);
        const nextIndex = stepIndex + 1;
        if (nextIndex < this.poSteps.length) {
            steps[nextIndex].status = PoStepperStatus.Default;
        }
    }
    setPreviousStepAsDone() {
        if (this.previousActiveStep) {
            this.previousActiveStep.status = PoStepperStatus.Done;
        }
    }
};
PoStepperComponent.ctorParameters = () => [
    { type: ChangeDetectorRef }
];
tslib_1.__decorate([
    ContentChildren(PoStepComponent),
    tslib_1.__metadata("design:type", QueryList)
], PoStepperComponent.prototype, "poSteps", void 0);
PoStepperComponent = tslib_1.__decorate([
    Component({
        selector: 'po-stepper',
        template: "<div class=\"po-stepper po-stepper-{{ orientation }}\">\n\n  <div class=\"po-stepper-container\">\n    <po-stepper-step *ngFor=\"let step of stepList; let index = index; trackBy: trackByFn\"\n      class=\"po-stepper-step-position\"\n      [p-circle-content]=\"index+1\"\n      [p-label]=\"step.label\"\n      [p-orientation]=\"orientation\"\n      [p-status]=\"step.status\"\n      [p-step-icons]=\"stepIcons\"\n      [p-step-size]=\"stepSize\"\n      (p-activated)=\"onStepActive(step)\"\n      (p-click)=\"changeStep(index, step)\"\n      (p-enter)=\"changeStep(index, step)\">\n    </po-stepper-step>\n  </div>\n\n  <div *ngIf=\"usePoSteps\" class=\"po-stepper-content\">\n    <ng-content></ng-content>\n  </div>\n\n</div>\n"
    }),
    tslib_1.__metadata("design:paramtypes", [ChangeDetectorRef])
], PoStepperComponent);
export { PoStepperComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tc3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3BvLXN0ZXBwZXIvcG8tc3RlcHBlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRyxPQUFPLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDakUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzlELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBR3JFOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBbUJHO0FBS0gsSUFBYSxrQkFBa0IsR0FBL0IsTUFBYSxrQkFBbUIsU0FBUSxzQkFBc0I7SUFtQjVELFlBQW9CLGNBQWlDO1FBQ25ELEtBQUssRUFBRSxDQUFDO1FBRFUsbUJBQWMsR0FBZCxjQUFjLENBQW1CO0lBRXJELENBQUM7SUFkRCxJQUFJLGdCQUFnQjtRQUNsQixPQUFPLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxJQUFJLFVBQVU7UUFDWixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUMvQixD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UUFDM0IsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDM0IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDO1NBQ3ZEO0lBQ0gsQ0FBQztDQUNGLENBQUE7O1lBM05xQyxpQkFBaUI7O0FBakJuQjtJQUFqQyxlQUFlLENBQUMsZUFBZSxDQUFDO3NDQUFVLFNBQVM7bURBQWtCO0FBRjNELGtCQUFrQjtJQUo5QixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsWUFBWTtRQUN0QixvdUJBQTBDO0tBQzNDLENBQUM7NkNBb0JvQyxpQkFBaUI7R0FuQjFDLGtCQUFrQixDQThPOUI7U0E5T1ksa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJDb250ZW50SW5pdCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgQ29udGVudENoaWxkcmVuLCBRdWVyeUxpc3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgUG9TdGVwcGVyU3RhdHVzIH0gZnJvbSAnLi9lbnVtcy9wby1zdGVwcGVyLXN0YXR1cy5lbnVtJztcbmltcG9ydCB7IFBvU3RlcENvbXBvbmVudCB9IGZyb20gJy4vcG8tc3RlcC9wby1zdGVwLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb1N0ZXBwZXJCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1zdGVwcGVyLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IFBvU3RlcHBlckl0ZW0gfSBmcm9tICcuL3BvLXN0ZXBwZXItaXRlbS5pbnRlcmZhY2UnO1xuXG4vKipcbiAqIEBkb2NzRXh0ZW5kcyBQb1N0ZXBwZXJCYXNlQ29tcG9uZW50XG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tc3RlcHBlci1iYXNpY1wiIHRpdGxlPVwiUG9ydGluYXJpIFN0ZXBwZXIgQmFzaWNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMvc2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc3RlcHBlci1iYXNpYy9zYW1wbGUtcG8tc3RlcHBlci1iYXNpYy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zdGVwcGVyLWxhYnNcIiB0aXRsZT1cIlBvcnRpbmFyaSBTdGVwcGVyIExhYnNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItbGFicy9zYW1wbGUtcG8tc3RlcHBlci1sYWJzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItbGFicy9zYW1wbGUtcG8tc3RlcHBlci1sYWJzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLXN0ZXBwZXItc2FsZXNcIiB0aXRsZT1cIlBvcnRpbmFyaSBTdGVwcGVyIC0gU2FsZXNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItc2FsZXMvc2FtcGxlLXBvLXN0ZXBwZXItc2FsZXMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc3RlcHBlci1zYWxlcy9zYW1wbGUtcG8tc3RlcHBlci1zYWxlcy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwby1zdGVwcGVyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLXN0ZXBwZXIuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvU3RlcHBlckNvbXBvbmVudCBleHRlbmRzIFBvU3RlcHBlckJhc2VDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlckNvbnRlbnRJbml0IHtcblxuICBAQ29udGVudENoaWxkcmVuKFBvU3RlcENvbXBvbmVudCkgcG9TdGVwczogUXVlcnlMaXN0PFBvU3RlcENvbXBvbmVudD47XG5cbiAgcHJpdmF0ZSBjdXJyZW50QWN0aXZlU3RlcDogUG9TdGVwQ29tcG9uZW50O1xuICBwcml2YXRlIHByZXZpb3VzQWN0aXZlU3RlcDogUG9TdGVwQ29tcG9uZW50O1xuXG4gIGdldCBjdXJyZW50U3RlcEluZGV4KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuc3RlcCAtIDE7XG4gIH1cblxuICBnZXQgc3RlcExpc3QoKTogUXVlcnlMaXN0PFBvU3RlcENvbXBvbmVudD4gfCBBcnJheTxQb1N0ZXBwZXJJdGVtPiB7XG4gICAgcmV0dXJuIHRoaXMudXNlUG9TdGVwcyAmJiB0aGlzLnBvU3RlcHMgfHwgdGhpcy5zdGVwcztcbiAgfVxuXG4gIGdldCB1c2VQb1N0ZXBzKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMucG9TdGVwcy5sZW5ndGg7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZikge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKSB7XG4gICAgdGhpcy5hY3RpdmVGaXJzdFN0ZXAoKTtcblxuICAgIHRoaXMucG9TdGVwcy5jaGFuZ2VzLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLmNvbnRyb2xTdGVwc1N0YXR1cygwLCB0aGlzLnBvU3RlcHMuZmlyc3QpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsdGVyYSBvIHN0YXR1cyBkbyAqc3RlcCogcGFyYSBhdGl2by5cbiAgICpcbiAgICogPiBFc3RlIG3DqXRvZG8gw6kgdmFsaWRvIGFwZW5hcyBwYXJhIGFzIGltcGxlbWVudGHDp8O1ZXMgcXVlIHV0aWxpemFtIG8gY29tcG9uZW50ZSBbKipwby1zdGVwKipdKC9kb2N1bWVudGF0aW9uL3BvLXN0ZXApLlxuICAgKlxuICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggw41uZGljZSBkbyBgcG8tc3RlcGAgcXVlIHNlIGRlc2VqYSBhdGl2YXIuXG4gICAqL1xuICBhY3RpdmUoaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICghdGhpcy51c2VQb1N0ZXBzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgc3RlcHNBcnJheSA9IHRoaXMuZ2V0UG9TdGVwcygpO1xuICAgIGNvbnN0IHN0ZXAgPSBzdGVwc0FycmF5W2luZGV4XTtcbiAgICBjb25zdCBpc0Rpc2FibGVkU3RlcCA9IHN0ZXAuc3RhdHVzID09PSBQb1N0ZXBwZXJTdGF0dXMuRGlzYWJsZWQ7XG4gICAgY29uc3QgaXNFcnJvclN0ZXAgPSBzdGVwLnN0YXR1cyA9PT0gUG9TdGVwcGVyU3RhdHVzLkVycm9yO1xuXG4gICAgaWYgKCFpc0Rpc2FibGVkU3RlcCB8fCBpc0Vycm9yU3RlcCkge1xuICAgICAgdGhpcy5jaGFuZ2VTdGVwKGluZGV4LCBzdGVwKTtcbiAgICB9XG5cbiAgfVxuXG4gIC8qKlxuICAgKiBBdGl2YSBvIHByaW1laXJvICpzdGVwKi5cbiAgICpcbiAgICogPiBFc3RlIG3DqXRvZG8gw6kgdmFsaWRvIGFwZW5hcyBwYXJhIGFzIGltcGxlbWVudGHDp8O1ZXMgcXVlIHV0aWxpemFtIG8gY29tcG9uZW50ZSBbKipwby1zdGVwKipdKC9kb2N1bWVudGF0aW9uL3BvLXN0ZXApLlxuICAgKi9cbiAgZmlyc3QoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnVzZVBvU3RlcHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBmaXJzdFN0ZXAgPSB0aGlzLnBvU3RlcHMuZmlyc3Q7XG4gICAgY29uc3QgZmlyc3RTdGVwSW5kZXggPSAwO1xuXG4gICAgdGhpcy5jaGFuZ2VTdGVwKGZpcnN0U3RlcEluZGV4LCBmaXJzdFN0ZXApO1xuICB9XG5cbiAgLyoqXG4gICAqIEF0aXZhIG8gcHLDs3hpbW8gKnN0ZXAqLlxuICAgKlxuICAgKiA+IEVzdGUgbcOpdG9kbyDDqSB2YWxpZG8gYXBlbmFzIHBhcmEgYXMgaW1wbGVtZW50YcOnw7VlcyBxdWUgdXRpbGl6YW0gbyBjb21wb25lbnRlIFsqKnBvLXN0ZXAqKl0oL2RvY3VtZW50YXRpb24vcG8tc3RlcCkuXG4gICAqL1xuICBuZXh0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy51c2VQb1N0ZXBzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBzdGVwcywgc3RlcEluZGV4IH0gPSB0aGlzLmdldFN0ZXBzQW5kSW5kZXgodGhpcy5jdXJyZW50QWN0aXZlU3RlcCk7XG4gICAgY29uc3QgbmV4dEluZGV4ID0gc3RlcEluZGV4ICsgMTtcbiAgICBjb25zdCBuZXh0U3RlcCA9IHN0ZXBzW25leHRJbmRleF07XG5cbiAgICB0aGlzLmNoYW5nZVN0ZXAobmV4dEluZGV4LCBuZXh0U3RlcCk7XG4gIH1cblxuICAvKipcbiAgICogQXRpdmEgbyAqc3RlcCogYW50ZXJpb3IuXG4gICAqXG4gICAqID4gRXN0ZSBtw6l0b2RvIMOpIHZhbGlkbyBhcGVuYXMgcGFyYSBhcyBpbXBsZW1lbnRhw6fDtWVzIHF1ZSB1dGlsaXphbSBvIGNvbXBvbmVudGUgWyoqcG8tc3RlcCoqXSgvZG9jdW1lbnRhdGlvbi9wby1zdGVwKS5cbiAgICovXG4gIHByZXZpb3VzKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy51c2VQb1N0ZXBzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBzdGVwcywgc3RlcEluZGV4IH0gPSB0aGlzLmdldFN0ZXBzQW5kSW5kZXgodGhpcy5jdXJyZW50QWN0aXZlU3RlcCk7XG4gICAgY29uc3QgcHJldmlvdXNJbmRleCA9IHN0ZXBJbmRleCAtIDE7XG4gICAgY29uc3QgcHJldmlvdXNTdGVwID0gc3RlcHNbcHJldmlvdXNJbmRleF07XG5cbiAgICB0aGlzLmNoYW5nZVN0ZXAocHJldmlvdXNJbmRleCwgcHJldmlvdXNTdGVwKTtcbiAgfVxuXG4gIGNoYW5nZVN0ZXAoc3RlcEluZGV4OiBudW1iZXIsIHN0ZXA/OiBQb1N0ZXBDb21wb25lbnQpOiB2b2lkIHtcbiAgICBjb25zdCBpc0RpZmZlcmVudFN0ZXAgPSAoIXRoaXMuY3VycmVudEFjdGl2ZVN0ZXAgfHwgc3RlcC5pZCAhPT0gdGhpcy5jdXJyZW50QWN0aXZlU3RlcC5pZCk7XG4gICAgdGhpcy5hbGxvd05leHRTdGVwKHN0ZXBJbmRleCkucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUobmV4dFN0ZXBBbGxvd2VkID0+IHtcbiAgICAgIGlmIChuZXh0U3RlcEFsbG93ZWQpIHtcbiAgICAgICAgaWYgKHRoaXMudXNlUG9TdGVwcyAmJiBpc0RpZmZlcmVudFN0ZXApIHtcbiAgICAgICAgICB0aGlzLmNvbnRyb2xTdGVwc1N0YXR1cyhzdGVwSW5kZXgsIHN0ZXApO1xuICAgICAgICAgIHRoaXMub25DaGFuZ2VTdGVwLmVtaXQoc3RlcCk7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMudXNlUG9TdGVwcyAmJiBzdGVwSW5kZXggIT09IHRoaXMuY3VycmVudFN0ZXBJbmRleCApIHtcbiAgICAgICAgICAvLyBpZiBwYXJhIHRyYXRhbWVudG8gZG8gbW9kZWxvIGFudGlnbyBkbyBwby1zdGVwcGVyXG4gICAgICAgICAgdGhpcy5vbkNoYW5nZVN0ZXAuZW1pdChzdGVwSW5kZXggKyAxKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgb25TdGVwQWN0aXZlKHN0ZXA6IFBvU3RlcENvbXBvbmVudCkge1xuICAgIHRoaXMuY3VycmVudEFjdGl2ZVN0ZXAgPSBzdGVwO1xuXG4gICAgdGhpcy5wcmV2aW91c0FjdGl2ZVN0ZXAgPSB0aGlzLnBvU3RlcHMuZmluZChzdGVwQ2hpbGQgPT4gc3RlcENoaWxkLnN0YXR1cyA9PT0gUG9TdGVwcGVyU3RhdHVzLkFjdGl2ZSAmJiBzdGVwQ2hpbGQuaWQgIT09IHN0ZXAuaWQpO1xuXG4gICAgdGhpcy5zZXRQcmV2aW91c1N0ZXBBc0RvbmUoKTtcbiAgfVxuXG4gIHRyYWNrQnlGbihzdGVwOiBQb1N0ZXBDb21wb25lbnQpIHtcbiAgICByZXR1cm4gc3RlcC5pZDtcbiAgfVxuXG4gIHByaXZhdGUgYWN0aXZlRmlyc3RTdGVwKCkge1xuICAgIGNvbnN0IGhhc1N0ZXBBY3RpdmUgPSB0aGlzLnBvU3RlcHMuc29tZShwb1N0ZXAgPT4gcG9TdGVwLnN0YXR1cyA9PT0gUG9TdGVwcGVyU3RhdHVzLkFjdGl2ZSk7XG5cbiAgICBpZiAodGhpcy51c2VQb1N0ZXBzICYmICFoYXNTdGVwQWN0aXZlKSB7XG4gICAgICB0aGlzLmNoYW5nZVN0ZXAoMCwgdGhpcy5wb1N0ZXBzLmZpcnN0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFsbG93TmV4dFN0ZXAobmV4dFN0ZXBJbmRleDogbnVtYmVyKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgaWYgKCF0aGlzLnNlcXVlbnRpYWwpIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy51c2VQb1N0ZXBzKSB7XG4gICAgICByZXR1cm4gb2YodGhpcy5pc0JlZm9yZVN0ZXAobmV4dFN0ZXBJbmRleCkpXG4gICAgICAucGlwZShzd2l0Y2hNYXAocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiBvZihyZXN1bHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB0aGlzLmNhbkFjdGl2ZU5leHRTdGVwKHRoaXMuY3VycmVudEFjdGl2ZVN0ZXApO1xuICAgICAgICB9XG4gICAgICB9KSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9mKHRoaXMuc3RlcHMuc2xpY2UodGhpcy5zdGVwLCBuZXh0U3RlcEluZGV4KS5ldmVyeShzdGVwID0+IHN0ZXAuc3RhdHVzID09PSBQb1N0ZXBwZXJTdGF0dXMuRG9uZSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5BY3RpdmVOZXh0U3RlcChjdXJyZW50QWN0aXZlU3RlcCA9IDxQb1N0ZXBDb21wb25lbnQ+e30pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBpZiAoIWN1cnJlbnRBY3RpdmVTdGVwLmNhbkFjdGl2ZU5leHRTdGVwKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuXG4gICAgY29uc3QgY2FuQWN0aXZlTmV4dFN0ZXAgPSBjdXJyZW50QWN0aXZlU3RlcC5jYW5BY3RpdmVOZXh0U3RlcChjdXJyZW50QWN0aXZlU3RlcCk7XG5cbiAgICBpZiAodHlwZW9mIGNhbkFjdGl2ZU5leHRTdGVwID09PSAnYm9vbGVhbicpIHtcbiAgICAgIGN1cnJlbnRBY3RpdmVTdGVwLnN0YXR1cyA9IHRoaXMuZ2V0U3RlcHBlclN0YXR1c0J5Q2FuQWN0aXZlKGNhbkFjdGl2ZU5leHRTdGVwKTtcbiAgICAgIHJldHVybiBvZihjYW5BY3RpdmVOZXh0U3RlcCk7XG4gICAgfSBlbHNlIGlmIChjYW5BY3RpdmVOZXh0U3RlcCBpbnN0YW5jZW9mIE9ic2VydmFibGUpIHtcbiAgICAgIHJldHVybiBjYW5BY3RpdmVOZXh0U3RlcC5waXBlKG1hcChyZXN1bHQgPT4ge1xuICAgICAgICBjdXJyZW50QWN0aXZlU3RlcC5zdGF0dXMgPSB0aGlzLmdldFN0ZXBwZXJTdGF0dXNCeUNhbkFjdGl2ZShyZXN1bHQpO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHN0ZXAgJHtjdXJyZW50QWN0aXZlU3RlcC5sYWJlbH0gY2FuQWN0aXZlTmV4dFN0ZXAgZnVuY3Rpb24gdG8gcmV0dXJuIGVpdGhlciBhIGJvb2xlYW4gb3IgT2JzZXJ2YWJsZWApO1xuICAgIH1cblxuICB9XG5cbiAgcHJpdmF0ZSBjb250cm9sU3RlcHNTdGF0dXMoc3RlcEluZGV4OiBudW1iZXIsIHN0ZXA6IFBvU3RlcENvbXBvbmVudCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnVzZVBvU3RlcHMpIHtcblxuICAgICAgdGhpcy5zZXRTdGVwQXNBY3RpdmUoc3RlcCk7XG4gICAgICB0aGlzLnNldE5leHRTdGVwQXNEZWZhdWx0KHN0ZXApO1xuXG4gICAgICBpZiAodGhpcy5pc0JlZm9yZVN0ZXAoc3RlcEluZGV4KSkge1xuICAgICAgICB0aGlzLnNldEZpbmFsU3RlcHBlcnNBc0Rpc2FibGVkKHN0ZXBJbmRleCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3RlcHBlclN0YXR1c0J5Q2FuQWN0aXZlKGNhbkFjdGl2ZU5leHRTdGVwOiBib29sZWFuKTogUG9TdGVwcGVyU3RhdHVzIHtcbiAgICByZXR1cm4gY2FuQWN0aXZlTmV4dFN0ZXAgPyBQb1N0ZXBwZXJTdGF0dXMuRG9uZSA6IFBvU3RlcHBlclN0YXR1cy5FcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3RlcHNBbmRJbmRleChzdGVwOiBQb1N0ZXBDb21wb25lbnQgPSA8YW55Pnt9KTogeyBzdGVwczogQXJyYXk8UG9TdGVwQ29tcG9uZW50Piwgc3RlcEluZGV4OiBudW1iZXIgfSB7XG4gICAgY29uc3Qgc3RlcHMgPSB0aGlzLmdldFBvU3RlcHMoKTtcbiAgICBjb25zdCBzdGVwSW5kZXggPSBzdGVwcy5maW5kSW5kZXgocG9TdGVwID0+IHBvU3RlcC5pZCA9PT0gc3RlcC5pZCk7XG5cbiAgICByZXR1cm4geyBzdGVwcywgc3RlcEluZGV4IH07XG4gIH1cblxuICBwcml2YXRlIGdldFBvU3RlcHMoKTogQXJyYXk8UG9TdGVwQ29tcG9uZW50PiB7XG4gICAgcmV0dXJuIHRoaXMucG9TdGVwcy50b0FycmF5KCk7XG4gIH1cblxuICBwcml2YXRlIGlzQmVmb3JlU3RlcChzdGVwSW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGN1cnJlbnRBY3RpdmVTdGVwSW5kZXggPSAoKSA9PiB0aGlzLmdldFBvU3RlcHMoKS5maW5kSW5kZXgoc3RlcCA9PiBzdGVwLmlkID09PSB0aGlzLmN1cnJlbnRBY3RpdmVTdGVwLmlkKTtcblxuICAgIHJldHVybiAhIXRoaXMuY3VycmVudEFjdGl2ZVN0ZXAgJiYgY3VycmVudEFjdGl2ZVN0ZXBJbmRleCgpID49IHN0ZXBJbmRleDtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RmluYWxTdGVwcGVyc0FzRGlzYWJsZWQoc3RlcEluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmdldFBvU3RlcHMoKVxuICAgICAgLmZpbHRlcigoc3RlcCwgaW5kZXgpID0+IHN0ZXAgJiYgaW5kZXggPj0gc3RlcEluZGV4ICsgMilcbiAgICAgIC5mb3JFYWNoKHN0ZXAgPT4gc3RlcC5zdGF0dXMgPSBQb1N0ZXBwZXJTdGF0dXMuRGlzYWJsZWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRTdGVwQXNBY3RpdmUoc3RlcDogUG9TdGVwQ29tcG9uZW50KTogdm9pZCB7XG4gICAgc3RlcC5zdGF0dXMgPSBQb1N0ZXBwZXJTdGF0dXMuQWN0aXZlO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXROZXh0U3RlcEFzRGVmYXVsdChjdXJyZW50U3RlcDogUG9TdGVwQ29tcG9uZW50KTogdm9pZCB7XG4gICAgY29uc3QgeyBzdGVwcywgc3RlcEluZGV4IH0gPSB0aGlzLmdldFN0ZXBzQW5kSW5kZXgoY3VycmVudFN0ZXApO1xuICAgIGNvbnN0IG5leHRJbmRleCA9IHN0ZXBJbmRleCArIDE7XG5cbiAgICBpZiAobmV4dEluZGV4IDwgdGhpcy5wb1N0ZXBzLmxlbmd0aCkge1xuICAgICAgc3RlcHNbbmV4dEluZGV4XS5zdGF0dXMgPSBQb1N0ZXBwZXJTdGF0dXMuRGVmYXVsdDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldFByZXZpb3VzU3RlcEFzRG9uZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wcmV2aW91c0FjdGl2ZVN0ZXApIHtcbiAgICAgIHRoaXMucHJldmlvdXNBY3RpdmVTdGVwLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5Eb25lO1xuICAgIH1cbiAgfVxufVxuIl19