import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PoHttpInterceptorDetailComponent } from './po-http-interceptor-detail/po-http-interceptor-detail.component';
// DEPRECATED 4.x.x
const NO_ERROR_HEADER_PARAM = 'X-Portinari-No-Error';
const NO_MESSAGE_HEADER_PARAM = 'X-Portinari-No-Message';
/**
 * @description
 *
 * O serviço Portinari Http Interceptor realiza o tratamento de requisições HTTP conforme o padrão do
 * [**Guia de implementação das APIs TOTVS**](http://tdn.totvs.com/pages/viewpage.action?pageId=484701395) para adaptá-lo
 * ao modelo do PO.
 *
 * > Para o correto funcionamento do interceptor `po-http-interceptor`, deve ser importado o módulo `BrowserAnimationsModule` no
 * > módulo principal da sua aplicação.
 *
 * Módulo da aplicação:
 * ```
 * import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
 * import { PoModule } from '@portinari/portinari-ui';
 * ...
 *
 * @NgModule({
 *   imports: [
 *     BrowserModule,
 *     BrowserAnimationsModule,
 *     ...
 *     PoModule
 *   ],
 *   declarations: [
 *     AppComponent,
 *     ...
 *   ],
 *   providers: [],
 *   bootstrap: [AppComponent]
 * })
 * export class AppModule { }
 * ```
 *
 * ### Funcionamento do interceptor
 *
 * Ao analisar o objeto `_messages` retornado pela requisição, o serviço exibirá notificações com mensagens na tela.
 * Os retornos de erros com códigos 4xx e 5xx são tratados automaticamente, sem a necessidade de incluir o `_messages`.
 *
 * É possível dispensar a notificação para o usuário utilizando-se no cabeçalho da requisição os parâmetros listados abaixo com o valor
 * igual a `true`:
 *
 * - `X-Portinari-No-Message`: Não exibe notificações de erro e/ou sucesso.
 *
 * - **Depreciado** `X-Portinari-No-Error`: não mostra notificações de erro com códigos `4xx` e `5xx`.
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-No-Message': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 *
 * Mais detalhes no tópico sobre cabeçalhos customizados no
 * [**Guia de implementação das APIs TOTVS**](http://tdn.totvs.com/pages/viewpage.action?pageId=484701395)
 *
 * > Após a validação no interceptor, os parâmetros serão removidos do cabeçalho da requisição.
 *
 * O `Content-Type` deve ser `application/json` e a estrutura de mensagem recebida pelo serviço deve seguir o
 * [**Guia de implementação das APIs TOTVS**](http://tdn.totvs.com/pages/viewpage.action?pageId=484701395)
 * (em Mensagens de sucesso para coleções), exemplo:
 *  - _messages: lista de mensagens ou objeto de mensagem, resultante do serviço.
 *    - type: success, warning, error, e information (será exibido a `tag` apenas se esta propriedade possuir valor);
 *    - code: título ou código da mensagem;
 *    - message: texto da mensagem;
 *    - detailedMessage: detalhamento do erro ou informativo;
 *
 * Ao clicar na ação 'Detalhes' no
 * [`po-notification`](/documentation/po-notification) os detalhes das mensagens de sucesso e de erro são apresentados em
 * um [`po-modal`](/documentation/po-modal) com um [`po-accordion`](/documentation/po-accordion) que possui um item por mensagem.
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 */
export class PoHttpInterceptorBaseService {
    constructor(componentInjector, notification) {
        this.componentInjector = componentInjector;
        this.notification = notification;
        this.notificationTypes = ['success', 'warning', 'error', 'information'];
        this.httpInterceptorDetailComponent = undefined;
    }
    intercept(request, next) {
        const cloneRequest = request.clone();
        request = request && this.hasParameters(request) ? this.cloneRequestWithoutParameters(request) : request;
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.processResponse(response, cloneRequest);
            }
        }, (error) => {
            this.processErrorResponse(error, cloneRequest);
        }));
    }
    processResponse(response, request) {
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (!hasNoMessageParam && response.body && response.body._messages) {
            const messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach((message) => {
                    this.showNotification(message);
                });
            }
            else {
                this.showNotification(messages);
            }
        }
    }
    processErrorResponse(response, request) {
        const errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: 'Servidor não está respondendo.', detailedMessage: response.message };
        const hasNoErrorParam = this.hasNoErrorParam(request);
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (errorResponse && errorResponse.message && !hasNoErrorParam && !hasNoMessageParam) {
            this.showNotification(Object.assign({}, errorResponse, { type: 'error' }));
        }
    }
    cloneRequestWithoutParameters(request) {
        const headers = request.headers
            .delete(NO_ERROR_HEADER_PARAM)
            .delete(NO_MESSAGE_HEADER_PARAM);
        return request.clone({ headers });
    }
    createModal(responseMessage) {
        const details = responseMessage.details ? [responseMessage, ...responseMessage.details] : [responseMessage];
        this.httpInterceptorDetailComponent = this.componentInjector.createComponentInApplication(PoHttpInterceptorDetailComponent);
        this.httpInterceptorDetailComponent.instance.detail = details;
        this.httpInterceptorDetailComponent.instance.closed.subscribe(() => this.destroyModal());
        this.httpInterceptorDetailComponent.instance.open();
    }
    destroyModal() {
        if (this.httpInterceptorDetailComponent) {
            this.componentInjector.destroyComponentInApplication(this.httpInterceptorDetailComponent);
            this.httpInterceptorDetailComponent = undefined;
        }
    }
    hasMessage(responseMessage) {
        const hasMessageProperties = responseMessage.message;
        return responseMessage && hasMessageProperties;
    }
    hasNoErrorParam(request) {
        const noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    }
    hasNoMessageParam(request) {
        const noMessageParam = request && request.headers.get(NO_MESSAGE_HEADER_PARAM);
        return noMessageParam && noMessageParam.toString().toLocaleLowerCase() === 'true';
    }
    hasParameters(request) {
        return request.headers.has(NO_ERROR_HEADER_PARAM) || request.headers.has(NO_MESSAGE_HEADER_PARAM);
    }
    showNotification(response) {
        if (!this.hasMessage(response)) {
            return;
        }
        const typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        const notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    }
    generateDetailModal(responseMessage) {
        return () => {
            if (!this.httpInterceptorDetailComponent) {
                this.createModal(responseMessage);
            }
        };
    }
    generateNotificationAction(responseMessage) {
        let notificationAction;
        let notificationLabel;
        if (responseMessage.helpUrl && !(responseMessage.detailedMessage || responseMessage.details)) {
            notificationLabel = 'Ajuda';
            notificationAction = this.generateUrlHelpFunction(responseMessage.helpUrl);
        }
        else if (responseMessage.detailedMessage || responseMessage.details) {
            notificationLabel = 'Detalhes';
            notificationAction = this.generateDetailModal(responseMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    }
    generateUrlHelpFunction(helpUrl) {
        return () => { window.open(helpUrl, '_blank'); };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1pbnRlcmNlcHRvci9wby1odHRwLWludGVyY2VwdG9yLWJhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQTZDLFlBQVksRUFBZ0MsTUFBTSxzQkFBc0IsQ0FBQztBQUc3SCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckMsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sbUVBQW1FLENBQUM7QUFFckgsbUJBQW1CO0FBQ25CLE1BQU0scUJBQXFCLEdBQUcsc0JBQXNCLENBQUM7QUFDckQsTUFBTSx1QkFBdUIsR0FBRyx3QkFBd0IsQ0FBQztBQUV6RDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBZ0dHO0FBQ0gsTUFBTSxPQUFnQiw0QkFBNEI7SUFNaEQsWUFBb0IsaUJBQTZDLEVBQVUsWUFBaUI7UUFBeEUsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE0QjtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFLO1FBSjVGLHNCQUFpQixHQUFHLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFFM0QsbUNBQThCLEdBQW1ELFNBQVMsQ0FBQztJQUVILENBQUM7SUFFakcsU0FBUyxDQUFDLE9BQXlCLEVBQUUsSUFBaUI7UUFDcEQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXJDLE9BQU8sR0FBRyxPQUFPLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENB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ckUsaUJBQWlCLEdBQUcsVUFBVSxDQUFDO1lBQy9CLGtCQUFrQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUNoRTtRQUNELE9BQU8sRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxFQUFFLGtCQUFrQixFQUFFLENBQUM7SUFDbEUsQ0FBQztJQUVPLHVCQUF1QixDQUFDLE9BQWU7UUFDN0MsT0FBTyxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRCxDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBJbnRlcmNlcHRvciwgSHR0cEhhbmRsZXIsIEh0dHBSZXF1ZXN0LCBIdHRwUmVzcG9uc2UsIEh0dHBFdmVudCwgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1jb21wb25lbnQtaW5qZWN0b3IvcG8tY29tcG9uZW50LWluamVjdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWwgfSBmcm9tICcuL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0h0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCB9IGZyb20gJy4vcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwvcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwuY29tcG9uZW50JztcblxuLy8gREVQUkVDQVRFRCA0LngueFxuY29uc3QgTk9fRVJST1JfSEVBREVSX1BBUkFNID0gJ1gtUG9ydGluYXJpLU5vLUVycm9yJztcbmNvbnN0IE5PX01FU1NBR0VfSEVBREVSX1BBUkFNID0gJ1gtUG9ydGluYXJpLU5vLU1lc3NhZ2UnO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gc2VydmnDp28gUG9ydGluYXJpIEh0dHAgSW50ZXJjZXB0b3IgcmVhbGl6YSBvIHRyYXRhbWVudG8gZGUgcmVxdWlzacOnw7VlcyBIVFRQIGNvbmZvcm1lIG8gcGFkcsOjbyBkb1xuICogWyoqR3VpYSBkZSBpbXBsZW1lbnRhw6fDo28gZGFzIEFQSXMgVE9UVlMqKl0oaHR0cDovL3Rkbi50b3R2cy5jb20vcGFnZXMvdmlld3BhZ2UuYWN0aW9uP3BhZ2VJZD00ODQ3MDEzOTUpIHBhcmEgYWRhcHTDoS1sb1xuICogYW8gbW9kZWxvIGRvIFBPLlxuICpcbiAqID4gUGFyYSBvIGNvcnJldG8gZnVuY2lvbmFtZW50byBkbyBpbnRlcmNlcHRvciBgcG8taHR0cC1pbnRlcmNlcHRvcmAsIGRldmUgc2VyIGltcG9ydGFkbyBvIG3Ds2R1bG8gYEJyb3dzZXJBbmltYXRpb25zTW9kdWxlYCBub1xuICogPiBtw7NkdWxvIHByaW5jaXBhbCBkYSBzdWEgYXBsaWNhw6fDo28uXG4gKlxuICogTcOzZHVsbyBkYSBhcGxpY2HDp8OjbzpcbiAqIGBgYFxuICogaW1wb3J0IHsgQnJvd3NlckFuaW1hdGlvbnNNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyL2FuaW1hdGlvbnMnO1xuICogaW1wb3J0IHsgUG9Nb2R1bGUgfSBmcm9tICdAcG9ydGluYXJpL3BvcnRpbmFyaS11aSc7XG4gKiAuLi5cbiAqXG4gKiBATmdNb2R1bGUoe1xuICogICBpbXBvcnRzOiBbXG4gKiAgICAgQnJvd3Nlck1vZHVsZSxcbiAqICAgICBCcm93c2VyQW5pbWF0aW9uc01vZHVsZSxcbiAqICAgICAuLi5cbiAqICAgICBQb01vZHVsZVxuICogICBdLFxuICogICBkZWNsYXJhdGlvbnM6IFtcbiAqICAgICBBcHBDb21wb25lbnQsXG4gKiAgICAgLi4uXG4gKiAgIF0sXG4gKiAgIHByb3ZpZGVyczogW10sXG4gKiAgIGJvb3RzdHJhcDogW0FwcENvbXBvbmVudF1cbiAqIH0pXG4gKiBleHBvcnQgY2xhc3MgQXBwTW9kdWxlIHsgfVxuICogYGBgXG4gKlxuICogIyMjIEZ1bmNpb25hbWVudG8gZG8gaW50ZXJjZXB0b3JcbiAqXG4gKiBBbyBhbmFsaXNhciBvIG9iamV0byBgX21lc3NhZ2VzYCByZXRvcm5hZG8gcGVsYSByZXF1aXNpw6fDo28sIG8gc2VydmnDp28gZXhpYmlyw6Egbm90aWZpY2HDp8O1ZXMgY29tIG1lbnNhZ2VucyBuYSB0ZWxhLlxuICogT3MgcmV0b3Jub3MgZGUgZXJyb3MgY29tIGPDs2RpZ29zIDR4eCBlIDV4eCBzw6NvIHRyYXRhZG9zIGF1dG9tYXRpY2FtZW50ZSwgc2VtIGEgbmVjZXNzaWRhZGUgZGUgaW5jbHVpciBvIGBfbWVzc2FnZXNgLlxuICpcbiAqIMOJIHBvc3PDrXZlbCBkaXNwZW5zYXIgYSBub3RpZmljYcOnw6NvIHBhcmEgbyB1c3XDoXJpbyB1dGlsaXphbmRvLXNlIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIG9zIHBhcsOibWV0cm9zIGxpc3RhZG9zIGFiYWl4byBjb20gbyB2YWxvclxuICogaWd1YWwgYSBgdHJ1ZWA6XG4gKlxuICogLSBgWC1Qb3J0aW5hcmktTm8tTWVzc2FnZWA6IE7Do28gZXhpYmUgbm90aWZpY2HDp8O1ZXMgZGUgZXJybyBlL291IHN1Y2Vzc28uXG4gKlxuICogLSAqKkRlcHJlY2lhZG8qKiBgWC1Qb3J0aW5hcmktTm8tRXJyb3JgOiBuw6NvIG1vc3RyYSBub3RpZmljYcOnw7VlcyBkZSBlcnJvIGNvbSBjw7NkaWdvcyBgNHh4YCBlIGA1eHhgLlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUG9ydGluYXJpLU5vLU1lc3NhZ2UnOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKlxuICogTWFpcyBkZXRhbGhlcyBubyB0w7NwaWNvIHNvYnJlIGNhYmXDp2FsaG9zIGN1c3RvbWl6YWRvcyBub1xuICogWyoqR3VpYSBkZSBpbXBsZW1lbnRhw6fDo28gZGFzIEFQSXMgVE9UVlMqKl0oaHR0cDovL3Rkbi50b3R2cy5jb20vcGFnZXMvdmlld3BhZ2UuYWN0aW9uP3BhZ2VJZD00ODQ3MDEzOTUpXG4gKlxuICogPiBBcMOzcyBhIHZhbGlkYcOnw6NvIG5vIGludGVyY2VwdG9yLCBvcyBwYXLDom1ldHJvcyBzZXLDo28gcmVtb3ZpZG9zIGRvIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvLlxuICpcbiAqIE8gYENvbnRlbnQtVHlwZWAgZGV2ZSBzZXIgYGFwcGxpY2F0aW9uL2pzb25gIGUgYSBlc3RydXR1cmEgZGUgbWVuc2FnZW0gcmVjZWJpZGEgcGVsbyBzZXJ2acOnbyBkZXZlIHNlZ3VpciBvXG4gKiBbKipHdWlhIGRlIGltcGxlbWVudGHDp8OjbyBkYXMgQVBJcyBUT1RWUyoqXShodHRwOi8vdGRuLnRvdHZzLmNvbS9wYWdlcy92aWV3cGFnZS5hY3Rpb24/cGFnZUlkPTQ4NDcwMTM5NSlcbiAqIChlbSBNZW5zYWdlbnMgZGUgc3VjZXNzbyBwYXJhIGNvbGXDp8O1ZXMpLCBleGVtcGxvOlxuICogIC0gX21lc3NhZ2VzOiBsaXN0YSBkZSBtZW5zYWdlbnMgb3Ugb2JqZXRvIGRlIG1lbnNhZ2VtLCByZXN1bHRhbnRlIGRvIHNlcnZpw6dvLlxuICogICAgLSB0eXBlOiBzdWNjZXNzLCB3YXJuaW5nLCBlcnJvciwgZSBpbmZvcm1hdGlvbiAoc2Vyw6EgZXhpYmlkbyBhIGB0YWdgIGFwZW5hcyBzZSBlc3RhIHByb3ByaWVkYWRlIHBvc3N1aXIgdmFsb3IpO1xuICogICAgLSBjb2RlOiB0w610dWxvIG91IGPDs2RpZ28gZGEgbWVuc2FnZW07XG4gKiAgICAtIG1lc3NhZ2U6IHRleHRvIGRhIG1lbnNhZ2VtO1xuICogICAgLSBkZXRhaWxlZE1lc3NhZ2U6IGRldGFsaGFtZW50byBkbyBlcnJvIG91IGluZm9ybWF0aXZvO1xuICpcbiAqIEFvIGNsaWNhciBuYSBhw6fDo28gJ0RldGFsaGVzJyBub1xuICogW2Bwby1ub3RpZmljYXRpb25gXSgvZG9jdW1lbnRhdGlvbi9wby1ub3RpZmljYXRpb24pIG9zIGRldGFsaGVzIGRhcyBtZW5zYWdlbnMgZGUgc3VjZXNzbyBlIGRlIGVycm8gc8OjbyBhcHJlc2VudGFkb3MgZW1cbiAqIHVtIFtgcG8tbW9kYWxgXSgvZG9jdW1lbnRhdGlvbi9wby1tb2RhbCkgY29tIHVtIFtgcG8tYWNjb3JkaW9uYF0oL2RvY3VtZW50YXRpb24vcG8tYWNjb3JkaW9uKSBxdWUgcG9zc3VpIHVtIGl0ZW0gcG9yIG1lbnNhZ2VtLlxuICpcbiAqIEFvIGltcG9ydGFyIG8gbcOzZHVsbyBgUG9Nb2R1bGVgIG5hIGFwbGljYcOnw6NvLCBvIGBwby1odHRwLWludGVyY2VwdG9yYCDDqSBhdXRvbWF0aWNhbWVudGUgY29uZmlndXJhZG8gc2VtIGEgbmVjZXNzaWRhZGVcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxuICpcbiAqIEFvIHJlYWxpemFyIHJlcXVpc2nDp8O1ZXMgdXRpbGl6ZSBvIGBIdHRwQ2xpZW50YCwgY29uZm9ybWUgZXhlbXBsbyBhYmFpeG86XG4gKlxuICogYGBgXG4gKiBpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuICpcbiAqIC4uLlxuICpcbiAqIEBJbmplY3RhYmxlKClcbiAqIGV4cG9ydCBjbGFzcyBVc2VyU2VydmljZSB7XG4gKlxuICogICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxuICpcbiAqICAgZ2V0VXNlcnMoKSB7XG4gKiAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoJy9hcGkvdXNlcnMnKTtcbiAqICAgfVxuICpcbiAqICAgLi4uXG4gKlxuICogfVxuICogYGBgXG4gKlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUG9IdHRwSW50ZXJjZXB0b3JCYXNlU2VydmljZSBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG5cbiAgbm90aWZpY2F0aW9uVHlwZXMgPSBbJ3N1Y2Nlc3MnLCAnd2FybmluZycsICdlcnJvcicsICdpbmZvcm1hdGlvbiddO1xuXG4gIHByaXZhdGUgaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50OiBDb21wb25lbnRSZWY8UG9IdHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQ+ID0gdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY29tcG9uZW50SW5qZWN0b3I6IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlLCBwcml2YXRlIG5vdGlmaWNhdGlvbjogYW55KSB7IH1cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgY29uc3QgY2xvbmVSZXF1ZXN0ID0gcmVxdWVzdC5jbG9uZSgpO1xuXG4gICAgcmVxdWVzdCA9IHJlcXVlc3QgJiYgdGhpcy5oYXNQYXJhbWV0ZXJzKHJlcXVlc3QpID8gdGhpcy5jbG9uZVJlcXVlc3RXaXRob3V0UGFyYW1ldGVycyhyZXF1ZXN0KSA6IHJlcXVlc3Q7XG5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCkucGlwZSh0YXAoKHJlc3BvbnNlOiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuXG4gICAgICBpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBIdHRwUmVzcG9uc2UpIHtcblxuICAgICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZShyZXNwb25zZSwgY2xvbmVSZXF1ZXN0KTtcblxuICAgICAgfVxuICAgIH0sIChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcblxuICAgICAgdGhpcy5wcm9jZXNzRXJyb3JSZXNwb25zZShlcnJvciwgY2xvbmVSZXF1ZXN0KTtcblxuICAgIH0pKTtcbiAgfVxuXG4gIHByb2Nlc3NSZXNwb25zZShyZXNwb25zZTogSHR0cFJlc3BvbnNlPGFueT4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBoYXNOb01lc3NhZ2VQYXJhbSA9IHRoaXMuaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdCk7XG5cbiAgICBpZiAoIWhhc05vTWVzc2FnZVBhcmFtICYmIHJlc3BvbnNlLmJvZHkgJiYgcmVzcG9uc2UuYm9keS5fbWVzc2FnZXMpIHtcblxuICAgICAgY29uc3QgbWVzc2FnZXMgPSByZXNwb25zZS5ib2R5Ll9tZXNzYWdlcztcblxuICAgICAgaWYgKG1lc3NhZ2VzIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgbWVzc2FnZXMuZm9yRWFjaCgobWVzc2FnZTogUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWwpID0+IHtcbiAgICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24obWVzc2FnZSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm9jZXNzRXJyb3JSZXNwb25zZShyZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UsIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBlcnJvclJlc3BvbnNlID0gcmVzcG9uc2Uuc3RhdHVzICE9PSAwXG4gICAgICA/IHJlc3BvbnNlLmVycm9yXG4gICAgICA6IHsgY29kZTogMCwgbWVzc2FnZTogJ1NlcnZpZG9yIG7Do28gZXN0w6EgcmVzcG9uZGVuZG8uJywgZGV0YWlsZWRNZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlIH07XG5cbiAgICBjb25zdCBoYXNOb0Vycm9yUGFyYW0gPSB0aGlzLmhhc05vRXJyb3JQYXJhbShyZXF1ZXN0KTtcbiAgICBjb25zdCBoYXNOb01lc3NhZ2VQYXJhbSA9IHRoaXMuaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdCk7XG5cbiAgICBpZiAoZXJyb3JSZXNwb25zZSAmJiBlcnJvclJlc3BvbnNlLm1lc3NhZ2UgJiYgIWhhc05vRXJyb3JQYXJhbSAmJiAhaGFzTm9NZXNzYWdlUGFyYW0pIHtcbiAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7IC4uLmVycm9yUmVzcG9uc2UsIHR5cGU6ICdlcnJvcicgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjbG9uZVJlcXVlc3RXaXRob3V0UGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSHR0cFJlcXVlc3Q8YW55PiB7XG4gICAgY29uc3QgaGVhZGVycyA9IHJlcXVlc3QuaGVhZGVyc1xuICAgICAgLmRlbGV0ZShOT19FUlJPUl9IRUFERVJfUEFSQU0pXG4gICAgICAuZGVsZXRlKE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiByZXF1ZXN0LmNsb25lKHsgaGVhZGVycyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTW9kYWwocmVzcG9uc2VNZXNzYWdlOiBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCkge1xuICAgIGNvbnN0IGRldGFpbHMgPSByZXNwb25zZU1lc3NhZ2UuZGV0YWlscyA/IFsgcmVzcG9uc2VNZXNzYWdlLCAuLi5yZXNwb25zZU1lc3NhZ2UuZGV0YWlscyBdIDogWyByZXNwb25zZU1lc3NhZ2UgXTtcblxuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50ID0gdGhpcy5jb21wb25lbnRJbmplY3Rvci5jcmVhdGVDb21wb25lbnRJbkFwcGxpY2F0aW9uKFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KTtcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudC5pbnN0YW5jZS5kZXRhaWwgPSBkZXRhaWxzO1xuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50Lmluc3RhbmNlLmNsb3NlZC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5kZXN0cm95TW9kYWwoKSk7XG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQuaW5zdGFuY2Uub3BlbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95TW9kYWwoKSB7XG4gICAgaWYgKHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KSB7XG4gICAgICB0aGlzLmNvbXBvbmVudEluamVjdG9yLmRlc3Ryb3lDb21wb25lbnRJbkFwcGxpY2F0aW9uKHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KTtcbiAgICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFzTWVzc2FnZShyZXNwb25zZU1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSB7XG4gICAgY29uc3QgaGFzTWVzc2FnZVByb3BlcnRpZXMgPSByZXNwb25zZU1lc3NhZ2UubWVzc2FnZTtcblxuICAgIHJldHVybiByZXNwb25zZU1lc3NhZ2UgJiYgaGFzTWVzc2FnZVByb3BlcnRpZXM7XG4gIH1cblxuICBwcml2YXRlIGhhc05vRXJyb3JQYXJhbShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgbm9FcnJvclBhcmFtID0gcmVxdWVzdCAmJiByZXF1ZXN0LmhlYWRlcnMuZ2V0KE5PX0VSUk9SX0hFQURFUl9QQVJBTSk7XG5cbiAgICByZXR1cm4gbm9FcnJvclBhcmFtICYmIG5vRXJyb3JQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIHByaXZhdGUgaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vTWVzc2FnZVBhcmFtID0gcmVxdWVzdCAmJiByZXF1ZXN0LmhlYWRlcnMuZ2V0KE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiBub01lc3NhZ2VQYXJhbSAmJiBub01lc3NhZ2VQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIHByaXZhdGUgaGFzUGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgcmV0dXJuIHJlcXVlc3QuaGVhZGVycy5oYXMoTk9fRVJST1JfSEVBREVSX1BBUkFNKSB8fCByZXF1ZXN0LmhlYWRlcnMuaGFzKE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcbiAgfVxuXG4gIHByaXZhdGUgc2hvd05vdGlmaWNhdGlvbihyZXNwb25zZTogYW55KSB7XG5cbiAgICBpZiAoIXRoaXMuaGFzTWVzc2FnZShyZXNwb25zZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB0eXBlTm90aWZpY2F0aW9uID0gdGhpcy5ub3RpZmljYXRpb25UeXBlcy5pbmNsdWRlcyhyZXNwb25zZS50eXBlKSA/IHJlc3BvbnNlLnR5cGUgOiAnaW5mb3JtYXRpb24nO1xuXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZU5vdGlmaWNhdGlvbkFjdGlvbihyZXNwb25zZSk7XG5cbiAgICB0aGlzLm5vdGlmaWNhdGlvblt0eXBlTm90aWZpY2F0aW9uXSh7XG4gICAgICBtZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlLFxuICAgICAgYWN0aW9uTGFiZWw6IG5vdGlmaWNhdGlvbkFjdGlvbi5sYWJlbCxcbiAgICAgIGFjdGlvbjogbm90aWZpY2F0aW9uQWN0aW9uLmFjdGlvblxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZURldGFpbE1vZGFsKHJlc3BvbnNlTWVzc2FnZTogYW55KSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmICghdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQpIHtcbiAgICAgICAgdGhpcy5jcmVhdGVNb2RhbChyZXNwb25zZU1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlTm90aWZpY2F0aW9uQWN0aW9uKHJlc3BvbnNlTWVzc2FnZTogYW55KSB7XG5cbiAgICBsZXQgbm90aWZpY2F0aW9uQWN0aW9uO1xuICAgIGxldCBub3RpZmljYXRpb25MYWJlbDtcblxuICAgIGlmIChyZXNwb25zZU1lc3NhZ2UuaGVscFVybCAmJiAhKHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxlZE1lc3NhZ2UgfHwgcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMpKSB7XG4gICAgICBub3RpZmljYXRpb25MYWJlbCA9ICdBanVkYSc7XG4gICAgICBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlVXJsSGVscEZ1bmN0aW9uKHJlc3BvbnNlTWVzc2FnZS5oZWxwVXJsKTtcblxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2VNZXNzYWdlLmRldGFpbGVkTWVzc2FnZSB8fCByZXNwb25zZU1lc3NhZ2UuZGV0YWlscykge1xuICAgICAgbm90aWZpY2F0aW9uTGFiZWwgPSAnRGV0YWxoZXMnO1xuICAgICAgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZURldGFpbE1vZGFsKHJlc3BvbnNlTWVzc2FnZSk7XG4gICAgfVxuICAgIHJldHVybiB7IGxhYmVsOiBub3RpZmljYXRpb25MYWJlbCwgYWN0aW9uOiBub3RpZmljYXRpb25BY3Rpb24gfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24oaGVscFVybDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICgpID0+IHsgd2luZG93Lm9wZW4oaGVscFVybCwgJ19ibGFuaycpOyB9O1xuICB9XG5cbn1cbiJdfQ==