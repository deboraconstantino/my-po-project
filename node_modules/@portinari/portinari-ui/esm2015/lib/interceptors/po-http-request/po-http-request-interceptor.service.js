import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { PoComponentInjectorService } from '../../services/po-component-injector/po-component-injector.service';
import { PoLoadingOverlayComponent } from '../../components/po-loading/po-loading-overlay/po-loading-overlay.component';
import { PoHttpRequesControltService } from './po-http-request-control-service';
import * as i0 from "@angular/core";
import * as i1 from "./po-http-request-control-service";
import * as i2 from "../../services/po-component-injector/po-component-injector.service";
const noCountPendingRequests = 'X-Portinari-No-Count-Pending-Requests';
const screenLock = 'X-Portinari-Screen-Lock';
/**
 * @description
 *
 * O serviço Portinari Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-Portinari-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `PoHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-Portinari-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-Portinari-No-Count-Pending-Requests': true, 'X-Portinari-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: PoHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * @example
 * <example name='po-http-request-interceptor-labs' title='Portinari Http Request Interceptor Labs'>
 *  <file name='sample-po-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-po-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
let PoHttpRequestInterceptorService = class PoHttpRequestInterceptorService {
    constructor(controlHttpRequest, poComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.poComponentInjector = poComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    intercept(request, next) {
        const requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.setCountPendingRequests(false, requestClone);
                this.setCountOverlayRequests(false, requestClone);
            }
        }), catchError(error => {
            this.setCountPendingRequests(false, requestClone);
            this.setCountOverlayRequests(false, requestClone);
            return throwError(error);
        }));
    }
    getCountPendingRequests() {
        return this.controlHttpRequest.getControlHttpRequest();
    }
    buildLoading() {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.poComponentInjector.createComponentInApplication(PoLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    }
    destroyLoading() {
        if (this.loadingOverlayComponent) {
            this.poComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    }
    requestCloneWithoutHeaderParam(headersParams, request) {
        let isRequestClone = false;
        headersParams.forEach(headerParam => {
            if (request.headers.has(headerParam)) {
                request.headers.delete(headerParam);
                isRequestClone = true;
            }
        });
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    }
    setCountPendingRequests(isIncrement, request) {
        const hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        const headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && (headerParam.toString().toLowerCase() === 'true')) {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    }
    setCountOverlayRequests(isIncrement, request) {
        const hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            const headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    }
};
PoHttpRequestInterceptorService.ctorParameters = () => [
    { type: PoHttpRequesControltService },
    { type: PoComponentInjectorService }
];
PoHttpRequestInterceptorService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function PoHttpRequestInterceptorService_Factory() { return new PoHttpRequestInterceptorService(i0.ɵɵinject(i1.PoHttpRequesControltService), i0.ɵɵinject(i2.PoComponentInjectorService)); }, token: PoHttpRequestInterceptorService, providedIn: "root" });
PoHttpRequestInterceptorService = tslib_1.__decorate([
    Injectable({
        providedIn: 'root'
    }),
    tslib_1.__metadata("design:paramtypes", [PoHttpRequesControltService,
        PoComponentInjectorService])
], PoHttpRequestInterceptorService);
export { PoHttpRequestInterceptorService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1yZXF1ZXN0L3BvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQXdELFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFHLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxvRUFBb0UsQ0FBQztBQUNoSCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw2RUFBNkUsQ0FBQztBQUV4SCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQzs7OztBQUVoRixNQUFNLHNCQUFzQixHQUFHLHVDQUF1QyxDQUFDO0FBQ3ZFLE1BQU0sVUFBVSxHQUFHLHlCQUF5QixDQUFDO0FBRTdDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBa0ZHO0FBSUgsSUFBYSwrQkFBK0IsR0FBNUMsTUFBYSwrQkFBK0I7SUFPMUMsWUFDVSxrQkFBK0MsRUFDL0MsbUJBQStDO1FBRC9DLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBNkI7UUFDL0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE0QjtRQVBqRCw0QkFBdUIsR0FBNEMsU0FBUyxDQUFDO1FBRTdFLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO1FBQzVCLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO0lBSTBCLENBQUM7SUFFL0QsU0FBUyxDQUFDLE9BQXlCLEVBQUUsSUFBaUI7UUFFcEQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXJDLE9BQU8sR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsQ0FBQyxzQkFBc0IsRUFBRSxVQUFVLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUU3RixJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFFakQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDOUIsR0FBRyxDQUFDLENBQUMsUUFBd0IsRUFBRSxFQUFFO1lBQy9CLElBQUksUUFBUSxZQUFZLFlBQVksRUFBRTtnQkFDcEMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDbEQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQzthQUNuRDtRQUNILENBQUMsQ0FBQyxFQUNGLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNqQixJQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFbEQsT0FBTyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRCx1QkFBdUI7UUFDckIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0lBRU8sWUFBWTtRQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQ2pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsNEJBQTRCLENBQUMseUJBQXlCLENBQUMsQ0FBQztZQUNoSCxJQUFJLENBQUMsdUJBQXVCLENBQUMsUUFBUSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDeEQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDdEU7SUFDSCxDQUFDO0lBRU8sY0FBYztRQUNwQixJQUFJLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUNoQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsNkJBQTZCLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDckYsSUFBSSxDQUFDLHVCQUF1QixHQUFHLFNBQVMsQ0FBQztTQUMxQztJQUNILENBQUM7SUFFTyw4QkFBOEIsQ0FBQyxhQUE0QixFQUFFLE9BQXlCO1FBQzVGLElBQUksY0FBYyxHQUFHLEtBQUssQ0FBQztRQUUzQixhQUFhLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ2xDLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ3BDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNwQyxjQUFjLEdBQUcsSUFBSSxDQUFDO2FBQ3ZCO1FBRUgsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLGNBQWMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO0lBQzlFLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxXQUFvQixFQUFFLE9BQXlCO1FBRTdFLE1BQU0saUNBQWlDLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUN0RixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBRWhFLElBQUksaUNBQWlDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxFQUFFLEtBQUssTUFBTSxDQUFFLEVBQUc7WUFDNUYsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLGVBQWUsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFFckQsQ0FBQztJQUVPLHVCQUF1QixDQUFDLFdBQW9CLEVBQUUsT0FBeUI7UUFDN0UsTUFBTSw0QkFBNEIsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVyRSxJQUFJLDRCQUE0QixFQUFFO1lBQ2hDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXBELElBQUksV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsRUFBRSxLQUFLLE9BQU8sRUFBRTtnQkFDcEQsT0FBTzthQUNSO1lBRUQsSUFBSSxDQUFDLGVBQWUsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLGVBQWUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1NBQ3hFO0lBQ0gsQ0FBQztDQUVGLENBQUE7O1lBMUYrQiwyQkFBMkI7WUFDMUIsMEJBQTBCOzs7QUFUOUMsK0JBQStCO0lBSDNDLFVBQVUsQ0FBQztRQUNWLFVBQVUsRUFBRSxNQUFNO0tBQ25CLENBQUM7NkNBUzhCLDJCQUEyQjtRQUMxQiwwQkFBMEI7R0FUOUMsK0JBQStCLENBa0czQztTQWxHWSwrQkFBK0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBQb0NvbXBvbmVudEluamVjdG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWNvbXBvbmVudC1pbmplY3Rvci9wby1jb21wb25lbnQtaW5qZWN0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBQb0xvYWRpbmdPdmVybGF5Q29tcG9uZW50IH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9wby1sb2FkaW5nL3BvLWxvYWRpbmctb3ZlcmxheS9wby1sb2FkaW5nLW92ZXJsYXkuY29tcG9uZW50JztcblxuaW1wb3J0IHsgUG9IdHRwUmVxdWVzQ29udHJvbHRTZXJ2aWNlIH0gZnJvbSAnLi9wby1odHRwLXJlcXVlc3QtY29udHJvbC1zZXJ2aWNlJztcblxuY29uc3Qgbm9Db3VudFBlbmRpbmdSZXF1ZXN0cyA9ICdYLVBvcnRpbmFyaS1Oby1Db3VudC1QZW5kaW5nLVJlcXVlc3RzJztcbmNvbnN0IHNjcmVlbkxvY2sgPSAnWC1Qb3J0aW5hcmktU2NyZWVuLUxvY2snO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gc2VydmnDp28gUG9ydGluYXJpIEh0dHAgUmVxdWVzdCBJbnRlcmNlcHRvciByZWFsaXphIGEgY29udGFiaWxpemHDp8OjbyBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcyBuYSBhcGxpY2HDp8Ojby5cbiAqXG4gKiBFeGlzdGUgYSBwb3NzaWJpbGlkYWRlIGRlIG7Do28gZWZldHVhciBhIGNvbnRhYmlsaXphw6fDo28gZGFzIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLCB1dGlsaXphbmRvIG8gcGFyw6JtZXRyb1xuICogYFgtUG9ydGluYXJpLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHNgLiBQYXJhIGlzc28gZGV2ZSBzZXIgaW5mb3JtYWRvIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIGNvbSBvIHZhbG9yIGAndHJ1ZSdgLFxuICogcG9yIGV4ZW1wbG86XG4gKlxuICogYGBgXG4gKiAuLi5cbiAqICBjb25zdCBoZWFkZXJzID0geyAnWC1Qb3J0aW5hcmktTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqIFBhcmEgb2J0ZXIgYSBxdWFudGlkYWRlIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLCBkZXZlIGluc2NyZXZlci1zZSBubyBtw6l0b2RvIGBnZXRDb3VudFBlbmRpbmdSZXF1ZXN0c2AgZG9cbiAqIHNlcnZpw6dvIGBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlYCwgY29tIGlzc28sIGFvIHJlYWxpemFyIHJlcXVpc2nDp8O1ZXMgdXRpbGl6YW5kbyBgSHR0cENsaWVudGAsXG4gKiBzZXLDoSByZXRvcm5hZG8gYSBxdWFudGlkYWRlIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLlxuICpcbiAqIFRhbWLDqW0gZXhpc3RlIGEgcG9zc2liaWxkYWRlIGRlIHRyYXZhciBhIHRlbGEgZSBtb3N0cmFyIHVtYSBpbWFnZW0gZGUgX2xvYWRpbmdfIGR1cmFudGUgbyBwcm9jZXNzYW1lbnRvIGRlIHVtYSByZXF1aXNpw6fDo29cbiAqIGRldmUtc2UgcGFzc2FyIG8gcGFyw6JtZXRybyBgWC1Qb3J0aW5hcmktU2NyZWVuLUxvY2tgIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIGNvbSB2YWxvciBgJ3RydWUnYC5cbiAqXG4gKiBwb3IgZXhlbXBsbzpcbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVBvcnRpbmFyaS1TY3JlZW4tTG9jayc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqID4gQXDDs3MgYSB2YWxpZGHDp8OjbyBubyBpbnRlcmNlcHRvciwgbyBwYXLDom1ldHJvIHNlcsOhIHJlbW92aWRvIGRvIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvLlxuICpcbiAqIEFvIGltcG9ydGFyIG8gbcOzZHVsbyBgUG9Nb2R1bGVgIG5hIGFwbGljYcOnw6NvLCBvIGBwby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3JgIMOpIGF1dG9tYXRpY2FtZW50ZSBjb25maWd1cmFkbyBzZW0gYSBuZWNlc3NpZGFkZVxuICogZGUgcXVhbHF1ZXIgY29uZmlndXJhw6fDo28gZXh0cmEuXG4gKlxuICpcbiAqIFNlZ3VlIGFiYWl4byB1bSBleGVtcGxvIGRlIHVzbzpcbiAqXG4gKiBgYGBcbiAqIGltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG4gKlxuICogLi4uXG4gKlxuICogQEluamVjdGFibGUoKVxuICogZXhwb3J0IGNsYXNzIEN1c3RvbWVyc1NlcnZpY2Uge1xuICpcbiAqICBoZWFkZXJzID0geyAnWC1Qb3J0aW5hcmktTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0cyc6IHRydWUsICdYLVBvcnRpbmFyaS1TY3JlZW4tTG9jayc6ICd0cnVlJyB9XG4gKiAgcGVuZGluZ1JlcXVlc3RzOiBudW1iZXIgPSAwO1xuICogIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICpcbiAqICBjb25zdHJ1Y3RvcihcbiAqICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAqICAgIHByaXZhdGUgaHR0cFJlcXVlc3RJbnRlcmNlcHRvcjogUG9IdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZSkgeyB9XG4gKlxuICogIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICogICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAqICB9XG4gKlxuICogIG5nT25Jbml0KCk6IHZvaWQge1xuICogICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLmh0dHBSZXF1ZXN0SW50ZXJjZXB0b3IuZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoKS5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gKiAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzID0gZGF0YTtcbiAqICAgIH0pO1xuICogIH1cbiAqXG4gKiAgZ2V0Q3VzdG9tZXJzKCkge1xuICogICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqICB9XG4gKlxuICogIC4uLlxuICpcbiAqIH1cbiAqIGBgYFxuICpcbiAqIEBleGFtcGxlXG4gKiA8ZXhhbXBsZSBuYW1lPSdwby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicycgdGl0bGU9J1BvcnRpbmFyaSBIdHRwIFJlcXVlc3QgSW50ZXJjZXB0b3IgTGFicyc+XG4gKiAgPGZpbGUgbmFtZT0nc2FtcGxlLXBvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzLmNvbXBvbmVudC50cyc+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPSdzYW1wbGUtcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLWxhYnMuY29tcG9uZW50Lmh0bWwnPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFBvSHR0cFJlcXVlc3RJbnRlcmNlcHRvclNlcnZpY2UgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuXG4gIHByaXZhdGUgbG9hZGluZ092ZXJsYXlDb21wb25lbnQ6IENvbXBvbmVudFJlZjxQb0xvYWRpbmdPdmVybGF5Q29tcG9uZW50PiA9IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHBlbmRpbmdSZXF1ZXN0czogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBvdmVybGF5UmVxdWVzdHM6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjb250cm9sSHR0cFJlcXVlc3Q6IFBvSHR0cFJlcXVlc0NvbnRyb2x0U2VydmljZSxcbiAgICBwcml2YXRlIHBvQ29tcG9uZW50SW5qZWN0b3I6IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlKSB7ICB9XG5cbiAgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKSB7XG5cbiAgICBjb25zdCByZXF1ZXN0Q2xvbmUgPSByZXF1ZXN0LmNsb25lKCk7XG5cbiAgICByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0Q2xvbmVXaXRob3V0SGVhZGVyUGFyYW0oW25vQ291bnRQZW5kaW5nUmVxdWVzdHMsIHNjcmVlbkxvY2tdLCByZXF1ZXN0KTtcblxuICAgIHRoaXMuc2V0Q291bnRQZW5kaW5nUmVxdWVzdHModHJ1ZSwgcmVxdWVzdENsb25lKTtcbiAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKHRydWUsIHJlcXVlc3RDbG9uZSk7XG5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCkucGlwZShcbiAgICAgIHRhcCgocmVzcG9uc2U6IEh0dHBFdmVudDxhbnk+KSA9PiB7XG4gICAgICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuICAgICAgICAgIHRoaXMuc2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG4gICAgICAgICAgdGhpcy5zZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcbiAgICAgICAgdGhpcy5zZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcblxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBnZXRDb3VudFBlbmRpbmdSZXF1ZXN0cygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRyb2xIdHRwUmVxdWVzdC5nZXRDb250cm9sSHR0cFJlcXVlc3QoKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRMb2FkaW5nKCkge1xuICAgIGlmICghdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCkge1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCA9IHRoaXMucG9Db21wb25lbnRJbmplY3Rvci5jcmVhdGVDb21wb25lbnRJbkFwcGxpY2F0aW9uKFBvTG9hZGluZ092ZXJsYXlDb21wb25lbnQpO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudC5pbnN0YW5jZS5zY3JlZW5Mb2NrID0gdHJ1ZTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveUxvYWRpbmcoKSB7XG4gICAgaWYgKHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpIHtcbiAgICAgIHRoaXMucG9Db21wb25lbnRJbmplY3Rvci5kZXN0cm95Q29tcG9uZW50SW5BcHBsaWNhdGlvbih0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXF1ZXN0Q2xvbmVXaXRob3V0SGVhZGVyUGFyYW0oaGVhZGVyc1BhcmFtczogQXJyYXk8c3RyaW5nPiwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IEh0dHBSZXF1ZXN0PGFueT4ge1xuICAgIGxldCBpc1JlcXVlc3RDbG9uZSA9IGZhbHNlO1xuXG4gICAgaGVhZGVyc1BhcmFtcy5mb3JFYWNoKGhlYWRlclBhcmFtID0+IHtcbiAgICAgIGlmIChyZXF1ZXN0LmhlYWRlcnMuaGFzKGhlYWRlclBhcmFtKSkge1xuICAgICAgICByZXF1ZXN0LmhlYWRlcnMuZGVsZXRlKGhlYWRlclBhcmFtKTtcbiAgICAgICAgaXNSZXF1ZXN0Q2xvbmUgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgfSk7XG5cbiAgICByZXR1cm4gaXNSZXF1ZXN0Q2xvbmUgPyByZXF1ZXN0LmNsb25lKHtoZWFkZXJzOiByZXF1ZXN0LmhlYWRlcnN9KSA6IHJlcXVlc3Q7XG4gIH1cblxuICBwcml2YXRlIHNldENvdW50UGVuZGluZ1JlcXVlc3RzKGlzSW5jcmVtZW50OiBib29sZWFuLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG5cbiAgICBjb25zdCBoYXNDb3VudFBlbmRpbmdSZXF1ZXN0SGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuaGFzKG5vQ291bnRQZW5kaW5nUmVxdWVzdHMpO1xuICAgIGNvbnN0IGhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmdldChub0NvdW50UGVuZGluZ1JlcXVlc3RzKTtcblxuICAgIGlmIChoYXNDb3VudFBlbmRpbmdSZXF1ZXN0SGVhZGVyUGFyYW0gJiYgKGhlYWRlclBhcmFtLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnICkgKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMgKz0gaXNJbmNyZW1lbnQgPyAxIDogLTE7XG4gICAgdGhpcy5jb250cm9sSHR0cFJlcXVlc3Quc2VuZCh0aGlzLnBlbmRpbmdSZXF1ZXN0cyk7XG5cbiAgfVxuXG4gIHByaXZhdGUgc2V0Q291bnRPdmVybGF5UmVxdWVzdHMoaXNJbmNyZW1lbnQ6IGJvb2xlYW4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBoYXNPdmVybGF5UmVxdWVzdEhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmhhcyhzY3JlZW5Mb2NrKTtcblxuICAgIGlmIChoYXNPdmVybGF5UmVxdWVzdEhlYWRlclBhcmFtKSB7XG4gICAgICBjb25zdCBoZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5nZXQoc2NyZWVuTG9jayk7XG5cbiAgICAgIGlmIChoZWFkZXJQYXJhbS50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkgPT09ICdmYWxzZScpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLm92ZXJsYXlSZXF1ZXN0cyArPSBpc0luY3JlbWVudCA/IDEgOiAtMTtcbiAgICAgIHRoaXMub3ZlcmxheVJlcXVlc3RzID4gMCA/IHRoaXMuYnVpbGRMb2FkaW5nKCkgOiB0aGlzLmRlc3Ryb3lMb2FkaW5nKCk7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==