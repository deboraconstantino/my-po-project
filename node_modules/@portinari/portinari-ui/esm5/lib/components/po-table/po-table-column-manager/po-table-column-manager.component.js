import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, OnChanges, OnDestroy, OnInit, Output, SimpleChange, SimpleChanges, Renderer2, ViewChild } from '@angular/core';
import { browserLanguage, capitalizeFirstLetter, convertToInt, poLocaleDefault } from '../../../utils/util';
import { PoPopoverComponent } from '../../po-popover/po-popover.component';
var PoTableColumnManagerMaxColumnsDefault = 99999;
export var poTableColumnManagerLiteralsDefault = {
    en: {
        columnsManager: 'Columns manager',
        restoreDefault: 'Restore default'
    },
    es: {
        columnsManager: 'Gerente de columna',
        restoreDefault: 'Restaurar por defecto'
    },
    pt: {
        columnsManager: 'Gerenciador de colunas',
        restoreDefault: 'Restaurar padrão'
    },
    ru: {
        columnsManager: 'менеджер колонок',
        restoreDefault: 'сброс настроек'
    }
};
var PoTableColumnManagerComponent = /** @class */ (function () {
    function PoTableColumnManagerComponent(renderer) {
        this.renderer = renderer;
        this._maxColumns = PoTableColumnManagerMaxColumnsDefault;
        this.columnsOptions = [];
        this.literals = tslib_1.__assign({}, poTableColumnManagerLiteralsDefault[poLocaleDefault], poTableColumnManagerLiteralsDefault[browserLanguage()]);
        this.visibleColumns = [];
        this.defaultColumns = [];
        this.columns = [];
        this.visibleColumnsChange = new EventEmitter();
    }
    Object.defineProperty(PoTableColumnManagerComponent.prototype, "maxColumns", {
        get: function () {
            return this._maxColumns;
        },
        set: function (value) {
            this._maxColumns = convertToInt(value, PoTableColumnManagerMaxColumnsDefault);
        },
        enumerable: true,
        configurable: true
    });
    PoTableColumnManagerComponent.prototype.ngOnInit = function () {
        this.updateColumnsOptions(this.columns);
    };
    PoTableColumnManagerComponent.prototype.ngOnChanges = function (changes) {
        var columns = changes.columns, maxColumns = changes.maxColumns, target = changes.target;
        if (target && target.firstChange) {
            this.initializeListeners();
        }
        if (columns) {
            this.onChangeColumns(columns);
        }
        if (maxColumns) {
            this.updateColumnsOptions(this.columns);
        }
    };
    PoTableColumnManagerComponent.prototype.ngOnDestroy = function () {
        this.removeListeners();
    };
    PoTableColumnManagerComponent.prototype.onChangeVisibleColumns = function (checkedColumns) {
        this.disableColumnsOptions(this.columnsOptions);
        var visibleTableColumns = this.getVisibleTableColumns(checkedColumns);
        this.visibleColumnsChange.emit(visibleTableColumns);
    };
    PoTableColumnManagerComponent.prototype.restore = function () {
        this.updateColumnsOptions(this.defaultColumns);
    };
    // desabilitará as colunas, que não estiverem selecionadas, após exeder o numero maximo de colunas.
    PoTableColumnManagerComponent.prototype.disableColumnsOptions = function (columns) {
        var _this = this;
        if (columns === void 0) { columns = []; }
        // necessario timeout para que seja possivel atualizar os columnsOptions apos a mudança do model
        setTimeout(function () {
            _this.columnsOptions = columns.map(function (column) { return (tslib_1.__assign({}, column, { disabled: _this.isDisableColumn(column.value) })); });
        });
    };
    PoTableColumnManagerComponent.prototype.getColumnTitleLabel = function (column) {
        return column.label || capitalizeFirstLetter(column.property);
    };
    /** Retorna um Array de column.property das colunas que são visiveis. */
    PoTableColumnManagerComponent.prototype.getVisibleColumns = function (columns) {
        var _this = this;
        var visibleColumns = [];
        columns.forEach(function (column) {
            if (column.visible !== false && visibleColumns.length < _this.maxColumns && column.type !== 'detail') {
                visibleColumns.push(column.property);
            }
        });
        return visibleColumns;
    };
    /** Retorna um Array PoTableColumn a partir das colunas visiveis no gerenciador de colunas. */
    PoTableColumnManagerComponent.prototype.getVisibleTableColumns = function (visibleColumns) {
        return this.columns.map(function (column) { return (tslib_1.__assign({}, column, { visible: visibleColumns.includes(column.property) || column.type === 'detail' })); });
    };
    PoTableColumnManagerComponent.prototype.initializeListeners = function () {
        var _this = this;
        this.resizeListener = this.renderer.listen('window', 'resize', function () {
            if (_this.popover) {
                _this.popover.close();
            }
        });
    };
    PoTableColumnManagerComponent.prototype.isDisableColumn = function (property) {
        return this.visibleColumns.length >= this.maxColumns ? !this.visibleColumns.includes(property) : false;
    };
    PoTableColumnManagerComponent.prototype.mapTableColumnsToCheckboxOptions = function (columns) {
        var _this = this;
        if (columns === void 0) { columns = []; }
        var columnsOptions = [];
        columns.forEach(function (column) {
            if (column.type !== 'detail') {
                columnsOptions.push({
                    value: column.property,
                    label: _this.getColumnTitleLabel(column),
                    disabled: _this.isDisableColumn(column.property)
                });
            }
        });
        return columnsOptions;
    };
    PoTableColumnManagerComponent.prototype.onChangeColumns = function (columns) {
        var firstChange = columns.firstChange, _a = columns.currentValue, currentValue = _a === void 0 ? [] : _a, _b = columns.previousValue, previousValue = _b === void 0 ? [] : _b;
        // atualizara o defaultColumns, quando for a primeira vez ou quando o defaultColumns for diferente do currentValue
        if (firstChange || (this.defaultColumns.length !== currentValue.length)) {
            this.defaultColumns = currentValue;
        }
        // verifica se o valor anterior é diferente do atual para atualizar as columnsOptions apenas quando for necessario
        if (previousValue.length !== currentValue.length) {
            this.updateColumnsOptions(currentValue);
        }
    };
    PoTableColumnManagerComponent.prototype.removeListeners = function () {
        if (this.resizeListener) {
            this.resizeListener();
        }
    };
    PoTableColumnManagerComponent.prototype.updateColumnsOptions = function (columns) {
        this.visibleColumns = this.getVisibleColumns(columns);
        this.columnsOptions = this.mapTableColumnsToCheckboxOptions(columns);
        this.onChangeVisibleColumns(this.visibleColumns);
    };
    PoTableColumnManagerComponent.ctorParameters = function () { return [
        { type: Renderer2 }
    ]; };
    tslib_1.__decorate([
        Input('p-columns'),
        tslib_1.__metadata("design:type", Array)
    ], PoTableColumnManagerComponent.prototype, "columns", void 0);
    tslib_1.__decorate([
        Input('p-max-columns'),
        tslib_1.__metadata("design:type", Number),
        tslib_1.__metadata("design:paramtypes", [Number])
    ], PoTableColumnManagerComponent.prototype, "maxColumns", null);
    tslib_1.__decorate([
        Input('p-target'),
        tslib_1.__metadata("design:type", ElementRef)
    ], PoTableColumnManagerComponent.prototype, "target", void 0);
    tslib_1.__decorate([
        Output('p-visible-columns-change'),
        tslib_1.__metadata("design:type", Object)
    ], PoTableColumnManagerComponent.prototype, "visibleColumnsChange", void 0);
    tslib_1.__decorate([
        ViewChild(PoPopoverComponent, { static: false }),
        tslib_1.__metadata("design:type", PoPopoverComponent)
    ], PoTableColumnManagerComponent.prototype, "popover", void 0);
    PoTableColumnManagerComponent = tslib_1.__decorate([
        Component({
            selector: 'po-table-column-manager',
            template: "<po-popover #popover *ngIf=\"target\" [p-target]=\"target\" p-position=\"bottom-left\">\n\n  <div class=\"po-table-column-manager-header\">\n    <div class=\"po-table-column-manager-header-title\">{{ literals.columnsManager }}</div>\n\n    <div class=\"po-table-column-manager-header-close\">\n      <button class=\"po-table-column-manager-header-close-button po-clickable po-icon po-icon-close\" (click)=\"popover.close()\">\n      </button>\n    </div>\n  </div>\n\n  <div class=\"po-table-column-manager-body\">\n    <po-checkbox-group\n      name=\"visibleColumns\"\n      [(ngModel)]=\"visibleColumns\"\n      p-columns=\"1\"\n      [p-options]=\"columnsOptions\"\n      (p-change)=\"onChangeVisibleColumns($event)\">\n    </po-checkbox-group>\n  </div>\n\n  <div class=\"po-table-column-manager-footer\">\n    <po-button\n      class=\"po-table-column-manager-footer-restore\"\n      p-small\n      p-type=\"link\"\n      [p-label]=\"literals.restoreDefault\"\n      (p-click)=\"restore()\">\n    </po-button>\n  </div>\n</po-popover>\n"
        }),
        tslib_1.__metadata("design:paramtypes", [Renderer2])
    ], PoTableColumnManagerComponent);
    return PoTableColumnManagerComponent;
}());
export { PoTableColumnManagerComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdGFibGUtY29sdW1uLW1hbmFnZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvcnRpbmFyaS9wb3J0aW5hcmktdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby10YWJsZS9wby10YWJsZS1jb2x1bW4tbWFuYWdlci9wby10YWJsZS1jb2x1bW4tbWFuYWdlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQy9FLE1BQU0sRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbkYsT0FBTyxFQUFFLGVBQWUsRUFBRSxxQkFBcUIsRUFBRSxZQUFZLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFNUcsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFJM0UsSUFBTSxxQ0FBcUMsR0FBRyxLQUFLLENBQUM7QUFFcEQsTUFBTSxDQUFDLElBQU0sbUNBQW1DLEdBQUc7SUFDakQsRUFBRSxFQUFFO1FBQ0YsY0FBYyxFQUFFLGlCQUFpQjtRQUNqQyxjQUFjLEVBQUUsaUJBQWlCO0tBQ2xDO0lBQ0QsRUFBRSxFQUFFO1FBQ0YsY0FBYyxFQUFFLG9CQUFvQjtRQUNwQyxjQUFjLEVBQUUsdUJBQXVCO0tBQ3hDO0lBQ0QsRUFBRSxFQUFFO1FBQ0YsY0FBYyxFQUFFLHdCQUF3QjtRQUN4QyxjQUFjLEVBQUUsa0JBQWtCO0tBQ25DO0lBQ0QsRUFBRSxFQUFFO1FBQ0YsY0FBYyxFQUFFLGtCQUFrQjtRQUNsQyxjQUFjLEVBQUUsZ0JBQWdCO0tBQ2pDO0NBQ0YsQ0FBQztBQU1GO0lBOEJFLHVDQUFvQixRQUFtQjtRQUFuQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBNUIvQixnQkFB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O0lBQ25ELENBQUM7O2dCQWxJNkIsU0FBUzs7SUFoQm5CO1FBQW5CLEtBQUssQ0FBQyxXQUFXLENBQUM7MENBQVUsS0FBSztrRUFBcUI7SUFFL0I7UUFBdkIsS0FBSyxDQUFDLGVBQWUsQ0FBQzs7O21FQUV0QjtJQU1rQjtRQUFsQixLQUFLLENBQUMsVUFBVSxDQUFDOzBDQUFTLFVBQVU7aUVBQUM7SUFFRjtRQUFuQyxNQUFNLENBQUMsMEJBQTBCLENBQUM7OytFQUFpRTtJQUVsRDtRQUFqRCxTQUFTLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7MENBQVUsa0JBQWtCO2tFQUFDO0lBNUJuRSw2QkFBNkI7UUFKekMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHlCQUF5QjtZQUNuQyw4aENBQXVEO1NBQ3hELENBQUM7aURBK0I4QixTQUFTO09BOUI1Qiw2QkFBNkIsQ0FrS3pDO0lBQUQsb0NBQUM7Q0FBQSxBQWxLRCxJQWtLQztTQWxLWSw2QkFBNkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBPbkluaXQsXG4gIE91dHB1dCwgU2ltcGxlQ2hhbmdlLCBTaW1wbGVDaGFuZ2VzLCBSZW5kZXJlcjIsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBicm93c2VyTGFuZ3VhZ2UsIGNhcGl0YWxpemVGaXJzdExldHRlciwgY29udmVydFRvSW50LCBwb0xvY2FsZURlZmF1bHQgfSBmcm9tICcuLi8uLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvQ2hlY2tib3hHcm91cE9wdGlvbiB9IGZyb20gJy4uLy4uL3BvLWZpZWxkL3BvLWNoZWNrYm94LWdyb3VwL2ludGVyZmFjZXMvcG8tY2hlY2tib3gtZ3JvdXAtb3B0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb1BvcG92ZXJDb21wb25lbnQgfSBmcm9tICcuLi8uLi9wby1wb3BvdmVyL3BvLXBvcG92ZXIuY29tcG9uZW50JztcblxuaW1wb3J0IHsgUG9UYWJsZUNvbHVtbiB9IGZyb20gJy4uL2ludGVyZmFjZXMvcG8tdGFibGUtY29sdW1uLmludGVyZmFjZSc7XG5cbmNvbnN0IFBvVGFibGVDb2x1bW5NYW5hZ2VyTWF4Q29sdW1uc0RlZmF1bHQgPSA5OTk5OTtcblxuZXhwb3J0IGNvbnN0IHBvVGFibGVDb2x1bW5NYW5hZ2VyTGl0ZXJhbHNEZWZhdWx0ID0ge1xuICBlbjoge1xuICAgIGNvbHVtbnNNYW5hZ2VyOiAnQ29sdW1ucyBtYW5hZ2VyJyxcbiAgICByZXN0b3JlRGVmYXVsdDogJ1Jlc3RvcmUgZGVmYXVsdCdcbiAgfSxcbiAgZXM6IHtcbiAgICBjb2x1bW5zTWFuYWdlcjogJ0dlcmVudGUgZGUgY29sdW1uYScsXG4gICAgcmVzdG9yZURlZmF1bHQ6ICdSZXN0YXVyYXIgcG9yIGRlZmVjdG8nXG4gIH0sXG4gIHB0OiB7XG4gICAgY29sdW1uc01hbmFnZXI6ICdHZXJlbmNpYWRvciBkZSBjb2x1bmFzJyxcbiAgICByZXN0b3JlRGVmYXVsdDogJ1Jlc3RhdXJhciBwYWRyw6NvJ1xuICB9LFxuICBydToge1xuICAgIGNvbHVtbnNNYW5hZ2VyOiAn0LzQtdC90LXQtNC20LXRgCDQutC+0LvQvtC90L7QuicsXG4gICAgcmVzdG9yZURlZmF1bHQ6ICfRgdCx0YDQvtGBINC90LDRgdGC0YDQvtC10LonXG4gIH1cbn07XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLXRhYmxlLWNvbHVtbi1tYW5hZ2VyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLXRhYmxlLWNvbHVtbi1tYW5hZ2VyLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb1RhYmxlQ29sdW1uTWFuYWdlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gIHByaXZhdGUgX21heENvbHVtbnM6IG51bWJlciA9IFBvVGFibGVDb2x1bW5NYW5hZ2VyTWF4Q29sdW1uc0RlZmF1bHQ7XG5cbiAgY29sdW1uc09wdGlvbnM6IEFycmF5PFBvQ2hlY2tib3hHcm91cE9wdGlvbj4gPSBbXTtcbiAgbGl0ZXJhbHMgPSB7XG4gICAgLi4ucG9UYWJsZUNvbHVtbk1hbmFnZXJMaXRlcmFsc0RlZmF1bHRbcG9Mb2NhbGVEZWZhdWx0XSxcbiAgICAuLi5wb1RhYmxlQ29sdW1uTWFuYWdlckxpdGVyYWxzRGVmYXVsdFticm93c2VyTGFuZ3VhZ2UoKV1cbiAgfTtcbiAgdmlzaWJsZUNvbHVtbnM6IEFycmF5PHN0cmluZz4gPSBbXTtcblxuICBwcml2YXRlIGRlZmF1bHRDb2x1bW5zOiBBcnJheTxQb1RhYmxlQ29sdW1uPiA9IFtdO1xuICBwcml2YXRlIHJlc2l6ZUxpc3RlbmVyOiAoKSA9PiB2b2lkO1xuXG4gIEBJbnB1dCgncC1jb2x1bW5zJykgY29sdW1uczogQXJyYXk8UG9UYWJsZUNvbHVtbj4gPSBbXTtcblxuICBASW5wdXQoJ3AtbWF4LWNvbHVtbnMnKSBzZXQgbWF4Q29sdW1ucyh2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fbWF4Q29sdW1ucyA9IGNvbnZlcnRUb0ludCh2YWx1ZSwgUG9UYWJsZUNvbHVtbk1hbmFnZXJNYXhDb2x1bW5zRGVmYXVsdCk7XG4gIH1cblxuICBnZXQgbWF4Q29sdW1ucygpIHtcbiAgICByZXR1cm4gdGhpcy5fbWF4Q29sdW1ucztcbiAgfVxuXG4gIEBJbnB1dCgncC10YXJnZXQnKSB0YXJnZXQ6IEVsZW1lbnRSZWY7XG5cbiAgQE91dHB1dCgncC12aXNpYmxlLWNvbHVtbnMtY2hhbmdlJykgdmlzaWJsZUNvbHVtbnNDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPEFycmF5PFBvVGFibGVDb2x1bW4+PigpO1xuXG4gIEBWaWV3Q2hpbGQoUG9Qb3BvdmVyQ29tcG9uZW50LCB7IHN0YXRpYzogZmFsc2UgfSkgcG9wb3ZlcjogUG9Qb3BvdmVyQ29tcG9uZW50O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMikge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnVwZGF0ZUNvbHVtbnNPcHRpb25zKHRoaXMuY29sdW1ucyk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgY29uc3QgeyBjb2x1bW5zLCBtYXhDb2x1bW5zLCB0YXJnZXQgfSA9IGNoYW5nZXM7XG5cbiAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5maXJzdENoYW5nZSkge1xuICAgICAgdGhpcy5pbml0aWFsaXplTGlzdGVuZXJzKCk7XG4gICAgfVxuXG4gICAgaWYgKGNvbHVtbnMpIHtcbiAgICAgIHRoaXMub25DaGFuZ2VDb2x1bW5zKGNvbHVtbnMpO1xuICAgIH1cblxuICAgIGlmIChtYXhDb2x1bW5zKSB7XG4gICAgICB0aGlzLnVwZGF0ZUNvbHVtbnNPcHRpb25zKHRoaXMuY29sdW1ucyk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnMoKTtcbiAgfVxuXG4gIG9uQ2hhbmdlVmlzaWJsZUNvbHVtbnMoY2hlY2tlZENvbHVtbnM6IEFycmF5PHN0cmluZz4pIHtcbiAgICB0aGlzLmRpc2FibGVDb2x1bW5zT3B0aW9ucyh0aGlzLmNvbHVtbnNPcHRpb25zKTtcblxuICAgIGNvbnN0IHZpc2libGVUYWJsZUNvbHVtbnMgPSB0aGlzLmdldFZpc2libGVUYWJsZUNvbHVtbnMoY2hlY2tlZENvbHVtbnMpO1xuXG4gICAgdGhpcy52aXNpYmxlQ29sdW1uc0NoYW5nZS5lbWl0KHZpc2libGVUYWJsZUNvbHVtbnMpO1xuICB9XG5cbiAgcmVzdG9yZSgpIHtcbiAgICB0aGlzLnVwZGF0ZUNvbHVtbnNPcHRpb25zKHRoaXMuZGVmYXVsdENvbHVtbnMpO1xuICB9XG5cbiAgLy8gZGVzYWJpbGl0YXLDoSBhcyBjb2x1bmFzLCBxdWUgbsOjbyBlc3RpdmVyZW0gc2VsZWNpb25hZGFzLCBhcMOzcyBleGVkZXIgbyBudW1lcm8gbWF4aW1vIGRlIGNvbHVuYXMuXG4gIHByaXZhdGUgZGlzYWJsZUNvbHVtbnNPcHRpb25zKGNvbHVtbnM6IEFycmF5PFBvQ2hlY2tib3hHcm91cE9wdGlvbj4gPSBbXSkge1xuICAgIC8vIG5lY2Vzc2FyaW8gdGltZW91dCBwYXJhIHF1ZSBzZWphIHBvc3NpdmVsIGF0dWFsaXphciBvcyBjb2x1bW5zT3B0aW9ucyBhcG9zIGEgbXVkYW7Dp2EgZG8gbW9kZWxcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuY29sdW1uc09wdGlvbnMgPSBjb2x1bW5zLm1hcChjb2x1bW4gPT4gKHtcbiAgICAgICAgLi4uY29sdW1uLFxuICAgICAgICBkaXNhYmxlZDogdGhpcy5pc0Rpc2FibGVDb2x1bW4oY29sdW1uLnZhbHVlKVxuICAgICAgfSkpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb2x1bW5UaXRsZUxhYmVsKGNvbHVtbjogUG9UYWJsZUNvbHVtbikge1xuICAgIHJldHVybiBjb2x1bW4ubGFiZWwgfHwgY2FwaXRhbGl6ZUZpcnN0TGV0dGVyKGNvbHVtbi5wcm9wZXJ0eSk7XG4gIH1cblxuICAvKiogUmV0b3JuYSB1bSBBcnJheSBkZSBjb2x1bW4ucHJvcGVydHkgZGFzIGNvbHVuYXMgcXVlIHPDo28gdmlzaXZlaXMuICovXG4gIHByaXZhdGUgZ2V0VmlzaWJsZUNvbHVtbnMoY29sdW1uczogQXJyYXk8UG9UYWJsZUNvbHVtbj4pOiBBcnJheTxzdHJpbmc+IHtcbiAgICBjb25zdCB2aXNpYmxlQ29sdW1ucyA9IFtdO1xuXG4gICAgY29sdW1ucy5mb3JFYWNoKGNvbHVtbiA9PiB7XG4gICAgICBpZiAoY29sdW1uLnZpc2libGUgIT09IGZhbHNlICYmIHZpc2libGVDb2x1bW5zLmxlbmd0aCA8IHRoaXMubWF4Q29sdW1ucyAmJiBjb2x1bW4udHlwZSAhPT0gJ2RldGFpbCcpIHtcblxuICAgICAgICB2aXNpYmxlQ29sdW1ucy5wdXNoKGNvbHVtbi5wcm9wZXJ0eSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdmlzaWJsZUNvbHVtbnM7XG4gIH1cblxuICAvKiogUmV0b3JuYSB1bSBBcnJheSBQb1RhYmxlQ29sdW1uIGEgcGFydGlyIGRhcyBjb2x1bmFzIHZpc2l2ZWlzIG5vIGdlcmVuY2lhZG9yIGRlIGNvbHVuYXMuICovXG4gIHByaXZhdGUgZ2V0VmlzaWJsZVRhYmxlQ29sdW1ucyh2aXNpYmxlQ29sdW1uczogQXJyYXk8c3RyaW5nPik6IEFycmF5PFBvVGFibGVDb2x1bW4+IHtcbiAgICByZXR1cm4gdGhpcy5jb2x1bW5zLm1hcChjb2x1bW4gPT4gKHtcbiAgICAgIC4uLmNvbHVtbixcbiAgICAgIHZpc2libGU6IHZpc2libGVDb2x1bW5zLmluY2x1ZGVzKGNvbHVtbi5wcm9wZXJ0eSkgfHwgY29sdW1uLnR5cGUgPT09ICdkZXRhaWwnXG4gICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplTGlzdGVuZXJzKCkge1xuICAgIHRoaXMucmVzaXplTGlzdGVuZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbignd2luZG93JywgJ3Jlc2l6ZScsICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnBvcG92ZXIpIHtcbiAgICAgICAgdGhpcy5wb3BvdmVyLmNsb3NlKCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgfVxuXG4gIHByaXZhdGUgaXNEaXNhYmxlQ29sdW1uKHByb3BlcnR5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy52aXNpYmxlQ29sdW1ucy5sZW5ndGggPj0gdGhpcy5tYXhDb2x1bW5zID8gIXRoaXMudmlzaWJsZUNvbHVtbnMuaW5jbHVkZXMocHJvcGVydHkpIDogZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIG1hcFRhYmxlQ29sdW1uc1RvQ2hlY2tib3hPcHRpb25zKGNvbHVtbnM6IEFycmF5PFBvVGFibGVDb2x1bW4+ID0gW10pIHtcbiAgICBjb25zdCBjb2x1bW5zT3B0aW9ucyA9IFtdO1xuXG4gICAgY29sdW1ucy5mb3JFYWNoKGNvbHVtbiA9PiB7XG4gICAgICBpZiAoY29sdW1uLnR5cGUgIT09ICdkZXRhaWwnKSB7XG4gICAgICAgIGNvbHVtbnNPcHRpb25zLnB1c2goe1xuICAgICAgICAgIHZhbHVlOiBjb2x1bW4ucHJvcGVydHksXG4gICAgICAgICAgbGFiZWw6IHRoaXMuZ2V0Q29sdW1uVGl0bGVMYWJlbChjb2x1bW4pLFxuICAgICAgICAgIGRpc2FibGVkOiB0aGlzLmlzRGlzYWJsZUNvbHVtbihjb2x1bW4ucHJvcGVydHkpXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgfSk7XG5cbiAgICByZXR1cm4gY29sdW1uc09wdGlvbnM7XG4gIH1cblxuICBwcml2YXRlIG9uQ2hhbmdlQ29sdW1ucyhjb2x1bW5zOiBTaW1wbGVDaGFuZ2UpIHtcbiAgICBjb25zdCB7IGZpcnN0Q2hhbmdlLCBjdXJyZW50VmFsdWUgPSBbXSwgcHJldmlvdXNWYWx1ZSA9IFtdIH0gPSBjb2x1bW5zO1xuXG4gICAgLy8gYXR1YWxpemFyYSBvIGRlZmF1bHRDb2x1bW5zLCBxdWFuZG8gZm9yIGEgcHJpbWVpcmEgdmV6IG91IHF1YW5kbyBvIGRlZmF1bHRDb2x1bW5zIGZvciBkaWZlcmVudGUgZG8gY3VycmVudFZhbHVlXG4gICAgaWYgKGZpcnN0Q2hhbmdlIHx8ICh0aGlzLmRlZmF1bHRDb2x1bW5zLmxlbmd0aCAhPT0gY3VycmVudFZhbHVlLmxlbmd0aCkpIHtcbiAgICAgIHRoaXMuZGVmYXVsdENvbHVtbnMgPSBjdXJyZW50VmFsdWU7XG4gICAgfVxuXG4gICAgLy8gdmVyaWZpY2Egc2UgbyB2YWxvciBhbnRlcmlvciDDqSBkaWZlcmVudGUgZG8gYXR1YWwgcGFyYSBhdHVhbGl6YXIgYXMgY29sdW1uc09wdGlvbnMgYXBlbmFzIHF1YW5kbyBmb3IgbmVjZXNzYXJpb1xuICAgIGlmIChwcmV2aW91c1ZhbHVlLmxlbmd0aCAhPT0gY3VycmVudFZhbHVlLmxlbmd0aCkge1xuICAgICAgdGhpcy51cGRhdGVDb2x1bW5zT3B0aW9ucyhjdXJyZW50VmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlTGlzdGVuZXJzKCkge1xuICAgIGlmICh0aGlzLnJlc2l6ZUxpc3RlbmVyKSB7XG4gICAgICB0aGlzLnJlc2l6ZUxpc3RlbmVyKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVDb2x1bW5zT3B0aW9ucyhjb2x1bW5zOiBBcnJheTxQb1RhYmxlQ29sdW1uPikge1xuICAgIHRoaXMudmlzaWJsZUNvbHVtbnMgPSB0aGlzLmdldFZpc2libGVDb2x1bW5zKGNvbHVtbnMpO1xuICAgIHRoaXMuY29sdW1uc09wdGlvbnMgPSB0aGlzLm1hcFRhYmxlQ29sdW1uc1RvQ2hlY2tib3hPcHRpb25zKGNvbHVtbnMpO1xuXG4gICAgdGhpcy5vbkNoYW5nZVZpc2libGVDb2x1bW5zKHRoaXMudmlzaWJsZUNvbHVtbnMpO1xuICB9XG5cbn1cbiJdfQ==