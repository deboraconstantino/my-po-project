import * as tslib_1 from "tslib";
import { Component, ChangeDetectorRef, OnDestroy, OnInit, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { PoDynamicFormBaseComponent } from './po-dynamic-form-base.component';
import { PoDynamicFormLoadService } from './po-dynamic-form-load/po-dynamic-form-load.service';
import { PoDynamicFormValidationService } from './po-dynamic-form-validation/po-dynamic-form-validation.service';
/**
 * @docsExtends PoDynamicFormBaseComponent
 *
 * @example
 *
 * <example name="po-dynamic-form-basic" title="Portinari Dynamic Form Basic">
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.html"> </file>
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-dynamic-form-register" title="Portinari Dynamic Form - Register">
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.html"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.ts"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.service.ts"> </file>
 * </example>
 */
var PoDynamicFormComponent = /** @class */ (function (_super) {
    tslib_1.__extends(PoDynamicFormComponent, _super);
    function PoDynamicFormComponent(changes, loadService, validationService) {
        var _this = _super.call(this) || this;
        _this.changes = changes;
        _this.loadService = loadService;
        _this.validationService = validationService;
        return _this;
    }
    Object.defineProperty(PoDynamicFormComponent.prototype, "form", {
        get: function () {
            return this._form || {};
        },
        set: function (value) {
            var _this = this;
            // necessario para nao ocorrer o ExpressionChangedAfterItHasBeenCheckedError
            setTimeout(function () {
                _this._form = value;
                _this.emitForm();
            });
        },
        enumerable: true,
        configurable: true
    });
    PoDynamicFormComponent.prototype.ngOnDestroy = function () {
        this.removeListeners();
    };
    PoDynamicFormComponent.prototype.ngOnInit = function () {
        if (this.load) {
            this.loadDataOnInitialize();
        }
    };
    /**
     * Função que atribui foco ao campo desejado.
     *
     * Para utilizá-la é necessário capturar a instância do `dynamic form`, como por exemplo:
     *
     * ``` html
     * <po-dynamic-form #dynamicForm [p-fields]="fields"></po-dynamic-form>
     * ```
     *
     * ``` javascript
     * import { PoDynamicFormComponent, PoDynamicFormField } from '@portinari/portinari-ui';
     *
     * ...
     *
     * @ViewChild('dynamicForm', { static: true }) dynamicForm: PoDynamicFormComponent;
     *
     * fields: Array<PoDynamicFormField> = [
     *   { property: 'fieldOne' },
     *   { property: 'fieldTwo' }
     * ];
     *
     * fieldFocus() {
     *   this.dynamicForm.focus('fieldTwo');
     * }
     * ```
     *
     * @param {string} property Nome da propriedade atribuída ao `PoDynamicFormField.property`.
     */
    PoDynamicFormComponent.prototype.focus = function (property) {
        this.fieldsComponent.focus(property);
    };
    PoDynamicFormComponent.prototype.validateForm = function (field) {
        var _this = this;
        var previousFocusElement = document.activeElement;
        this.disableForm(true);
        var errorOnValidation = function () { return _this.disableForm(false); };
        this.sendFormSubscription = this.validationService
            .sendFormChange(this.validate, field, this.value)
            .subscribe(this.applyFormValidation(previousFocusElement), errorOnValidation);
    };
    PoDynamicFormComponent.prototype.applyFormUpdatesOnLoad = function (previousFocusElement) {
        var _this = this;
        return function (dynamicFormData) {
            _this.updateModelOnLoad(dynamicFormData);
            _this.disableForm(false);
            _this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    };
    PoDynamicFormComponent.prototype.applyFormValidation = function (previousFocusElement) {
        var _this = this;
        return function (dynamicFormData) {
            _this.updateModelWithValidation(dynamicFormData);
            _this.disableForm(false);
            _this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    };
    PoDynamicFormComponent.prototype.disableForm = function (value) {
        this.disabledForm = value;
        this.changes.detectChanges();
    };
    PoDynamicFormComponent.prototype.emitForm = function () {
        if (!this.groupForm && this.formOutput.observers.length) {
            this.formOutput.emit(this.form);
        }
    };
    PoDynamicFormComponent.prototype.loadDataOnInitialize = function () {
        var _this = this;
        var previousFocusElement = document.activeElement;
        this.disabledForm = true;
        var errorOnLoad = function () { return _this.disabledForm = false; };
        this.onLoadSubscription = this.loadService
            .executeLoad(this.load, this.value)
            .subscribe(this.applyFormUpdatesOnLoad(previousFocusElement), errorOnLoad);
    };
    PoDynamicFormComponent.prototype.removeListeners = function () {
        if (this.onLoadSubscription) {
            this.onLoadSubscription.unsubscribe();
        }
        if (this.sendFormSubscription) {
            this.sendFormSubscription.unsubscribe();
        }
    };
    PoDynamicFormComponent.prototype.setFocusOnFieldByProperty = function (property, previousFocusElement) {
        var _this = this;
        if (property) {
            // precisa do timeout para que o valor seja atribuido no campo antes de setar o focus,
            // para nao disparar a mudança posteriormente. Situação ocorre quando retornar campo com valor e focus atribuido a ele.
            setTimeout(function () { return _this.focus(property); });
        }
        else {
            previousFocusElement['focus']();
        }
    };
    PoDynamicFormComponent.prototype.updateModelOnLoad = function (loadedFormData) {
        Object.assign(this.value, loadedFormData.value);
        this.fields = this.loadService.createAndUpdateFieldsForm(loadedFormData.fields, this.fields);
    };
    PoDynamicFormComponent.prototype.updateModelWithValidation = function (formData) {
        Object.assign(this.value, formData.value);
        this.fields = this.validationService.updateFieldsForm(formData.fields, this.fields);
    };
    PoDynamicFormComponent.ctorParameters = function () { return [
        { type: ChangeDetectorRef },
        { type: PoDynamicFormLoadService },
        { type: PoDynamicFormValidationService }
    ]; };
    tslib_1.__decorate([
        ViewChild('dynamicForm', { static: false }),
        tslib_1.__metadata("design:type", NgForm),
        tslib_1.__metadata("design:paramtypes", [NgForm])
    ], PoDynamicFormComponent.prototype, "form", null);
    tslib_1.__decorate([
        ViewChild('fieldsComponent', { static: false }),
        tslib_1.__metadata("design:type", Object)
    ], PoDynamicFormComponent.prototype, "fieldsComponent", void 0);
    PoDynamicFormComponent = tslib_1.__decorate([
        Component({
            selector: 'po-dynamic-form',
            template: "\r\n<ng-container *ngIf=\"groupForm; then reuseFormTemplate; else uniqueFormTemplate\"></ng-container>\r\n\r\n<ng-template #reuseFormTemplate>\r\n\r\n  <po-dynamic-form-fields #fieldsComponent\r\n    [p-auto-focus]=\"autoFocus\"\r\n    [p-fields]=\"fields\"\r\n    [p-value]=\"value\">\r\n  </po-dynamic-form-fields>\r\n\r\n</ng-template>\r\n\r\n<ng-template #uniqueFormTemplate>\r\n\r\n  <form #dynamicForm=\"ngForm\">\r\n\r\n    <po-dynamic-form-fields #fieldsComponent\r\n      [(p-fields)]=\"fields\"\r\n      [p-auto-focus]=\"autoFocus\"\r\n      [p-disabled-form]=\"disabledForm\"\r\n      [p-validate]=\"validate\"\r\n      [p-value]=\"value\"\r\n      (p-form-validate)=\"validateForm($event)\">\r\n    </po-dynamic-form-fields>\r\n\r\n  </form>\r\n\r\n</ng-template>\r\n"
        }),
        tslib_1.__metadata("design:paramtypes", [ChangeDetectorRef,
            PoDynamicFormLoadService,
            PoDynamicFormValidationService])
    ], PoDynamicFormComponent);
    return PoDynamicFormComponent;
}(PoDynamicFormBaseComponent));
export { PoDynamicFormComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb3J0aW5hcmkvcG9ydGluYXJpLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZHluYW1pYy9wby1keW5hbWljLWZvcm0vcG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJeEMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHOUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0scURBQXFELENBQUM7QUFFL0YsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUVBQWlFLENBQUM7QUFFakg7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBTUg7SUFBNEMsa0RBQTBCO0lBd0JwRSxnQ0FDVSxPQUEwQixFQUMxQixXQUFxQyxFQUNyQyxpQkFBaUQ7UUFIM0QsWUFJRSxpQkFBTyxTQUNSO1FBSlMsYUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDMUIsaUJBQVcsR0FBWCxXQUFXLENBQTBCO1FBQ3JDLHVCQUFpQixHQUFqQixpQkFBaUIsQ0FBZ0M7O0lBRTNELENBQUM7SUFwQjRDLHNCQUFJLHdDQUFJO2FBU3JEO1lBQ0UsT0FBTyxJQUFJLENBQUMsS0FBSyxJQUFVLEVBQUUsQ0FBQztRQUNoQyxDQUFDO2FBWDRDLFVBQVMsS0FBYTtZQUFuRSxpQkFPQztZQU5DLDRFQUE0RTtZQUM1RSxVQUFVLENBQUM7Z0JBQ1QsS0FBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7Z0JBRW5CLEtBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7OztPQUFBO0lBZUQsNENBQVcsR0FBWDtRQUNFLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUQseUNBQVEsR0FBUjtRQUNFLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtZQUNiLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1NBQzdCO0lBQ0gsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7T0EyQkc7SUFDSCxzQ0FBSyxHQUFMLFVBQU0sUUFBZ0I7UUFDcEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELDZDQUFZLEdBQVosVUFBYSxLQUF5QjtRQUF0QyxpQkFTQztRQVJDLElBQU0sb0JBQW9CLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQztRQUVwRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZCLElBQU0saUJBQWlCLEdBQUcsY0FBTSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQXZCLENBQXVCLENBQUM7UUFFeEQsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxpQkFBaUI7YUFDL0MsY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUM7YUFDaEQsU0FBUyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFDbEYsQ0FBQztJQUVPLHVEQUFzQixHQUE5QixVQUErQixvQkFBNkI7UUFBNUQsaUJBTUM7UUFMQyxPQUFPLFVBQUEsZUFBZTtZQUNwQixLQUFJLENBQUMsaUJBQWlCLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDeEMsS0FBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN4QixLQUFJLENBQUMseUJBQXlCLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBQzlFLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFTyxvREFBbUIsR0FBM0IsVUFBNEIsb0JBQTZCO1FBQXpELGlCQU1DO1FBTEMsT0FBTyxVQUFBLGVBQWU7WUFDcEIsS0FBSSxDQUFDLHlCQUF5QixDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2hELEtBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDeEIsS0FBSSxDQUFDLHlCQUF5QixDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztRQUM5RSxDQUFDLENBQUM7SUFDSixDQUFDO0lBRU8sNENBQVcsR0FBbkIsVUFBb0IsS0FBYztRQUNoQyxJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFTyx5Q0FBUSxHQUFoQjtRQUNFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRTtZQUN2RCxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakM7SUFDSCxDQUFDO0lBRU8scURBQW9CLEdBQTVCO1FBQUEsaUJBU0M7UUFSQyxJQUFNLG9CQUFvQixHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUM7UUFFcEQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDekIsSUFBTSxXQUFXLEdBQUcsY0FBTSxPQUFBLEtBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxFQUF6QixDQUF5QixDQUFDO1FBRXBELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsV0FBVzthQUN2QyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDO2FBQ2xDLFNBQVMsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsb0JBQW9CLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMvRSxDQUFDO0lBRU8sZ0RBQWUsR0FBdkI7UUFDRSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUMzQixJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDdkM7UUFFRCxJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUM3QixJQUFJLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDekM7SUFDSCxDQUFDO0lBRU8sMERBQXlCLEdBQWpDLFVBQWtDLFFBQWdCLEVBQUUsb0JBQTZCO1FBQWpGLGlCQVFDO1FBUEMsSUFBSSxRQUFRLEVBQUU7WUFDWixzRkFBc0Y7WUFDdEYsdUhBQXVIO1lBQ3ZILFVBQVUsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBcEIsQ0FBb0IsQ0FBQyxDQUFDO1NBQ3hDO2FBQU07WUFDTCxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVPLGtEQUFpQixHQUF6QixVQUEwQixjQUFpQztRQUN6RCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyx5QkFBeUIsQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMvRixDQUFDO0lBRU8sMERBQXlCLEdBQWpDLFVBQWtDLFFBQWlDO1FBQ2pFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEYsQ0FBQzs7Z0JBN0hrQixpQkFBaUI7Z0JBQ2Isd0JBQXdCO2dCQUNsQiw4QkFBOEI7O0lBbEJkO1FBQTVDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7MENBQWlCLE1BQU07aURBQU4sTUFBTTtzREFPbEU7SUFNZ0Q7UUFBaEQsU0FBUyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzttRUFBd0Q7SUF0QjdGLHNCQUFzQjtRQUpsQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsaUJBQWlCO1lBQzNCLHV4QkFBK0M7U0FDaEQsQ0FBQztpREEwQm1CLGlCQUFpQjtZQUNiLHdCQUF3QjtZQUNsQiw4QkFBOEI7T0EzQmhELHNCQUFzQixDQXdKbEM7SUFBRCw2QkFBQztDQUFBLEFBeEpELENBQTRDLDBCQUEwQixHQXdKckU7U0F4Slksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBDaGFuZ2VEZXRlY3RvclJlZiwgT25EZXN0cm95LCBPbkluaXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBOZ0Zvcm0gfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcblxyXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1CYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tYmFzZS5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtRmllbGQgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1maWVsZC5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtTG9hZCB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLWxvYWQvcG8tZHluYW1pYy1mb3JtLWxvYWQuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUxvYWRTZXJ2aWNlIH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tbG9hZC9wby1keW5hbWljLWZvcm0tbG9hZC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybVZhbGlkYXRpb24gfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uU2VydmljZSB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24uc2VydmljZSc7XHJcblxyXG4vKipcclxuICogQGRvY3NFeHRlbmRzIFBvRHluYW1pY0Zvcm1CYXNlQ29tcG9uZW50XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqXHJcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1keW5hbWljLWZvcm0tYmFzaWNcIiB0aXRsZT1cIlBvcnRpbmFyaSBEeW5hbWljIEZvcm0gQmFzaWNcIj5cclxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tZHluYW1pYy1mb3JtLWJhc2ljL3NhbXBsZS1wby1keW5hbWljLWZvcm0tYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tYmFzaWMvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxyXG4gKiA8L2V4YW1wbGU+XHJcbiAqXHJcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1keW5hbWljLWZvcm0tcmVnaXN0ZXJcIiB0aXRsZT1cIlBvcnRpbmFyaSBEeW5hbWljIEZvcm0gLSBSZWdpc3RlclwiPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyLnNlcnZpY2UudHNcIj4gPC9maWxlPlxyXG4gKiA8L2V4YW1wbGU+XHJcbiAqL1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdwby1keW5hbWljLWZvcm0nLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1keW5hbWljLWZvcm0uY29tcG9uZW50Lmh0bWwnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb0R5bmFtaWNGb3JtQ29tcG9uZW50IGV4dGVuZHMgUG9EeW5hbWljRm9ybUJhc2VDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcblxyXG4gIHByaXZhdGUgX2Zvcm06IE5nRm9ybTtcclxuXHJcbiAgZGlzYWJsZWRGb3JtOiBib29sZWFuO1xyXG5cclxuICBwcml2YXRlIG9uTG9hZFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgc2VuZEZvcm1TdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgQFZpZXdDaGlsZCgnZHluYW1pY0Zvcm0nLCB7IHN0YXRpYzogZmFsc2UgfSkgc2V0IGZvcm0odmFsdWU6IE5nRm9ybSkge1xyXG4gICAgLy8gbmVjZXNzYXJpbyBwYXJhIG5hbyBvY29ycmVyIG8gRXhwcmVzc2lvbkNoYW5nZWRBZnRlckl0SGFzQmVlbkNoZWNrZWRFcnJvclxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIHRoaXMuX2Zvcm0gPSB2YWx1ZTtcclxuXHJcbiAgICAgIHRoaXMuZW1pdEZvcm0oKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGZvcm0oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fZm9ybSB8fCA8YW55PiB7fTtcclxuICB9XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ2ZpZWxkc0NvbXBvbmVudCcsIHsgc3RhdGljOiBmYWxzZSB9KSBmaWVsZHNDb21wb25lbnQ6IHsgZm9jdXM6IChwcm9wZXJ0eTogc3RyaW5nKSA9PiB2b2lkIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBjaGFuZ2VzOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIHByaXZhdGUgbG9hZFNlcnZpY2U6IFBvRHluYW1pY0Zvcm1Mb2FkU2VydmljZSxcclxuICAgIHByaXZhdGUgdmFsaWRhdGlvblNlcnZpY2U6IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uU2VydmljZSkge1xyXG4gICAgc3VwZXIoKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnMoKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgaWYgKHRoaXMubG9hZCkge1xyXG4gICAgICB0aGlzLmxvYWREYXRhT25Jbml0aWFsaXplKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGdW7Dp8OjbyBxdWUgYXRyaWJ1aSBmb2NvIGFvIGNhbXBvIGRlc2VqYWRvLlxyXG4gICAqXHJcbiAgICogUGFyYSB1dGlsaXrDoS1sYSDDqSBuZWNlc3PDoXJpbyBjYXB0dXJhciBhIGluc3TDom5jaWEgZG8gYGR5bmFtaWMgZm9ybWAsIGNvbW8gcG9yIGV4ZW1wbG86XHJcbiAgICpcclxuICAgKiBgYGAgaHRtbFxyXG4gICAqIDxwby1keW5hbWljLWZvcm0gI2R5bmFtaWNGb3JtIFtwLWZpZWxkc109XCJmaWVsZHNcIj48L3BvLWR5bmFtaWMtZm9ybT5cclxuICAgKiBgYGBcclxuICAgKlxyXG4gICAqIGBgYCBqYXZhc2NyaXB0XHJcbiAgICogaW1wb3J0IHsgUG9EeW5hbWljRm9ybUNvbXBvbmVudCwgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnQHBvcnRpbmFyaS9wb3J0aW5hcmktdWknO1xyXG4gICAqXHJcbiAgICogLi4uXHJcbiAgICpcclxuICAgKiBAVmlld0NoaWxkKCdkeW5hbWljRm9ybScsIHsgc3RhdGljOiB0cnVlIH0pIGR5bmFtaWNGb3JtOiBQb0R5bmFtaWNGb3JtQ29tcG9uZW50O1xyXG4gICAqXHJcbiAgICogZmllbGRzOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+ID0gW1xyXG4gICAqICAgeyBwcm9wZXJ0eTogJ2ZpZWxkT25lJyB9LFxyXG4gICAqICAgeyBwcm9wZXJ0eTogJ2ZpZWxkVHdvJyB9XHJcbiAgICogXTtcclxuICAgKlxyXG4gICAqIGZpZWxkRm9jdXMoKSB7XHJcbiAgICogICB0aGlzLmR5bmFtaWNGb3JtLmZvY3VzKCdmaWVsZFR3bycpO1xyXG4gICAqIH1cclxuICAgKiBgYGBcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBOb21lIGRhIHByb3ByaWVkYWRlIGF0cmlidcOtZGEgYW8gYFBvRHluYW1pY0Zvcm1GaWVsZC5wcm9wZXJ0eWAuXHJcbiAgICovXHJcbiAgZm9jdXMocHJvcGVydHk6IHN0cmluZykge1xyXG4gICAgdGhpcy5maWVsZHNDb21wb25lbnQuZm9jdXMocHJvcGVydHkpO1xyXG4gIH1cclxuXHJcbiAgdmFsaWRhdGVGb3JtKGZpZWxkOiBQb0R5bmFtaWNGb3JtRmllbGQpIHtcclxuICAgIGNvbnN0IHByZXZpb3VzRm9jdXNFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcclxuXHJcbiAgICB0aGlzLmRpc2FibGVGb3JtKHRydWUpO1xyXG4gICAgY29uc3QgZXJyb3JPblZhbGlkYXRpb24gPSAoKSA9PiB0aGlzLmRpc2FibGVGb3JtKGZhbHNlKTtcclxuXHJcbiAgICB0aGlzLnNlbmRGb3JtU3Vic2NyaXB0aW9uID0gdGhpcy52YWxpZGF0aW9uU2VydmljZVxyXG4gICAgICAuc2VuZEZvcm1DaGFuZ2UodGhpcy52YWxpZGF0ZSwgZmllbGQsIHRoaXMudmFsdWUpXHJcbiAgICAgIC5zdWJzY3JpYmUodGhpcy5hcHBseUZvcm1WYWxpZGF0aW9uKHByZXZpb3VzRm9jdXNFbGVtZW50KSwgZXJyb3JPblZhbGlkYXRpb24pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhcHBseUZvcm1VcGRhdGVzT25Mb2FkKHByZXZpb3VzRm9jdXNFbGVtZW50OiBFbGVtZW50KTogKGR5bmFtaWNGb3JtRGF0YTogUG9EeW5hbWljRm9ybUxvYWQpID0+IHZvaWQge1xyXG4gICAgcmV0dXJuIGR5bmFtaWNGb3JtRGF0YSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlTW9kZWxPbkxvYWQoZHluYW1pY0Zvcm1EYXRhKTtcclxuICAgICAgdGhpcy5kaXNhYmxlRm9ybShmYWxzZSk7XHJcbiAgICAgIHRoaXMuc2V0Rm9jdXNPbkZpZWxkQnlQcm9wZXJ0eShkeW5hbWljRm9ybURhdGEuZm9jdXMsIHByZXZpb3VzRm9jdXNFbGVtZW50KTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFwcGx5Rm9ybVZhbGlkYXRpb24ocHJldmlvdXNGb2N1c0VsZW1lbnQ6IEVsZW1lbnQpOiAoZHluYW1pY0Zvcm1EYXRhOiBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvbikgPT4gdm9pZCB7XHJcbiAgICByZXR1cm4gZHluYW1pY0Zvcm1EYXRhID0+IHtcclxuICAgICAgdGhpcy51cGRhdGVNb2RlbFdpdGhWYWxpZGF0aW9uKGR5bmFtaWNGb3JtRGF0YSk7XHJcbiAgICAgIHRoaXMuZGlzYWJsZUZvcm0oZmFsc2UpO1xyXG4gICAgICB0aGlzLnNldEZvY3VzT25GaWVsZEJ5UHJvcGVydHkoZHluYW1pY0Zvcm1EYXRhLmZvY3VzLCBwcmV2aW91c0ZvY3VzRWxlbWVudCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkaXNhYmxlRm9ybSh2YWx1ZTogYm9vbGVhbikge1xyXG4gICAgdGhpcy5kaXNhYmxlZEZvcm0gPSB2YWx1ZTtcclxuICAgIHRoaXMuY2hhbmdlcy5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGVtaXRGb3JtKCkge1xyXG4gICAgaWYgKCF0aGlzLmdyb3VwRm9ybSAmJiB0aGlzLmZvcm1PdXRwdXQub2JzZXJ2ZXJzLmxlbmd0aCkge1xyXG4gICAgICB0aGlzLmZvcm1PdXRwdXQuZW1pdCh0aGlzLmZvcm0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBsb2FkRGF0YU9uSW5pdGlhbGl6ZSgpIHtcclxuICAgIGNvbnN0IHByZXZpb3VzRm9jdXNFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcclxuXHJcbiAgICB0aGlzLmRpc2FibGVkRm9ybSA9IHRydWU7XHJcbiAgICBjb25zdCBlcnJvck9uTG9hZCA9ICgpID0+IHRoaXMuZGlzYWJsZWRGb3JtID0gZmFsc2U7XHJcblxyXG4gICAgdGhpcy5vbkxvYWRTdWJzY3JpcHRpb24gPSB0aGlzLmxvYWRTZXJ2aWNlXHJcbiAgICAgIC5leGVjdXRlTG9hZCh0aGlzLmxvYWQsIHRoaXMudmFsdWUpXHJcbiAgICAgIC5zdWJzY3JpYmUodGhpcy5hcHBseUZvcm1VcGRhdGVzT25Mb2FkKHByZXZpb3VzRm9jdXNFbGVtZW50KSwgZXJyb3JPbkxvYWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW1vdmVMaXN0ZW5lcnMoKSB7XHJcbiAgICBpZiAodGhpcy5vbkxvYWRTdWJzY3JpcHRpb24pIHtcclxuICAgICAgdGhpcy5vbkxvYWRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5zZW5kRm9ybVN1YnNjcmlwdGlvbikge1xyXG4gICAgICB0aGlzLnNlbmRGb3JtU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldEZvY3VzT25GaWVsZEJ5UHJvcGVydHkocHJvcGVydHk6IHN0cmluZywgcHJldmlvdXNGb2N1c0VsZW1lbnQ6IEVsZW1lbnQpIHtcclxuICAgIGlmIChwcm9wZXJ0eSkge1xyXG4gICAgICAvLyBwcmVjaXNhIGRvIHRpbWVvdXQgcGFyYSBxdWUgbyB2YWxvciBzZWphIGF0cmlidWlkbyBubyBjYW1wbyBhbnRlcyBkZSBzZXRhciBvIGZvY3VzLFxyXG4gICAgICAvLyBwYXJhIG5hbyBkaXNwYXJhciBhIG11ZGFuw6dhIHBvc3Rlcmlvcm1lbnRlLiBTaXR1YcOnw6NvIG9jb3JyZSBxdWFuZG8gcmV0b3JuYXIgY2FtcG8gY29tIHZhbG9yIGUgZm9jdXMgYXRyaWJ1aWRvIGEgZWxlLlxyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZm9jdXMocHJvcGVydHkpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHByZXZpb3VzRm9jdXNFbGVtZW50Wydmb2N1cyddKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZU1vZGVsT25Mb2FkKGxvYWRlZEZvcm1EYXRhOiBQb0R5bmFtaWNGb3JtTG9hZCkge1xyXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnZhbHVlLCBsb2FkZWRGb3JtRGF0YS52YWx1ZSk7XHJcbiAgICB0aGlzLmZpZWxkcyA9IHRoaXMubG9hZFNlcnZpY2UuY3JlYXRlQW5kVXBkYXRlRmllbGRzRm9ybShsb2FkZWRGb3JtRGF0YS5maWVsZHMsIHRoaXMuZmllbGRzKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlTW9kZWxXaXRoVmFsaWRhdGlvbihmb3JtRGF0YTogUG9EeW5hbWljRm9ybVZhbGlkYXRpb24pIHtcclxuICAgIE9iamVjdC5hc3NpZ24odGhpcy52YWx1ZSwgZm9ybURhdGEudmFsdWUpO1xyXG4gICAgdGhpcy5maWVsZHMgPSB0aGlzLnZhbGlkYXRpb25TZXJ2aWNlLnVwZGF0ZUZpZWxkc0Zvcm0oZm9ybURhdGEuZmllbGRzLCB0aGlzLmZpZWxkcyk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=