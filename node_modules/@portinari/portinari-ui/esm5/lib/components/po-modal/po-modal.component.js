import * as tslib_1 from "tslib";
import { ChangeDetectorRef, Component, ElementRef, Renderer2, ViewChild } from '@angular/core';
import { v4 as uuid } from 'uuid';
import { PoModalBaseComponent } from './po-modal-base.component';
import { PoModalService } from './po-modal-service';
/**
 * @docsExtends PoModalBaseComponent
 *
 * @example
 *
 * <example name="po-modal-basic" title="Portinari Modal Basic">
 *  <file name="sample-po-modal-basic/sample-po-modal-basic.component.html"> </file>
 *  <file name="sample-po-modal-basic/sample-po-modal-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-modal-labs" title="Portinari Modal Labs">
 *  <file name="sample-po-modal-labs/sample-po-modal-labs.component.html"> </file>
 *  <file name="sample-po-modal-labs/sample-po-modal-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-modal-fruits-salad" title="Portinari Modal - Fruits Salad">
 *  <file name="sample-po-modal-fruits-salad/sample-po-modal-fruits-salad.component.html"> </file>
 *  <file name="sample-po-modal-fruits-salad/sample-po-modal-fruits-salad.component.ts"> </file>
 * </example>
 */
var PoModalComponent = /** @class */ (function (_super) {
    tslib_1.__extends(PoModalComponent, _super);
    function PoModalComponent(poModalService, renderer, changeDetector) {
        var _this = _super.call(this) || this;
        _this.poModalService = poModalService;
        _this.renderer = renderer;
        _this.changeDetector = changeDetector;
        _this.focusableElements = 'input, select, textarea, button:not([disabled]), a';
        _this.id = uuid();
        return _this;
    }
    PoModalComponent.prototype.close = function (xClosed) {
        if (xClosed === void 0) { xClosed = false; }
        this.poModalService.modalActive = undefined;
        _super.prototype.close.call(this, xClosed);
        this.removeEventListeners();
        if (this.sourceElement) {
            this.sourceElement.focus();
        }
    };
    PoModalComponent.prototype.closeModalOnEscapeKey = function (event) {
        if (!this.hideClose) {
            event.preventDefault();
            event.stopPropagation();
            this.close();
        }
    };
    PoModalComponent.prototype.getPrimaryActionButtonType = function () {
        return this.primaryAction.danger ? 'danger' : 'primary';
    };
    PoModalComponent.prototype.getSecondaryActionButtonType = function () {
        return this.secondaryAction && this.secondaryAction.danger && !this.primaryAction.danger ? 'danger' : 'default';
    };
    PoModalComponent.prototype.onClickOut = function (event) {
        if (this.clickOut && !this.modalContent.nativeElement.contains(event.target)) {
            this.close();
        }
    };
    PoModalComponent.prototype.open = function () {
        this.sourceElement = document.activeElement;
        _super.prototype.open.call(this);
        this.handleFocus();
    };
    PoModalComponent.prototype.handleFocus = function () {
        var _this = this;
        this.poModalService.modalActive = this.id;
        setTimeout(function () {
            if (_this.modalContent) {
                _this.initFocus();
                document.addEventListener('focus', _this.focusFunction, true);
            }
        });
    };
    PoModalComponent.prototype.initFocus = function () {
        var _this = this;
        this.focusFunction = function (event) {
            _this.poModalService.modalActive = _this.poModalService.modalActive || _this.id;
            var modalElement = _this.modalContent.nativeElement;
            if (!modalElement.contains(event.target) && _this.poModalService.modalActive === _this.id) {
                event.stopPropagation();
                _this.firstElement.focus();
            }
        };
        this.setFirstElement();
        if (this.hideClose) {
            this.firstElement.focus();
        }
        else {
            var firstFieldElement = this.modalContent.nativeElement.querySelectorAll(this.focusableElements)[1] ||
                this.modalContent.nativeElement;
            firstFieldElement.focus();
        }
    };
    PoModalComponent.prototype.removeEventListeners = function () {
        document.removeEventListener('focus', this.focusFunction, true);
    };
    PoModalComponent.prototype.setFirstElement = function () {
        this.firstElement = this.modalContent.nativeElement.querySelector(this.focusableElements) || this.modalContent.nativeElement;
    };
    PoModalComponent.ctorParameters = function () { return [
        { type: PoModalService },
        { type: Renderer2 },
        { type: ChangeDetectorRef }
    ]; };
    tslib_1.__decorate([
        ViewChild('modalContent', { read: ElementRef, static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], PoModalComponent.prototype, "modalContent", void 0);
    PoModalComponent = tslib_1.__decorate([
        Component({
            selector: 'po-modal',
            template: "<div *ngIf=\"!isHidden\"\n  class=\"po-modal\"\n  tabindex=\"0\"\n  (keydown.esc)=\"closeModalOnEscapeKey($event)\">\n\n  <div class=\"po-modal-overlay\">\n    <div class=\"po-modal-container po-pb-2 po-pt-2\" (mousedown)=\"onClickOut($event)\">\n\n      <div class=\"po-modal-vertical-align\">\n        <div #modalContent\n          class=\"po-modal-content po-modal-{{ size }}\"\n          tabindex=\"-1\">\n\n          <div class=\"po-modal-header\">\n            <div class=\"po-modal-title po-text-ellipsis\">\n              {{ title }}\n            </div>\n\n            <a *ngIf=\"!hideClose\"\n              class=\"po-modal-header-close-button\"\n              tabindex=\"0\"\n              (click)=\"close(true)\">\n              <span class=\"po-icon po-icon-close\"></span>\n            </a>\n          </div>\n\n          <div class=\"po-modal-body\">\n            <ng-content></ng-content>\n          </div>\n\n          <div class=\"po-modal-footer\">\n            <po-button *ngIf=\"secondaryAction\"\n              [p-disabled]=\"secondaryAction.disabled\"\n              [p-label]=\"secondaryAction.label\"\n              [p-loading]=\"secondaryAction.loading\"\n              [p-type]=\"getSecondaryActionButtonType()\"\n              (p-click)=\"secondaryAction.action()\">\n            </po-button>\n\n            <po-button\n              class=\"po-button-modal-first-action\"\n              [p-disabled]=\"primaryAction.disabled\"\n              [p-label]=\"primaryAction.label\"\n              [p-loading]=\"primaryAction.loading\"\n              [p-type]=\"getPrimaryActionButtonType()\"\n              (p-click)=\"primaryAction.action()\">\n            </po-button>\n          </div>\n\n        </div>\n      </div>\n\n    </div>\n  </div>\n</div>\n\n"
        }),
        tslib_1.__metadata("design:paramtypes", [PoModalService, Renderer2, ChangeDetectorRef])
    ], PoModalComponent);
    return PoModalComponent;
}(PoModalBaseComponent));
export { PoModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvcnRpbmFyaS9wb3J0aW5hcmktdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby1tb2RhbC9wby1tb2RhbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFL0YsT0FBTyxFQUFFLEVBQUUsSUFBSSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXBEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBbUJHO0FBTUg7SUFBc0MsNENBQW9CO0lBWXhELDBCQUFvQixjQUE4QixFQUFVLFFBQW1CLEVBQVUsY0FBaUM7UUFBMUgsWUFDRSxpQkFBTyxTQUNSO1FBRm1CLG9CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUFVLGNBQVEsR0FBUixRQUFRLENBQVc7UUFBVSxvQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUFObEgsdUJBQWlCLEdBQUcsb0RBQW9ELENBQUM7UUFDekUsUUFBRSxHQUFXLElBQUksRUFBRSxDQUFDOztJQU81QixDQUFDO0lBRUQsZ0NBQUssR0FBTCxVQUFNLE9BQWU7UUFBZix3QkFBQSxFQUFBLGVBQWU7UUFDbkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEdBQUcsU0FBUyxDQUFDO1FBRTVDLGlCQUFNLEtBQUssWUFBQyxPQUFPLENBQUMsQ0FBQztRQUVyQixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUU1QixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUM1QjtJ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LGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRU8sMENBQWUsR0FBdkI7UUFDRSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQztJQUMvSCxDQUFDOztnQkF0Rm1DLGNBQWM7Z0JBQW9CLFNBQVM7Z0JBQTBCLGlCQUFpQjs7SUFWMUQ7UUFBL0QsU0FBUyxDQUFDLGNBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzBDQUFlLFVBQVU7MERBQUM7SUFGOUUsZ0JBQWdCO1FBSjVCLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxVQUFVO1lBQ3BCLDh2REFBd0M7U0FDekMsQ0FBQztpREFhb0MsY0FBYyxFQUFvQixTQUFTLEVBQTBCLGlCQUFpQjtPQVovRyxnQkFBZ0IsQ0FvRzVCO0lBQUQsdUJBQUM7Q0FBQSxBQXBHRCxDQUFzQyxvQkFBb0IsR0FvR3pEO1NBcEdZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IHY0IGFzIHV1aWQgfSBmcm9tICd1dWlkJztcblxuaW1wb3J0IHsgUG9Nb2RhbEJhc2VDb21wb25lbnQgfSBmcm9tICcuL3BvLW1vZGFsLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IFBvTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi9wby1tb2RhbC1zZXJ2aWNlJztcblxuLyoqXG4gKiBAZG9jc0V4dGVuZHMgUG9Nb2RhbEJhc2VDb21wb25lbnRcbiAqXG4gKiBAZXhhbXBsZVxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1tb2RhbC1iYXNpY1wiIHRpdGxlPVwiUG9ydGluYXJpIE1vZGFsIEJhc2ljXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1tb2RhbC1iYXNpYy9zYW1wbGUtcG8tbW9kYWwtYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tbW9kYWwtYmFzaWMvc2FtcGxlLXBvLW1vZGFsLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLW1vZGFsLWxhYnNcIiB0aXRsZT1cIlBvcnRpbmFyaSBNb2RhbCBMYWJzXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1tb2RhbC1sYWJzL3NhbXBsZS1wby1tb2RhbC1sYWJzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLW1vZGFsLWxhYnMvc2FtcGxlLXBvLW1vZGFsLWxhYnMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tbW9kYWwtZnJ1aXRzLXNhbGFkXCIgdGl0bGU9XCJQb3J0aW5hcmkgTW9kYWwgLSBGcnVpdHMgU2FsYWRcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLW1vZGFsLWZydWl0cy1zYWxhZC9zYW1wbGUtcG8tbW9kYWwtZnJ1aXRzLXNhbGFkLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLW1vZGFsLWZydWl0cy1zYWxhZC9zYW1wbGUtcG8tbW9kYWwtZnJ1aXRzLXNhbGFkLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKi9cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tbW9kYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tbW9kYWwuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvTW9kYWxDb21wb25lbnQgZXh0ZW5kcyBQb01vZGFsQmFzZUNvbXBvbmVudCB7XG5cbiAgQFZpZXdDaGlsZCgnbW9kYWxDb250ZW50JywgeyByZWFkOiBFbGVtZW50UmVmLCBzdGF0aWM6IGZhbHNlIH0pIG1vZGFsQ29udGVudDogRWxlbWVudFJlZjtcblxuICBwcml2YXRlIGZpcnN0RWxlbWVudDtcbiAgcHJpdmF0ZSBmb2N1c0Z1bmN0aW9uO1xuICBwcml2YXRlIGZvY3VzYWJsZUVsZW1lbnRzID0gJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBidXR0b246bm90KFtkaXNhYmxlZF0pLCBhJztcbiAgcHJpdmF0ZSBpZDogc3RyaW5nID0gdXVpZCgpO1xuICBwcml2YXRlIHNvdXJjZUVsZW1lbnQ7XG5cbiAgb25SZXNpemVMaXN0ZW5lcjogKCkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBvTW9kYWxTZXJ2aWNlOiBQb01vZGFsU2VydmljZSwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLCBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZikge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBjbG9zZSh4Q2xvc2VkID0gZmFsc2UpIHtcbiAgICB0aGlzLnBvTW9kYWxTZXJ2aWNlLm1vZGFsQWN0aXZlID0gdW5kZWZpbmVkO1xuXG4gICAgc3VwZXIuY2xvc2UoeENsb3NlZCk7XG5cbiAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXJzKCk7XG5cbiAgICBpZiAodGhpcy5zb3VyY2VFbGVtZW50KSB7XG4gICAgICB0aGlzLnNvdXJjZUVsZW1lbnQuZm9jdXMoKTtcbiAgICB9XG4gIH1cblxuICBjbG9zZU1vZGFsT25Fc2NhcGVLZXkoZXZlbnQpIHtcbiAgICBpZiAoIXRoaXMuaGlkZUNsb3NlKSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0UHJpbWFyeUFjdGlvbkJ1dHRvblR5cGUoKSB7XG4gICAgcmV0dXJuIHRoaXMucHJpbWFyeUFjdGlvbi5kYW5nZXIgPyAnZGFuZ2VyJyA6ICdwcmltYXJ5JztcbiAgfVxuXG4gIGdldFNlY29uZGFyeUFjdGlvbkJ1dHRvblR5cGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2Vjb25kYXJ5QWN0aW9uICYmIHRoaXMuc2Vjb25kYXJ5QWN0aW9uLmRhbmdlciAmJiAhdGhpcy5wcmltYXJ5QWN0aW9uLmRhbmdlciA/ICdkYW5nZXInIDogJ2RlZmF1bHQnO1xuICB9XG5cbiAgb25DbGlja091dChldmVudCkge1xuICAgIGlmICh0aGlzLmNsaWNrT3V0ICYmICF0aGlzLm1vZGFsQ29udGVudC5uYXRpdmVFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkpIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICBvcGVuKCkge1xuICAgIHRoaXMuc291cmNlRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG5cbiAgICBzdXBlci5vcGVuKCk7XG5cbiAgICB0aGlzLmhhbmRsZUZvY3VzKCk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUZvY3VzKCk6IGFueSB7XG4gICAgdGhpcy5wb01vZGFsU2VydmljZS5tb2RhbEFjdGl2ZSA9IHRoaXMuaWQ7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGlmICh0aGlzLm1vZGFsQ29udGVudCkge1xuICAgICAgICB0aGlzLmluaXRGb2N1cygpO1xuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmb2N1cycsIHRoaXMuZm9jdXNGdW5jdGlvbiwgdHJ1ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGluaXRGb2N1cygpIHtcbiAgICB0aGlzLmZvY3VzRnVuY3Rpb24gPSAoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgdGhpcy5wb01vZGFsU2VydmljZS5tb2RhbEFjdGl2ZSA9IHRoaXMucG9Nb2RhbFNlcnZpY2UubW9kYWxBY3RpdmUgfHwgdGhpcy5pZDtcbiAgICAgIGNvbnN0IG1vZGFsRWxlbWVudCA9IHRoaXMubW9kYWxDb250ZW50Lm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICAgIGlmICghbW9kYWxFbGVtZW50LmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgJiYgdGhpcy5wb01vZGFsU2VydmljZS5tb2RhbEFjdGl2ZSA9PT0gdGhpcy5pZCkge1xuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5maXJzdEVsZW1lbnQuZm9jdXMoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5zZXRGaXJzdEVsZW1lbnQoKTtcblxuICAgIGlmICh0aGlzLmhpZGVDbG9zZSkge1xuICAgICAgdGhpcy5maXJzdEVsZW1lbnQuZm9jdXMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZmlyc3RGaWVsZEVsZW1lbnQgPVxuICAgICAgICB0aGlzLm1vZGFsQ29udGVudC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGhpcy5mb2N1c2FibGVFbGVtZW50cylbMV0gfHxcbiAgICAgICAgdGhpcy5tb2RhbENvbnRlbnQubmF0aXZlRWxlbWVudDtcbiAgICAgIGZpcnN0RmllbGRFbGVtZW50LmZvY3VzKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFdmVudExpc3RlbmVycygpIHtcbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdmb2N1cycsIHRoaXMuZm9jdXNGdW5jdGlvbiwgdHJ1ZSk7XG4gIH1cblxuICBwcml2YXRlIHNldEZpcnN0RWxlbWVudCgpIHtcbiAgICB0aGlzLmZpcnN0RWxlbWVudCA9IHRoaXMubW9kYWxDb250ZW50Lm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLmZvY3VzYWJsZUVsZW1lbnRzKSB8fCB0aGlzLm1vZGFsQ29udGVudC5uYXRpdmVFbGVtZW50O1xuICB9XG5cbn1cbiJdfQ==