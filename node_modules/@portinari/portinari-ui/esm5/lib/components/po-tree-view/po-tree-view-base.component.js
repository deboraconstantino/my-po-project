import * as tslib_1 from "tslib";
import { EventEmitter, Input, Output } from '@angular/core';
import { convertToBoolean } from '../../utils/util';
var poTreeViewMaxLevel = 4;
/**
 * @description
 *
 * O componente fornece um modelo de visualização em árvore, possibilitando a visualização das informações de maneira
 * hierárquica, desta forma sendo possível utilizar até 4 níveis.
 *
 * Nele é possível navegar entre os itens através da tecla *tab*, permitindo expandir ou colapsar o item em foco
 * por meio das teclas *enter* e *space*.
 *
 * Além da navegação, o componente possibilita também a seleção dos itens do primeiro ao último nível, tanto de forma parcial como completa.
 *
 * O componente também possui eventos disparados ao marcar/desmarcar e expandir/colapsar os itens.
 */
var PoTreeViewBaseComponent = /** @class */ (function () {
    function PoTreeViewBaseComponent() {
        this._items = [];
        this._selectable = false;
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao colapsar um item.
         *
         * > Como parâmetro o componente envia o item colapsado.
         */
        this.collapsed = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao expandir um item.
         *
         * > Como parâmetro o componente envia o item expandido.
         */
        this.expanded = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao selecionar um item.
         *
         * > Como parâmetro o componente envia o item selecionado.
         */
        this.selected = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao desfazer a seleção de um item.
         *
         * > Como parâmetro o componente envia o item que foi desmarcado.
         */
        this.unselected = new EventEmitter();
    }
    Object.defineProperty(PoTreeViewBaseComponent.prototype, "items", {
        get: function () {
            return this._items;
        },
        /**
         * Lista de itens do tipo `PoTreeViewItem` que será renderizada pelo componente.
         */
        set: function (value) {
            this._items = Array.isArray(value) ? this.getItemsByMaxLevel(value) : [];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoTreeViewBaseComponent.prototype, "selectable", {
        get: function () {
            return this._selectable;
        },
        /**
         * @optional
         *
         * @description
         *
         * Habilita uma caixa de seleção para selecionar e/ou desmarcar um item da lista.
         *
         * @default false
         */
        set: function (value) {
            this._selectable = convertToBoolean(value);
        },
        enumerable: true,
        configurable: true
    });
    PoTreeViewBaseComponent.prototype.emitExpanded = function (treeViewItem) {
        var event = treeViewItem.expanded ? 'expanded' : 'collapsed';
        this[event].emit(tslib_1.__assign({}, treeViewItem));
    };
    PoTreeViewBaseComponent.prototype.emitSelected = function (treeViewItem) {
        var event = treeViewItem.selected ? 'selected' : 'unselected';
        this.updateItemsOnSelect(treeViewItem);
        this[event].emit(tslib_1.__assign({}, treeViewItem));
    };
    PoTreeViewBaseComponent.prototype.addChildItemInParent = function (childItem, parentItem) {
        if (!parentItem.subItems) {
            parentItem.subItems = [];
        }
        parentItem.subItems.push(childItem);
    };
    // caso houver parentItem:
    //  - expande o parentItem caso o filho estiver expandido;
    //  - adiciona o childItem no parentItem;
    //  - marca o parentItem caso conter subItems marcodos ou nulos;
    // Se não conter parentItem, adiciona o childItem no items.
    PoTreeViewBaseComponent.prototype.addItem = function (items, childItem, parentItem) {
        if (parentItem) {
            this.expandParentItem(childItem, parentItem);
            this.addChildItemInParent(childItem, parentItem);
            this.selectItemBySubItems(parentItem);
            items.push(parentItem);
        }
        else {
            items.push(childItem);
        }
    };
    PoTreeViewBaseComponent.prototype.selectAllItems = function (items, isSelected) {
        var _this = this;
        items.forEach(function (item) {
            if (item.subItems) {
                _this.selectAllItems(item.subItems, isSelected);
            }
            item.selected = isSelected;
        });
    };
    PoTreeViewBaseComponent.prototype.selectItemBySubItems = function (item) {
        item.selected = this.everyItemSelected(item.subItems);
    };
    // retornará:
    //  - true: se todos os items estiverem marcados;
    //  - null: se no minimo um item esteja marcado ou nullo (indeterminate)
    //  - false: caso não corresponda em nenhuma das opções acima, no caso, nenhum marcado ou nulo;
    PoTreeViewBaseComponent.prototype.everyItemSelected = function (items) {
        if (items === void 0) { items = []; }
        var itemsLength = items.length;
        var lengthCheckedItems = items.filter(function (item) { return item.selected; }).length;
        if (itemsLength && itemsLength === lengthCheckedItems) {
            return true;
        }
        var hasIndeterminateItems = items.filter(function (item) { return item.selected || item.selected === null; }).length;
        if (hasIndeterminateItems) {
            return null;
        }
        return false;
    };
    // expande o item pai caso o filho estiver expandido.
    PoTreeViewBaseComponent.prototype.expandParentItem = function (childItem, parentItem) {
        if (childItem.expanded) {
            parentItem.expanded = true;
        }
    };
    PoTreeViewBaseComponent.prototype.getItemsByMaxLevel = function (items, level, parentItem, newItems) {
        var _this = this;
        if (items === void 0) { items = []; }
        if (level === void 0) { level = 0; }
        if (newItems === void 0) { newItems = []; }
        items.forEach(function (item) {
            var subItems = item.subItems, currentItem = tslib_1.__rest(item, ["subItems"]);
            if (level === poTreeViewMaxLevel) {
                return;
            }
            if (Array.isArray(subItems)) {
                // caso um item pai iniciar selecionado, deve selecionar os filhos.
                if (currentItem.selected) {
                    _this.selectAllItems(subItems, currentItem.selected);
                }
                _this.getItemsByMaxLevel(subItems, ++level, currentItem);
                --level;
            }
            _this.addItem(newItems, currentItem, parentItem);
        });
        return newItems;
    };
    PoTreeViewBaseComponent.prototype.getItemsWithParentSelected = function (items, parentItem, newItems) {
        var _this = this;
        if (items === void 0) { items = []; }
        if (newItems === void 0) { newItems = []; }
        items.forEach(function (item) {
            var subItems = item.subItems, currentItem = tslib_1.__rest(item, ["subItems"]);
            if (Array.isArray(subItems)) {
                _this.getItemsWithParentSelected(subItems, currentItem);
            }
            _this.addItem(newItems, currentItem, parentItem);
        });
        return newItems;
    };
    PoTreeViewBaseComponent.prototype.updateItemsOnSelect = function (selectedItem) {
        if (selectedItem.subItems) {
            this.selectAllItems(selectedItem.subItems, selectedItem.selected);
        }
        this._items = this.getItemsWithParentSelected(this.items);
    };
    tslib_1.__decorate([
        Input('p-items'),
        tslib_1.__metadata("design:type", Array),
        tslib_1.__metadata("design:paramtypes", [Array])
    ], PoTreeViewBaseComponent.prototype, "items", null);
    tslib_1.__decorate([
        Input('p-selectable'),
        tslib_1.__metadata("design:type", Boolean),
        tslib_1.__metadata("design:paramtypes", [Boolean])
    ], PoTreeViewBaseComponent.prototype, "selectable", null);
    tslib_1.__decorate([
        Output('p-collapsed'),
        tslib_1.__metadata("design:type", Object)
    ], PoTreeViewBaseComponent.prototype, "collapsed", void 0);
    tslib_1.__decorate([
        Output('p-expanded'),
        tslib_1.__metadata("design:type", Object)
    ], PoTreeViewBaseComponent.prototype, "expanded", void 0);
    tslib_1.__decorate([
        Output('p-selected'),
        tslib_1.__metadata("design:type", Object)
    ], PoTreeViewBaseComponent.prototype, "selected", void 0);
    tslib_1.__decorate([
        Output('p-unselected'),
        tslib_1.__metadata("design:type", Object)
    ], PoTreeViewBaseComponent.prototype, "unselected", void 0);
    return PoTreeViewBaseComponent;
}());
export { PoTreeViewBaseComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdHJlZS12aWV3LWJhc2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvcnRpbmFyaS9wb3J0aW5hcmktdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby10cmVlLXZpZXcvcG8tdHJlZS12aWV3LWJhc2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFNUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFJcEQsSUFBTSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFFN0I7Ozs7Ozs7Ozs7OztHQVlHO0FBQ0g7SUFBQTtRQUVVLFdBQU0sR0FBMEIsRUFBRSxDQUFDO1FBQ25DLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBOEJyQzs7Ozs7Ozs7V0FRRztRQUNvQixjQUFTLEdBQUcsSUFBSSxZQUFZLEVBQWtCLENBQUM7UUFFdEU7Ozs7Ozs7O1dBUUc7UUFDbUIsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFrQixDQUFDO1FBRXBFOzs7Ozs7OztXQVFHO1FBQ21CLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBa0IsQ0FBQztRQUVwRTs7Ozs7Ozs7V0FRRztRQUNxQixlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQWtCLENBQUM7SUFvSTFFLENBQUM7SUF2TW1CLHNCQUFJLDBDQUFLO2FBSTNCO1lBQ0UsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3JCLENBQUM7UUFURDs7V0FFRzthQUNlLFVBQVUsS0FBNEI7WUFDdEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUMzRSxDQUFDOzs7T0FBQTtJQWVzQixzQkFB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QVc5QztRQUFyQixNQUFNLENBQUMsWUFBWSxDQUFDOzs2REFBK0M7SUFXNUM7UUFBdkIsTUFBTSxDQUFDLGNBQWMsQ0FBQzs7K0RBQWlEO0lBb0kxRSw4QkFBQztDQUFBLEFBL01ELElBK01DO1NBL01ZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciwgSW5wdXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBjb252ZXJ0VG9Cb29sZWFuIH0gZnJvbSAnLi4vLi4vdXRpbHMvdXRpbCc7XG5cbmltcG9ydCB7IFBvVHJlZVZpZXdJdGVtIH0gZnJvbSAnLi9wby10cmVlLXZpZXctaXRlbS9wby10cmVlLXZpZXctaXRlbS5pbnRlcmZhY2UnO1xuXG5jb25zdCBwb1RyZWVWaWV3TWF4TGV2ZWwgPSA0O1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gY29tcG9uZW50ZSBmb3JuZWNlIHVtIG1vZGVsbyBkZSB2aXN1YWxpemHDp8OjbyBlbSDDoXJ2b3JlLCBwb3NzaWJpbGl0YW5kbyBhIHZpc3VhbGl6YcOnw6NvIGRhcyBpbmZvcm1hw6fDtWVzIGRlIG1hbmVpcmFcbiAqIGhpZXLDoXJxdWljYSwgZGVzdGEgZm9ybWEgc2VuZG8gcG9zc8OtdmVsIHV0aWxpemFyIGF0w6kgNCBuw612ZWlzLlxuICpcbiAqIE5lbGUgw6kgcG9zc8OtdmVsIG5hdmVnYXIgZW50cmUgb3MgaXRlbnMgYXRyYXbDqXMgZGEgdGVjbGEgKnRhYiosIHBlcm1pdGluZG8gZXhwYW5kaXIgb3UgY29sYXBzYXIgbyBpdGVtIGVtIGZvY29cbiAqIHBvciBtZWlvIGRhcyB0ZWNsYXMgKmVudGVyKiBlICpzcGFjZSouXG4gKlxuICogQWzDqW0gZGEgbmF2ZWdhw6fDo28sIG8gY29tcG9uZW50ZSBwb3NzaWJpbGl0YSB0YW1iw6ltIGEgc2VsZcOnw6NvIGRvcyBpdGVucyBkbyBwcmltZWlybyBhbyDDumx0aW1vIG7DrXZlbCwgdGFudG8gZGUgZm9ybWEgcGFyY2lhbCBjb21vIGNvbXBsZXRhLlxuICpcbiAqIE8gY29tcG9uZW50ZSB0YW1iw6ltIHBvc3N1aSBldmVudG9zIGRpc3BhcmFkb3MgYW8gbWFyY2FyL2Rlc21hcmNhciBlIGV4cGFuZGlyL2NvbGFwc2FyIG9zIGl0ZW5zLlxuICovXG5leHBvcnQgY2xhc3MgUG9UcmVlVmlld0Jhc2VDb21wb25lbnQge1xuXG4gIHByaXZhdGUgX2l0ZW1zOiBBcnJheTxQb1RyZWVWaWV3SXRlbT4gPSBbXTtcbiAgcHJpdmF0ZSBfc2VsZWN0YWJsZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBMaXN0YSBkZSBpdGVucyBkbyB0aXBvIGBQb1RyZWVWaWV3SXRlbWAgcXVlIHNlcsOhIHJlbmRlcml6YWRhIHBlbG8gY29tcG9uZW50ZS5cbiAgICovXG4gIEBJbnB1dCgncC1pdGVtcycpIHNldCBpdGVtcyh2YWx1ZTogQXJyYXk8UG9UcmVlVmlld0l0ZW0+KSB7XG4gICAgdGhpcy5faXRlbXMgPSBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHRoaXMuZ2V0SXRlbXNCeU1heExldmVsKHZhbHVlKSA6IFtdO1xuICB9XG5cbiAgZ2V0IGl0ZW1zKCkge1xuICAgIHJldHVybiB0aGlzLl9pdGVtcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAb3B0aW9uYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEhhYmlsaXRhIHVtYSBjYWl4YSBkZSBzZWxlw6fDo28gcGFyYSBzZWxlY2lvbmFyIGUvb3UgZGVzbWFyY2FyIHVtIGl0ZW0gZGEgbGlzdGEuXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICBASW5wdXQoJ3Atc2VsZWN0YWJsZScpIHNldCBzZWxlY3RhYmxlKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5fc2VsZWN0YWJsZSA9IGNvbnZlcnRUb0Jvb2xlYW4odmFsdWUpO1xuICB9XG5cbiAgZ2V0IHNlbGVjdGFibGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NlbGVjdGFibGU7XG4gIH1cblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBBw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBhbyBjb2xhcHNhciB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIGNvbGFwc2Fkby5cbiAgICovXG4gIEBPdXRwdXQoJ3AtY29sbGFwc2VkJykgY29sbGFwc2VkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBBw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBhbyBleHBhbmRpciB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIGV4cGFuZGlkby5cbiAgICovXG4gIEBPdXRwdXQoJ3AtZXhwYW5kZWQnKSBleHBhbmRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8UG9UcmVlVmlld0l0ZW0+KCk7XG5cbiAgLyoqXG4gICAqIEBvcHRpb25hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogQcOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgYW8gc2VsZWNpb25hciB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIHNlbGVjaW9uYWRvLlxuICAgKi9cbiAgQE91dHB1dCgncC1zZWxlY3RlZCcpIHNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBBw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBhbyBkZXNmYXplciBhIHNlbGXDp8OjbyBkZSB1bSBpdGVtLlxuICAgKlxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIHF1ZSBmb2kgZGVzbWFyY2Fkby5cbiAgICovXG4gIEBPdXRwdXQoJ3AtdW5zZWxlY3RlZCcpIHVuc2VsZWN0ZWQgPSBuZXcgRXZlbnRFbWl0dGVyPFBvVHJlZVZpZXdJdGVtPigpO1xuXG4gIHByb3RlY3RlZCBlbWl0RXhwYW5kZWQodHJlZVZpZXdJdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGNvbnN0IGV2ZW50ID0gdHJlZVZpZXdJdGVtLmV4cGFuZGVkID8gJ2V4cGFuZGVkJyA6ICdjb2xsYXBzZWQnO1xuXG4gICAgdGhpc1tldmVudF0uZW1pdCh7IC4uLnRyZWVWaWV3SXRlbSB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBlbWl0U2VsZWN0ZWQodHJlZVZpZXdJdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGNvbnN0IGV2ZW50ID0gdHJlZVZpZXdJdGVtLnNlbGVjdGVkID8gJ3NlbGVjdGVkJyA6ICd1bnNlbGVjdGVkJztcblxuICAgIHRoaXMudXBkYXRlSXRlbXNPblNlbGVjdCh0cmVlVmlld0l0ZW0pO1xuXG4gICAgdGhpc1tldmVudF0uZW1pdCh7IC4uLnRyZWVWaWV3SXRlbSB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQ2hpbGRJdGVtSW5QYXJlbnQoY2hpbGRJdGVtOiBQb1RyZWVWaWV3SXRlbSwgcGFyZW50SXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcbiAgICBpZiAoIXBhcmVudEl0ZW0uc3ViSXRlbXMpIHtcbiAgICAgIHBhcmVudEl0ZW0uc3ViSXRlbXMgPSBbXTtcbiAgICB9XG5cbiAgICBwYXJlbnRJdGVtLnN1Ykl0ZW1zLnB1c2goY2hpbGRJdGVtKTtcbiAgfVxuXG4gIC8vIGNhc28gaG91dmVyIHBhcmVudEl0ZW06XG4gIC8vICAtIGV4cGFuZGUgbyBwYXJlbnRJdGVtIGNhc28gbyBmaWxobyBlc3RpdmVyIGV4cGFuZGlkbztcbiAgLy8gIC0gYWRpY2lvbmEgbyBjaGlsZEl0ZW0gbm8gcGFyZW50SXRlbTtcbiAgLy8gIC0gbWFyY2EgbyBwYXJlbnRJdGVtIGNhc28gY29udGVyIHN1Ykl0ZW1zIG1hcmNvZG9zIG91IG51bG9zO1xuICAvLyBTZSBuw6NvIGNvbnRlciBwYXJlbnRJdGVtLCBhZGljaW9uYSBvIGNoaWxkSXRlbSBubyBpdGVtcy5cbiAgcHJpdmF0ZSBhZGRJdGVtKGl0ZW1zOiBBcnJheTxQb1RyZWVWaWV3SXRlbT4sIGNoaWxkSXRlbTogUG9UcmVlVmlld0l0ZW0sIHBhcmVudEl0ZW0/OiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGlmIChwYXJlbnRJdGVtKSB7XG4gICAgICB0aGlzLmV4cGFuZFBhcmVudEl0ZW0oY2hpbGRJdGVtLCBwYXJlbnRJdGVtKTtcbiAgICAgIHRoaXMuYWRkQ2hpbGRJdGVtSW5QYXJlbnQoY2hpbGRJdGVtLCBwYXJlbnRJdGVtKTtcbiAgICAgIHRoaXMuc2VsZWN0SXRlbUJ5U3ViSXRlbXMocGFyZW50SXRlbSk7XG5cbiAgICAgIGl0ZW1zLnB1c2gocGFyZW50SXRlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGl0ZW1zLnB1c2goY2hpbGRJdGVtKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNlbGVjdEFsbEl0ZW1zKGl0ZW1zOiBBcnJheTxQb1RyZWVWaWV3SXRlbT4sIGlzU2VsZWN0ZWQ6IGJvb2xlYW4pIHtcbiAgICBpdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuXG4gICAgICBpZiAoaXRlbS5zdWJJdGVtcykge1xuICAgICAgICB0aGlzLnNlbGVjdEFsbEl0ZW1zKGl0ZW0uc3ViSXRlbXMsIGlzU2VsZWN0ZWQpO1xuICAgICAgfVxuXG4gICAgICBpdGVtLnNlbGVjdGVkID0gaXNTZWxlY3RlZDtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2VsZWN0SXRlbUJ5U3ViSXRlbXMoaXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcbiAgICBpdGVtLnNlbGVjdGVkID0gdGhpcy5ldmVyeUl0ZW1TZWxlY3RlZChpdGVtLnN1Ykl0ZW1zKTtcbiAgfVxuXG4gIC8vIHJldG9ybmFyw6E6XG4gIC8vICAtIHRydWU6IHNlIHRvZG9zIG9zIGl0ZW1zIGVzdGl2ZXJlbSBtYXJjYWRvcztcbiAgLy8gIC0gbnVsbDogc2Ugbm8gbWluaW1vIHVtIGl0ZW0gZXN0ZWphIG1hcmNhZG8gb3UgbnVsbG8gKGluZGV0ZXJtaW5hdGUpXG4gIC8vICAtIGZhbHNlOiBjYXNvIG7Do28gY29ycmVzcG9uZGEgZW0gbmVuaHVtYSBkYXMgb3DDp8O1ZXMgYWNpbWEsIG5vIGNhc28sIG5lbmh1bSBtYXJjYWRvIG91IG51bG87XG4gIHByaXZhdGUgZXZlcnlJdGVtU2VsZWN0ZWQoaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiA9IFtdKTogYm9vbGVhbiB8IG51bGwge1xuICAgIGNvbnN0IGl0ZW1zTGVuZ3RoID0gaXRlbXMubGVuZ3RoO1xuXG4gICAgY29uc3QgbGVuZ3RoQ2hlY2tlZEl0ZW1zID0gaXRlbXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5zZWxlY3RlZCkubGVuZ3RoO1xuXG4gICAgaWYgKGl0ZW1zTGVuZ3RoICYmIGl0ZW1zTGVuZ3RoID09PSBsZW5ndGhDaGVja2VkSXRlbXMpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc0luZGV0ZXJtaW5hdGVJdGVtcyA9IGl0ZW1zLmZpbHRlcihpdGVtID0+IGl0ZW0uc2VsZWN0ZWQgfHwgaXRlbS5zZWxlY3RlZCA9PT0gbnVsbCkubGVuZ3RoO1xuXG4gICAgaWYgKGhhc0luZGV0ZXJtaW5hdGVJdGVtcykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gZXhwYW5kZSBvIGl0ZW0gcGFpIGNhc28gbyBmaWxobyBlc3RpdmVyIGV4cGFuZGlkby5cbiAgcHJpdmF0ZSBleHBhbmRQYXJlbnRJdGVtKGNoaWxkSXRlbTogUG9UcmVlVmlld0l0ZW0sIHBhcmVudEl0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XG4gICAgaWYgKGNoaWxkSXRlbS5leHBhbmRlZCkge1xuICAgICAgcGFyZW50SXRlbS5leHBhbmRlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRJdGVtc0J5TWF4TGV2ZWwoaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiA9IFtdLCBsZXZlbDogbnVtYmVyID0gMCwgcGFyZW50SXRlbT86IFBvVHJlZVZpZXdJdGVtLCBuZXdJdGVtcyA9IFtdKSB7XG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGNvbnN0IHsgc3ViSXRlbXMsIC4uLmN1cnJlbnRJdGVtIH0gPSBpdGVtO1xuXG4gICAgICBpZiAobGV2ZWwgPT09IHBvVHJlZVZpZXdNYXhMZXZlbCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHN1Ykl0ZW1zKSkge1xuXG4gICAgICAgIC8vIGNhc28gdW0gaXRlbSBwYWkgaW5pY2lhciBzZWxlY2lvbmFkbywgZGV2ZSBzZWxlY2lvbmFyIG9zIGZpbGhvcy5cbiAgICAgICAgaWYgKGN1cnJlbnRJdGVtLnNlbGVjdGVkKSB7XG4gICAgICAgICAgdGhpcy5zZWxlY3RBbGxJdGVtcyhzdWJJdGVtcywgY3VycmVudEl0ZW0uc2VsZWN0ZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5nZXRJdGVtc0J5TWF4TGV2ZWwoc3ViSXRlbXMsICsrbGV2ZWwsIGN1cnJlbnRJdGVtKTtcbiAgICAgICAgLS1sZXZlbDtcbiAgICAgIH1cblxuICAgICAgdGhpcy5hZGRJdGVtKG5ld0l0ZW1zLCBjdXJyZW50SXRlbSwgcGFyZW50SXRlbSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3SXRlbXM7XG4gIH1cblxuICBwcml2YXRlIGdldEl0ZW1zV2l0aFBhcmVudFNlbGVjdGVkKGl0ZW1zOiBBcnJheTxQb1RyZWVWaWV3SXRlbT4gPSBbXSwgcGFyZW50SXRlbT86IFBvVHJlZVZpZXdJdGVtLCBuZXdJdGVtcyA9IFtdKSB7XG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGNvbnN0IHsgc3ViSXRlbXMsIC4uLmN1cnJlbnRJdGVtIH0gPSBpdGVtO1xuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShzdWJJdGVtcykpIHtcbiAgICAgICAgdGhpcy5nZXRJdGVtc1dpdGhQYXJlbnRTZWxlY3RlZChzdWJJdGVtcywgY3VycmVudEl0ZW0pO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmFkZEl0ZW0obmV3SXRlbXMsIGN1cnJlbnRJdGVtLCBwYXJlbnRJdGVtKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBuZXdJdGVtcztcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSXRlbXNPblNlbGVjdChzZWxlY3RlZEl0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XG4gICAgaWYgKHNlbGVjdGVkSXRlbS5zdWJJdGVtcykge1xuICAgICAgdGhpcy5zZWxlY3RBbGxJdGVtcyhzZWxlY3RlZEl0ZW0uc3ViSXRlbXMsIHNlbGVjdGVkSXRlbS5zZWxlY3RlZCk7XG4gICAgfVxuXG4gICAgdGhpcy5faXRlbXMgPSB0aGlzLmdldEl0ZW1zV2l0aFBhcmVudFNlbGVjdGVkKHRoaXMuaXRlbXMpO1xuICB9XG5cbn1cbiJdfQ==