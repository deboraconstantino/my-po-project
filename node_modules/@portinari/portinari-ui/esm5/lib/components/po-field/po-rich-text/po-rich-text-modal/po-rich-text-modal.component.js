import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Output, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { convertImageToBase64, isExternalLink, isIE } from '../../../../utils/util';
import { PoLanguageService } from './../../../../services/po-language/po-language.service';
import { PoModalComponent } from '../../../po-modal';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
import { PoRichTextModalType } from '../enums/po-rich-text-modal-type.enum';
import { PoUploadComponent } from '../../po-upload/po-upload.component';
var uploadRestrictions = ['.apng', '.bmp', '.gif', '.ico', '.jpeg', '.jpg', '.png', '.svg'];
var PoRichTextModalComponent = /** @class */ (function () {
    function PoRichTextModalComponent(languageService) {
        var _this = this;
        this.languageService = languageService;
        this.selection = document.getSelection();
        this.uploadRestrictions = {
            allowedExtensions: uploadRestrictions
        };
        this.literals = tslib_1.__assign({}, poRichTextLiteralsDefault[this.languageService.getShortLanguage()]);
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: function () {
                _this.modal.close();
                _this.command.emit();
                _this.retrieveCursorPosition();
                _this.cleanUpFields();
            }
        };
        this.modalConfirmAction = {
            label: this.literals.insert,
            disabled: false,
            action: function () { return _this.insertElementRef(); }
        };
        this.modalLinkConfirmAction = {
            label: this.linkConfirmAction(),
            disabled: true,
            action: function () { return _this.isLinkEditing ? _this.toEditLink() : _this.toInsertLink(_this.urlLink, _this.urlLinkText); }
        };
        this.command = new EventEmitter();
        this.linkEditing = new EventEmitter();
    }
    Object.defineProperty(PoRichTextModalComponent.prototype, "modalTitle", {
        get: function () {
            if (this.modalType === 'image') {
                return this.literals.insertImage;
            }
            return this.linkConfirmAction();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoRichTextModalComponent.prototype, "isUploadValid", {
        get: function () {
            return !!(this.uploadModel && this.uploadModel.length);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoRichTextModalComponent.prototype, "isUrlValid", {
        get: function () {
            return !!this.urlImage && this.modalImageForm && this.modalImageForm.valid;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoRichTextModalComponent.prototype, "modalPrimaryAction", {
        get: function () {
            return this.modalType === 'image' ? this.modalConfirmAction : this.modalLinkConfirmAction;
        },
        enumerable: true,
        configurable: true
    });
    PoRichTextModalComponent.prototype.convertToBase64 = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var uploadImage;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!this.isUploadValid) return [3 /*break*/, 2];
                        uploadImage = this.uploadModel[0].rawFile;
                        return [4 /*yield*/, convertImageToBase64(uploadImage)];
                    case 1: return [2 /*return*/, _a.sent()];
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    PoRichTextModalComponent.prototype.linkConfirmAction = function () {
        return this.isLinkEditing ? this.literals.editLink : this.literals.insertLink;
    };
    PoRichTextModalComponent.prototype.emitCommand = function (value) {
        var command;
        if (value && this.modalType === PoRichTextModalType.Image) {
            command = 'insertImage';
            this.command.emit(({ command: command, value: value }));
        }
    };
    PoRichTextModalComponent.prototype.formModelValidate = function () {
        return this.modalLinkConfirmAction.disabled = this.modalLinkForm && this.modalLinkForm.invalid;
    };
    PoRichTextModalComponent.prototype.insertElementRef = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var uploadImage;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(this.modalType === PoRichTextModalType.Image && !this.urlImage)) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.convertToBase64()];
                    case 1:
                        uploadImage = _a.sent();
                        _a.label = 2;
                    case 2:
                        this.retrieveCursorPosition();
                        this.modal.close();
                        if (this.isUrlValid || this.isUploadValid) {
                            this.emitCommand(this.urlImage || uploadImage);
                        }
                        this.cleanUpFields();
                        return [2 /*return*/];
                }
            });
        });
    };
    PoRichTextModalComponent.prototype.openModal = function (type) {
        this.modalType = type;
        this.saveCursorPosition();
        if (this.modalType === PoRichTextModalType.Link) {
            this.prepareModalForLink();
            this.modalLinkConfirmAction.label = this.linkConfirmAction();
        }
        this.modal.open();
    };
    PoRichTextModalComponent.prototype.selectedLink = function (event) {
        this.isSelectedLink = !!event;
        this.linkElement = event;
    };
    PoRichTextModalComponent.prototype.checkIfIsEmpty = function (urlLink, urlLinkText) {
        return urlLinkText === undefined || urlLinkText.trim() === '' ? urlLink : urlLinkText;
    };
    PoRichTextModalComponent.prototype.cleanUpFields = function () {
        this.urlImage = undefined;
        this.urlLink = undefined;
        this.urlLinkText = undefined;
        this.uploadModel = undefined;
        this.isLinkEditing = false;
        this.isSelectedLink = false;
        this.linkElement = undefined;
    };
    PoRichTextModalComponent.prototype.formReset = function (control) {
        control.markAsPristine();
        control.markAsUntouched();
        control.updateValueAndValidity();
    };
    PoRichTextModalComponent.prototype.prepareModalForLink = function () {
        var _this = this;
        this.saveSelectionText();
        if (this.modalLinkForm) {
            this.formReset(this.modalLinkForm.control);
        }
        setTimeout(function () { _this.formModelValidate(); });
        if (this.isSelectedLink) {
            this.isLinkEditing = true;
            this.setLinkEditableForModal();
        }
        this.linkEditing.emit(this.isLinkEditing);
    };
    PoRichTextModalComponent.prototype.restoreSelection = function () {
        if (this.savedSelection) {
            if (this.selection) {
                this.selection.removeAllRanges();
                this.selection.addRange(this.savedSelection);
            }
            return true;
        }
        else {
            return false;
        }
    };
    PoRichTextModalComponent.prototype.retrieveCursorPosition = function () {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    };
    PoRichTextModalComponent.prototype.saveCursorPosition = function () {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    };
    PoRichTextModalComponent.prototype.saveSelectionText = function () {
        if (this.selection.anchorNode !== null) {
            this.savedSelection = this.selection.getRangeAt(0);
            this.urlLinkText = this.selection.toString();
        }
        else {
            return null;
        }
    };
    PoRichTextModalComponent.prototype.setLinkEditableForModal = function () {
        this.urlLinkText = this.linkElement.innerText;
        this.urlLink = this.linkElement.getAttribute('href');
    };
    PoRichTextModalComponent.prototype.toEditLink = function () {
        if (isIE()) {
            this.linkElement.parentNode.removeChild(this.linkElement);
        }
        else {
            this.linkElement.remove();
        }
        this.toInsertLink(this.urlLink, this.urlLinkText);
    };
    PoRichTextModalComponent.prototype.toInsertLink = function (urlLink, urlLinkText) {
        this.modal.close();
        this.restoreSelection();
        var urlLinkTextValue = this.checkIfIsEmpty(urlLink, urlLinkText);
        var urlAsExternalLink = isExternalLink(urlLink) ? urlLink : "http://" + urlLink;
        var command = 'InsertHTML';
        var value = { urlLink: urlAsExternalLink, urlLinkText: urlLinkTextValue };
        this.command.emit({ command: command, value: value });
        this.cleanUpFields();
    };
    PoRichTextModalComponent.ctorParameters = function () { return [
        { type: PoLanguageService }
    ]; };
    tslib_1.__decorate([
        ViewChild('modal', { static: true }),
        tslib_1.__metadata("design:type", PoModalComponent)
    ], PoRichTextModalComponent.prototype, "modal", void 0);
    tslib_1.__decorate([
        ViewChild('modalImageForm', { static: false }),
        tslib_1.__metadata("design:type", NgForm)
    ], PoRichTextModalComponent.prototype, "modalImageForm", void 0);
    tslib_1.__decorate([
        ViewChild('upload', { static: true }),
        tslib_1.__metadata("design:type", PoUploadComponent)
    ], PoRichTextModalComponent.prototype, "upload", void 0);
    tslib_1.__decorate([
        ViewChild('modalImage', { static: true }),
        tslib_1.__metadata("design:type", ElementRef)
    ], PoRichTextModalComponent.prototype, "modalImage", void 0);
    tslib_1.__decorate([
        ViewChild('modalLink', { static: true }),
        tslib_1.__metadata("design:type", PoModalComponent)
    ], PoRichTextModalComponent.prototype, "modalLink", void 0);
    tslib_1.__decorate([
        ViewChild('modalLinkForm', { static: false }),
        tslib_1.__metadata("design:type", NgForm)
    ], PoRichTextModalComponent.prototype, "modalLinkForm", void 0);
    tslib_1.__decorate([
        Output('p-command'),
        tslib_1.__metadata("design:type", Object)
    ], PoRichTextModalComponent.prototype, "command", void 0);
    tslib_1.__decorate([
        Output('p-link-editing'),
        tslib_1.__metadata("design:type", Object)
    ], PoRichTextModalComponent.prototype, "linkEditing", void 0);
    PoRichTextModalComponent = tslib_1.__decorate([
        Component({
            selector: 'po-rich-text-modal',
            template: "<po-modal #modal\r\n  p-hide-close\r\n  [p-primary-action]=\"modalPrimaryAction\"\r\n  [p-secondary-action]=\"modalCancelAction\"\r\n  [p-title]=\"modalTitle\">\r\n\r\n  <ng-container *ngTemplateOutlet=\"modalType === 'image' ? modalImage : modalLink\"></ng-container>\r\n</po-modal>\r\n\r\n<ng-template #modalImage>\r\n  <form #modalImageForm=\"ngForm\">\r\n    <div class=\"po-row\">\r\n      <!-- po-upload desabilita o drag drop caso n\u00E3o tenha valor atribuido para a propriedade p-url -->\r\n      <po-upload #upload\r\n        class=\"po-md-12\"\r\n        name=\"upload\"\r\n        [(ngModel)]=\"uploadModel\"\r\n        p-drag-drop-height=\"160\"\r\n        p-hide-restrictions-info\r\n        p-hide-send-button\r\n        p-url=\"x\"\r\n        [p-drag-drop]=\"!modal.isHidden\"\r\n        [p-disabled]=\"isUrlValid\"\r\n        [p-restrictions]=\"uploadRestrictions\">\r\n      </po-upload>\r\n    </div>\r\n\r\n    <div class=\"po-row\">\r\n      <po-url\r\n        class=\"po-md-12 po-mt-3\"\r\n        name=\"url\"\r\n        [(ngModel)]=\"urlImage\"\r\n        [p-label]=\"literals.urlImage\"\r\n        [p-disabled]=\"isUploadValid\">\r\n      </po-url>\r\n    </div>\r\n  </form>\r\n</ng-template>\r\n\r\n<ng-template #modalLink>\r\n  <form #modalLinkForm=\"ngForm\">\r\n    <div class=\"po-row\">\r\n      <po-input class=\"po-md-12 po-mb-2\"\r\n        name=\"urlLinkText\"\r\n        [(ngModel)]=\"urlLinkText\"\r\n        p-optional\r\n        [p-label]=\"literals.linkTextLabel\"\r\n        [p-placeholder]=\"literals.linkTextLabel\">\r\n      </po-input>\r\n\r\n      <po-url class=\"po-md-12\"\r\n        name=\"urlLink\"\r\n        [(ngModel)]=\"urlLink\"\r\n        p-label=\"Link\"\r\n        p-required\r\n        [p-help]=\"literals.linkUrlTextHelper\"\r\n        [p-placeholder]=\"literals.linkUrlTextPlaceholder\"\r\n        (p-change-model)=\"formModelValidate()\">\r\n      </po-url>\r\n    </div>\r\n  </form>\r\n</ng-template>\r\n"
        }),
        tslib_1.__metadata("design:paramtypes", [PoLanguageService])
    ], PoRichTextModalComponent);
    return PoRichTextModalComponent;
}());
export { PoRichTextModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb3J0aW5hcmkvcG9ydGluYXJpLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tcmljaC10ZXh0L3BvLXJpY2gtdGV4dC1tb2RhbC9wby1yaWNoLXRleHQtbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RixPQUFPLEVBQW1CLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXpELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDcEYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0RBQXdELENBQUM7QUFFM0YsT0FBTyxFQUFpQixnQkFBZ0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQzVFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBR3hFLElBQU0sa0JBQWtCLEdBQUcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFNOUY7SUFnRkUsa0NBQW9CLGVBQWtDO1FBQXRELGlCQUEwRDtRQUF0QyxvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7UUE1RXRELGNBQVMsR0FBRyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFcEMsdUJBQWtCLEdBQTZCO1lBQzdDLGlCQUFpQixFQUFFLGtC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QXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5cclxuaW1wb3J0IHsgY29udmVydEltYWdlVG9CYXNlNjQsIGlzRXh0ZXJuYWxMaW5rLCBpc0lFIH0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbHMvdXRpbCc7XHJcbmltcG9ydCB7IFBvTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcclxuXHJcbmltcG9ydCB7IFBvTW9kYWxBY3Rpb24sIFBvTW9kYWxDb21wb25lbnQgfSBmcm9tICcuLi8uLi8uLi9wby1tb2RhbCc7XHJcbmltcG9ydCB7IHBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHQgfSBmcm9tICcuLi9wby1yaWNoLXRleHQtbGl0ZXJhbHMnO1xyXG5pbXBvcnQgeyBQb1JpY2hUZXh0TW9kYWxUeXBlIH0gZnJvbSAnLi4vZW51bXMvcG8tcmljaC10ZXh0LW1vZGFsLXR5cGUuZW51bSc7XHJcbmltcG9ydCB7IFBvVXBsb2FkQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vcG8tdXBsb2FkL3BvLXVwbG9hZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBQb1VwbG9hZEZpbGVSZXN0cmljdGlvbnMgfSBmcm9tICcuLi8uLi9wby11cGxvYWQvaW50ZXJmYWNlcy9wby11cGxvYWQtZmlsZS1yZXN0cmljdGlvbi5pbnRlcmZhY2UnO1xyXG5cclxuY29uc3QgdXBsb2FkUmVzdHJpY3Rpb25zID0gWycuYXBuZycsICcuYm1wJywgJy5naWYnLCAnLmljbycsICcuanBlZycsICcuanBnJywgJy5wbmcnLCAnLnN2ZyddO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdwby1yaWNoLXRleHQtbW9kYWwnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1yaWNoLXRleHQtbW9kYWwuY29tcG9uZW50Lmh0bWwnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb1JpY2hUZXh0TW9kYWxDb21wb25lbnQge1xyXG5cclxuICBtb2RhbFR5cGU6IFBvUmljaFRleHRNb2RhbFR5cGU7XHJcbiAgc2F2ZWRDdXJzb3JQb3NpdGlvbjtcclxuICBzZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTtcclxuICB1cGxvYWRNb2RlbDogQXJyYXk8YW55PjtcclxuICB1cGxvYWRSZXN0cmljdGlvbnM6IFBvVXBsb2FkRmlsZVJlc3RyaWN0aW9ucyA9IHtcclxuICAgIGFsbG93ZWRFeHRlbnNpb25zOiB1cGxvYWRSZXN0cmljdGlvbnNcclxuICB9O1xyXG4gIHVybEltYWdlOiBzdHJpbmc7XHJcbiAgdXJsTGluazogc3RyaW5nO1xyXG4gIHVybExpbmtUZXh0OiBzdHJpbmc7XHJcblxyXG4gIHByaXZhdGUgaXNMaW5rRWRpdGluZzogYm9vbGVhbjtcclxuICBwcml2YXRlIGlzU2VsZWN0ZWRMaW5rOiBib29sZWFuO1xyXG4gIHByaXZhdGUgbGlua0VsZW1lbnQ6IGFueTtcclxuICBwcml2YXRlIHNhdmVkU2VsZWN0aW9uOiBSYW5nZSB8IG51bGw7XHJcblxyXG4gIHJlYWRvbmx5IGxpdGVyYWxzID0ge1xyXG4gICAgLi4ucG9SaWNoVGV4dExpdGVyYWxzRGVmYXVsdFt0aGlzLmxhbmd1YWdlU2VydmljZS5nZXRTaG9ydExhbmd1YWdlKCldXHJcbiAgfTtcclxuXHJcbiAgbW9kYWxDYW5jZWxBY3Rpb246IFBvTW9kYWxBY3Rpb24gPSB7XHJcbiAgICBsYWJlbDogdGhpcy5saXRlcmFscy5jYW5jZWwsXHJcbiAgICBhY3Rpb246ICgpID0+IHtcclxuICAgICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xyXG4gICAgICB0aGlzLmNvbW1hbmQuZW1pdCgpO1xyXG4gICAgICB0aGlzLnJldHJpZXZlQ3Vyc29yUG9zaXRpb24oKTtcclxuICAgICAgdGhpcy5jbGVhblVwRmllbGRzKCk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgbW9kYWxDb25maXJtQWN0aW9uOiBQb01vZGFsQWN0aW9uID0ge1xyXG4gICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuaW5zZXJ0LFxyXG4gICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgYWN0aW9uOiAoKSA9PiB0aGlzLmluc2VydEVsZW1lbnRSZWYoKVxyXG4gIH07XHJcblxyXG4gIG1vZGFsTGlua0NvbmZpcm1BY3Rpb24gPSB7XHJcbiAgICBsYWJlbDogdGhpcy5saW5rQ29uZmlybUFjdGlvbigpLFxyXG4gICAgZGlzYWJsZWQ6IHRydWUsXHJcbiAgICBhY3Rpb246ICgpID0+IHRoaXMuaXNMaW5rRWRpdGluZyA/IHRoaXMudG9FZGl0TGluaygpIDogdGhpcy50b0luc2VydExpbmsodGhpcy51cmxMaW5rLCB0aGlzLnVybExpbmtUZXh0KVxyXG4gIH07XHJcblxyXG4gIGdldCBtb2RhbFRpdGxlKCk6IHN0cmluZyB7XHJcbiAgICBpZiAodGhpcy5tb2RhbFR5cGUgPT09ICdpbWFnZScpIHtcclxuICAgICAgcmV0dXJuIHRoaXMubGl0ZXJhbHMuaW5zZXJ0SW1hZ2U7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMubGlua0NvbmZpcm1BY3Rpb24oKTtcclxuICB9XHJcblxyXG4gIGdldCBpc1VwbG9hZFZhbGlkKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICEhKHRoaXMudXBsb2FkTW9kZWwgJiYgdGhpcy51cGxvYWRNb2RlbC5sZW5ndGgpO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGlzVXJsVmFsaWQoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gISF0aGlzLnVybEltYWdlICYmIHRoaXMubW9kYWxJbWFnZUZvcm0gJiYgdGhpcy5tb2RhbEltYWdlRm9ybS52YWxpZDtcclxuICB9XHJcblxyXG4gIGdldCBtb2RhbFByaW1hcnlBY3Rpb24oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5tb2RhbFR5cGUgPT09ICdpbWFnZScgPyB0aGlzLm1vZGFsQ29uZmlybUFjdGlvbiA6IHRoaXMubW9kYWxMaW5rQ29uZmlybUFjdGlvbjtcclxuICB9XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsJywgeyBzdGF0aWM6IHRydWUgfSkgbW9kYWw6IFBvTW9kYWxDb21wb25lbnQ7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsSW1hZ2VGb3JtJywgeyBzdGF0aWM6IGZhbHNlIH0pIG1vZGFsSW1hZ2VGb3JtOiBOZ0Zvcm07XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ3VwbG9hZCcsIHsgc3RhdGljOiB0cnVlIH0pIHVwbG9hZDogUG9VcGxvYWRDb21wb25lbnQ7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsSW1hZ2UnLCB7IHN0YXRpYzogdHJ1ZSB9KSBtb2RhbEltYWdlOiBFbGVtZW50UmVmO1xyXG5cclxuICBAVmlld0NoaWxkKCdtb2RhbExpbmsnLCB7IHN0YXRpYzogdHJ1ZSB9KSBtb2RhbExpbms6IFBvTW9kYWxDb21wb25lbnQ7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ21vZGFsTGlua0Zvcm0nLCB7IHN0YXRpYzogZmFsc2UgfSkgbW9kYWxMaW5rRm9ybTogTmdGb3JtO1xyXG5cclxuICBAT3V0cHV0KCdwLWNvbW1hbmQnKSBjb21tYW5kID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmcgfCB7IGNvbW1hbmQ6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IGFueSB9PigpO1xyXG5cclxuICBAT3V0cHV0KCdwLWxpbmstZWRpdGluZycpIGxpbmtFZGl0aW5nID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBQb0xhbmd1YWdlU2VydmljZSkge31cclxuXHJcbiAgYXN5bmMgY29udmVydFRvQmFzZTY0KCkge1xyXG4gICAgaWYgKHRoaXMuaXNVcGxvYWRWYWxpZCkge1xyXG4gICAgICBjb25zdCB1cGxvYWRJbWFnZSA9IHRoaXMudXBsb2FkTW9kZWxbMF0ucmF3RmlsZTtcclxuICAgICAgcmV0dXJuIGF3YWl0IGNvbnZlcnRJbWFnZVRvQmFzZTY0KHVwbG9hZEltYWdlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGxpbmtDb25maXJtQWN0aW9uKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5pc0xpbmtFZGl0aW5nID8gdGhpcy5saXRlcmFscy5lZGl0TGluayA6IHRoaXMubGl0ZXJhbHMuaW5zZXJ0TGluaztcclxuICB9XHJcblxyXG4gIGVtaXRDb21tYW5kKHZhbHVlKSB7XHJcbiAgICBsZXQgY29tbWFuZDogc3RyaW5nO1xyXG4gICAgaWYgKHZhbHVlICYmIHRoaXMubW9kYWxUeXBlID09PSBQb1JpY2hUZXh0TW9kYWxUeXBlLkltYWdlKSB7XHJcbiAgICAgIGNvbW1hbmQgPSAnaW5zZXJ0SW1hZ2UnO1xyXG4gICAgICB0aGlzLmNvbW1hbmQuZW1pdCgoeyBjb21tYW5kLCB2YWx1ZSB9KSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmb3JtTW9kZWxWYWxpZGF0ZSgpIHtcclxuICAgIHJldHVybiB0aGlzLm1vZGFsTGlua0NvbmZpcm1BY3Rpb24uZGlzYWJsZWQgPSB0aGlzLm1vZGFsTGlua0Zvcm0gJiYgdGhpcy5tb2RhbExpbmtGb3JtLmludmFsaWQ7XHJcbiAgfVxyXG5cclxuICBhc3luYyBpbnNlcnRFbGVtZW50UmVmKCkge1xyXG5cclxuICAgIGxldCB1cGxvYWRJbWFnZTogc3RyaW5nO1xyXG5cclxuICAgIGlmICh0aGlzLm1vZGFsVHlwZSA9PT0gUG9SaWNoVGV4dE1vZGFsVHlwZS5JbWFnZSAmJiAhdGhpcy51cmxJbWFnZSkge1xyXG4gICAgICB1cGxvYWRJbWFnZSA9IGF3YWl0IHRoaXMuY29udmVydFRvQmFzZTY0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5yZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCk7XHJcbiAgICB0aGlzLm1vZGFsLmNsb3NlKCk7XHJcblxyXG4gICAgaWYgKHRoaXMuaXNVcmxWYWxpZCB8fCB0aGlzLmlzVXBsb2FkVmFsaWQpIHtcclxuICAgICAgdGhpcy5lbWl0Q29tbWFuZCh0aGlzLnVybEltYWdlIHx8IHVwbG9hZEltYWdlKTtcclxuICAgIH1cclxuICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xyXG4gIH1cclxuXHJcbiAgb3Blbk1vZGFsKHR5cGU6IFBvUmljaFRleHRNb2RhbFR5cGUpIHtcclxuICAgIHRoaXMubW9kYWxUeXBlID0gdHlwZTtcclxuXHJcbiAgICB0aGlzLnNhdmVDdXJzb3JQb3NpdGlvbigpO1xyXG5cclxuICAgIGlmICh0aGlzLm1vZGFsVHlwZSA9PT0gUG9SaWNoVGV4dE1vZGFsVHlwZS5MaW5rKSB7XHJcbiAgICAgIHRoaXMucHJlcGFyZU1vZGFsRm9yTGluaygpO1xyXG4gICAgICB0aGlzLm1vZGFsTGlua0NvbmZpcm1BY3Rpb24ubGFiZWwgPSB0aGlzLmxpbmtDb25maXJtQWN0aW9uKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5tb2RhbC5vcGVuKCk7XHJcbiAgfVxyXG5cclxuICBzZWxlY3RlZExpbmsoZXZlbnQpIHtcclxuICAgIHRoaXMuaXNTZWxlY3RlZExpbmsgPSAhIWV2ZW50O1xyXG4gICAgdGhpcy5saW5rRWxlbWVudCA9IGV2ZW50O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjaGVja0lmSXNFbXB0eSh1cmxMaW5rOiBzdHJpbmcsIHVybExpbmtUZXh0OiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB1cmxMaW5rVGV4dCA9PT0gdW5kZWZpbmVkIHx8IHVybExpbmtUZXh0LnRyaW0oKSA9PT0gJycgPyB1cmxMaW5rIDogdXJsTGlua1RleHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNsZWFuVXBGaWVsZHMoKSB7XHJcbiAgICB0aGlzLnVybEltYWdlID0gdW5kZWZpbmVkO1xyXG4gICAgdGhpcy51cmxMaW5rID0gdW5kZWZpbmVkO1xyXG4gICAgdGhpcy51cmxMaW5rVGV4dCA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMudXBsb2FkTW9kZWwgPSB1bmRlZmluZWQ7XHJcbiAgICB0aGlzLmlzTGlua0VkaXRpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuaXNTZWxlY3RlZExpbmsgPSBmYWxzZTtcclxuICAgIHRoaXMubGlua0VsZW1lbnQgPSB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZvcm1SZXNldChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpIHtcclxuICAgIGNvbnRyb2wubWFya0FzUHJpc3RpbmUoKTtcclxuICAgIGNvbnRyb2wubWFya0FzVW50b3VjaGVkKCk7XHJcbiAgICBjb250cm9sLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcHJlcGFyZU1vZGFsRm9yTGluaygpIHtcclxuICAgIHRoaXMuc2F2ZVNlbGVjdGlvblRleHQoKTtcclxuICAgIGlmICh0aGlzLm1vZGFsTGlua0Zvcm0pIHtcclxuICAgICAgdGhpcy5mb3JtUmVzZXQodGhpcy5tb2RhbExpbmtGb3JtLmNvbnRyb2wpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLmZvcm1Nb2RlbFZhbGlkYXRlKCk7IH0pO1xyXG5cclxuICAgIGlmICh0aGlzLmlzU2VsZWN0ZWRMaW5rKSB7XHJcbiAgICAgIHRoaXMuaXNMaW5rRWRpdGluZyA9IHRydWU7XHJcbiAgICAgIHRoaXMuc2V0TGlua0VkaXRhYmxlRm9yTW9kYWwoKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmxpbmtFZGl0aW5nLmVtaXQodGhpcy5pc0xpbmtFZGl0aW5nKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVzdG9yZVNlbGVjdGlvbigpIHtcclxuICAgIGlmICh0aGlzLnNhdmVkU2VsZWN0aW9uKSB7XHJcbiAgICAgIGlmICh0aGlzLnNlbGVjdGlvbikge1xyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0aW9uLmFkZFJhbmdlKHRoaXMuc2F2ZWRTZWxlY3Rpb24pO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSAgZWxzZSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmV0cmlldmVDdXJzb3JQb3NpdGlvbigpIHtcclxuICAgIHRoaXMuc2VsZWN0aW9uLmNvbGxhcHNlKHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvblswXSwgdGhpcy5zYXZlZEN1cnNvclBvc2l0aW9uWzFdKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2F2ZUN1cnNvclBvc2l0aW9uKCkge1xyXG4gICAgdGhpcy5zYXZlZEN1cnNvclBvc2l0aW9uID0gWyB0aGlzLnNlbGVjdGlvbi5mb2N1c05vZGUsIHRoaXMuc2VsZWN0aW9uLmZvY3VzT2Zmc2V0IF07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNhdmVTZWxlY3Rpb25UZXh0KCkge1xyXG4gICAgaWYgKHRoaXMuc2VsZWN0aW9uLmFuY2hvck5vZGUgIT09IG51bGwpIHtcclxuICAgICAgdGhpcy5zYXZlZFNlbGVjdGlvbiA9IHRoaXMuc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7XHJcbiAgICAgIHRoaXMudXJsTGlua1RleHQgPSB0aGlzLnNlbGVjdGlvbi50b1N0cmluZygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldExpbmtFZGl0YWJsZUZvck1vZGFsKCkge1xyXG4gICAgdGhpcy51cmxMaW5rVGV4dCA9IHRoaXMubGlua0VsZW1lbnQuaW5uZXJUZXh0O1xyXG4gICAgdGhpcy51cmxMaW5rID0gdGhpcy5saW5rRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2hyZWYnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdG9FZGl0TGluaygpIHtcclxuICAgIGlmIChpc0lFKCkpIHtcclxuICAgICAgdGhpcy5saW5rRWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMubGlua0VsZW1lbnQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgIHRoaXMubGlua0VsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy50b0luc2VydExpbmsodGhpcy51cmxMaW5rLCB0aGlzLnVybExpbmtUZXh0KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdG9JbnNlcnRMaW5rKHVybExpbmssIHVybExpbmtUZXh0KSB7XHJcbiAgICB0aGlzLm1vZGFsLmNsb3NlKCk7XHJcbiAgICB0aGlzLnJlc3RvcmVTZWxlY3Rpb24oKTtcclxuXHJcbiAgICBjb25zdCB1cmxMaW5rVGV4dFZhbHVlID0gdGhpcy5jaGVja0lmSXNFbXB0eSh1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XHJcbiAgICBjb25zdCB1cmxBc0V4dGVybmFsTGluayA9IGlzRXh0ZXJuYWxMaW5rKHVybExpbmspID8gdXJsTGluayA6IGBodHRwOi8vJHt1cmxMaW5rfWA7XHJcblxyXG4gICAgY29uc3QgY29tbWFuZDogc3RyaW5nID0gJ0luc2VydEhUTUwnO1xyXG5cclxuICAgIGNvbnN0IHZhbHVlID0geyB1cmxMaW5rOiB1cmxBc0V4dGVybmFsTGluaywgdXJsTGlua1RleHQ6IHVybExpbmtUZXh0VmFsdWUgfTtcclxuXHJcbiAgICB0aGlzLmNvbW1hbmQuZW1pdCh7IGNvbW1hbmQsIHZhbHVlIH0pO1xyXG5cclxuICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19