import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { isFirefox, isIE, isIEOrEdge, openExternalLink } from './../../../../utils/util';
import { PoKeyCodeEnum } from './../../../../enums/po-key-code.enum';
var poRichTextBodyCommands = [
    'bold', 'italic', 'underline', 'justifyleft', 'justifycenter', 'justifyright', 'justifyfull', 'insertUnorderedList', 'Createlink'
];
var PoRichTextBodyComponent = /** @class */ (function () {
    function PoRichTextBodyComponent() {
        this.change = new EventEmitter();
        this.commands = new EventEmitter();
        this.selectedLink = new EventEmitter();
        this.shortcutCommand = new EventEmitter();
        this.value = new EventEmitter();
        this.onAnchorClick = function (event) {
            var target = event.target, ctrlKey = event.ctrlKey, metaKey = event.metaKey;
            var url;
            var elementLink;
            if (ctrlKey || metaKey) {
                if (event.path) {
                    event.path.forEach(function (element) {
                        if (element.nodeName === 'A') {
                            url = element.href;
                            elementLink = element;
                        }
                    });
                }
                else {
                    url = target.attributes.href.value;
                    elementLink = target;
                }
                openExternalLink(url);
                elementLink.classList.remove('po-clickable');
            }
        };
    }
    PoRichTextBodyComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.bodyElement.nativeElement.designMode = 'on';
        // timeout necessário para setar o valor vindo do writeValue do componente principal.
        setTimeout(function () { return _this.updateValueWithModelValue(); });
    };
    PoRichTextBodyComponent.prototype.executeCommand = function (command) {
        this.bodyElement.nativeElement.focus();
        if (typeof (command) === 'object') {
            if (command.command === 'InsertHTML') {
                var linkCommand = command.command, urlLink = command.value.urlLink, urlLinkText = command.value.urlLinkText;
                this.handleCommandLink(linkCommand, urlLink, urlLinkText);
            }
            else {
                document.execCommand(command.command, false, command.value);
            }
        }
        else {
            document.execCommand(command, false, null);
        }
        this.updateModel();
        this.value.emit(this.modelValue);
    };
    PoRichTextBodyComponent.prototype.linkEditing = function (event) {
        this.isLinkEditing = !!event;
    };
    PoRichTextBodyComponent.prototype.onBlur = function () {
        var _this = this;
        if (this.modelValue !== this.valueBeforeChange) {
            clearTimeout(this.timeoutChange);
            this.timeoutChange = setTimeout(function () {
                _this.change.emit(_this.modelValue);
            }, 200);
        }
    };
    PoRichTextBodyComponent.prototype.focus = function () {
        this.bodyElement.nativeElement.focus();
    };
    PoRichTextBodyComponent.prototype.onClick = function () {
        this.emitSelectionCommands();
    };
    PoRichTextBodyComponent.prototype.onFocus = function () {
        this.valueBeforeChange = this.modelValue;
    };
    PoRichTextBodyComponent.prototype.onKeyDown = function (event) {
        var keyK = event.keyCode === PoKeyCodeEnum.keyK;
        var isLinkShortcut = keyK && event.ctrlKey || keyK && event.metaKey;
        if (isLinkShortcut) {
            event.preventDefault();
            this.shortcutCommand.emit();
        }
        this.toggleCursorOnLink(event, 'add');
    };
    PoRichTextBodyComponent.prototype.onKeyUp = function (event) {
        this.toggleCursorOnLink(event, 'remove');
        this.removeBrElement();
        this.updateModel();
        this.emitSelectionCommands();
    };
    PoRichTextBodyComponent.prototype.onPaste = function () {
        this.addClickListenerOnAnchorElements();
        this.update();
    };
    PoRichTextBodyComponent.prototype.update = function () {
        var _this = this;
        setTimeout(function () { return _this.updateModel(); });
        setTimeout(function () {
            _this.removeBrElement();
            _this.updateModel();
            _this.emitSelectionCommands();
        });
    };
    PoRichTextBodyComponent.prototype.addClickListenerOnAnchorElements = function () {
        var _this = this;
        this.bodyElement.nativeElement.querySelectorAll('a').forEach(function (element) {
            element.addEventListener('click', _this.onAnchorClick);
        });
    };
    PoRichTextBodyComponent.prototype.emitSelectionCommands = function () {
        var commands = poRichTextBodyCommands.filter(function (command) { return document.queryCommandState(command); });
        var rgbColor = document.queryCommandValue('ForeColor');
        var hexColor;
        if (!isIE()) {
            hexColor = this.rgbToHex(rgbColor);
        }
        if (this.isCursorPositionedInALink()) {
            commands.push('Createlink');
        }
        this.selectedLink.emit(this.linkElement); // importante ficar fora do if para emitir mesmo undefined.
        this.commands.emit({ commands: commands, hexColor: hexColor });
    };
    PoRichTextBodyComponent.prototype.getTextSelection = function () {
        var textSelection = document.getSelection();
        if (!textSelection) {
            return;
        }
        var focusNode = textSelection.focusNode ? textSelection.focusNode.parentElement : undefined;
        var anchorNode = textSelection.anchorNode ? textSelection.anchorNode.parentNode : undefined;
        var node = focusNode || anchorNode;
        var tagName;
        if (node) {
            tagName = node['tagName'] || node['nodeName'];
            return {
                node: node,
                tagName: tagName
            };
        }
    };
    PoRichTextBodyComponent.prototype.handleCommandLink = function (linkCommand, urlLink, urlLinkText) {
        if (isIE()) {
            this.insertHtmlLinkElement(urlLink, urlLinkText);
        }
        else {
            // '&nbsp;' necessário para o cursor não ficar preso dentro do link no Firefox.
            var linkValue = isFirefox() && !this.isLinkEditing ?
                "&nbsp;" + this.makeLinkTag(urlLink, urlLinkText) + "&nbsp;" :
                this.makeLinkTag(urlLink, urlLinkText);
            document.execCommand(linkCommand, false, linkValue);
        }
        this.addClickListenerOnAnchorElements();
    };
    // tratamento específico para IE pois não suporta o comando 'insertHTML'.
    PoRichTextBodyComponent.prototype.insertHtmlLinkElement = function (urlLink, urlLinkText) {
        var selection = document.getSelection();
        var selectionRange = selection.getRangeAt(0);
        var elementLink = document.createElement('a');
        var elementlinkText = document.createTextNode(urlLinkText);
        elementLink.appendChild(elementlinkText);
        elementLink.href = urlLink;
        elementLink.setAttribute('target', '_blank');
        elementLink.classList.add('po-rich-text-link');
        selectionRange.deleteContents();
        selectionRange.insertNode(elementLink);
    };
    PoRichTextBodyComponent.prototype.isCursorPositionedInALink = function () {
        var textSelection = this.getTextSelection();
        this.linkElement = undefined;
        var isLink = false;
        if (textSelection && textSelection.node && textSelection.tagName === 'A') {
            this.linkElement = textSelection.node;
            isLink = true;
        }
        else if ((isFirefox() || isIEOrEdge()) && this.verifyCursorPositionInFirefoxIEEdge()) {
            isLink = true;
        }
        else {
            isLink = textSelection ? this.isParentNodeAnchor(textSelection) : false;
        }
        return isLink;
    };
    PoRichTextBodyComponent.prototype.isParentNodeAnchor = function (textSelection) {
        var element = textSelection.node;
        var isLink = false;
        while (element && (element.tagName !== null || element.nodeName !== null)) {
            if (element.tagName === 'A' || element.nodeName === 'A') {
                this.linkElement = element;
                isLink = true;
                return isLink;
            }
            element = element.parentElement || element.parentNode;
        }
        this.linkElement = undefined;
        return isLink;
    };
    PoRichTextBodyComponent.prototype.makeLinkTag = function (urlLink, urlLinkText) {
        return "<a class=\"po-rich-text-link\" href=\"" + urlLink + "\" target=\"_blank\">" + (urlLinkText || urlLink) + "</a>";
    };
    // Tratamento necessário para eliminar a tag <br> criada no firefox quando o body for limpo.
    PoRichTextBodyComponent.prototype.removeBrElement = function () {
        var bodyElement = this.bodyElement.nativeElement;
        if (!bodyElement.innerText.trim() && bodyElement.childNodes.length === 1 && bodyElement.querySelector('br')) {
            bodyElement.querySelector('br').remove();
        }
    };
    PoRichTextBodyComponent.prototype.rgbToHex = function (rgb) {
        // Tratamento necessário para converter o código rgb para hexadecimal.
        var sep = rgb.indexOf(',') > -1 ? ',' : ' ';
        rgb = rgb.substr(4).split(')')[0].split(sep);
        var r = (+rgb[0]).toString(16);
        var g = (+rgb[1]).toString(16);
        var b = (+rgb[2]).toString(16);
        if (r.length === 1) {
            r = '0' + r;
        }
        if (g.length === 1) {
            g = '0' + g;
        }
        if (b.length === 1) {
            b = '0' + b;
        }
        return '#' + r + g + b;
    };
    PoRichTextBodyComponent.prototype.toggleCursorOnLink = function (event, action) {
        var selection = document.getSelection();
        var element = selection.focusNode ? selection.focusNode.parentNode : undefined;
        var isCtrl = event.key === 'Control';
        var isCommand = event.key === 'Meta';
        var isOnCtrlLink = this.isCursorPositionedInALink() && (isCtrl || isCommand);
        if (element) {
            if (isOnCtrlLink) {
                element['classList'][action]('po-clickable');
            }
            else {
                var isClickable = element['classList'] && element['classList'].contains('po-clickable');
                if (isClickable) {
                    element['classList'].remove('po-clickable');
                }
            }
            this.updateModel();
        }
    };
    PoRichTextBodyComponent.prototype.updateModel = function () {
        this.modelValue = this.bodyElement.nativeElement.innerHTML;
        this.value.emit(this.modelValue);
    };
    PoRichTextBodyComponent.prototype.updateValueWithModelValue = function () {
        if (this.modelValue) {
            this.bodyElement.nativeElement.insertAdjacentHTML('afterbegin', this.modelValue);
        }
    };
    PoRichTextBodyComponent.prototype.verifyCursorPositionInFirefoxIEEdge = function () {
        var textSelection = document.getSelection();
        var nodeLink = textSelection.focusNode;
        var isLink = false;
        if (nodeLink && nodeLink.nodeName === 'A') {
            this.linkElement = nodeLink;
            isLink = true;
        }
        else {
            var range = textSelection.getRangeAt(0);
            var fragmentDocument = range.cloneContents();
            var element = fragmentDocument.childNodes[0] || fragmentDocument.firstElementChild;
            this.linkElement = (element && element.nodeName === 'A') ? element : undefined;
            isLink = !!this.linkElement;
        }
        return isLink;
    };
    tslib_1.__decorate([
        ViewChild('bodyElement', { static: true }),
        tslib_1.__metadata("design:type", ElementRef)
    ], PoRichTextBodyComponent.prototype, "bodyElement", void 0);
    tslib_1.__decorate([
        Input('p-height'),
        tslib_1.__metadata("design:type", String)
    ], PoRichTextBodyComponent.prototype, "height", void 0);
    tslib_1.__decorate([
        Input('p-model-value'),
        tslib_1.__metadata("design:type", String)
    ], PoRichTextBodyComponent.prototype, "modelValue", void 0);
    tslib_1.__decorate([
        Input('p-placeholder'),
        tslib_1.__metadata("design:type", String)
    ], PoRichTextBodyComponent.prototype, "placeholder", void 0);
    tslib_1.__decorate([
        Input('p-readonly'),
        tslib_1.__metadata("design:type", String)
    ], PoRichTextBodyComponent.prototype, "readonly", void 0);
    tslib_1.__decorate([
        Output('p-change'),
        tslib_1.__metadata("design:type", Object)
    ], PoRichTextBodyComponent.prototype, "change", void 0);
    tslib_1.__decorate([
        Output('p-commands'),
        tslib_1.__metadata("design:type", Object)
    ], PoRichTextBodyComponent.prototype, "commands", void 0);
    tslib_1.__decorate([
        Output('p-selected-link'),
        tslib_1.__metadata("design:type", Object)
    ], PoRichTextBodyComponent.prototype, "selectedLink", void 0);
    tslib_1.__decorate([
        Output('p-shortcut-command'),
        tslib_1.__metadata("design:type", Object)
    ], PoRichTextBodyComponent.prototype, "shortcutCommand", void 0);
    tslib_1.__decorate([
        Output('p-value'),
        tslib_1.__metadata("design:type", Object)
    ], PoRichTextBodyComponent.prototype, "value", void 0);
    PoRichTextBodyComponent = tslib_1.__decorate([
        Component({
            selector: 'po-rich-text-body',
            template: "<div #bodyElement\n  class=\"po-rich-text-body\"\n  tabindex=\"0\"\n  [attr.contenteditable]=\"!readonly\"\n  [attr.data-placeholder]=\"placeholder\"\n  [style.height.px]=\"height\"\n  (blur)=\"onBlur()\"\n  (click)=\"onClick()\"\n  (cut)=\"update()\"\n  (focus)=\"onFocus()\"\n  (keydown)=\"onKeyDown($event)\"\n  (keyup)=\"onKeyUp($event)\"\n  (paste)=\"onPaste()\">\n</div>\n"
        })
    ], PoRichTextBodyComponent);
    return PoRichTextBodyComponent;
}());
export { PoRichTextBodyComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvcnRpbmFyaS9wb3J0aW5hcmktdWkvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby1maWVsZC9wby1yaWNoLXRleHQvcG8tcmljaC10ZXh0LWJvZHkvcG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFdEcsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDekYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBRXJFLElBQU0sc0JBQXNCLEdBQUc7SUFDN0IsTUFBTSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFLHFCQUFxQixFQUFFLFlBQVk7Q0FDbEksQ0FBQztBQU1GO0lBSkE7UUFxQnNCLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRS9CLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRTlCLGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUVwQyxvQkFBZSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFckQsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUE2TTNDLGtCQUFhLEdBQUcsVUFBQSxLQUFLO1lBQ25CLElBQUEscUJBQU0sRUFBRSx1QkFBTyxFQUFFLHVCQUFPLENBQVc7WUFDM0MsSUFBSSxHQUFHLENBQUM7WUFDUixJQUFJLFdBQVcsQ0FBQztZQUVoQixJQUFJLE9BQU8sSUFBSSxPQUFPLEVBQUU7Z0JBQ3RC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UUFBMUIsTUFBTSxDQUFDLGlCQUFpQixDQUFDOztpRUFBd0M7SUFFcEM7UUFBN0IsTUFBTSxDQUFDLG9CQUFvQixDQUFDOztvRUFBMkM7SUFFckQ7UUFBbEIsTUFBTSxDQUFDLFNBQVMsQ0FBQzs7MERBQWlDO0lBekJ4Qyx1QkFBdUI7UUFKbkMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLG1CQUFtQjtZQUM3QixzWUFBaUQ7U0FDbEQsQ0FBQztPQUNXLHVCQUF1QixDQW1WbkM7SUFBRCw4QkFBQztDQUFBLEFBblZELElBbVZDO1NBblZZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25Jbml0LCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBpc0ZpcmVmb3gsIGlzSUUsIGlzSUVPckVkZ2UsIG9wZW5FeHRlcm5hbExpbmsgfSBmcm9tICcuLy4uLy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9LZXlDb2RlRW51bSB9IGZyb20gJy4vLi4vLi4vLi4vLi4vZW51bXMvcG8ta2V5LWNvZGUuZW51bSc7XG5cbmNvbnN0IHBvUmljaFRleHRCb2R5Q29tbWFuZHMgPSBbXG4gICdib2xkJywgJ2l0YWxpYycsICd1bmRlcmxpbmUnLCAnanVzdGlmeWxlZnQnLCAnanVzdGlmeWNlbnRlcicsICdqdXN0aWZ5cmlnaHQnLCAnanVzdGlmeWZ1bGwnLCAnaW5zZXJ0VW5vcmRlcmVkTGlzdCcsICdDcmVhdGVsaW5rJ1xuXTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tcmljaC10ZXh0LWJvZHknLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvUmljaFRleHRCb2R5Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICBwcml2YXRlIGlzTGlua0VkaXRpbmc6IGJvb2xlYW47XG4gIHByaXZhdGUgbGlua0VsZW1lbnQ6IGFueTtcbiAgcHJpdmF0ZSB0aW1lb3V0Q2hhbmdlOiBhbnk7XG4gIHByaXZhdGUgdmFsdWVCZWZvcmVDaGFuZ2U6IGFueTtcblxuICBAVmlld0NoaWxkKCdib2R5RWxlbWVudCcsIHsgc3RhdGljOiB0cnVlIH0pIGJvZHlFbGVtZW50OiBFbGVtZW50UmVmO1xuXG4gIEBJbnB1dCgncC1oZWlnaHQnKSBoZWlnaHQ/OiBzdHJpbmc7XG5cbiAgQElucHV0KCdwLW1vZGVsLXZhbHVlJykgbW9kZWxWYWx1ZT86IHN0cmluZztcblxuICBASW5wdXQoJ3AtcGxhY2Vob2xkZXInKSBwbGFjZWhvbGRlcj86IHN0cmluZztcblxuICBASW5wdXQoJ3AtcmVhZG9ubHknKSByZWFkb25seT86IHN0cmluZztcblxuICBAT3V0cHV0KCdwLWNoYW5nZScpIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3AtY29tbWFuZHMnKSBjb21tYW5kcyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3Atc2VsZWN0ZWQtbGluaycpIHNlbGVjdGVkTGluayA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3Atc2hvcnRjdXQtY29tbWFuZCcpIHNob3J0Y3V0Q29tbWFuZCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3AtdmFsdWUnKSB2YWx1ZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5kZXNpZ25Nb2RlID0gJ29uJztcblxuICAgIC8vIHRpbWVvdXQgbmVjZXNzw6FyaW8gcGFyYSBzZXRhciBvIHZhbG9yIHZpbmRvIGRvIHdyaXRlVmFsdWUgZG8gY29tcG9uZW50ZSBwcmluY2lwYWwuXG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnVwZGF0ZVZhbHVlV2l0aE1vZGVsVmFsdWUoKSk7XG4gIH1cblxuICBleGVjdXRlQ29tbWFuZChjb21tYW5kOiAoc3RyaW5nIHwgeyBjb21tYW5kOiBhbnksIHZhbHVlOiBzdHJpbmcgfCBhbnkgfSkpIHtcbiAgICB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQuZm9jdXMoKTtcblxuICAgIGlmICh0eXBlb2YgKGNvbW1hbmQpID09PSAnb2JqZWN0Jykge1xuXG4gICAgICBpZiAoY29tbWFuZC5jb21tYW5kID09PSAnSW5zZXJ0SFRNTCcpIHtcbiAgICAgICAgY29uc3QgeyBjb21tYW5kOiBsaW5rQ29tbWFuZCwgdmFsdWUgOiB7IHVybExpbmsgfSwgdmFsdWUgOiB7IHVybExpbmtUZXh0fSB9ID0gY29tbWFuZDtcblxuICAgICAgICB0aGlzLmhhbmRsZUNvbW1hbmRMaW5rKGxpbmtDb21tYW5kLCB1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZChjb21tYW5kLmNvbW1hbmQsIGZhbHNlLCBjb21tYW5kLnZhbHVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoY29tbWFuZCwgZmFsc2UsIG51bGwpO1xuICAgIH1cblxuICAgIHRoaXMudXBkYXRlTW9kZWwoKTtcbiAgICB0aGlzLnZhbHVlLmVtaXQodGhpcy5tb2RlbFZhbHVlKTtcbiAgfVxuXG4gIGxpbmtFZGl0aW5nKGV2ZW50KSB7XG4gICAgdGhpcy5pc0xpbmtFZGl0aW5nID0gISFldmVudDtcbiAgfVxuXG4gIG9uQmx1cigpIHtcbiAgICBpZiAodGhpcy5tb2RlbFZhbHVlICE9PSB0aGlzLnZhbHVlQmVmb3JlQ2hhbmdlKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0Q2hhbmdlKTtcbiAgICAgIHRoaXMudGltZW91dENoYW5nZSA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KHRoaXMubW9kZWxWYWx1ZSk7XG4gICAgICB9LCAyMDApO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzKCk6IHZvaWQge1xuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICB9XG5cbiAgb25DbGljaygpIHtcbiAgICB0aGlzLmVtaXRTZWxlY3Rpb25Db21tYW5kcygpO1xuICB9XG5cbiAgb25Gb2N1cygpIHtcbiAgICB0aGlzLnZhbHVlQmVmb3JlQ2hhbmdlID0gdGhpcy5tb2RlbFZhbHVlO1xuICB9XG5cbiAgb25LZXlEb3duKGV2ZW50KSB7XG4gICAgY29uc3Qga2V5SyA9IGV2ZW50LmtleUNvZGUgPT09IFBvS2V5Q29kZUVudW0ua2V5SztcbiAgICBjb25zdCBpc0xpbmtTaG9ydGN1dCA9IGtleUsgJiYgZXZlbnQuY3RybEtleSB8fCBrZXlLICYmIGV2ZW50Lm1ldGFLZXk7XG5cbiAgICBpZiAoaXNMaW5rU2hvcnRjdXQpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLnNob3J0Y3V0Q29tbWFuZC5lbWl0KCk7XG4gICAgfVxuXG4gICAgdGhpcy50b2dnbGVDdXJzb3JPbkxpbmsoZXZlbnQsICdhZGQnKTtcbiAgfVxuXG4gIG9uS2V5VXAoZXZlbnQ6IGFueSkge1xuICAgIHRoaXMudG9nZ2xlQ3Vyc29yT25MaW5rKGV2ZW50LCAncmVtb3ZlJyk7XG5cbiAgICB0aGlzLnJlbW92ZUJyRWxlbWVudCgpO1xuICAgIHRoaXMudXBkYXRlTW9kZWwoKTtcbiAgICB0aGlzLmVtaXRTZWxlY3Rpb25Db21tYW5kcygpO1xuICB9XG5cbiAgb25QYXN0ZSgpIHtcbiAgICB0aGlzLmFkZENsaWNrTGlzdGVuZXJPbkFuY2hvckVsZW1lbnRzKCk7XG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfVxuXG4gIHVwZGF0ZSgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlTW9kZWwoKSk7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMucmVtb3ZlQnJFbGVtZW50KCk7XG4gICAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XG4gICAgICB0aGlzLmVtaXRTZWxlY3Rpb25Db21tYW5kcygpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRDbGlja0xpc3RlbmVyT25BbmNob3JFbGVtZW50cygpIHtcbiAgICB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnYScpLmZvckVhY2goZWxlbWVudCA9PiB7XG5cbiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uQW5jaG9yQ2xpY2spO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBlbWl0U2VsZWN0aW9uQ29tbWFuZHMoKSB7XG4gICAgY29uc3QgY29tbWFuZHMgPSBwb1JpY2hUZXh0Qm9keUNvbW1hbmRzLmZpbHRlcihjb21tYW5kID0+IGRvY3VtZW50LnF1ZXJ5Q29tbWFuZFN0YXRlKGNvbW1hbmQpKTtcbiAgICBjb25zdCByZ2JDb2xvciA9IGRvY3VtZW50LnF1ZXJ5Q29tbWFuZFZhbHVlKCdGb3JlQ29sb3InKTtcblxuICAgIGxldCBoZXhDb2xvcjtcbiAgICBpZiAoIWlzSUUoKSkge1xuICAgICAgaGV4Q29sb3IgPSB0aGlzLnJnYlRvSGV4KHJnYkNvbG9yKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0N1cnNvclBvc2l0aW9uZWRJbkFMaW5rKCkpIHtcbiAgICAgIGNvbW1hbmRzLnB1c2goJ0NyZWF0ZWxpbmsnKTtcbiAgICB9XG5cbiAgICB0aGlzLnNlbGVjdGVkTGluay5lbWl0KHRoaXMubGlua0VsZW1lbnQpOyAvLyBpbXBvcnRhbnRlIGZpY2FyIGZvcmEgZG8gaWYgcGFyYSBlbWl0aXIgbWVzbW8gdW5kZWZpbmVkLlxuICAgIHRoaXMuY29tbWFuZHMuZW1pdCh7Y29tbWFuZHMsIGhleENvbG9yfSk7XG4gIH1cblxuICBwcml2YXRlIGdldFRleHRTZWxlY3Rpb24oKSB7XG4gICAgY29uc3QgdGV4dFNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xuICAgIGlmICghdGV4dFNlbGVjdGlvbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBmb2N1c05vZGUgPSB0ZXh0U2VsZWN0aW9uLmZvY3VzTm9kZSA/IHRleHRTZWxlY3Rpb24uZm9jdXNOb2RlLnBhcmVudEVsZW1lbnQgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgYW5jaG9yTm9kZSA9IHRleHRTZWxlY3Rpb24uYW5jaG9yTm9kZSA/IHRleHRTZWxlY3Rpb24uYW5jaG9yTm9kZS5wYXJlbnROb2RlIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IG5vZGUgPSBmb2N1c05vZGUgfHwgYW5jaG9yTm9kZTtcbiAgICBsZXQgdGFnTmFtZTtcblxuICAgIGlmIChub2RlKSB7XG4gICAgICB0YWdOYW1lID0gbm9kZVsndGFnTmFtZSddIHx8IG5vZGVbJ25vZGVOYW1lJ107XG4gICAgICByZXR1cm4ge1xuICAgICAgICBub2RlLFxuICAgICAgICB0YWdOYW1lXG4gICAgICB9O1xuICAgIH1cblxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVDb21tYW5kTGluayhsaW5rQ29tbWFuZDogc3RyaW5nLCB1cmxMaW5rOiBzdHJpbmcsIHVybExpbmtUZXh0OiBzdHJpbmcpIHtcbiAgICBpZiAoaXNJRSgpKSB7XG4gICAgICB0aGlzLmluc2VydEh0bWxMaW5rRWxlbWVudCh1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gJyZuYnNwOycgbmVjZXNzw6FyaW8gcGFyYSBvIGN1cnNvciBuw6NvIGZpY2FyIHByZXNvIGRlbnRybyBkbyBsaW5rIG5vIEZpcmVmb3guXG4gICAgICBjb25zdCBsaW5rVmFsdWUgPSBpc0ZpcmVmb3goKSAmJiAhdGhpcy5pc0xpbmtFZGl0aW5nID9cbiAgICAgIGAmbmJzcDske3RoaXMubWFrZUxpbmtUYWcodXJsTGluaywgdXJsTGlua1RleHQpfSZuYnNwO2AgOlxuICAgICAgdGhpcy5tYWtlTGlua1RhZyh1cmxMaW5rLCB1cmxMaW5rVGV4dCk7XG5cbiAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKGxpbmtDb21tYW5kLCBmYWxzZSwgbGlua1ZhbHVlKTtcbiAgICB9XG5cbiAgICB0aGlzLmFkZENsaWNrTGlzdGVuZXJPbkFuY2hvckVsZW1lbnRzKCk7XG4gIH1cblxuICAvLyB0cmF0YW1lbnRvIGVzcGVjw61maWNvIHBhcmEgSUUgcG9pcyBuw6NvIHN1cG9ydGEgbyBjb21hbmRvICdpbnNlcnRIVE1MJy5cbiAgcHJpdmF0ZSBpbnNlcnRIdG1sTGlua0VsZW1lbnQodXJsTGluazogc3RyaW5nLCB1cmxMaW5rVGV4dDogc3RyaW5nKSB7XG4gICAgY29uc3TCoHNlbGVjdGlvbsKgPcKgZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XG4gICAgY29uc3Qgc2VsZWN0aW9uUmFuZ2UgPSBzZWxlY3Rpb24uZ2V0UmFuZ2VBdCgwKTtcbiAgICBjb25zdCBlbGVtZW50TGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbiAgICBjb25zdCBlbGVtZW50bGlua1RleHQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh1cmxMaW5rVGV4dCk7XG5cbiAgICBlbGVtZW50TGluay5hcHBlbmRDaGlsZChlbGVtZW50bGlua1RleHQpO1xuICAgIGVsZW1lbnRMaW5rLmhyZWYgPSB1cmxMaW5rO1xuICAgIGVsZW1lbnRMaW5rLnNldEF0dHJpYnV0ZSgndGFyZ2V0JywgJ19ibGFuaycpO1xuICAgIGVsZW1lbnRMaW5rLmNsYXNzTGlzdC5hZGQoJ3BvLXJpY2gtdGV4dC1saW5rJyk7XG5cbiAgICBzZWxlY3Rpb25SYW5nZS5kZWxldGVDb250ZW50cygpO1xuICAgIHNlbGVjdGlvblJhbmdlLmluc2VydE5vZGUoZWxlbWVudExpbmspO1xuICB9XG5cbiAgcHJpdmF0ZcKgaXNDdXJzb3JQb3NpdGlvbmVkSW5BTGluaygpOiBib29sZWFuwqB7XG4gICAgY29uc3TCoHRleHRTZWxlY3Rpb27CoD3CoHRoaXMuZ2V0VGV4dFNlbGVjdGlvbigpO1xuICAgIHRoaXMubGlua0VsZW1lbnQgPSB1bmRlZmluZWQ7XG5cbiAgICBsZXQgaXNMaW5rID0gZmFsc2U7XG5cbiAgICBpZsKgKHRleHRTZWxlY3Rpb24gJiYgdGV4dFNlbGVjdGlvbi5ub2RlICYmIHRleHRTZWxlY3Rpb24udGFnTmFtZcKgPT09wqAnQScpwqB7XG4gICAgICB0aGlzLmxpbmtFbGVtZW50ID0gdGV4dFNlbGVjdGlvbi5ub2RlO1xuICAgICAgaXNMaW5rID0gdHJ1ZTtcblxuICAgIH0gZWxzZSBpZiAoKGlzRmlyZWZveCgpIHx8IGlzSUVPckVkZ2UoKSkgJiYgdGhpcy52ZXJpZnlDdXJzb3JQb3NpdGlvbkluRmlyZWZveElFRWRnZSgpKSB7XG4gICAgICBpc0xpbmsgPSB0cnVlO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgIGlzTGluayA9IHRleHRTZWxlY3Rpb24gPyB0aGlzLmlzUGFyZW50Tm9kZUFuY2hvcih0ZXh0U2VsZWN0aW9uKSA6IGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gaXNMaW5rO1xuICB9XG5cbiAgcHJpdmF0ZcKgaXNQYXJlbnROb2RlQW5jaG9yKHRleHRTZWxlY3Rpb24pOiBib29sZWFuIHtcbiAgICBsZXQgZWxlbWVudCA9IHRleHRTZWxlY3Rpb24ubm9kZTtcbiAgICBsZXQgaXNMaW5rID0gZmFsc2U7XG5cbiAgICB3aGlsZcKgKGVsZW1lbnQgJiYgKGVsZW1lbnQudGFnTmFtZcKgIT09IG51bGwgfHwgZWxlbWVudC5ub2RlTmFtZSAhPT0gbnVsbCkpwqB7XG4gICAgICBpZsKgKGVsZW1lbnQudGFnTmFtZcKgPT09ICdBJyB8fCBlbGVtZW50Lm5vZGVOYW1lID09PSAnQScpwqB7XG4gICAgICAgIHRoaXMubGlua0VsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgICBpc0xpbmsgPSB0cnVlO1xuICAgICAgICByZXR1cm7CoGlzTGluaztcbiAgICAgIH1cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQgfHwgZWxlbWVudC5wYXJlbnROb2RlO1xuICAgIH1cblxuICAgIHRoaXMubGlua0VsZW1lbnQgPSB1bmRlZmluZWQ7XG4gICAgcmV0dXJuwqBpc0xpbms7XG4gIH1cblxuICBwcml2YXRlIG1ha2VMaW5rVGFnKHVybExpbms6IHN0cmluZywgdXJsTGlua1RleHQ6IHN0cmluZykge1xuICAgIHJldHVybiBgPGEgY2xhc3M9XCJwby1yaWNoLXRleHQtbGlua1wiIGhyZWY9XCIke3VybExpbmt9XCIgdGFyZ2V0PVwiX2JsYW5rXCI+JHt1cmxMaW5rVGV4dCB8fCB1cmxMaW5rfTwvYT5gO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkFuY2hvckNsaWNrID0gZXZlbnQgPT4ge1xuICAgIGNvbnN0IHsgdGFyZ2V0LCBjdHJsS2V5LCBtZXRhS2V5IH0gPSBldmVudDtcbiAgICBsZXQgdXJsO1xuICAgIGxldCBlbGVtZW50TGluaztcblxuICAgIGlmIChjdHJsS2V5IHx8IG1ldGFLZXkpIHtcbiAgICAgIGlmIChldmVudC5wYXRoKSB7XG4gICAgICAgIGV2ZW50LnBhdGguZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlTmFtZSA9PT0gJ0EnKSB7XG4gICAgICAgICAgICB1cmwgPSBlbGVtZW50LmhyZWY7XG4gICAgICAgICAgICBlbGVtZW50TGluayA9IGVsZW1lbnQ7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHVybCA9IHRhcmdldC5hdHRyaWJ1dGVzLmhyZWYudmFsdWU7XG4gICAgICAgIGVsZW1lbnRMaW5rID0gdGFyZ2V0O1xuICAgICAgfVxuICAgICAgb3BlbkV4dGVybmFsTGluayh1cmwpO1xuICAgICAgZWxlbWVudExpbmsuY2xhc3NMaXN0LnJlbW92ZSgncG8tY2xpY2thYmxlJyk7XG4gICAgfVxuICB9XG5cbiAgLy8gVHJhdGFtZW50byBuZWNlc3PDoXJpbyBwYXJhIGVsaW1pbmFyIGEgdGFnIDxicj4gY3JpYWRhIG5vIGZpcmVmb3ggcXVhbmRvIG8gYm9keSBmb3IgbGltcG8uXG4gIHByaXZhdGUgcmVtb3ZlQnJFbGVtZW50KCkge1xuICAgIGNvbnN0IGJvZHlFbGVtZW50ID0gdGhpcy5ib2R5RWxlbWVudC5uYXRpdmVFbGVtZW50O1xuXG4gICAgaWYgKCFib2R5RWxlbWVudC5pbm5lclRleHQudHJpbSgpICYmIGJvZHlFbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxICYmIGJvZHlFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JyJykpIHtcbiAgICAgIGJvZHlFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JyJykucmVtb3ZlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZ2JUb0hleChyZ2IpIHtcbiAgICAvLyBUcmF0YW1lbnRvIG5lY2Vzc8OhcmlvIHBhcmEgY29udmVydGVyIG8gY8OzZGlnbyByZ2IgcGFyYSBoZXhhZGVjaW1hbC5cbiAgICBjb25zdCBzZXAgPSByZ2IuaW5kZXhPZignLCcpID4gLTEgPyAnLCcgOiAnICc7XG4gICAgcmdiID0gcmdiLnN1YnN0cig0KS5zcGxpdCgnKScpWzBdLnNwbGl0KHNlcCk7XG5cbiAgICBsZXQgciA9ICgrcmdiWzBdKS50b1N0cmluZygxNik7XG4gICAgbGV0IGcgPSAoK3JnYlsxXSkudG9TdHJpbmcoMTYpO1xuICAgIGxldCBiID0gKCtyZ2JbMl0pLnRvU3RyaW5nKDE2KTtcblxuICAgIGlmIChyLmxlbmd0aCA9PT0gMSkge1xuICAgICAgciA9ICcwJyArIHI7XG4gICAgfVxuICAgIGlmIChnLmxlbmd0aCA9PT0gMSkge1xuICAgICAgZyA9ICcwJyArIGc7XG4gICAgfVxuICAgIGlmIChiLmxlbmd0aCA9PT0gMSkge1xuICAgICAgYiA9ICcwJyArIGI7XG4gICAgfVxuXG4gICAgcmV0dXJuICcjJyArIHIgKyBnICsgYjtcbiAgfVxuXG4gIHByaXZhdGUgdG9nZ2xlQ3Vyc29yT25MaW5rKGV2ZW50OiBhbnksIGFjdGlvbjogJ2FkZCcgfCAncmVtb3ZlJykge1xuICAgIGNvbnN0IHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xuICAgIGNvbnN0IGVsZW1lbnQgPSBzZWxlY3Rpb24uZm9jdXNOb2RlID8gc2VsZWN0aW9uLmZvY3VzTm9kZS5wYXJlbnROb2RlIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IGlzQ3RybCA9IGV2ZW50LmtleSA9PT0gJ0NvbnRyb2wnO1xuICAgIGNvbnN0IGlzQ29tbWFuZCA9IGV2ZW50LmtleSA9PT0gJ01ldGEnO1xuICAgIGNvbnN0IGlzT25DdHJsTGluayA9IHRoaXMuaXNDdXJzb3JQb3NpdGlvbmVkSW5BTGluaygpICYmIChpc0N0cmwgfHwgaXNDb21tYW5kKTtcblxuICAgIGlmIChlbGVtZW50KSB7XG4gICAgICBpZiAoaXNPbkN0cmxMaW5rKSB7XG4gICAgICAgIGVsZW1lbnRbJ2NsYXNzTGlzdCddW2FjdGlvbl0oJ3BvLWNsaWNrYWJsZScpO1xuXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBpc0NsaWNrYWJsZSA9IGVsZW1lbnRbJ2NsYXNzTGlzdCddICYmIGVsZW1lbnRbJ2NsYXNzTGlzdCddLmNvbnRhaW5zKCdwby1jbGlja2FibGUnKTtcblxuICAgICAgICBpZiAoaXNDbGlja2FibGUpIHtcbiAgICAgICAgICBlbGVtZW50WydjbGFzc0xpc3QnXS5yZW1vdmUoJ3BvLWNsaWNrYWJsZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XG4gICAgfVxuXG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZU1vZGVsKCkge1xuICAgIHRoaXMubW9kZWxWYWx1ZSA9IHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5pbm5lckhUTUw7XG5cbiAgICB0aGlzLnZhbHVlLmVtaXQodGhpcy5tb2RlbFZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlVmFsdWVXaXRoTW9kZWxWYWx1ZSgpIHtcbiAgICBpZiAodGhpcy5tb2RlbFZhbHVlKSB7XG4gICAgICB0aGlzLmJvZHlFbGVtZW50Lm5hdGl2ZUVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCdhZnRlcmJlZ2luJywgdGhpcy5tb2RlbFZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHZlcmlmeUN1cnNvclBvc2l0aW9uSW5GaXJlZm94SUVFZGdlKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHRleHRTZWxlY3Rpb24gPSBkb2N1bWVudC5nZXRTZWxlY3Rpb24oKTtcbiAgICBjb25zdCBub2RlTGluayA9IHRleHRTZWxlY3Rpb24uZm9jdXNOb2RlO1xuICAgIGxldCBpc0xpbmsgPSBmYWxzZTtcblxuICAgIGlmIChub2RlTGluayAmJiBub2RlTGluay5ub2RlTmFtZSA9PT0gJ0EnKSB7XG4gICAgICB0aGlzLmxpbmtFbGVtZW50ID0gbm9kZUxpbms7XG4gICAgICBpc0xpbmsgPSB0cnVlO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJhbmdlID0gdGV4dFNlbGVjdGlvbi5nZXRSYW5nZUF0KDApO1xuICAgICAgY29uc3QgZnJhZ21lbnREb2N1bWVudCA9IHJhbmdlLmNsb25lQ29udGVudHMoKTtcbiAgICAgIGNvbnN0IGVsZW1lbnQgPSBmcmFnbWVudERvY3VtZW50LmNoaWxkTm9kZXNbMF0gfHwgZnJhZ21lbnREb2N1bWVudC5maXJzdEVsZW1lbnRDaGlsZDtcblxuICAgICAgdGhpcy5saW5rRWxlbWVudCA9IChlbGVtZW50ICYmIGVsZW1lbnQubm9kZU5hbWUgPT09ICdBJykgPyBlbGVtZW50IDogdW5kZWZpbmVkO1xuICAgICAgaXNMaW5rID0gISF0aGlzLmxpbmtFbGVtZW50O1xuICAgIH1cblxuICAgIHJldHVybiBpc0xpbms7XG4gIH1cblxufVxuIl19