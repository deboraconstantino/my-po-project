import * as tslib_1 from "tslib";
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { PoI18nPipe } from '../../../../services/po-i18n/po-i18n.pipe';
import { PoNotificationService } from '../../../../services/po-notification/po-notification.service';
var PoUploadDragDropDirective = /** @class */ (function () {
    function PoUploadDragDropDirective(i18nPipe, notification) {
        this.i18nPipe = i18nPipe;
        this.notification = notification;
        this.dragLeave = new EventEmitter();
        this.dragOver = new EventEmitter();
        this.fileChange = new EventEmitter();
    }
    PoUploadDragDropDirective.prototype.onDragLeave = function (event) {
        var _this = this;
        event.preventDefault();
        event.stopPropagation();
        this.timeout = setTimeout(function () { return _this.dragLeave.emit(); }, 30);
    };
    PoUploadDragDropDirective.prototype.onDragOver = function (event) {
        event.preventDefault();
        event.stopPropagation();
        clearTimeout(this.timeout);
        if (!this.disabled) {
            this.dragOver.emit();
        }
    };
    PoUploadDragDropDirective.prototype.onDrop = function (event) {
        event.preventDefault();
        event.stopPropagation();
        this.getFilesFromDataTransferItems(event);
        this.dragLeave.emit();
    };
    PoUploadDragDropDirective.prototype.getFilesFromDataTransferItems = function (event) {
        var _this = this;
        if (!this.disabled) {
            this.invalidFileType = 0;
            if (this.directoryCompatible) {
                this.getOnlyDirectories(event.dataTransfer.items).then(function () {
                    _this.sendFiles(event, _this.files);
                });
            }
            else {
                var files = this.getOnlyFiles(event.dataTransfer.files);
                this.sendFiles(event, files);
            }
        }
    };
    // analisa as entradas recursivamente
    PoUploadDragDropDirective.prototype.getFilesFromEntry = function (entry) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var file;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!entry.isFile) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.readFile(entry)];
                    case 1:
                        file = _a.sent();
                        return [2 /*return*/, [file]];
                    case 2:
                        if (!entry.isDirectory) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.readDirectory(entry)];
                    case 3: return [2 /*return*/, _a.sent()];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    PoUploadDragDropDirective.prototype.getOnlyDirectories = function (dataTransferItems) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_1, _a, e_2, _b, entries, dataTransferItems_1, dataTransferItems_1_1, item, entries_1, entries_1_1, entry, newFiles, e_2_1;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        entries = [];
                        try {
                            // lista todas as entradas antes de analisá-las
                            for (dataTransferItems_1 = tslib_1.__values(dataTransferItems), dataTransferItems_1_1 = dataTransferItems_1.next(); !dataTransferItems_1_1.done; dataTransferItems_1_1 = dataTransferItems_1.next()) {
                                item = dataTransferItems_1_1.value;
                                entries.push(item.webkitGetAsEntry());
                            }
                        }
                        catch (e_1_1) { e_1 = { error: e_1_1 }; }
                        finally {
                            try {
                                if (dataTransferItems_1_1 && !dataTransferItems_1_1.done && (_a = dataTransferItems_1.return)) _a.call(dataTransferItems_1);
                            }
                            finally { if (e_1) throw e_1.error; }
                        }
                        this.files = [];
                        _c.label = 1;
                    case 1:
                        _c.trys.push([1, 7, 8, 9]);
                        entries_1 = tslib_1.__values(entries), entries_1_1 = entries_1.next();
                        _c.label = 2;
                    case 2:
                        if (!!entries_1_1.done) return [3 /*break*/, 6];
                        entry = entries_1_1.value;
                        if (!entry.isFile) return [3 /*break*/, 3];
                        this.invalidFileType++;
                        return [3 /*break*/, 5];
                    case 3: return [4 /*yield*/, this.getFilesFromEntry(entry)];
                    case 4:
                        newFiles = _c.sent();
                        this.files = this.files.concat(newFiles);
                        _c.label = 5;
                    case 5:
                        entries_1_1 = entries_1.next();
                        return [3 /*break*/, 2];
                    case 6: return [3 /*break*/, 9];
                    case 7:
                        e_2_1 = _c.sent();
                        e_2 = { error: e_2_1 };
                        return [3 /*break*/, 9];
                    case 8:
                        try {
                            if (entries_1_1 && !entries_1_1.done && (_b = entries_1.return)) _b.call(entries_1);
                        }
                        finally { if (e_2) throw e_2.error; }
                        return [7 /*endfinally*/];
                    case 9: return [2 /*return*/];
                }
            });
        });
    };
    // return only files. If it is a directory, invalidFileType counts.
    PoUploadDragDropDirective.prototype.getOnlyFiles = function (fileList) {
        var _this = this;
        return Array.from(fileList).reduce(function (newFiles, file) {
            if (file.type) {
                return newFiles.concat(file);
            }
            else {
                _this.invalidFileType++;
            }
            return newFiles;
        }, []);
    };
    PoUploadDragDropDirective.prototype.readFile = function (entry) {
        return new Promise(function (resolve) {
            entry.file(function (file) {
                resolve(file);
            });
        });
    };
    PoUploadDragDropDirective.prototype.readDirectory = function (entry) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var dirReader, files, newFiles;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        dirReader = entry.createReader();
                        files = [];
                        return [4 /*yield*/, this.readDirectoryEntries(dirReader)];
                    case 1:
                        newFiles = _a.sent();
                        files = files.concat(newFiles);
                        return [2 /*return*/, files];
                }
            });
        });
    };
    PoUploadDragDropDirective.prototype.readDirectoryEntries = function (dirReader) {
        var _this = this;
        return new Promise(function (resolve) {
            dirReader.readEntries(function (entries) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                var e_3, _a, files, entries_2, entries_2_1, entry, itemFiles, e_3_1;
                return tslib_1.__generator(this, function (_b) {
                    switch (_b.label) {
                        case 0:
                            files = [];
                            _b.label = 1;
                        case 1:
                            _b.trys.push([1, 6, 7, 8]);
                            entries_2 = tslib_1.__values(entries), entries_2_1 = entries_2.next();
                            _b.label = 2;
                        case 2:
                            if (!!entries_2_1.done) return [3 /*break*/, 5];
                            entry = entries_2_1.value;
                            return [4 /*yield*/, this.getFilesFromEntry(entry)];
                        case 3:
                            itemFiles = _b.sent();
                            files = files.concat(itemFiles);
                            _b.label = 4;
                        case 4:
                            entries_2_1 = entries_2.next();
                            return [3 /*break*/, 2];
                        case 5: return [3 /*break*/, 8];
                        case 6:
                            e_3_1 = _b.sent();
                            e_3 = { error: e_3_1 };
                            return [3 /*break*/, 8];
                        case 7:
                            try {
                                if (entries_2_1 && !entries_2_1.done && (_a = entries_2.return)) _a.call(entries_2);
                            }
                            finally { if (e_3) throw e_3.error; }
                            return [7 /*endfinally*/];
                        case 8:
                            resolve(files);
                            return [2 /*return*/];
                    }
                });
            }); });
        });
    };
    PoUploadDragDropDirective.prototype.sendFeedback = function (invalidFiles) {
        if (invalidFiles) {
            this.setPipeArguments('invalidFileType', invalidFiles);
        }
    };
    PoUploadDragDropDirective.prototype.sendFiles = function (event, files) {
        if (this.areaElement.contains(event.target)) {
            if (files.length > 0) {
                this.fileChange.emit(files);
            }
            this.sendFeedback(this.invalidFileType);
        }
        else {
            var invalidDropAreaArg = this.directoryCompatible ? this.literals.folders : this.literals.files;
            this.setPipeArguments('invalidDropArea', invalidDropAreaArg);
        }
    };
    // método responsável por setar os argumentos do i18nPipe.
    PoUploadDragDropDirective.prototype.setPipeArguments = function (literalAttributes, args) {
        var pipeArguments = this.i18nPipe.transform(this.literals[literalAttributes], args);
        this.notification.information(pipeArguments);
    };
    PoUploadDragDropDirective.ctorParameters = function () { return [
        { type: PoI18nPipe },
        { type: PoNotificationService }
    ]; };
    tslib_1.__decorate([
        Input('p-area-element'),
        tslib_1.__metadata("design:type", HTMLElement)
    ], PoUploadDragDropDirective.prototype, "areaElement", void 0);
    tslib_1.__decorate([
        Input('p-directory-compatible'),
        tslib_1.__metadata("design:type", Boolean)
    ], PoUploadDragDropDirective.prototype, "directoryCompatible", void 0);
    tslib_1.__decorate([
        Input('p-disabled'),
        tslib_1.__metadata("design:type", Boolean)
    ], PoUploadDragDropDirective.prototype, "disabled", void 0);
    tslib_1.__decorate([
        Input('p-literals'),
        tslib_1.__metadata("design:type", Object)
    ], PoUploadDragDropDirective.prototype, "literals", void 0);
    tslib_1.__decorate([
        Output('p-drag-leave'),
        tslib_1.__metadata("design:type", EventEmitter)
    ], PoUploadDragDropDirective.prototype, "dragLeave", void 0);
    tslib_1.__decorate([
        Output('p-drag-over'),
        tslib_1.__metadata("design:type", EventEmitter)
    ], PoUploadDragDropDirective.prototype, "dragOver", void 0);
    tslib_1.__decorate([
        Output('p-file-change'),
        tslib_1.__metadata("design:type", EventEmitter)
    ], PoUploadDragDropDirective.prototype, "fileChange", void 0);
    tslib_1.__decorate([
        HostListener('document:dragleave', ['$event']),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], PoUploadDragDropDirective.prototype, "onDragLeave", null);
    tslib_1.__decorate([
        HostListener('document:dragover', ['$event']),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], PoUploadDragDropDirective.prototype, "onDragOver", null);
    tslib_1.__decorate([
        HostListener('document:drop', ['$event']),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], PoUploadDragDropDirective.prototype, "onDrop", null);
    PoUploadDragDropDirective = tslib_1.__decorate([
        Directive({
            selector: '[p-upload-drag-drop]',
            providers: [PoI18nPipe]
        }),
        tslib_1.__metadata("design:paramtypes", [PoI18nPipe, PoNotificationService])
    ], PoUploadDragDropDirective);
    return PoUploadDragDropDirective;
}());
export { PoUploadDragDropDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdXBsb2FkLWRyYWctZHJvcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3BvLWZpZWxkL3BvLXVwbG9hZC9wby11cGxvYWQtZHJhZy1kcm9wL3BvLXVwbG9hZC1kcmFnLWRyb3AuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDdkUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sOERBQThELENBQUM7QUFPckc7SUFxQkUsbUNBQW9CLFFBQW9CLEVBQVUsWUFBbUM7UUFBakUsYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUF1QjtRQU43RCxjQUFTLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFFeEQsYUFBUSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXBELGVBQVUsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUVRLENBQUM7SUFFMUMsK0NBQVcsR0FBWCxVQUFZLEtBQUs7UUFBakUsaUJBS0M7UUFKQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdkIsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXhCLElBQUksQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxFQUFyQixDQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFOEMsOENBQVUsR0FBVixVQUFXLEtBQUs7UUFDN0QsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3ZCLEtBQUssQ0FBQyxlQUFl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VTtnQkFBd0IscUJBQXFCOztJQWQ1RDtRQUF4QixLQUFLLENBQUMsZ0JBQWdCLENBQUM7MENBQWMsV0FBVztrRUFBQztJQUVqQjtRQUFoQyxLQUFLLENBQUMsd0JBQXdCLENBQUM7OzBFQUE4QjtJQUV6QztRQUFwQixLQUFLLENBQUMsWUFBWSxDQUFDOzsrREFBbUI7SUFFbEI7UUFBcEIsS0FBSyxDQUFDLFlBQVksQ0FBQzs7K0RBQTRCO0lBRXhCO1FBQXZCLE1BQU0sQ0FBQyxjQUFjLENBQUM7MENBQVksWUFBWTtnRUFBZ0M7SUFFeEQ7UUFBdEIsTUFBTSxDQUFDLGFBQWEsQ0FBQzswQ0FBVyxZQUFZOytEQUFnQztJQUVwRDtRQUF4QixNQUFNLENBQUMsZUFBZSxDQUFDOzBDQUFhLFlBQVk7aUVBQWdDO0lBSWpDO1FBQS9DLFlBQVksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDOzs7O2dFQUs5QztJQUU4QztRQUE5QyxZQUFZLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7OzsrREFTN0M7SUFFMEM7UUFBMUMsWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDOzs7OzJEQU16QztJQS9DVSx5QkFBeUI7UUFKckMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHNCQUFzQjtZQUNoQyxTQUFTLEVBQUUsQ0FBRSxVQUFVLENBQUU7U0FDMUIsQ0FBQztpREFzQjhCLFVBQVUsRUFBd0IscUJBQXFCO09BckIxRSx5QkFBeUIsQ0FpS3JDO0lBQUQsZ0NBQUM7Q0FBQSxBQWpLRCxJQWlLQztTQWpLWSx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEV2ZW50RW1pdHRlciwgSG9zdExpc3RlbmVyLCBJbnB1dCwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBQb0kxOG5QaXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvcG8taTE4bi9wby1pMThuLnBpcGUnO1xyXG5pbXBvcnQgeyBQb05vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi8uLi9zZXJ2aWNlcy9wby1ub3RpZmljYXRpb24vcG8tbm90aWZpY2F0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBQb1VwbG9hZExpdGVyYWxzIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9wby11cGxvYWQtbGl0ZXJhbHMuaW50ZXJmYWNlJztcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW3AtdXBsb2FkLWRyYWctZHJvcF0nLFxyXG4gIHByb3ZpZGVyczogWyBQb0kxOG5QaXBlIF1cclxufSlcclxuZXhwb3J0IGNsYXNzIFBvVXBsb2FkRHJhZ0Ryb3BEaXJlY3RpdmUge1xyXG5cclxuICB0aW1lb3V0OiBhbnk7XHJcblxyXG4gIHByaXZhdGUgZmlsZXM6IEFycmF5PEZpbGU+O1xyXG4gIHByaXZhdGUgaW52YWxpZEZpbGVUeXBlOiBudW1iZXI7XHJcblxyXG4gIEBJbnB1dCgncC1hcmVhLWVsZW1lbnQnKSBhcmVhRWxlbWVudDogSFRNTEVsZW1lbnQ7XHJcblxyXG4gIEBJbnB1dCgncC1kaXJlY3RvcnktY29tcGF0aWJsZScpIGRpcmVjdG9yeUNvbXBhdGlibGU6IGJvb2xlYW47XHJcblxyXG4gIEBJbnB1dCgncC1kaXNhYmxlZCcpIGRpc2FibGVkOiBib29sZWFuO1xyXG5cclxuICBASW5wdXQoJ3AtbGl0ZXJhbHMnKSBsaXRlcmFsczogUG9VcGxvYWRMaXRlcmFscztcclxuXHJcbiAgQE91dHB1dCgncC1kcmFnLWxlYXZlJykgZHJhZ0xlYXZlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBAT3V0cHV0KCdwLWRyYWctb3ZlcicpIGRyYWdPdmVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBAT3V0cHV0KCdwLWZpbGUtY2hhbmdlJykgZmlsZUNoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpMThuUGlwZTogUG9JMThuUGlwZSwgcHJpdmF0ZSBub3RpZmljYXRpb246IFBvTm90aWZpY2F0aW9uU2VydmljZSkgeyB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmRyYWdsZWF2ZScsIFsnJGV2ZW50J10pIG9uRHJhZ0xlYXZlKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmRyYWdMZWF2ZS5lbWl0KCksIDMwKTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmRyYWdvdmVyJywgWyckZXZlbnQnXSkgb25EcmFnT3ZlcihldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpO1xyXG5cclxuICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xyXG4gICAgICB0aGlzLmRyYWdPdmVyLmVtaXQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmRyb3AnLCBbJyRldmVudCddKSBvbkRyb3AoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICB0aGlzLmdldEZpbGVzRnJvbURhdGFUcmFuc2Zlckl0ZW1zKGV2ZW50KTtcclxuICAgIHRoaXMuZHJhZ0xlYXZlLmVtaXQoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RmlsZXNGcm9tRGF0YVRyYW5zZmVySXRlbXMoZXZlbnQ6IERyYWdFdmVudCkge1xyXG4gICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7XHJcbiAgICAgIHRoaXMuaW52YWxpZEZpbGVUeXBlID0gMDtcclxuICAgICAgaWYgKHRoaXMuZGlyZWN0b3J5Q29tcGF0aWJsZSkge1xyXG4gICAgICAgIHRoaXMuZ2V0T25seURpcmVjdG9yaWVzKGV2ZW50LmRhdGFUcmFuc2Zlci5pdGVtcykudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNlbmRGaWxlcyhldmVudCwgdGhpcy5maWxlcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmdldE9ubHlGaWxlcyhldmVudC5kYXRhVHJhbnNmZXIuZmlsZXMpO1xyXG4gICAgICAgIHRoaXMuc2VuZEZpbGVzKGV2ZW50LCBmaWxlcyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIGFuYWxpc2EgYXMgZW50cmFkYXMgcmVjdXJzaXZhbWVudGVcclxuICBwcml2YXRlIGFzeW5jIGdldEZpbGVzRnJvbUVudHJ5KGVudHJ5KSB7XHJcbiAgICBpZiAoZW50cnkuaXNGaWxlKSB7XHJcbiAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLnJlYWRGaWxlKGVudHJ5KTtcclxuICAgICAgcmV0dXJuIFtmaWxlXTtcclxuICAgIH0gZWxzZSBpZiAoZW50cnkuaXNEaXJlY3RvcnkpIHtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVhZERpcmVjdG9yeShlbnRyeSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGdldE9ubHlEaXJlY3RvcmllcyhkYXRhVHJhbnNmZXJJdGVtcykge1xyXG4gICAgY29uc3QgZW50cmllcyA9IFtdO1xyXG5cclxuICAgIC8vIGxpc3RhIHRvZGFzIGFzIGVudHJhZGFzIGFudGVzIGRlIGFuYWxpc8OhLWxhc1xyXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGRhdGFUcmFuc2Zlckl0ZW1zKSB7XHJcbiAgICAgIGVudHJpZXMucHVzaChpdGVtLndlYmtpdEdldEFzRW50cnkoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5maWxlcyA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XHJcbiAgICAgIGlmIChlbnRyeS5pc0ZpbGUpIHtcclxuICAgICAgICB0aGlzLmludmFsaWRGaWxlVHlwZSsrO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IG5ld0ZpbGVzID0gYXdhaXQgdGhpcy5nZXRGaWxlc0Zyb21FbnRyeShlbnRyeSk7XHJcbiAgICAgICAgdGhpcy5maWxlcyA9IHRoaXMuZmlsZXMuY29uY2F0KG5ld0ZpbGVzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gcmV0dXJuIG9ubHkgZmlsZXMuIElmIGl0IGlzIGEgZGlyZWN0b3J5LCBpbnZhbGlkRmlsZVR5cGUgY291bnRzLlxyXG4gIHByaXZhdGUgZ2V0T25seUZpbGVzKGZpbGVMaXN0OiBGaWxlTGlzdCk6IEFycmF5PEZpbGU+IHtcclxuICAgIHJldHVybiBBcnJheS5mcm9tKGZpbGVMaXN0KS5yZWR1Y2UoKG5ld0ZpbGVzLCBmaWxlKSA9PiB7XHJcbiAgICAgIGlmIChmaWxlLnR5cGUpIHtcclxuICAgICAgICByZXR1cm4gbmV3RmlsZXMuY29uY2F0KGZpbGUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuaW52YWxpZEZpbGVUeXBlKys7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG5ld0ZpbGVzO1xyXG4gICAgfSwgW10pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWFkRmlsZShlbnRyeSkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG4gICAgICBlbnRyeS5maWxlKGZpbGUgPT4ge1xyXG4gICAgICAgIHJlc29sdmUoZmlsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHJlYWREaXJlY3RvcnkoZW50cnkpIHtcclxuICAgIGNvbnN0IGRpclJlYWRlciA9IGVudHJ5LmNyZWF0ZVJlYWRlcigpO1xyXG4gICAgbGV0IGZpbGVzID0gW107XHJcbiAgICBsZXQgbmV3RmlsZXM7XHJcblxyXG4gICAgbmV3RmlsZXMgPSBhd2FpdCB0aGlzLnJlYWREaXJlY3RvcnlFbnRyaWVzKGRpclJlYWRlcik7XHJcbiAgICBmaWxlcyA9IGZpbGVzLmNvbmNhdChuZXdGaWxlcyk7XHJcbiAgICByZXR1cm4gZmlsZXM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlYWREaXJlY3RvcnlFbnRyaWVzKGRpclJlYWRlcikge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG4gICAgICBkaXJSZWFkZXIucmVhZEVudHJpZXMoYXN5bmMgZW50cmllcyA9PiB7XHJcbiAgICAgICAgbGV0IGZpbGVzID0gW107XHJcbiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XHJcbiAgICAgICAgICBjb25zdCBpdGVtRmlsZXMgPSBhd2FpdCB0aGlzLmdldEZpbGVzRnJvbUVudHJ5KGVudHJ5KTtcclxuICAgICAgICAgIGZpbGVzID0gZmlsZXMuY29uY2F0KGl0ZW1GaWxlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlc29sdmUoZmlsZXMpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZW5kRmVlZGJhY2soaW52YWxpZEZpbGVzOiBudW1iZXIpIHtcclxuICAgIGlmIChpbnZhbGlkRmlsZXMpIHtcclxuICAgICAgdGhpcy5zZXRQaXBlQXJndW1lbnRzKCdpbnZhbGlkRmlsZVR5cGUnLCBpbnZhbGlkRmlsZXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZW5kRmlsZXMoZXZlbnQsIGZpbGVzKSB7XHJcbiAgICBpZiAodGhpcy5hcmVhRWxlbWVudC5jb250YWlucyhldmVudC50YXJnZXQpKSB7XHJcblxyXG4gICAgICBpZiAoZmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHRoaXMuZmlsZUNoYW5nZS5lbWl0KGZpbGVzKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5zZW5kRmVlZGJhY2sodGhpcy5pbnZhbGlkRmlsZVR5cGUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgaW52YWxpZERyb3BBcmVhQXJnID0gdGhpcy5kaXJlY3RvcnlDb21wYXRpYmxlID8gdGhpcy5saXRlcmFscy5mb2xkZXJzIDogdGhpcy5saXRlcmFscy5maWxlcztcclxuICAgICAgdGhpcy5zZXRQaXBlQXJndW1lbnRzKCdpbnZhbGlkRHJvcEFyZWEnLCBpbnZhbGlkRHJvcEFyZWFBcmcpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gbcOpdG9kbyByZXNwb25zw6F2ZWwgcG9yIHNldGFyIG9zIGFyZ3VtZW50b3MgZG8gaTE4blBpcGUuXHJcbiAgcHJpdmF0ZSBzZXRQaXBlQXJndW1lbnRzKGxpdGVyYWxBdHRyaWJ1dGVzOiBzdHJpbmcsIGFyZ3M/KSB7XHJcbiAgICBjb25zdCBwaXBlQXJndW1lbnRzID0gdGhpcy5pMThuUGlwZS50cmFuc2Zvcm0odGhpcy5saXRlcmFsc1tsaXRlcmFsQXR0cmlidXRlc10sIGFyZ3MpO1xyXG4gICAgdGhpcy5ub3RpZmljYXRpb24uaW5mb3JtYXRpb24ocGlwZUFyZ3VtZW50cyk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=