import * as tslib_1 from "tslib";
import { Component, ElementRef, Input, ViewChild } from '@angular/core';
import { convertToInt, convertToBoolean } from '../../../utils/util';
import { PoMenuItemsService } from '../services/po-menu-items.service';
// valor para que caibam 3 linhas de `label`
var poMenuItemSubItemSize = 98;
/**
 * @docsPrivate
 *
 * @description
 *
 * Componente que implementa cada item do po-menu.
 */
var PoMenuItemComponent = /** @class */ (function () {
    function PoMenuItemComponent(menuItemsService) {
        this.menuItemsService = menuItemsService;
        this._isSelected = false;
        this._isSubItem = false;
        this.maxHeight = 0;
    }
    Object.defineProperty(PoMenuItemComponent.prototype, "badgeValue", {
        get: function () {
            return this._badgeValue;
        },
        // Valor do badge.
        set: function (badgeValue) {
            this._badgeValue = convertToInt(badgeValue);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "isSelected", {
        get: function () {
            return this._isSelected;
        },
        // Indica se o item está selecionado.
        set: function (value) {
            this._isSelected = convertToBoolean(value);
            this.isSelectedSubItem = this.isSelected && this.isSubItem;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "isSubItem", {
        get: function () {
            return this._isSubItem;
        },
        // Indica se o item é um sub item
        set: function (value) {
            this._isSubItem = convertToBoolean(value);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "subItems", {
        get: function () {
            return this._subItems;
        },
        // Lista de sub-items.
        set: function (subitems) {
            this._subItems = subitems;
            if (this.isOpened) {
                this.calcMenuSubItemsMaxHeight();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "canShowBadge", {
        get: function () {
            return this.type !== 'subItems' && (this.badgeValue || this.badgeValue === 0) && this.badgeValue >= 0;
        },
        enumerable: true,
        configurable: true
    });
    PoMenuItemComponent.prototype.ngOnDestroy = function () {
        this.itemSubscription.unsubscribe();
    };
    PoMenuItemComponent.prototype.ngOnInit = function () {
        var _this = this;
        // subscribe to menu component messages
        this.itemSubscription = this.menuItemsService.receiveFromParentMenuClicked().subscribe(function (menu) {
            _this.processMenuItem(menu);
        });
    };
    PoMenuItemComponent.prototype.clickMenuItem = function (event) {
        if (!(event.ctrlKey || event.metaKey)) {
            event.preventDefault();
            // Emmit to parent
            this.menuItemsService.sendToParentMenuClicked({
                link: this.link,
                action: this.action,
                id: this.id,
                icon: this.icon,
                label: this.label,
                level: this.level,
                subItems: this.subItems,
                isSelected: this.isSelected,
                isOpened: this.isOpened,
                shortLabel: this.shortLabel,
                type: this.type
            });
        }
    };
    PoMenuItemComponent.prototype.accordionAnimation = function (menuActive, menuOpened, hasSubItemOpened, activatedByRoute) {
        if (this.id === menuOpened['id']) {
            this.maxHeight = this.subItems.length * poMenuItemSubItemSize;
        }
        if (hasSubItemOpened) {
            this.maxHeight = menuOpened['isOpened'] ?
                (this.maxHeight + menuOpened.subItems.length * poMenuItemSubItemSize) :
                (this.maxHeight - menuOpened.subItems.length * poMenuItemSubItemSize);
            if (activatedByRoute) {
                this.maxHeight = this.getMinimumHeight(0, this, menuActive);
            }
        }
    };
    PoMenuItemComponent.prototype.activateMenu = function (menu) {
        this.isSelected = menu && this.id === menu.id;
    };
    PoMenuItemComponent.prototype.calcMenuSubItemsMaxHeight = function () {
        var _this = this;
        setTimeout(function () {
            var subItems = Array.from(_this.menuSubItems.nativeElement.querySelectorAll('.po-menu-item'));
            subItems.forEach(function (menuItem) { return _this.maxHeight += menuItem.offsetHeight; });
        });
    };
    PoMenuItemComponent.prototype.getMinimumHeight = function (minimumHeight, menuItem, menuActive) {
        minimumHeight += poMenuItemSubItemSize;
        if (menuItem.subItems && this.hasSubItem(menuItem.subItems, menuActive['id'])) {
            for (var index = 0; index < menuItem.subItems.length; index++) {
                minimumHeight = this.getMinimumHeight(minimumHeight, menuItem.subItems[index], menuActive);
            }
        }
        return minimumHeight;
    };
    PoMenuItemComponent.prototype.groupedMenu = function (menuActive, menuOpened, activatedByRoute) {
        if (activatedByRoute === void 0) { activatedByRoute = false; }
        var hasSubItemOpened = (menuOpened && this.id !== menuOpened['id']) ? this.hasSubItem(this.subItems, menuOpened['id']) : false;
        this.isOpened = this.isMenuOpened(menuOpened, hasSubItemOpened);
        this.isSelected = (menuActive && !this.isOpened) ? this.hasSubItem(this.subItems, menuActive['id']) : false;
        if (!this.isOpened) {
            this.maxHeight = 0;
            return;
        }
        this.accordionAnimation(menuActive, menuOpened, hasSubItemOpened, activatedByRoute);
    };
    PoMenuItemComponent.prototype.hasSubItem = function (subItems, id) {
        var _this = this;
        if (subItems) {
            return subItems.some(function (item) {
                return item['id'] === id ? true : _this.hasSubItem(item.subItems, id);
            });
        }
    };
    PoMenuItemComponent.prototype.isMenuOpened = function (menuOpened, hasSubItemOpened) {
        if (menuOpened) {
            return (this.id === menuOpened['id']) ? menuOpened['isOpened'] : hasSubItemOpened;
        }
        return false;
    };
    PoMenuItemComponent.prototype.processMenuItem = function (menu) {
        if (this.type === 'internalLink') {
            this.activateMenu(menu.active);
            return;
        }
        if (this.type === 'subItems') {
            this.groupedMenu(menu.active, menu.grouped, menu.activatedByRoute);
            return;
        }
    };
    PoMenuItemComponent.ctorParameters = function () { return [
        { type: PoMenuItemsService }
    ]; };
    tslib_1.__decorate([
        Input('p-action'),
        tslib_1.__metadata("design:type", Object)
    ], PoMenuItemComponent.prototype, "action", void 0);
    tslib_1.__decorate([
        Input('p-badge-alert'),
        tslib_1.__metadata("design:type", Boolean)
    ], PoMenuItemComponent.prototype, "badgeAlert", void 0);
    tslib_1.__decorate([
        Input('p-badge-color'),
        tslib_1.__metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "badgeColor", void 0);
    tslib_1.__decorate([
        Input('p-badge-value'),
        tslib_1.__metadata("design:type", Number),
        tslib_1.__metadata("design:paramtypes", [Number])
    ], PoMenuItemComponent.prototype, "badgeValue", null);
    tslib_1.__decorate([
        Input('p-collapsed-menu'),
        tslib_1.__metadata("design:type", Boolean)
    ], PoMenuItemComponent.prototype, "collapsedMenu", void 0);
    tslib_1.__decorate([
        Input('p-icon'),
        tslib_1.__metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "icon", void 0);
    tslib_1.__decorate([
        Input('p-id'),
        tslib_1.__metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "id", void 0);
    tslib_1.__decorate([
        Input('p-is-opened'),
        tslib_1.__metadata("design:type", Boolean)
    ], PoMenuItemComponent.prototype, "isOpened", void 0);
    tslib_1.__decorate([
        Input('p-is-selected'),
        tslib_1.__metadata("design:type", Boolean),
        tslib_1.__metadata("design:paramtypes", [Boolean])
    ], PoMenuItemComponent.prototype, "isSelected", null);
    tslib_1.__decorate([
        Input('p-is-sub-item'),
        tslib_1.__metadata("design:type", Boolean),
        tslib_1.__metadata("design:paramtypes", [Boolean])
    ], PoMenuItemComponent.prototype, "isSubItem", null);
    tslib_1.__decorate([
        Input('p-label'),
        tslib_1.__metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "label", void 0);
    tslib_1.__decorate([
        Input('p-level'),
        tslib_1.__metadata("design:type", Number)
    ], PoMenuItemComponent.prototype, "level", void 0);
    tslib_1.__decorate([
        Input('p-link'),
        tslib_1.__metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "link", void 0);
    tslib_1.__decorate([
        Input('p-short-label'),
        tslib_1.__metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "shortLabel", void 0);
    tslib_1.__decorate([
        Input('p-sub-items'),
        tslib_1.__metadata("design:type", Array),
        tslib_1.__metadata("design:paramtypes", [Array])
    ], PoMenuItemComponent.prototype, "subItems", null);
    tslib_1.__decorate([
        Input('p-type'),
        tslib_1.__metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "type", void 0);
    tslib_1.__decorate([
        ViewChild('menuSubItems', { static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], PoMenuItemComponent.prototype, "menuSubItems", void 0);
    PoMenuItemComponent = tslib_1.__decorate([
        Component({
            selector: 'po-menu-item',
            template: "<!-- menu com link interno -->\n<a *ngIf=\"type === 'internalLink'\" class=\"po-menu-item-link\" [routerLink]=\"link\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu com link externo -->\n<a *ngIf=\"type === 'externalLink'\" class=\"po-menu-item-link\" [href]=\"link\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu sem link -->\n<a *ngIf=\"type === 'noLink'\" class=\"po-menu-item-link\" href=\"javascript:;\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu com sub itens -->\n<div *ngIf=\"type === 'subItems'\" class=\"po-menu-item-link po-clickable\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate;\"></ng-container>\n  <div #menuSubItems\n    class=\"po-menu-sub-items\"\n    [hidden]=\"collapsedMenu\"\n    [style.maxHeight.px]=\"maxHeight\">\n    <div *ngFor=\"let subItem of subItems\">\n      <po-menu-item\n        p-is-sub-item\n        [p-action]=\"subItem.action\"\n        [p-badge-alert]=\"subItem.badgeAlert\"\n        [p-badge-color]=\"subItem.badge ? subItem.badge.color : undefined\"\n        [p-badge-value]=\"subItem.badge ? subItem.badge.value : undefined\"\n        [p-id]=\"subItem.id\"\n        [p-label]=\"subItem.label\"\n        [p-level]=\"subItem.level\"\n        [p-link]=\"subItem.link\"\n        [p-sub-items]=\"subItem.subItems\"\n        [p-type]=\"subItem.type\">\n      </po-menu-item>\n    </div>\n  </div>\n</div>\n\n<ng-template #menuItemTemplate>\n  <div class=\"po-menu-item\"\n    [class.po-menu-icon-container]=\"level === 1 && icon\"\n    [class.po-menu-item-selected]=\"isSelected\"\n    [class.po-menu-item-level-two]=\"level === 2\"\n    [class.po-menu-item-level-three]=\"level === 3\"\n    [class.po-menu-item-level-four]=\"level === 4\"\n    [class.po-menu-item-grouper-up]=\"type === 'subItems' && isOpened\"\n    [class.po-menu-item-grouper-down]=\"type === 'subItems' && !isOpened\"\n    [class.po-menu-sub-item-selected]=\"isSelectedSubItem\"\n    (click)=\"clickMenuItem($event);\">\n    <po-badge *ngIf=\"canShowBadge\"\n      [ngClass]=\"!collapsedMenu ? 'po-menu-badge-align' : 'po-menu-badge-align-collapsed'\"\n      [p-color]=\"badgeColor\"\n      [p-value]=\"badgeValue\">\n    </po-badge>\n    <span *ngIf=\"level === 1 && icon\" class=\"po-icon {{icon}} po-menu-icon-item\"></span>\n    <div *ngIf=\"badgeAlert\"\n      class=\"po-color-07\"\n      [ngClass]=\"!collapsedMenu ? 'po-menu-badge-alert' : 'po-menu-badge-alert-collapsed'\">\n    </div>\n    <span *ngIf=\"type === 'subItems' && !collapsedMenu\"\n      class=\"po-icon po-menu-group-icon\"\n      [class.po-icon-arrow-up]=\"isOpened\"\n      [class.po-icon-arrow-down]=\"!isOpened\">\n    </span>\n    <div [class.po-menu-icon-label]=\"level === 1 && icon\">\n      {{ label }}\n    </div>\n    <div *ngIf=\"collapsedMenu\" class=\"po-menu-short-label\">{{ shortLabel }}</div>\n  </div>\n</ng-template>\n"
        }),
        tslib_1.__metadata("design:paramtypes", [PoMenuItemsService])
    ], PoMenuItemComponent);
    return PoMenuItemComponent;
}());
export { PoMenuItemComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbWVudS1pdGVtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwb3J0aW5hcmkvcG9ydGluYXJpLXVpLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tbWVudS9wby1tZW51LWl0ZW0vcG8tbWVudS1pdGVtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFxQixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJM0YsT0FBTyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR3JFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRXZFLDRDQUE0QztBQUM1QyxJQUFNLHFCQUFxQixHQUFHLEVBQUUsQ0FBQztBQUVqQzs7Ozs7O0dBTUc7QUFLSDtJQThGRSw2QkFBb0IsZ0JBQW9DO1FBQXBDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBb0I7UUEzRmhELGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGVBQVUsR0FBWSxLQUFLLENBQUM7UUFJcEMsY0FBUyxHQUFXLENBQUMsQ0FBQztJQXNGc0MsQ0FBQztJQXhFckMsc0JBQUksMkNBQVU7YUFJdEM7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUIsQ0FBQztRQVBELGtCQUFrQjthQUNNLFVBQWUsVUFBa0I7WUFDdkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUMsQ0FBQzs7O09BQUE7SUFtQnVCLHNCQUFJLDJDQUFVO2FBS3RDO1lBQ0UsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQzFCLENBQUM7UUFSRCxxQ0FBcUM7YUFDYixVQUFlLEtBQWM7WUFDbkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUUzQyxJQUFJLENBQUMs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QixDQUFDOzs4REFBd0I7SUFHakM7UUFBaEIsS0FBSyxDQUFDLFFBQVEsQ0FBQzs7cURBQWM7SUFHZjtRQUFkLEtBQUssQ0FBQyxNQUFNLENBQUM7O21EQUFZO0lBR0o7UUFBckIsS0FBSyxDQUFDLGFBQWEsQ0FBQzs7eURBQW1CO0lBR2hCO1FBQXZCLEtBQUssQ0FBQyxlQUFlLENBQUM7Ozt5REFJdEI7SUFNdUI7UUFBdkIsS0FBSyxDQUFDLGVBQWUsQ0FBQzs7O3dEQUV0QjtJQU9pQjtRQUFqQixLQUFLLENBQUMsU0FBUyxDQUFDOztzREFBZTtJQUdkO1FBQWpCLEtBQUssQ0FBQyxTQUFTLENBQUM7O3NEQUFlO0lBR2Y7UUFBaEIsS0FBSyxDQUFDLFFBQVEsQ0FBQzs7cURBQWU7SUFHUDtRQUF2QixLQUFLLENBQUMsZUFBZSxDQUFDOzsyREFBb0I7SUFHckI7UUFBckIsS0FBSyxDQUFDLGFBQWEsQ0FBQzswQ0FBd0IsS0FBSztpREFBTCxLQUFLO3VEQUtqRDtJQU9nQjtRQUFoQixLQUFLLENBQUMsUUFBUSxDQUFDOztxREFBYztJQUVnQjtRQUE3QyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzBDQUFlLFVBQVU7NkRBQUM7SUF4RjVELG1CQUFtQjtRQUovQixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsY0FBYztZQUN4QixrNkZBQTRDO1NBQzdDLENBQUM7aURBK0ZzQyxrQkFBa0I7T0E5RjdDLG1CQUFtQixDQXFOL0I7SUFBRCwwQkFBQztDQUFBLEFBck5ELElBcU5DO1NBck5ZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IGNvbnZlcnRUb0ludCwgY29udmVydFRvQm9vbGVhbiB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xuXG5pbXBvcnQgeyBQb01lbnVJdGVtIH0gZnJvbSAnLi4vcG8tbWVudS1pdGVtLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb01lbnVJdGVtc1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9wby1tZW51LWl0ZW1zLnNlcnZpY2UnO1xuXG4vLyB2YWxvciBwYXJhIHF1ZSBjYWliYW0gMyBsaW5oYXMgZGUgYGxhYmVsYFxuY29uc3QgcG9NZW51SXRlbVN1Ykl0ZW1TaXplID0gOTg7XG5cbi8qKlxuICogQGRvY3NQcml2YXRlXG4gKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogQ29tcG9uZW50ZSBxdWUgaW1wbGVtZW50YSBjYWRhIGl0ZW0gZG8gcG8tbWVudS5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tbWVudS1pdGVtJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLW1lbnUtaXRlbS5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUG9NZW51SXRlbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSwgT25Jbml0IHtcblxuICBwcml2YXRlIF9iYWRnZVZhbHVlOiBudW1iZXI7XG4gIHByaXZhdGUgX2lzU2VsZWN0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfaXNTdWJJdGVtOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgX3N1Ykl0ZW1zOiBBcnJheTxQb01lbnVJdGVtPjtcblxuICBpc1NlbGVjdGVkU3ViSXRlbTtcbiAgbWF4SGVpZ2h0OiBudW1iZXIgPSAwO1xuXG4gIHByaXZhdGUgaXRlbVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIC8vIEHDp8OjbyBxdWUgc2Vyw6EgY2hhbWFkYSBhbyBjbGljYXIgbm8gaXRlbS5cbiAgQElucHV0KCdwLWFjdGlvbicpIGFjdGlvbjogc3RyaW5nIHwgRnVuY3Rpb247XG5cbiAgLy8gSW5kaWNhIHNlIGNvbnTDqW0gYWxndW0gaXRlbSBmaWxobyBjb20gbyBiYWRnZS5cbiAgQElucHV0KCdwLWJhZGdlLWFsZXJ0JykgYmFkZ2VBbGVydDogYm9vbGVhbjtcblxuICAvLyBDb3IgZG8gYmFkZ2UuXG4gIEBJbnB1dCgncC1iYWRnZS1jb2xvcicpIGJhZGdlQ29sb3I6IHN0cmluZztcblxuICAvLyBWYWxvciBkbyBiYWRnZS5cbiAgQElucHV0KCdwLWJhZGdlLXZhbHVlJykgc2V0IGJhZGdlVmFsdWUoYmFkZ2VWYWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fYmFkZ2VWYWx1ZSA9IGNvbnZlcnRUb0ludChiYWRnZVZhbHVlKTtcbiAgfVxuXG4gIGdldCBiYWRnZVZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLl9iYWRnZVZhbHVlO1xuICB9XG5cbiAgLy8gSW5kaWNhIHNlIG8gbWVudSBlc3TDoSBjb2xhcHNhZG9cbiAgQElucHV0KCdwLWNvbGxhcHNlZC1tZW51JykgY29sbGFwc2VkTWVudTogYm9vbGVhbjtcblxuICAvLyDDjWNvbmUgZGUgbWVudVxuICBASW5wdXQoJ3AtaWNvbicpIGljb246IHN0cmluZztcblxuICAvLyBJZGVudGlmaWNhZG9yIGRvIGl0ZW0uXG4gIEBJbnB1dCgncC1pZCcpIGlkOiBzdHJpbmc7XG5cbiAgLy8gSW5kaWNhIHNlIG8gaXRlbSBlc3TDoSBhYmVydG8gKG1lbnUgYWdydXBhZG8pXG4gIEBJbnB1dCgncC1pcy1vcGVuZWQnKSBpc09wZW5lZDogYm9vbGVhbjtcblxuICAvLyBJbmRpY2Egc2UgbyBpdGVtIGVzdMOhIHNlbGVjaW9uYWRvLlxuICBASW5wdXQoJ3AtaXMtc2VsZWN0ZWQnKSBzZXQgaXNTZWxlY3RlZCh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX2lzU2VsZWN0ZWQgPSBjb252ZXJ0VG9Cb29sZWFuKHZhbHVlKTtcblxuICAgIHRoaXMuaXNTZWxlY3RlZFN1Ykl0ZW0gPSB0aGlzLmlzU2VsZWN0ZWQgJiYgdGhpcy5pc1N1Ykl0ZW07XG4gIH1cbiAgZ2V0IGlzU2VsZWN0ZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lzU2VsZWN0ZWQ7XG4gIH1cblxuICAvLyBJbmRpY2Egc2UgbyBpdGVtIMOpIHVtIHN1YiBpdGVtXG4gIEBJbnB1dCgncC1pcy1zdWItaXRlbScpIHNldCBpc1N1Ykl0ZW0odmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLl9pc1N1Ykl0ZW0gPSBjb252ZXJ0VG9Cb29sZWFuKHZhbHVlKTtcbiAgfVxuXG4gIGdldCBpc1N1Ykl0ZW0oKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lzU3ViSXRlbTtcbiAgfVxuXG4gIC8vIFRleHRvIHF1ZSBhcGFyZWNlcsOhIHJlcHJlc2VudGFuZG8gbyBpdGVtLlxuICBASW5wdXQoJ3AtbGFiZWwnKSBsYWJlbDogc3RyaW5nO1xuXG4gIC8vIEluZGljYSBxdWFsIGVtIG7DrXZlbCBkbyBwby1tZW51IGVuY29udHJhLXNlLlxuICBASW5wdXQoJ3AtbGV2ZWwnKSBsZXZlbDogbnVtYmVyO1xuXG4gIC8vIExpbmsgZG8gaXRlbS5cbiAgQElucHV0KCdwLWxpbmsnKSBsaW5rPzogc3RyaW5nO1xuXG4gIC8vIFRleHRvIHF1ZSBhcGFyZWNlcsOhIHJlcHJlc2VudGFuZG8gbyBpdGVtLlxuICBASW5wdXQoJ3Atc2hvcnQtbGFiZWwnKSBzaG9ydExhYmVsOiBzdHJpbmc7XG5cbiAgLy8gTGlzdGEgZGUgc3ViLWl0ZW1zLlxuICBASW5wdXQoJ3Atc3ViLWl0ZW1zJykgc2V0IHN1Ykl0ZW1zKHN1Yml0ZW1zOiBBcnJheTxQb01lbnVJdGVtPikge1xuICAgIHRoaXMuX3N1Ykl0ZW1zID0gc3ViaXRlbXM7XG4gICAgaWYgKHRoaXMuaXNPcGVuZWQpIHtcbiAgICAgIHRoaXMuY2FsY01lbnVTdWJJdGVtc01heEhlaWdodCgpO1xuICAgIH1cbiAgfVxuXG4gIGdldCBzdWJJdGVtcygpIHtcbiAgICByZXR1cm4gdGhpcy5fc3ViSXRlbXM7XG4gIH1cblxuICAvLyBJbmRpY2EgbyB0aXBvIGRlIGl0ZW0sIGNvbW8gJ2ludGVybmFsTGluaycgb3UgJ3N1Ykl0ZW1zJy5cbiAgQElucHV0KCdwLXR5cGUnKSB0eXBlOiBzdHJpbmc7XG5cbiAgQFZpZXdDaGlsZCgnbWVudVN1Ykl0ZW1zJywgeyBzdGF0aWM6IGZhbHNlIH0pIG1lbnVTdWJJdGVtczogRWxlbWVudFJlZjtcblxuICBnZXQgY2FuU2hvd0JhZGdlKCkge1xuICAgIHJldHVybiB0aGlzLnR5cGUgIT09ICdzdWJJdGVtcycgJiYgKHRoaXMuYmFkZ2VWYWx1ZSB8fCB0aGlzLmJhZGdlVmFsdWUgPT09IDApICYmIHRoaXMuYmFkZ2VWYWx1ZSA+PSAwO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBtZW51SXRlbXNTZXJ2aWNlOiBQb01lbnVJdGVtc1NlcnZpY2UpIHsgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuaXRlbVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG5cbiAgICAvLyBzdWJzY3JpYmUgdG8gbWVudSBjb21wb25lbnQgbWVzc2FnZXNcbiAgICB0aGlzLml0ZW1TdWJzY3JpcHRpb24gPSB0aGlzLm1lbnVJdGVtc1NlcnZpY2UucmVjZWl2ZUZyb21QYXJlbnRNZW51Q2xpY2tlZCgpLnN1YnNjcmliZShtZW51ID0+IHtcbiAgICAgIHRoaXMucHJvY2Vzc01lbnVJdGVtKG1lbnUpO1xuICAgIH0pO1xuICB9XG5cbiAgY2xpY2tNZW51SXRlbShldmVudCk6IHZvaWQge1xuICAgIGlmICghKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSkpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgIC8vIEVtbWl0IHRvIHBhcmVudFxuICAgICAgdGhpcy5tZW51SXRlbXNTZXJ2aWNlLnNlbmRUb1BhcmVudE1lbnVDbGlja2VkKHtcbiAgICAgICAgbGluazogdGhpcy5saW5rLFxuICAgICAgICBhY3Rpb246IHRoaXMuYWN0aW9uLFxuICAgICAgICBpZDogdGhpcy5pZCxcbiAgICAgICAgaWNvbjogdGhpcy5pY29uLFxuICAgICAgICBsYWJlbDogdGhpcy5sYWJlbCxcbiAgICAgICAgbGV2ZWw6IHRoaXMubGV2ZWwsXG4gICAgICAgIHN1Ykl0ZW1zOiB0aGlzLnN1Ykl0ZW1zLFxuICAgICAgICBpc1NlbGVjdGVkOiB0aGlzLmlzU2VsZWN0ZWQsXG4gICAgICAgIGlzT3BlbmVkOiB0aGlzLmlzT3BlbmVkLFxuICAgICAgICBzaG9ydExhYmVsOiB0aGlzLnNob3J0TGFiZWwsXG4gICAgICAgIHR5cGU6IHRoaXMudHlwZVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhY2NvcmRpb25BbmltYXRpb24obWVudUFjdGl2ZTogUG9NZW51SXRlbSwgbWVudU9wZW5lZDogUG9NZW51SXRlbSwgaGFzU3ViSXRlbU9wZW5lZDogYm9vbGVhbiwgYWN0aXZhdGVkQnlSb3V0ZTogYm9vbGVhbikge1xuXG4gICAgaWYgKHRoaXMuaWQgPT09IG1lbnVPcGVuZWRbJ2lkJ10pIHtcbiAgICAgIHRoaXMubWF4SGVpZ2h0ID0gdGhpcy5zdWJJdGVtcy5sZW5ndGggKiBwb01lbnVJdGVtU3ViSXRlbVNpemU7XG4gICAgfVxuXG4gICAgaWYgKGhhc1N1Ykl0ZW1PcGVuZWQpIHtcbiAgICAgIHRoaXMubWF4SGVpZ2h0ID0gbWVudU9wZW5lZFsnaXNPcGVuZWQnXSA/XG4gICAgICAgICh0aGlzLm1heEhlaWdodCArIG1lbnVPcGVuZWQuc3ViSXRlbXMubGVuZ3RoICogcG9NZW51SXRlbVN1Ykl0ZW1TaXplKSA6XG4gICAgICAgICh0aGlzLm1heEhlaWdodCAtIG1lbnVPcGVuZWQuc3ViSXRlbXMubGVuZ3RoICogcG9NZW51SXRlbVN1Ykl0ZW1TaXplKTtcblxuICAgICAgaWYgKGFjdGl2YXRlZEJ5Um91dGUpIHtcbiAgICAgICAgdGhpcy5tYXhIZWlnaHQgPSB0aGlzLmdldE1pbmltdW1IZWlnaHQoMCwgdGhpcywgbWVudUFjdGl2ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhY3RpdmF0ZU1lbnUobWVudTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5pc1NlbGVjdGVkID0gbWVudSAmJiB0aGlzLmlkID09PSBtZW51LmlkO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjTWVudVN1Ykl0ZW1zTWF4SGVpZ2h0KCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgY29uc3Qgc3ViSXRlbXMgPSBBcnJheS5mcm9tKHRoaXMubWVudVN1Ykl0ZW1zLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnBvLW1lbnUtaXRlbScpKTtcbiAgICAgIHN1Ykl0ZW1zLmZvckVhY2goKG1lbnVJdGVtOiBhbnkpID0+IHRoaXMubWF4SGVpZ2h0ICs9IG1lbnVJdGVtLm9mZnNldEhlaWdodCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldE1pbmltdW1IZWlnaHQobWluaW11bUhlaWdodDogbnVtYmVyLCBtZW51SXRlbTogUG9NZW51SXRlbSwgbWVudUFjdGl2ZTogUG9NZW51SXRlbSkge1xuICAgIG1pbmltdW1IZWlnaHQgKz0gcG9NZW51SXRlbVN1Ykl0ZW1TaXplO1xuXG4gICAgaWYgKG1lbnVJdGVtLnN1Ykl0ZW1zICYmIHRoaXMuaGFzU3ViSXRlbShtZW51SXRlbS5zdWJJdGVtcywgbWVudUFjdGl2ZVsnaWQnXSkpIHtcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBtZW51SXRlbS5zdWJJdGVtcy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgbWluaW11bUhlaWdodCA9IHRoaXMuZ2V0TWluaW11bUhlaWdodChtaW5pbXVtSGVpZ2h0LCBtZW51SXRlbS5zdWJJdGVtc1tpbmRleF0sIG1lbnVBY3RpdmUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtaW5pbXVtSGVpZ2h0O1xuICB9XG5cbiAgcHJpdmF0ZSBncm91cGVkTWVudShtZW51QWN0aXZlOiBQb01lbnVJdGVtLCBtZW51T3BlbmVkOiBQb01lbnVJdGVtLCBhY3RpdmF0ZWRCeVJvdXRlOiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcblxuICAgIGNvbnN0IGhhc1N1Ykl0ZW1PcGVuZWQgPSAobWVudU9wZW5lZCAmJiB0aGlzLmlkICE9PSBtZW51T3BlbmVkWydpZCddKSA/IHRoaXMuaGFzU3ViSXRlbSh0aGlzLnN1Ykl0ZW1zLCBtZW51T3BlbmVkWydpZCddKSA6IGZhbHNlO1xuXG4gICAgdGhpcy5pc09wZW5lZCA9IHRoaXMuaXNNZW51T3BlbmVkKG1lbnVPcGVuZWQsIGhhc1N1Ykl0ZW1PcGVuZWQpO1xuXG4gICAgdGhpcy5pc1NlbGVjdGVkID0gKG1lbnVBY3RpdmUgJiYgIXRoaXMuaXNPcGVuZWQpID8gdGhpcy5oYXNTdWJJdGVtKHRoaXMuc3ViSXRlbXMsIG1lbnVBY3RpdmVbJ2lkJ10pIDogZmFsc2U7XG5cbiAgICBpZiAoIXRoaXMuaXNPcGVuZWQpIHtcbiAgICAgIHRoaXMubWF4SGVpZ2h0ID0gMDtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5hY2NvcmRpb25BbmltYXRpb24obWVudUFjdGl2ZSwgbWVudU9wZW5lZCwgaGFzU3ViSXRlbU9wZW5lZCwgYWN0aXZhdGVkQnlSb3V0ZSk7XG4gIH1cblxuICBwcml2YXRlIGhhc1N1Ykl0ZW0oc3ViSXRlbXM6IEFycmF5PFBvTWVudUl0ZW0+LCBpZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKHN1Ykl0ZW1zKSB7XG4gICAgICByZXR1cm4gc3ViSXRlbXMuc29tZShpdGVtID0+IHtcbiAgICAgICAgcmV0dXJuIGl0ZW1bJ2lkJ10gPT09IGlkID8gdHJ1ZSA6IHRoaXMuaGFzU3ViSXRlbShpdGVtLnN1Ykl0ZW1zLCBpZCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzTWVudU9wZW5lZChtZW51T3BlbmVkOiBQb01lbnVJdGVtLCBoYXNTdWJJdGVtT3BlbmVkOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgaWYgKG1lbnVPcGVuZWQpIHtcbiAgICAgIHJldHVybiAodGhpcy5pZCA9PT0gbWVudU9wZW5lZFsnaWQnXSkgPyBtZW51T3BlbmVkWydpc09wZW5lZCddIDogaGFzU3ViSXRlbU9wZW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NNZW51SXRlbShtZW51KSB7XG5cbiAgICBpZiAodGhpcy50eXBlID09PSAnaW50ZXJuYWxMaW5rJykge1xuICAgICAgdGhpcy5hY3RpdmF0ZU1lbnUobWVudS5hY3RpdmUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnR5cGUgPT09ICdzdWJJdGVtcycpIHtcbiAgICAgIHRoaXMuZ3JvdXBlZE1lbnUobWVudS5hY3RpdmUsIG1lbnUuZ3JvdXBlZCwgbWVudS5hY3RpdmF0ZWRCeVJvdXRlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cblxufVxuIl19