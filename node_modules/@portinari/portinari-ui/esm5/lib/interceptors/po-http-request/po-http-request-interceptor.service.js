import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { PoComponentInjectorService } from '../../services/po-component-injector/po-component-injector.service';
import { PoLoadingOverlayComponent } from '../../components/po-loading/po-loading-overlay/po-loading-overlay.component';
import { PoHttpRequesControltService } from './po-http-request-control-service';
import * as i0 from "@angular/core";
import * as i1 from "./po-http-request-control-service";
import * as i2 from "../../services/po-component-injector/po-component-injector.service";
var noCountPendingRequests = 'X-Portinari-No-Count-Pending-Requests';
var screenLock = 'X-Portinari-Screen-Lock';
/**
 * @description
 *
 * O serviço Portinari Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-Portinari-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `PoHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-Portinari-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-Portinari-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-Portinari-No-Count-Pending-Requests': true, 'X-Portinari-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: PoHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * @example
 * <example name='po-http-request-interceptor-labs' title='Portinari Http Request Interceptor Labs'>
 *  <file name='sample-po-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-po-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
var PoHttpRequestInterceptorService = /** @class */ (function () {
    function PoHttpRequestInterceptorService(controlHttpRequest, poComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.poComponentInjector = poComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    PoHttpRequestInterceptorService.prototype.intercept = function (request, next) {
        var _this = this;
        var requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(tap(function (response) {
            if (response instanceof HttpResponse) {
                _this.setCountPendingRequests(false, requestClone);
                _this.setCountOverlayRequests(false, requestClone);
            }
        }), catchError(function (error) {
            _this.setCountPendingRequests(false, requestClone);
            _this.setCountOverlayRequests(false, requestClone);
            return throwError(error);
        }));
    };
    PoHttpRequestInterceptorService.prototype.getCountPendingRequests = function () {
        return this.controlHttpRequest.getControlHttpRequest();
    };
    PoHttpRequestInterceptorService.prototype.buildLoading = function () {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.poComponentInjector.createComponentInApplication(PoLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    };
    PoHttpRequestInterceptorService.prototype.destroyLoading = function () {
        if (this.loadingOverlayComponent) {
            this.poComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    };
    PoHttpRequestInterceptorService.prototype.requestCloneWithoutHeaderParam = function (headersParams, request) {
        var isRequestClone = false;
        headersParams.forEach(function (headerParam) {
            if (request.headers.has(headerParam)) {
                request.headers.delete(headerParam);
                isRequestClone = true;
            }
        });
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    };
    PoHttpRequestInterceptorService.prototype.setCountPendingRequests = function (isIncrement, request) {
        var hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        var headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && (headerParam.toString().toLowerCase() === 'true')) {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    };
    PoHttpRequestInterceptorService.prototype.setCountOverlayRequests = function (isIncrement, request) {
        var hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            var headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    };
    PoHttpRequestInterceptorService.ctorParameters = function () { return [
        { type: PoHttpRequesControltService },
        { type: PoComponentInjectorService }
    ]; };
    PoHttpRequestInterceptorService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function PoHttpRequestInterceptorService_Factory() { return new PoHttpRequestInterceptorService(i0.ɵɵinject(i1.PoHttpRequesControltService), i0.ɵɵinject(i2.PoComponentInjectorService)); }, token: PoHttpRequestInterceptorService, providedIn: "root" });
    PoHttpRequestInterceptorService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        }),
        tslib_1.__metadata("design:paramtypes", [PoHttpRequesControltService,
            PoComponentInjectorService])
    ], PoHttpRequestInterceptorService);
    return PoHttpRequestInterceptorService;
}());
export { PoHttpRequestInterceptorService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS11aS8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1yZXF1ZXN0L3BvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQXdELFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFHLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxvRUFBb0UsQ0FBQztBQUNoSCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw2RUFBNkUsQ0FBQztBQUV4SCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQzs7OztBQUVoRixJQUFNLHNCQUFzQixHQUFHLHVDQUF1QyxDQUFDO0FBQ3ZFLElBQU0sVUFBVSxHQUFHLHlCQUF5QixDQUFDO0FBRTdDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBa0ZHO0FBSUg7SUFPRSx5Q0FDVSxrQkFBK0MsRUFDL0MsbUJBQStDO1FBRC9DLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBNkI7UUFDL0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE0QjtRQVBqRCw0QkFBdUIsR0FBNEMsU0FBUyxDQUFDO1FBRTdFLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO1FBQzVCLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO0lBSTBCLENBQUM7SUFFL0QsbURBQVMs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a0dDO1NBbEdZLCtCQUErQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEV2ZW50LCBIdHRwSGFuZGxlciwgSHR0cEludGVyY2VwdG9yLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tY29tcG9uZW50LWluamVjdG9yL3BvLWNvbXBvbmVudC1pbmplY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7IFBvTG9hZGluZ092ZXJsYXlDb21wb25lbnQgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL3BvLWxvYWRpbmcvcG8tbG9hZGluZy1vdmVybGF5L3BvLWxvYWRpbmctb3ZlcmxheS5jb21wb25lbnQnO1xuXG5pbXBvcnQgeyBQb0h0dHBSZXF1ZXNDb250cm9sdFNlcnZpY2UgfSBmcm9tICcuL3BvLWh0dHAtcmVxdWVzdC1jb250cm9sLXNlcnZpY2UnO1xuXG5jb25zdCBub0NvdW50UGVuZGluZ1JlcXVlc3RzID0gJ1gtUG9ydGluYXJpLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnO1xuY29uc3Qgc2NyZWVuTG9jayA9ICdYLVBvcnRpbmFyaS1TY3JlZW4tTG9jayc7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogTyBzZXJ2acOnbyBQb3J0aW5hcmkgSHR0cCBSZXF1ZXN0IEludGVyY2VwdG9yIHJlYWxpemEgYSBjb250YWJpbGl6YcOnw6NvIGRlIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzIG5hIGFwbGljYcOnw6NvLlxuICpcbiAqIEV4aXN0ZSBhIHBvc3NpYmlsaWRhZGUgZGUgbsOjbyBlZmV0dWFyIGEgY29udGFiaWxpemHDp8OjbyBkYXMgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMsIHV0aWxpemFuZG8gbyBwYXLDom1ldHJvXG4gKiBgWC1Qb3J0aW5hcmktTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0c2AuIFBhcmEgaXNzbyBkZXZlIHNlciBpbmZvcm1hZG8gbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gY29tIG8gdmFsb3IgYCd0cnVlJ2AsXG4gKiBwb3IgZXhlbXBsbzpcbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVBvcnRpbmFyaS1Oby1Db3VudC1QZW5kaW5nLVJlcXVlc3RzJzogJ3RydWUnIH07XG4gKlxuICogIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqIC4uLlxuICpcbiAqIGBgYFxuICogUGFyYSBvYnRlciBhIHF1YW50aWRhZGUgZGUgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMsIGRldmUgaW5zY3JldmVyLXNlIG5vIG3DqXRvZG8gYGdldENvdW50UGVuZGluZ1JlcXVlc3RzYCBkb1xuICogc2VydmnDp28gYFBvSHR0cFJlcXVlc3RJbnRlcmNlcHRvclNlcnZpY2VgLCBjb20gaXNzbywgYW8gcmVhbGl6YXIgcmVxdWlzacOnw7VlcyB1dGlsaXphbmRvIGBIdHRwQ2xpZW50YCxcbiAqIHNlcsOhIHJldG9ybmFkbyBhIHF1YW50aWRhZGUgZGUgcmVxdWlzacOnw7VlcyBwZW5kZW50ZXMuXG4gKlxuICogVGFtYsOpbSBleGlzdGUgYSBwb3NzaWJpbGRhZGUgZGUgdHJhdmFyIGEgdGVsYSBlIG1vc3RyYXIgdW1hIGltYWdlbSBkZSBfbG9hZGluZ18gZHVyYW50ZSBvIHByb2Nlc3NhbWVudG8gZGUgdW1hIHJlcXVpc2nDp8Ojb1xuICogZGV2ZS1zZSBwYXNzYXIgbyBwYXLDom1ldHJvIGBYLVBvcnRpbmFyaS1TY3JlZW4tTG9ja2Agbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gY29tIHZhbG9yIGAndHJ1ZSdgLlxuICpcbiAqIHBvciBleGVtcGxvOlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUG9ydGluYXJpLVNjcmVlbi1Mb2NrJzogJ3RydWUnIH07XG4gKlxuICogIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqIC4uLlxuICpcbiAqIGBgYFxuICogPiBBcMOzcyBhIHZhbGlkYcOnw6NvIG5vIGludGVyY2VwdG9yLCBvIHBhcsOibWV0cm8gc2Vyw6EgcmVtb3ZpZG8gZG8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28uXG4gKlxuICogQW8gaW1wb3J0YXIgbyBtw7NkdWxvIGBQb01vZHVsZWAgbmEgYXBsaWNhw6fDo28sIG8gYHBvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvcmAgw6kgYXV0b21hdGljYW1lbnRlIGNvbmZpZ3VyYWRvIHNlbSBhIG5lY2Vzc2lkYWRlXG4gKiBkZSBxdWFscXVlciBjb25maWd1cmHDp8OjbyBleHRyYS5cbiAqXG4gKlxuICogU2VndWUgYWJhaXhvIHVtIGV4ZW1wbG8gZGUgdXNvOlxuICpcbiAqIGBgYFxuICogaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbiAqXG4gKiAuLi5cbiAqXG4gKiBASW5qZWN0YWJsZSgpXG4gKiBleHBvcnQgY2xhc3MgQ3VzdG9tZXJzU2VydmljZSB7XG4gKlxuICogIGhlYWRlcnMgPSB7ICdYLVBvcnRpbmFyaS1Oby1Db3VudC1QZW5kaW5nLVJlcXVlc3RzJzogdHJ1ZSwgJ1gtUG9ydGluYXJpLVNjcmVlbi1Mb2NrJzogJ3RydWUnIH1cbiAqICBwZW5kaW5nUmVxdWVzdHM6IG51bWJlciA9IDA7XG4gKiAgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gKlxuICogIGNvbnN0cnVjdG9yKFxuICogICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICogICAgcHJpdmF0ZSBodHRwUmVxdWVzdEludGVyY2VwdG9yOiBQb0h0dHBSZXF1ZXN0SW50ZXJjZXB0b3JTZXJ2aWNlKSB7IH1cbiAqXG4gKiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gKiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICogIH1cbiAqXG4gKiAgbmdPbkluaXQoKTogdm9pZCB7XG4gKiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuaHR0cFJlcXVlc3RJbnRlcmNlcHRvci5nZXRDb3VudFBlbmRpbmdSZXF1ZXN0cygpLnN1YnNjcmliZShkYXRhID0+IHtcbiAqICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMgPSBkYXRhO1xuICogICAgfSk7XG4gKiAgfVxuICpcbiAqICBnZXRDdXN0b21lcnMoKSB7XG4gKiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogIH1cbiAqXG4gKiAgLi4uXG4gKlxuICogfVxuICogYGBgXG4gKlxuICogQGV4YW1wbGVcbiAqIDxleGFtcGxlIG5hbWU9J3BvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci1sYWJzJyB0aXRsZT0nUG9ydGluYXJpIEh0dHAgUmVxdWVzdCBJbnRlcmNlcHRvciBMYWJzJz5cbiAqICA8ZmlsZSBuYW1lPSdzYW1wbGUtcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLWxhYnMuY29tcG9uZW50LnRzJz4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9J3NhbXBsZS1wby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicy5jb21wb25lbnQuaHRtbCc+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUG9IdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZSBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG5cbiAgcHJpdmF0ZSBsb2FkaW5nT3ZlcmxheUNvbXBvbmVudDogQ29tcG9uZW50UmVmPFBvTG9hZGluZ092ZXJsYXlDb21wb25lbnQ+ID0gdW5kZWZpbmVkO1xuXG4gIHByaXZhdGUgcGVuZGluZ1JlcXVlc3RzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIG92ZXJsYXlSZXF1ZXN0czogbnVtYmVyID0gMDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNvbnRyb2xIdHRwUmVxdWVzdDogUG9IdHRwUmVxdWVzQ29udHJvbHRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcG9Db21wb25lbnRJbmplY3RvcjogUG9Db21wb25lbnRJbmplY3RvclNlcnZpY2UpIHsgIH1cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpIHtcblxuICAgIGNvbnN0IHJlcXVlc3RDbG9uZSA9IHJlcXVlc3QuY2xvbmUoKTtcblxuICAgIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RDbG9uZVdpdGhvdXRIZWFkZXJQYXJhbShbbm9Db3VudFBlbmRpbmdSZXF1ZXN0cywgc2NyZWVuTG9ja10sIHJlcXVlc3QpO1xuXG4gICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyh0cnVlLCByZXF1ZXN0Q2xvbmUpO1xuICAgIHRoaXMuc2V0Q291bnRPdmVybGF5UmVxdWVzdHModHJ1ZSwgcmVxdWVzdENsb25lKTtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgdGFwKChyZXNwb25zZTogSHR0cEV2ZW50PGFueT4pID0+IHtcbiAgICAgICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcbiAgICAgICAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xuICAgICAgICB0aGlzLnNldENvdW50UGVuZGluZ1JlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuICAgICAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKGZhbHNlLCByZXF1ZXN0Q2xvbmUpO1xuXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGdldENvdW50UGVuZGluZ1JlcXVlc3RzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbEh0dHBSZXF1ZXN0LmdldENvbnRyb2xIdHRwUmVxdWVzdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZExvYWRpbmcoKSB7XG4gICAgaWYgKCF0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KSB7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50ID0gdGhpcy5wb0NvbXBvbmVudEluamVjdG9yLmNyZWF0ZUNvbXBvbmVudEluQXBwbGljYXRpb24oUG9Mb2FkaW5nT3ZlcmxheUNvbXBvbmVudCk7XG4gICAgICB0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50Lmluc3RhbmNlLnNjcmVlbkxvY2sgPSB0cnVlO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudC5pbnN0YW5jZS5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95TG9hZGluZygpIHtcbiAgICBpZiAodGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCkge1xuICAgICAgdGhpcy5wb0NvbXBvbmVudEluamVjdG9yLmRlc3Ryb3lDb21wb25lbnRJbkFwcGxpY2F0aW9uKHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlcXVlc3RDbG9uZVdpdGhvdXRIZWFkZXJQYXJhbShoZWFkZXJzUGFyYW1zOiBBcnJheTxzdHJpbmc+LCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSHR0cFJlcXVlc3Q8YW55PiB7XG4gICAgbGV0IGlzUmVxdWVzdENsb25lID0gZmFsc2U7XG5cbiAgICBoZWFkZXJzUGFyYW1zLmZvckVhY2goaGVhZGVyUGFyYW0gPT4ge1xuICAgICAgaWYgKHJlcXVlc3QuaGVhZGVycy5oYXMoaGVhZGVyUGFyYW0pKSB7XG4gICAgICAgIHJlcXVlc3QuaGVhZGVycy5kZWxldGUoaGVhZGVyUGFyYW0pO1xuICAgICAgICBpc1JlcXVlc3RDbG9uZSA9IHRydWU7XG4gICAgICB9XG5cbiAgICB9KTtcblxuICAgIHJldHVybiBpc1JlcXVlc3RDbG9uZSA/IHJlcXVlc3QuY2xvbmUoe2hlYWRlcnM6IHJlcXVlc3QuaGVhZGVyc30pIDogcmVxdWVzdDtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoaXNJbmNyZW1lbnQ6IGJvb2xlYW4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcblxuICAgIGNvbnN0IGhhc0NvdW50UGVuZGluZ1JlcXVlc3RIZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5oYXMobm9Db3VudFBlbmRpbmdSZXF1ZXN0cyk7XG4gICAgY29uc3QgaGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KG5vQ291bnRQZW5kaW5nUmVxdWVzdHMpO1xuXG4gICAgaWYgKGhhc0NvdW50UGVuZGluZ1JlcXVlc3RIZWFkZXJQYXJhbSAmJiAoaGVhZGVyUGFyYW0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpID09PSAndHJ1ZScgKSApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cyArPSBpc0luY3JlbWVudCA/IDEgOiAtMTtcbiAgICB0aGlzLmNvbnRyb2xIdHRwUmVxdWVzdC5zZW5kKHRoaXMucGVuZGluZ1JlcXVlc3RzKTtcblxuICB9XG5cbiAgcHJpdmF0ZSBzZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyhpc0luY3JlbWVudDogYm9vbGVhbiwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGNvbnN0IGhhc092ZXJsYXlSZXF1ZXN0SGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuaGFzKHNjcmVlbkxvY2spO1xuXG4gICAgaWYgKGhhc092ZXJsYXlSZXF1ZXN0SGVhZGVyUGFyYW0pIHtcbiAgICAgIGNvbnN0IGhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmdldChzY3JlZW5Mb2NrKTtcblxuICAgICAgaWYgKGhlYWRlclBhcmFtLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKSA9PT0gJ2ZhbHNlJykge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMub3ZlcmxheVJlcXVlc3RzICs9IGlzSW5jcmVtZW50ID8gMSA6IC0xO1xuICAgICAgdGhpcy5vdmVybGF5UmVxdWVzdHMgPiAwID8gdGhpcy5idWlsZExvYWRpbmcoKSA6IHRoaXMuZGVzdHJveUxvYWRpbmcoKTtcbiAgICB9XG4gIH1cblxufVxuIl19