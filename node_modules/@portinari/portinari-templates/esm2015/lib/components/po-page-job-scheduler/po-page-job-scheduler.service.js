/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addZero, convertDateToISOExtended } from '../../utils/util';
export class PoPageJobSchedulerService {
    /**
     * @param {?} http
     */
    constructor(http) {
        this.http = http;
        this.endpoint = '/';
        this.headers = new HttpHeaders({
            'X-PORTINARI-SCREEN-LOCK': 'true'
        });
    }
    /**
     * @param {?=} config
     * @return {?}
     */
    configServiceApi(config = {}) {
        this.endpoint = config.endpoint;
    }
    // Cria um recurso
    /**
     * @param {?} resource
     * @return {?}
     */
    createResource(resource) {
        /** @type {?} */
        const jobScheduler = this.convertToJobScheduler(resource);
        return this.http.post(`${this.endpoint}`, jobScheduler, { headers: this.headers });
    }
    /**
     * @return {?}
     */
    getHeadProcesses() {
        /** @type {?} */
        const headers = { 'X-Portinari-No-Error': 'true' };
        return this.http.head(`${this.endpoint}/processes`, { headers });
    }
    // Busca parametros pelo processo id
    /**
     * @param {?} processId
     * @return {?}
     */
    getParametersByProcess(processId) {
        return this.http.get(`${this.endpoint}/processes/${processId}/parameters`, { headers: this.headers })
            .pipe(map((/**
         * @param {?} resource
         * @return {?}
         */
        (resource) => resource.items)));
    }
    // Busca um único recurso
    /**
     * @param {?} id
     * @return {?}
     */
    getProcess(id) {
        return this.http.get(`${this.endpoint}/processes/${id}`, { headers: this.headers });
    }
    // Busca uma lista de processos
    /**
     * @param {?=} params
     * @return {?}
     */
    getProcesses(params = {}) {
        return this.http.get(`${this.endpoint}/processes`, { params });
    }
    // Busca um único recurso
    /**
     * @param {?} id
     * @return {?}
     */
    getResource(id) {
        return this.http.get(`${this.endpoint}/${id}`, { headers: this.headers })
            .pipe(map((/**
         * @param {?} resource
         * @return {?}
         */
        resource => this.convertToJobSchedulerInternal(resource))));
    }
    // Atualiza um recurso
    /**
     * @param {?} id
     * @param {?} resource
     * @return {?}
     */
    updateResource(id, resource) {
        /** @type {?} */
        const jobScheduler = this.convertToJobScheduler(resource);
        return this.http.put(`${this.endpoint}/${id}`, jobScheduler, { headers: this.headers });
    }
    /**
     * @private
     * @param {?} jobSchedulerInternal
     * @return {?}
     */
    convertToJobScheduler(jobSchedulerInternal) {
        /** @type {?} */
        const jobScheduler = Object.assign({}, jobSchedulerInternal);
        if (jobSchedulerInternal.periodicity) {
            if (jobSchedulerInternal.periodicity === 'single') {
                jobScheduler.recurrent = false;
            }
            else {
                Object.assign(jobScheduler, this.convertToPeriodicity(jobSchedulerInternal));
            }
        }
        if (jobSchedulerInternal.firstExecutionHour) {
            jobScheduler.firstExecution =
                this.replaceHourFirstExecution(jobSchedulerInternal.firstExecution, jobSchedulerInternal.firstExecutionHour);
        }
        if (!Object.keys(this.returnValidExecutionParameter(jobScheduler.executionParameter)).length) {
            delete jobScheduler.executionParameter;
        }
        this.removeInvalidKeys(jobScheduler);
        return jobScheduler;
    }
    /**
     * @private
     * @param {?=} jobScheduler
     * @return {?}
     */
    convertToJobSchedulerInternal(jobScheduler = (/** @type {?} */ ({}))) {
        /** @type {?} */
        const jobSchedulerInternal = Object.assign({}, jobScheduler);
        if (jobScheduler.firstExecution) {
            jobSchedulerInternal.firstExecutionHour = this.getHourFirstExecution(jobScheduler.firstExecution);
        }
        Object.assign(jobSchedulerInternal, this.convertToPeriodicityInternal(jobScheduler));
        this.removeInvalidKeys(jobSchedulerInternal, ['weekly', 'monthly', 'daily']);
        return jobSchedulerInternal;
    }
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    convertToPeriodicity(value) {
        /** @type {?} */
        const newValue = {};
        /** @type {?} */
        const valuePeriodicity = value.periodicity;
        if (valuePeriodicity) {
            newValue[valuePeriodicity] = {};
            if (valuePeriodicity === 'monthly') {
                newValue[valuePeriodicity].day = value.dayOfMonth ? parseInt(value.dayOfMonth, 10) : 0;
            }
            else if (valuePeriodicity === 'weekly') {
                newValue[valuePeriodicity].daysOfWeek = value.daysOfWeek;
            }
            newValue[valuePeriodicity].hour = value.hour ? parseInt(value.hour.split(':')[0], 10) : 0;
            newValue[valuePeriodicity].minute = value.hour ? parseInt(value.hour.split(':')[1], 10) : 0;
        }
        return newValue;
    }
    /**
     * @private
     * @param {?=} value
     * @return {?}
     */
    convertToPeriodicityInternal(value = (/** @type {?} */ ({}))) {
        if (value.monthly) {
            return {
                periodicity: 'monthly',
                hour: `${addZero(value.monthly.hour)}:${addZero(value.monthly.minute)}`,
                dayOfMonth: value.monthly.day
            };
        }
        else if (value.daily) {
            return {
                periodicity: 'daily',
                hour: `${addZero(value.daily.hour)}:${addZero(value.daily.minute)}`
            };
        }
        else if (value.weekly) {
            return {
                periodicity: 'weekly',
                hour: `${addZero(value.weekly.hour)}:${addZero(value.weekly.minute)}`,
                daysOfWeek: [...value.weekly.daysOfWeek]
            };
        }
        else {
            return {
                periodicity: 'single'
            };
        }
    }
    /**
     * @private
     * @param {?} date
     * @return {?}
     */
    getCurrentHour(date) {
        /** @type {?} */
        const hours = addZero(date.getHours());
        /** @type {?} */
        const minutes = addZero(date.getMinutes());
        return `${hours}:${minutes}`;
    }
    /**
     * @private
     * @param {?} firstExecutionDate
     * @return {?}
     */
    getHourFirstExecution(firstExecutionDate) {
        return this.getCurrentHour(new Date(firstExecutionDate));
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} keys
     * @return {?}
     */
    removeInvalidKeys(value, keys) {
        /** @type {?} */
        const invalidKeys = keys || ['periodicity', 'hour', 'minute', 'day', 'daysOfWeek', 'dayOfMonth', 'firstExecutionHour'];
        Object.keys(value).forEach((/**
         * @param {?} key
         * @return {?}
         */
        key => {
            if (invalidKeys.includes(key)) {
                delete value[key];
            }
        }));
    }
    /**
     * @private
     * @param {?} date
     * @param {?} time
     * @return {?}
     */
    replaceHourFirstExecution(date, time) {
        /** @type {?} */
        const firstExecutionDate = new Date(date);
        /** @type {?} */
        const timeSplited = time.split(':');
        /** @type {?} */
        const hours = parseInt(timeSplited[0], 10);
        /** @type {?} */
        const minutes = parseInt(timeSplited[1], 10);
        firstExecutionDate.setHours(hours, minutes);
        return convertDateToISOExtended(firstExecutionDate);
    }
    /**
     * @private
     * @param {?} parameter
     * @return {?}
     */
    returnValidExecutionParameter(parameter) {
        /** @type {?} */
        const newParameter = Object.assign({}, parameter);
        for (const key in newParameter) {
            if (newParameter.hasOwnProperty(key) && newParameter[key] === undefined) {
                delete newParameter[key];
            }
        }
        return newParameter;
    }
}
PoPageJobSchedulerService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PoPageJobSchedulerService.ctorParameters = () => [
    { type: HttpClient }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    PoPageJobSchedulerService.prototype.endpoint;
    /** @type {?} */
    PoPageJobSchedulerService.prototype.headers;
    /**
     * @type {?}
     * @private
     */
    PoPageJobSchedulerService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcGFnZS1qb2Itc2NoZWR1bGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9ydGluYXJpL3BvcnRpbmFyaS10ZW1wbGF0ZXMvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby1wYWdlLWpvYi1zY2hlZHVsZXIvcG8tcGFnZS1qb2Itc2NoZWR1bGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckMsT0FBTyxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBT3JFLE1BQU0sT0FBTyx5QkFBeUI7Ozs7SUFRcEMsWUFBb0IsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQU41QixhQUFRLEdBQUcsR0FBRyxDQUFDO1FBRWQsWUFBTyxHQUFnQixJQUFJLFdBQVcsQ0FBQztZQUM5Qyx5QkFBeUIsRUFBRSxNQUFNO1NBQ2xDLENBQUMsQ0FBQztJQUVxQyxDQUFDOzs7OztJQUV6QyxnQkFBZ0IsQ0FBQyxTQUFnQyxFQUFFO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNsQyxDQUFDOzs7Ozs7SUFHRCxjQUFjLENBQUMsUUFBUTs7Y0FDZixZQUFZLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFFBQVEsQ0FBQztRQUV6RCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFlBQVksRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUNyRixDQUFDOzs7O0lBRUQsZ0JBQWdC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QUFDOztjQUVuQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7O2NBRTdCLEtBQUssR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQzs7Y0FDcEMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBRTVDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFNUMsT0FBTyx3QkFBd0IsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQ3RELENBQUM7Ozs7OztJQUVPLDZCQUE2QixDQUFDLFNBQWlCOztjQUMvQyxZQUFZLHFCQUFRLFNBQVMsQ0FBRTtRQUVyQyxLQUFLLE1BQU0sR0FBRyxJQUFJLFlBQVksRUFBRTtZQUM5QixJQUFJLFlBQVksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksWUFBWSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDdkUsT0FBTyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDMUI7U0FDRjtRQUVELE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7OztZQTNMRixVQUFVOzs7O1lBWkYsVUFBVTs7Ozs7OztJQWVqQiw2Q0FBdUI7O0lBRXZCLDRDQUVHOzs7OztJQUVTLHlDQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IGFkZFplcm8sIGNvbnZlcnREYXRlVG9JU09FeHRlbmRlZCB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xyXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtRmllbGQgfSBmcm9tICdAcG9ydGluYXJpL3BvcnRpbmFyaS11aSc7XHJcblxyXG5pbXBvcnQgeyBQb0pvYlNjaGVkdWxlciB9IGZyb20gJy4vaW50ZXJmYWNlcy9wby1qb2Itc2NoZWR1bGVyLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvSm9iU2NoZWR1bGVySW50ZXJuYWwgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tam9iLXNjaGVkdWxlci1pbnRlcm5hbC5pbnRlcmZhY2UnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUG9QYWdlSm9iU2NoZWR1bGVyU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgZW5kcG9pbnQgPSAnLyc7XHJcblxyXG4gIHJlYWRvbmx5IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcclxuICAgICdYLVBPUlRJTkFSSS1TQ1JFRU4tTE9DSyc6ICd0cnVlJ1xyXG4gIH0pO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxyXG5cclxuICBjb25maWdTZXJ2aWNlQXBpKGNvbmZpZzogeyBlbmRwb2ludD86IHN0cmluZyB9ID0ge30pIHtcclxuICAgIHRoaXMuZW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQ7XHJcbiAgfVxyXG5cclxuICAvLyBDcmlhIHVtIHJlY3Vyc29cclxuICBjcmVhdGVSZXNvdXJjZShyZXNvdXJjZSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBqb2JTY2hlZHVsZXIgPSB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlcihyZXNvdXJjZSk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KGAke3RoaXMuZW5kcG9pbnR9YCwgam9iU2NoZWR1bGVyLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KTtcclxuICB9XHJcblxyXG4gIGdldEhlYWRQcm9jZXNzZXMoKSB7XHJcbiAgICBjb25zdCBoZWFkZXJzID0geyAnWC1Qb3J0aW5hcmktTm8tRXJyb3InOiAndHJ1ZScgfTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmhlYWQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzYCwgeyBoZWFkZXJzIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gQnVzY2EgcGFyYW1ldHJvcyBwZWxvIHByb2Nlc3NvIGlkXHJcbiAgZ2V0UGFyYW1ldGVyc0J5UHJvY2Vzcyhwcm9jZXNzSWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXMvJHtwcm9jZXNzSWR9L3BhcmFtZXRlcnNgLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KVxyXG4gICAgLnBpcGUobWFwKChyZXNvdXJjZTogeyBpdGVtczogQXJyYXk8UG9EeW5hbWljRm9ybUZpZWxkPiB9KSA9PiByZXNvdXJjZS5pdGVtcykpO1xyXG4gIH1cclxuXHJcbiAgLy8gQnVzY2EgdW0gw7puaWNvIHJlY3Vyc29cclxuICBnZXRQcm9jZXNzKGlkOiBzdHJpbmcgfCBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYCR7dGhpcy5lbmRwb2ludH0vcHJvY2Vzc2VzLyR7aWR9YCwgeyBoZWFkZXJzOiB0aGlzLmhlYWRlcnMgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBCdXNjYSB1bWEgbGlzdGEgZGUgcHJvY2Vzc29zXHJcbiAgZ2V0UHJvY2Vzc2VzKHBhcmFtczoge30gPSB7fSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXNgLCB7IHBhcmFtcyB9KTtcclxuICB9XHJcblxyXG4gIC8vIEJ1c2NhIHVtIMO6bmljbyByZWN1cnNvXHJcbiAgZ2V0UmVzb3VyY2UoaWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgJHt0aGlzLmVuZHBvaW50fS8ke2lkfWAsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pXHJcbiAgICAgIC5waXBlKG1hcChyZXNvdXJjZSA9PiB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlckludGVybmFsKHJlc291cmNlKSkpO1xyXG4gIH1cclxuXHJcbiAgLy8gQXR1YWxpemEgdW0gcmVjdXJzb1xyXG4gIHVwZGF0ZVJlc291cmNlKGlkLCByZXNvdXJjZSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBqb2JTY2hlZHVsZXIgPSB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlcihyZXNvdXJjZSk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCBqb2JTY2hlZHVsZXIsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb252ZXJ0VG9Kb2JTY2hlZHVsZXIoam9iU2NoZWR1bGVySW50ZXJuYWwpOiBQb0pvYlNjaGVkdWxlciB7XHJcbiAgICBjb25zdCBqb2JTY2hlZHVsZXIgPSB7IC4uLmpvYlNjaGVkdWxlckludGVybmFsIH07XHJcblxyXG4gICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLnBlcmlvZGljaXR5KSB7XHJcblxyXG4gICAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucGVyaW9kaWNpdHkgPT09ICdzaW5nbGUnKSB7XHJcbiAgICAgICAgam9iU2NoZWR1bGVyLnJlY3VycmVudCA9IGZhbHNlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24oam9iU2NoZWR1bGVyLCB0aGlzLmNvbnZlcnRUb1BlcmlvZGljaXR5KGpvYlNjaGVkdWxlckludGVybmFsKSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91cikge1xyXG4gICAgICBqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24gPVxyXG4gICAgICAgIHRoaXMucmVwbGFjZUhvdXJGaXJzdEV4ZWN1dGlvbihqb2JTY2hlZHVsZXJJbnRlcm5hbC5maXJzdEV4ZWN1dGlvbiwgam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIU9iamVjdC5rZXlzKHRoaXMucmV0dXJuVmFsaWRFeGVjdXRpb25QYXJhbWV0ZXIoam9iU2NoZWR1bGVyLmV4ZWN1dGlvblBhcmFtZXRlcikpLmxlbmd0aCkge1xyXG4gICAgICBkZWxldGUgam9iU2NoZWR1bGVyLmV4ZWN1dGlvblBhcmFtZXRlcjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnJlbW92ZUludmFsaWRLZXlzKGpvYlNjaGVkdWxlcik7XHJcblxyXG4gICAgcmV0dXJuIGpvYlNjaGVkdWxlcjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29udmVydFRvSm9iU2NoZWR1bGVySW50ZXJuYWwoam9iU2NoZWR1bGVyID0gPGFueT4ge30pOiBQb0pvYlNjaGVkdWxlckludGVybmFsIHtcclxuICAgIGNvbnN0IGpvYlNjaGVkdWxlckludGVybmFsID0geyAuLi5qb2JTY2hlZHVsZXIgfTtcclxuXHJcbiAgICBpZiAoam9iU2NoZWR1bGVyLmZpcnN0RXhlY3V0aW9uKSB7XHJcbiAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91ciA9IHRoaXMuZ2V0SG91ckZpcnN0RXhlY3V0aW9uKGpvYlNjaGVkdWxlci5maXJzdEV4ZWN1dGlvbik7XHJcbiAgICB9XHJcblxyXG4gICAgT2JqZWN0LmFzc2lnbihqb2JTY2hlZHVsZXJJbnRlcm5hbCwgdGhpcy5jb252ZXJ0VG9QZXJpb2RpY2l0eUludGVybmFsKGpvYlNjaGVkdWxlcikpO1xyXG5cclxuICAgIHRoaXMucmVtb3ZlSW52YWxpZEtleXMoam9iU2NoZWR1bGVySW50ZXJuYWwsIFsnd2Vla2x5JywgJ21vbnRobHknLCAnZGFpbHknXSk7XHJcblxyXG4gICAgcmV0dXJuIGpvYlNjaGVkdWxlckludGVybmFsO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb252ZXJ0VG9QZXJpb2RpY2l0eSh2YWx1ZTogeyBwZXJpb2RpY2l0eTogc3RyaW5nICwgZGF5T2ZNb250aD86IHN0cmluZywgZGF5c09mV2Vlaz86IG51bWJlciwgaG91cj86IHN0cmluZyB9KSB7XHJcbiAgICBjb25zdCBuZXdWYWx1ZSA9IHt9O1xyXG4gICAgY29uc3QgdmFsdWVQZXJpb2RpY2l0eSA9IHZhbHVlLnBlcmlvZGljaXR5O1xyXG5cclxuICAgIGlmICh2YWx1ZVBlcmlvZGljaXR5KSB7XHJcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldID0ge307XHJcblxyXG4gICAgICBpZiAodmFsdWVQZXJpb2RpY2l0eSA9PT0gJ21vbnRobHknKSB7XHJcbiAgICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uZGF5ID0gdmFsdWUuZGF5T2ZNb250aCA/IHBhcnNlSW50KHZhbHVlLmRheU9mTW9udGgsIDEwKSA6IDA7XHJcbiAgICAgIH0gZWxzZSBpZiAodmFsdWVQZXJpb2RpY2l0eSA9PT0gJ3dlZWtseScpIHtcclxuICAgICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5kYXlzT2ZXZWVrID0gdmFsdWUuZGF5c09mV2VlaztcclxuICAgICAgfVxyXG5cclxuICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uaG91ciA9IHZhbHVlLmhvdXIgPyBwYXJzZUludCh2YWx1ZS5ob3VyLnNwbGl0KCc6JylbMF0sIDEwKSA6IDA7XHJcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLm1pbnV0ZSA9IHZhbHVlLmhvdXIgPyBwYXJzZUludCh2YWx1ZS5ob3VyLnNwbGl0KCc6JylbMV0sIDEwKSA6IDA7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ld1ZhbHVlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb252ZXJ0VG9QZXJpb2RpY2l0eUludGVybmFsKHZhbHVlID0gPGFueT4ge30pIHtcclxuICAgIGlmICh2YWx1ZS5tb250aGx5KSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdtb250aGx5JyxcclxuICAgICAgICBob3VyOiBgJHthZGRaZXJvKHZhbHVlLm1vbnRobHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5tb250aGx5Lm1pbnV0ZSl9YCxcclxuICAgICAgICBkYXlPZk1vbnRoOiB2YWx1ZS5tb250aGx5LmRheVxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIGlmICh2YWx1ZS5kYWlseSkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHBlcmlvZGljaXR5OiAnZGFpbHknLFxyXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUuZGFpbHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5kYWlseS5taW51dGUpfWBcclxuICAgICAgfTtcclxuICAgIH0gZWxzZSBpZiAodmFsdWUud2Vla2x5KSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgcGVyaW9kaWNpdHk6ICd3ZWVrbHknLFxyXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUud2Vla2x5LmhvdXIpfToke2FkZFplcm8odmFsdWUud2Vla2x5Lm1pbnV0ZSl9YCxcclxuICAgICAgICBkYXlzT2ZXZWVrOiBbLi4udmFsdWUud2Vla2x5LmRheXNPZldlZWtdXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHBlcmlvZGljaXR5OiAnc2luZ2xlJ1xyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDdXJyZW50SG91cihkYXRlOiBEYXRlKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGhvdXJzID0gYWRkWmVybyhkYXRlLmdldEhvdXJzKCkpO1xyXG4gICAgY29uc3QgbWludXRlcyA9IGFkZFplcm8oZGF0ZS5nZXRNaW51dGVzKCkpO1xyXG5cclxuICAgIHJldHVybiBgJHtob3Vyc306JHttaW51dGVzfWA7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEhvdXJGaXJzdEV4ZWN1dGlvbihmaXJzdEV4ZWN1dGlvbkRhdGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50SG91cihuZXcgRGF0ZShmaXJzdEV4ZWN1dGlvbkRhdGUpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlSW52YWxpZEtleXModmFsdWU6IG9iamVjdCwga2V5cz86IEFycmF5PHN0cmluZz4pIHtcclxuICAgIGNvbnN0IGludmFsaWRLZXlzID0ga2V5cyB8fCBbJ3BlcmlvZGljaXR5JywgJ2hvdXInLCAnbWludXRlJywgJ2RheScsICdkYXlzT2ZXZWVrJywgJ2RheU9mTW9udGgnLCAnZmlyc3RFeGVjdXRpb25Ib3VyJ107XHJcblxyXG4gICAgT2JqZWN0LmtleXModmFsdWUpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgaWYgKGludmFsaWRLZXlzLmluY2x1ZGVzKGtleSkpIHtcclxuICAgICAgICBkZWxldGUgdmFsdWVba2V5XTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlcGxhY2VIb3VyRmlyc3RFeGVjdXRpb24oZGF0ZTogc3RyaW5nLCB0aW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgZmlyc3RFeGVjdXRpb25EYXRlID0gbmV3IERhdGUoZGF0ZSk7XHJcblxyXG4gICAgY29uc3QgdGltZVNwbGl0ZWQgPSB0aW1lLnNwbGl0KCc6Jyk7XHJcblxyXG4gICAgY29uc3QgaG91cnMgPSBwYXJzZUludCh0aW1lU3BsaXRlZFswXSwgMTApO1xyXG4gICAgY29uc3QgbWludXRlcyA9IHBhcnNlSW50KHRpbWVTcGxpdGVkWzFdLCAxMCk7XHJcblxyXG4gICAgZmlyc3RFeGVjdXRpb25EYXRlLnNldEhvdXJzKGhvdXJzLCBtaW51dGVzKTtcclxuXHJcbiAgICByZXR1cm4gY29udmVydERhdGVUb0lTT0V4dGVuZGVkKGZpcnN0RXhlY3V0aW9uRGF0ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJldHVyblZhbGlkRXhlY3V0aW9uUGFyYW1ldGVyKHBhcmFtZXRlcjogb2JqZWN0KSB7XHJcbiAgICBjb25zdCBuZXdQYXJhbWV0ZXIgPSB7IC4uLnBhcmFtZXRlciB9O1xyXG5cclxuICAgIGZvciAoY29uc3Qga2V5IGluIG5ld1BhcmFtZXRlcikge1xyXG4gICAgICBpZiAobmV3UGFyYW1ldGVyLmhhc093blByb3BlcnR5KGtleSkgJiYgbmV3UGFyYW1ldGVyW2tleV0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGRlbGV0ZSBuZXdQYXJhbWV0ZXJba2V5XTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXdQYXJhbWV0ZXI7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=